---
title: "Technical Report: Full House Model in R"
date: "Version 2"
author: "Shen Yan, Adrian Burgos Jr., Christopher Kinson,  and Daniel J. Eck"
output:
  html_document:
    toc: true
    theme: united
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, cache.lazy = FALSE)
```

# Introduction

We will go through examples of how our Full House Model era-adjusts batting averages (BA) using the parametric method, and bWAR (Baseball-Reference Win Above Replacement), fWAR (Fangraphs Win Above Replacement), HR (Home Run), BB (Walks) for batters, bWAR, fWAR, ERA (Earned Run Average), SO (Strikeout) for pitchers using the nonparametric method. Also we provide details about how the tables and figures in the paper and supplementary materials are produced.

We first load in relevant software packages and the data. The necessary data are collected from [Baseball-Reference](https://www.baseball-reference.com/), [Fangraphs](https://www.fangraphs.com/) and Github [Chadwick](https://github.com/chadwickbureau). The details of data collection are in the Supplement Materials. The revelant datasets that involved in this technical report can be found in the [Tech_report_data](https://github.com/yanshenlmx/Tech_report_data)

For batters, each row of data consists of a player ID, a year ID, a name, a age, a league ID (lgID), a recorded number of at bats (AB), game(G), plate appearances (PA), a park-factored batting average (BA), a walk (BB), a observed hits (obs_hits), observed home run (obs_HR), a hit-by-pitch (HBP), a sacrifice bunt (SH), a sacrifice fly (SF), a park-factored hits (H), a park-factored home run (HR), a baseball-reference WAR (bWAR), a fangraph WAR (fWAR) and a size of the MLB-eligible population (pops).

For pitchers, each row of data consists of a player ID, a year ID, a name, a age, a league ID (lgID), a team ID (teamID), a recorded number of inning pitched (IP) and a game(G), a observed earned run (obs_ER), a observed home run (obs_HR), a observed hits (obs_H), a strikeout (SO), a park-factored earned run (ER), a park-factored home run (HR_PF), a park-factored hits (H_PF), a walk (BB), a hit-by-pitch (HBP), a baseball-reference WAR (bWAR), a fangraph WAR (fWAR) and a size of the MLB-eligible population (pops).

```{r message=FALSE, warning=FALSE}
rm(list=ls())
library(tidyverse)
library(orderstats)
library(Pareto)
library(doParallel)
library(splines)
library(retrosheet)
ncores <- detectCores() - 1
years <- 1871:2022

load("bat_pit.RData")
source('source.R')
```

In this analysis we assume that BA $\stackrel{i i d}{\sim} N\left(\mu_{i}, \sigma_{i}\right)$ and that talent scores $\stackrel{i i d}{\sim} \operatorname{Pareto}(\alpha)$ where $\alpha=1.16$. We do not have any assumptions on the distribution of the baseball statistics. This choice of alpha corresponds to the Pareto principle which is casually referred to as the $80 / 20$ rule.

# Batters

In this section, our Full House Model era-adjusts batting statistics, such as bWAR, fWAR, HR, BB and BA using the nonparametric distribution measuring the components. We also apply our Full House Model to  era-adjuste BA using the parametric distribution measuring the components. 

## bWAR

We now try out the bWAR for batters and first we select the full-time batters. We declare the median PA after screening out individuals who batted fewer than 75 PA as our cutoff for full-time batters.

```{r cache=TRUE}
batters <- bat_dat %>% select(yearID, playerID, lgID, name, age, PA, G, bWAR, pops)
cutoff <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    m <- batters %>% filter(yearID == xx) %>% filter(PA >= 75)
    data.frame(thres = median(m$PA), yearID = xx)
  }))
batters <- merge(batters, cutoff, by = 'yearID')
batters <- batters %>% mutate(comp =  bWAR / G, full_time = ifelse(PA >= thres, 'Y', 'N'))
```

In the [1994 and 1995](https://en.wikipedia.org/wiki/1994%E2%80%9395_Major_League_Baseball_strike), hitters and pitchers played fewer games per season than the regular season. To deal with extreme statistics from the small sample size, we motivated a shrinkage method that adjust the raw statistics toward a global average. Our shrinkage method follows a shrinkage of ballpark effect estimates motivated from Michael Schell's book, [Baseball's All-Time Best Sluggers](https://www-jstor-org.proxy2.library.illinois.edu/stable/j.ctt19705ks.25?seq=8). This methods involves weighted average of raw components and league average, which is 

$$\textrm{adjusted component} = (\textrm{raw components} \times \textrm{total ABs} + 4000 \times \textrm{league average})/(\textrm{totals AB + 4000}) $$
When we use the shrinkage method to analyze our seasonal data, the shrinkage factor $4000 / (\textrm{totals AB + 4000})$ get adjusted based on fraction of 4000 to the totals AB of the MLB teams. For example, $$\textrm{adjusted bWAR per game} = (\textrm{raw bWAR per game} \times \textrm{game} + 7 \times \textrm{league average})/(\textrm{game + 7}) $$

```{r cache=TRUE}
batters_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- batters %>% filter(yearID == xx)
    lg_avg <- sum(int$bWAR)/sum(int$G)
    int %>% mutate(comp = (bWAR + lg_avg * 7)/(G + 7))
  }))
```

The following script computes the talent scores for bWAR per game from all batters and all seasons (1871 to 2022).

```{r cache=TRUE}
batters_talent_bWAR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
  talent_computing_nonpara(dataset = batters_schell, component_name = "bWAR", year = yy, ystar = thresh_fun(component = batters_schell %>% filter(full_time == 'Y', yearID == yy) %>% select(comp), component_name = 'bWAR'), alpha = 1.16) })) %>% arrange(-WAR_talent)
```

We built a common mapping environment with regard to the provided season size based on the no-strike seasons rather than utilizing one specific season from 1871 to 2022 as the projected season. To acquire era-adjusted statistics, we project the players' talent to this common mapping environment. [Micheal Schell](https://www-jstor-org.proxy2.library.illinois.edu/stable/j.ctt19705ks.6?seq=15) inspired us to use the National League seasons from 1977 through 1989, with the exception of the 1981 strike season, as the common mapping environment. The number of teams in these seasons that we choose remains constant in order to prevent the Major League's expansion effect. We then construct an isotonic regression model of the corresponding components on the ordered talent scores. In the common mapping environment, this model provides the association between the components and the talent scores.

We set the total number of full-time players throughout all seasons to be equal to the number of components in the common mapping environment. This is due to the fact that the more components in the common mapping environment, the $\widetilde{F}_{Y_i}(t)$ and $F_{Y_i}(t)$ are more closely. Then we select this number of components based on the quantile mapping and the quantiles of the components are equally spaced. The talent scores of the components we choose from the common mapping environment are calculated using the isotonic regression model. Now we construct the common mapping environment completely.

```{r cache=TRUE}
no_strike <- batters_talent_bWAR %>% 
    filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  
t <- isoreg(no_strike$WAR_talent, no_strike$comp)
talent_new <- quantile(no_strike$WAR_talent, probs = (seq(0,250)/250))
comp_new <- as.stepfun(t)(talent_new)
```

The figure below shows the relationship between bWAR talent and bWAR per game. The black dots represent the observations from the full-time batters from the 1977 season to 1989 season with the exception of the 1981 strike season. The red dots represent the observations from the common mapping environment that we define above. Based on the figure above, the observations from the common mapping environment accurately depict the relationship between bWAR talent and bWAR per game from the 1977 season to the 1989 season with the exception of the 1981 strike season.

```{r}
mapping_envir <- data.frame(talent_new = talent_new, comp_new = comp_new)
ggplot(data = no_strike, aes(x = WAR_talent, y = comp)) + geom_point() + 
  geom_point(data = mapping_envir, aes(x = talent_new, y = comp_new), color = 'red') +
  labs(x = 'bWAR talent', y = 'bWAR per game') +
  scale_x_continuous(trans='log')
```

```{r}
ystar <- thresh_fun(comp_new, component_name = 'bWAR')
pop_new <- round(mean(no_strike$pops))
component_name = 'bWAR'
yy <- sort(comp_new)
n <- length(yy)
ytilde <- rep(0, n + 1)
if (component_name == 'bWAR' | component_name == 'fWAR') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
}
if (component_name == 'HR' | component_name == 'BB') {
    # since the minimal HR is greater or equal to 0.
    ytilde[1] <- 0
}
ytilde[n+1] <- yy[n] + ystar
ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2 
}))
```

We now extend the method to compute hypothetical careers in the common mapping environment and obtain the era-adjusted statistics.

```{r cache=TRUE}
career_kAB_1st <- do.call(rbind, mclapply(1:30000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                         snippet = batters_talent_bWAR[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores))
  
  
career_kAB_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                         snippet = batters_talent_bWAR[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
career_kAB_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_bWAR), function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                         snippet = batters_talent_bWAR[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
career_kAB <- rbind(career_kAB_1st, career_kAB_2nd, career_kAB_3rd)
```

Instead of using the raw G and PA in the data set, we calculate the mapped G by applying quantile mapping for the full-time hitters and non-full-time hitters separately. Quantile mapping is based on that a pth percentile player's games in one year is equal to a pth percentile player's games in the common mapping environment.

We also specify that worst performance of bWAR for the full time players in each season -2.

```{r cache=TRUE}
## mapping statistics
  
mapped_quan_b_raw <- do.call(rbind, mclapply(years, function(xx){
    batters_full <- batters %>% filter(yearID == xx) %>% 
      filter(full_time == 'Y') %>% arrange(-G)
    batters_less <- batters %>% filter(yearID == xx) %>% 
      filter(full_time == 'N') %>% arrange(-G)
    
    n1 <- nrow(batters_full)
    n2 <- nrow(batters_less)
    
    mapped_G_full <- c()
    mapped_G_less <- c()
    for (yy in c(1977:1980, 1982:1989)) {
      batters_ref_full <- batters %>% 
        filter(yearID == yy, full_time == 'Y') %>% arrange(-G)
      batters_ref_less <- batters %>% 
        filter(yearID == yy, full_time == 'N') %>% arrange(-G)
      n1r <- nrow(batters_ref_full)
      n2r <- nrow(batters_ref_less)
      
      mapped_G_full <- cbind(mapped_G_full, approx(x = seq((n1r-1),0)/(n1r-1), 
                                                   y = batters_ref_full$G, 
                                                   xout = seq((n1-1),0)/(n1-1))$y)
      mapped_G_less <- cbind(mapped_G_less, approx(x = seq((n2r-1),0)/(n2r-1), 
                                                   y = batters_ref_less$G, 
                                                   xout = seq((n2-1),0)/(n2-1))$y)
    }
    
    batters_full$mapped_G <- rowMeans(mapped_G_full)
    batters_less$mapped_G <- rowMeans(mapped_G_less)
    
    
    batters_full <- batters_full %>% arrange(-PA)
    batters_less <- batters_less %>% arrange(-PA)
    mapped_PA_full <- c()
    mapped_PA_less <- c()
    for (yy in c(1977:1980, 1982:1989)) {
      batters_ref_full <- batters %>% 
        filter(yearID == yy, full_time == 'Y') %>% arrange(-PA)
      batters_ref_less <- batters %>% 
        filter(yearID == yy, full_time == 'N') %>% arrange(-PA)
      n1r <- nrow(batters_ref_full)
      n2r <- nrow(batters_ref_less)
      
      mapped_PA_full <- cbind(mapped_PA_full, approx(x = seq((n1r-1),0)/(n1r-1), 
                                                     y = batters_ref_full$PA, 
                                                     xout = seq((n1-1),0)/(n1-1))$y)
      mapped_PA_less <- cbind(mapped_PA_less, approx(x = seq((n2r-1),0)/(n2r-1), 
                                                     y = batters_ref_less$PA, 
                                                     xout = seq((n2-1),0)/(n2-1))$y)
    }
    
    batters_full$mapped_PA <- rowMeans(mapped_PA_full)
    batters_less$mapped_PA <- rowMeans(mapped_PA_less)
    
    m <- rbind(batters_full, batters_less)
    data.frame(playerID = m$playerID, yearID = m$yearID,
               mapped_G_raw = round(m$mapped_G), mapped_PA_raw = round(m$mapped_PA))
    
  }, mc.cores = ncores))
   
mapped_batters_1 <- merge(career_kAB, mapped_quan_b_raw, 
                            by = c('playerID', 'yearID'))
  
min_refbWAR <- -2
  
mapped_batters_bWAR <- mapped_batters_1 %>% 
    mutate(adj_bWAR = adj_comp * mapped_G_raw) %>% 
    mutate(adj_bWAR = ifelse(adj_bWAR < min_refbWAR, min_refbWAR, adj_bWAR)) %>%
    mutate(mapped_G_bWAR = round(adj_bWAR / adj_comp))
```

Then we apply the same techniques for fWAR, HR, BB.

```{r cache=TRUE, echo=FALSE}
batters <- bat_dat %>% select(yearID, playerID, lgID, name, age, PA, G, bWAR,fWAR,pops)
  
  batters <- merge(batters, cutoff, by = 'yearID')
  
  batters <- batters %>% mutate(comp =  fWAR / G, full_time = ifelse(PA >= thres, 'Y', 'N'))
  
  batters_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- batters %>% filter(yearID == xx)
    lg_avg <- sum(int$fWAR)/sum(int$G)
    int %>% mutate(comp = (fWAR + lg_avg * 7)/(G + 7))
  }))
  
  batters_talent_fWAR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
    talent_computing_nonpara(dataset = batters_schell, component_name = "fWAR", year = yy, 
                             ystar = thresh_fun(component = batters_schell %>% filter(full_time == 'Y', yearID == yy) %>% select(comp), component_name = 'fWAR'), alpha = 1.16)
  })) %>% arrange(-WAR_talent)
  
  no_strike <- batters_talent_fWAR %>% 
    filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  
  t <- isoreg(no_strike$WAR_talent, no_strike$comp)
  
  talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,250)/250)
  
  comp_new <- as.stepfun(t)(talent_new)
  
  ystar <- thresh_fun(comp_new, component_name = 'fWAR')
  pop_new <- round(mean(no_strike$pops))
  component_name = 'fWAR'
  yy <- sort(comp_new)
  n <- length(yy)
  ytilde <- rep(0, n + 1)
  if (component_name == 'bWAR' | component_name == 'fWAR') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
  }
  if (component_name == 'HR' | component_name == 'BB') {
    # since the minimal HR is greater or equal to 0.
    ytilde[1] <- 0
  }
  ytilde[n+1] <- yy[n] + ystar
  ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2 
  }))
  
  career_kAB_1st <- do.call(rbind, mclapply(1:30000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_fWAR, component_name = 'fWAR', 
                         snippet = batters_talent_fWAR[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores))
  
  
  career_kAB_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_fWAR, component_name = 'fWAR', 
                         snippet = batters_talent_fWAR[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
  career_kAB_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_fWAR), function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_fWAR, component_name = 'fWAR', 
                         snippet = batters_talent_fWAR[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
  career_kAB <- rbind(career_kAB_1st, career_kAB_2nd, career_kAB_3rd)
  
  mapped_batters_1 <- merge(career_kAB, mapped_quan_b_raw, 
                            by = c('playerID', 'yearID'))
  
  min_reffWAR <- -2
  
  mapped_batters_fWAR <- mapped_batters_1 %>% 
    mutate(adj_fWAR = adj_comp * mapped_G_raw) %>% 
    mutate(adj_fWAR = ifelse(adj_fWAR < min_reffWAR, min_reffWAR, adj_fWAR)) %>%
    mutate(mapped_G_fWAR = round(adj_fWAR / adj_comp))
```

```{r cache=TRUE, echo=FALSE}
batters_HR <- bat_dat %>% 
    select(yearID, playerID, lgID, name, PA, AB, HR, BB, HBP, SH, SF, bWAR, pops)
  
  cutoff <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    m <- batters_HR %>% filter(yearID == xx) %>% filter(PA >= 75)
    data.frame(thres = median(m$PA), yearID = xx)
  }))
  
  batters <- merge(batters_HR, cutoff, by = 'yearID')
  
  batters <- batters %>% mutate(comp =  ifelse(AB != 0, HR / AB, 0), full_time = ifelse(PA >= thres, 'Y', 'N'))
  
  batters_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- batters %>% filter(yearID == xx)
    lg_avg <- sum(int$HR)/sum(int$AB)
    int %>% mutate(comp = (HR + lg_avg * 25)/(AB + 25))
  }))
  
  batters_talent_HR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
    talent_computing_nonpara(dataset = batters_schell, component_name = "HR", 
                             year = yy, ystar = thresh_fun(component = batters_schell %>% 
                                                            filter(full_time == 'Y', yearID == yy) %>%
                                                            select(comp), component_name = 'HR'), 
                             alpha = 1.16)
  })) %>% arrange(-WAR_talent)
  
  no_strike <- batters_talent_HR %>% 
    filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  
  min_refHR <- min(no_strike$HR)
  
  t <- isoreg(no_strike$WAR_talent, no_strike$comp)
  
  talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,250)/250)
  
  comp_new <- as.stepfun(t)(talent_new)
  
  ystar <- thresh_fun(comp_new, component_name = 'HR')
  pop_new <- round(mean(no_strike$pops))
  component_name = 'HR'
  yy <- sort(comp_new)
  n <- length(yy)
  ytilde <- rep(0, n + 1)
  if (component_name == 'bWAR' | component_name == 'fWAR') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
  }
  if (component_name == 'HR' | component_name == 'BB') {
    # since the minimal HR is greater or equal to 0.
    ytilde[1] <- 0
  }
  ytilde[n+1] <- yy[n] + ystar
  ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2 
  }))
  
  career_kAB_1st <- do.call(rbind, mclapply(1:30000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_HR, component_name = 'HR', 
                         snippet = batters_talent_HR[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores))
  
  
  career_kAB_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_HR, component_name = 'HR', 
                         snippet = batters_talent_HR[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
  career_kAB_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_HR), function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_HR, component_name = 'HR', 
                         snippet = batters_talent_HR[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
  career_kAB <- rbind(career_kAB_1st, career_kAB_2nd, career_kAB_3rd)
  
```


```{r cache=TRUE, echo=FALSE}
batters_BB <- bat_dat %>% select(yearID, playerID, lgID, name, G, PA, BB, pops)
  
  batters <- merge(batters_BB, cutoff, by = 'yearID')
  
  batters <- batters %>% mutate(comp = ifelse(PA > 0, BB / PA, 0), full_time = ifelse(PA >= thres, 'Y', 'N'))
  
  batters_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- batters %>% filter(yearID == xx)
    lg_avg <- sum(int$BB)/sum(int$PA)
    int %>% mutate(comp = (BB + lg_avg * 28)/(PA + 28))
  }))
  
  batters_talent_BB <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
    talent_computing_nonpara(dataset = batters_schell, component_name = "BB", 
                             year = yy, ystar = 
                               thresh_fun(component = batters_schell %>% 
                                           filter(full_time == 'Y', yearID == yy) %>% 
                                           select(comp), component_name = 'BB'), alpha = 1.16)
  })) %>% arrange(-WAR_talent)
  
  
  no_strike <- batters_talent_BB %>% 
    filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  
  min_refBB <- 0
  
  t <- isoreg(no_strike$WAR_talent, no_strike$comp)
  
  talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,250)/250)
  
  comp_new <- as.stepfun(t)(talent_new)
  
  ystar <- thresh_fun(comp_new, component_name = 'BB')
  pop_new <- round(mean(no_strike$pops))
  component_name = 'BB'
  yy <- sort(comp_new)
  n <- length(yy)
  ytilde <- rep(0, n + 1)
  if (component_name == 'bWAR' | component_name == 'fWAR') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
  }
  if (component_name == 'HR' | component_name == 'BB') {
    # since the minimal HR is greater or equal to 0.
    ytilde[1] <- 0
  }
  ytilde[n+1] <- yy[n] + ystar
  ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2 
  }))
  
  career_kAB_BB_1st <- do.call(rbind, mclapply(1:30000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_BB, component_name = 'BB', 
                         snippet = batters_talent_BB[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores))
  
  
  career_kAB_BB_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_BB, component_name = 'BB', 
                         snippet = batters_talent_BB[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
  career_kAB_BB_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_BB), function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_BB, component_name = 'BB', 
                         snippet = batters_talent_BB[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
  career_kAB_BB <- rbind(career_kAB_BB_1st, career_kAB_BB_2nd, career_kAB_BB_3rd)
  
  colnames(career_kAB)[colnames(career_kAB) == 'adj_comp'] <- "adj_HR_AB"
  
  career_combined <- merge(career_kAB %>% select(-comp), career_kAB_BB %>% 
                             select(yearID, playerID, comp, adj_comp), by = c('yearID', 'playerID'))
  
  mapped_batters_1 <- merge(career_combined, mapped_quan_b_raw, 
                            by = c('playerID', 'yearID'))
  
  mapped_batters_HR <- mapped_batters_1 %>%
    mutate(adj_BB = ceiling(adj_comp * ceiling(mapped_PA_raw))) %>% 
    mutate(adj_BB = ifelse(adj_BB < min_refBB, min_refBB, adj_BB)) %>% 
    mutate(mapped_PA = mapped_PA_raw) %>%
    mutate(adj_AB = ceiling(mapped_PA) - adj_BB - HBP - SH - SF) %>% 
    mutate(adj_AB = ifelse(adj_AB < 0, 0, adj_AB)) %>% 
    mutate(adj_HR = ceiling(adj_HR_AB * adj_AB)) %>% 
    mutate(adj_HR = ifelse(adj_HR < min_refHR, min_refHR, adj_HR))
  
```

[Stephen Jay Gould](https://en.wikipedia.org/wiki/Full_House:_The_Spread_of_Excellence_from_Plato_to_Darwin) suggests that the BA in every season follows normal distribution and we perform Shapiro-Wilk Normality Test to verify this argument. Based on the results, 16 out of 152 seasons from 1971 to 2022 seasons fail the normality test. The 16 seasons are 1876, 1895, 1896, 1904, 1908, 1912, 1916, 1922, 1924, 1941, 1946, 1959, 1961, 1967, 1972, 1987, 1994, 1997. 

```{r cache=TRUE}
batters <- bat_dat
  
  batters <- merge(batters, cutoff, by = 'yearID')
  
  batters <- batters %>% select(playerID, yearID, lgID, name, age, lgID, AB, 
                                PA, obs_hits, H, thres, bWAR, pops) %>%
    mutate(comp = ifelse(AB != 0, H / AB, 0), full_time = ifelse(PA >= thres, 'Y', 'N'))
  
  batters_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- batters %>% filter(yearID == xx)
    lg_avg <- sum(int$H)/sum(int$AB)
    int %>% mutate(comp = (H + lg_avg * 25)/(AB + 25))
  }))
  
  normality <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    m <- batters_schell %>% filter(yearID == xx, full_time == 'Y') %>% pull(comp) %>% shapiro.test()
    data.frame(yearID = xx, p_value = m$p.value)
  }))
  
  years[which(normality$p_value <= 0.05)]
```

Now we use both parametric and non-parametric distribution to measure the BA.

```{r cache=TRUE, echo=FALSE}
batters_talent_AVG <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
    talent_computing_nonpara(dataset = batters_schell, component_name = "AVG", 
                             year = yy, ystar = thresh_fun(component = batters_schell %>% 
                                                            filter(full_time == 'Y', yearID == yy) %>%
                                                            select(comp), component_name = 'AVG'), 
                             alpha = 1.16)
  })) %>% arrange(-WAR_talent)
  
  no_strike <- batters_talent_AVG %>%
    filter(yearID < 1990, yearID >= 1977, yearID != 1981,
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  
  min_refAVG <- min(no_strike$comp)
  
  t <- isoreg(no_strike$WAR_talent, no_strike$comp)
  
  talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,250)/250)
  
  comp_new <- as.stepfun(t)(talent_new)
  
  ystar <- thresh_fun(comp_new, component_name = 'AVG')
  pop_new <- round(mean(no_strike$pops))
  component_name = 'AVG'
  yy <- sort(comp_new)
  n <- length(yy)
  ytilde <- rep(0, n + 1)
  if (component_name == 'bWAR' | component_name == 'fWAR') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
  }
  if (component_name == 'HR' | component_name == 'BB') {
    # since the minimal HR is greater or equal to 0.
    ytilde[1] <- 0
  }
  if (component_name == 'AVG') {
    ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
  }
  ytilde[n+1] <- yy[n] + ystar
  ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2
  }))
  
  # get career adjustment on season by season basis
  # talent_exp <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
  #   m <- batters_talent_AVG %>% filter(yearID == xx, PA >= thres) %>% pull(bWAR) %>% sort()
  #   n <- length(m)
  #   batters_talent_AVG %>% filter(yearID == xx) %>%
  #     mutate(WAR_talent_exp = WAR_talent + quantile(no_strike$WAR_talent, 1/n) - avg_talent)
  # })) 
  
  career_kAB_AVG_1st <- do.call(rbind, mclapply(1:30000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                         snippet = batters_talent_AVG[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores))
  
  
  career_kAB_AVG_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                         snippet = batters_talent_AVG[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores))
  
  career_kAB_AVG_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_AVG), function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                         snippet = batters_talent_AVG[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores))
  
  
  career_kAB <- rbind(career_kAB_AVG_1st, 
                      career_kAB_AVG_2nd, 
                      career_kAB_AVG_3rd)
 
  mapped_batters_AVG_nonpara <- career_kAB %>% 
    mutate(adj_AVG = ifelse(adj_comp < min_refAVG, min_refAVG, adj_comp))
  
```

```{r cache=TRUE, echo=FALSE}
batters <- bat_dat
  
  batters <- merge(batters, cutoff, by = 'yearID')
  
  batters <- batters %>% select(playerID, yearID, lgID, name, age, lgID, AB, 
                                PA, obs_hits, H, thres, bWAR, pops) %>%
    mutate(comp = ifelse(AB != 0, H / AB, 0), full_time = ifelse(PA >= thres, 'Y', 'N'))
  
  batters_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- batters %>% filter(yearID == xx)
    lg_avg <- sum(int$H)/sum(int$AB)
    int %>% mutate(comp = (H + lg_avg * 25)/(AB + 25))
  }))
  
  batters_talent_AVG <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
    talent_computing_para(dataset = batters_schell, year = yy, alpha = 1.16)
  })) %>% arrange(-talent)
  
  no_strike <- batters_talent_AVG %>%
    filter(yearID < 1990, yearID >= 1977, yearID != 1981,
           full_time == 'Y', lgID == 'NL') %>%
    arrange(talent)
  
  min_refAVG <- min(no_strike$comp)
  
  t <- isoreg(no_strike$talent, no_strike$comp)
  
  talent_new <- quantile(no_strike$talent, probs = seq(0,250)/250)
  comp_new <- as.stepfun(t)(talent_new)
  pop_new <- round(mean(no_strike$pops))
  
  mean_new <- mean(comp_new)
  sd_new <- sd(comp_new)
  
  career_kAB_AVG_1st <- do.call(rbind, mclapply(1:30000, function(zz){
    int <- career_talent_para(dataset = batters_talent_AVG, 
                              snippet = batters_talent_AVG[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores))
  
  career_kAB_AVG_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
    int <- career_talent_para(dataset = batters_talent_AVG, 
                              snippet = batters_talent_AVG[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores))
  
  career_kAB_AVG_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_AVG), function(zz){
    int <- career_talent_para(dataset = batters_talent_AVG, 
                              snippet = batters_talent_AVG[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores))
  
  
  career_kAB <- rbind(career_kAB_AVG_1st, 
                      career_kAB_AVG_2nd, 
                      career_kAB_AVG_3rd)
  
  mapped_batters_AVG_para <- career_kAB %>% 
    mutate(adj_AVG = ifelse(adj_comp < min_refAVG, min_refAVG, adj_comp))
  
```

We eliminate players who had an era-adjusted bWAR or fWAR below the replacement level for more than half of their career seasons. We also set three rules to eliminate some players' poor early and late career seasons. The three rules are 

+ In at least 2 consecutive seasons, the era-adjusted bWAR is below -1.5.
+ In at least 2 consecutive seasons, the era-adjusted fWAR is below -1.5. 
+ In at least two consecutive seasons, no more than one era-adjusted bWAR or era-adjusted fWAR can be more than 0.2. 

The value 0.2 is calculated from the average bWAR or fWAR of the players that disappeared from the MLB from the 1977 season to 1989 season with the exception of 1981 season. 

After getting the era-adjusted statistics, we find some players' statistics dramatically change in tails of their career, which is unrealistic in the real life. To solve it, we apply some smoothing methods to alleviate these dramatic variations, such as local polynomial regression fitting and natural cubic spline. Then natural cubic spline method has the minimal bias and is considered as the best option compared with other methods.

Also, we notice that the smoothing method could weaken player's prime or extreme seasons. Therefore, we take the average of the smoothed era-adjusted statistics and era-adjusted statistics, which can keep player's prime season and alleviate the dramatic changes in the tail of their career. 

```{r cache=TRUE}
AVG_part <- mapped_batters_AVG_nonpara %>%
    mutate(adj_AVG = round(adj_AVG, 3)) %>% 
    select(yearID, playerID, name, adj_AVG) 
  HR_part <- mapped_batters_HR %>% 
    mutate(mapped_PA = round(mapped_PA)) %>% 
    mutate(adj_HR = round(adj_HR)) %>%
    mutate(adj_AB = round(adj_AB)) %>%
    select(yearID, playerID, adj_HR, adj_AB, HBP, SF, mapped_PA) 
  bWAR_part <- mapped_batters_bWAR %>%
    mutate(adj_bWAR = round(adj_bWAR, 2)) %>%
    select(yearID, playerID, adj_bWAR, mapped_G_bWAR) 
  fWAR_part <- mapped_batters_fWAR %>%
    mutate(adj_fWAR = round(adj_fWAR, 2)) %>%
    select(yearID, playerID, age, adj_fWAR, mapped_G_fWAR) 
  BB_part <- mapped_batters_HR %>% 
    mutate(adj_BB = round(adj_BB)) %>%
    select(yearID, playerID, BB, adj_BB)
  master_batters <- merge(BB_part, merge(AVG_part, 
                                         merge(HR_part, merge(bWAR_part, fWAR_part, 
                                                              by = c('yearID', 'playerID')), 
                                               by = c('yearID', 'playerID')), 
                                         by = c('yearID', 'playerID')), 
                          by = c('yearID', 'playerID'))
  
  master_batters <- master_batters %>% 
    mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
  master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0
  
  master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
    mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))
  master_batters_nonpara$mapped_G <- apply(master_batters_nonpara[,c(13,16)], 1, min)
  
  ## Batters
  batters <- master_batters_nonpara

  ## extract and remove bad players 
  foo <- batters %>% 
    arrange(desc(adj_AVG)) %>% 
    filter(adj_AB >= 300) %>% 
    dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
    mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
  bar <- split(foo, as.factor(foo$playerID))
  baz <- do.call(rbind, lapply(bar, function(m){
    m[which.max(m$adj_fWAR), ]
  }))
  baz <- baz %>% arrange(adj_fWAR)
  bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
  
  baz <- do.call(rbind, lapply(bar, function(m){
    m[which.max(m$adj_bWAR), ]
  }))
  baz <- baz %>% arrange(adj_bWAR)
  bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
  bad_players <- union(bad_players_bWAR, bad_players_fWAR)
  batters <- batters[!batters$playerID %in% bad_players, ]
  
  ###### investigate anomalies ######
  
  ## more on base events than PAs
  
  # check average for minimal at bats and correct issues
  batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
  batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
  batters[batters$adj_AB > 0, ]$adj_AVG <- 
    round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)
  
  ## build adjusted data set
  batters_adjusted <- batters %>% 
    dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                  adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
  colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                  "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
  batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))

  
  ## trim out bad players
  # first round
  foo <- split(batters_adjusted, f = batters_adjusted$playerID)
  bar <- lapply(foo, function(m){
    ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
  })
  checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                        m_bad = unlist(lapply(bar, mean)), 
                        len = unlist(lapply(bar, length)))
  batters_adjusted <- batters_adjusted %>% 
    filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
  batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
  
  # second round
  foo <- split(batters_adjusted, f = batters_adjusted$playerID)
  bar <- lapply(foo, function(m){
    ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
  })
  checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                        m_bad = unlist(lapply(bar, mean)), 
                        len = unlist(lapply(bar, length)))
  batters_adjusted <- batters_adjusted %>% 
    filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
  batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
  
  # third round
  foo <- split(batters_adjusted, f = batters_adjusted$playerID)
  bar <- lapply(foo, function(m){
    min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
  })
  checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                        m_bad = unlist(lapply(bar, mean)), 
                        len = unlist(lapply(bar, length)))
  batters_adjusted <- batters_adjusted %>% 
    filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
  batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
  
  # forth round
  foo <- split(batters_adjusted, f = batters_adjusted$playerID)
  bar <- lapply(foo, function(m){
    ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
  })
  checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                        m_bad = unlist(lapply(bar, mean)), 
                        len = unlist(lapply(bar, length)))
  batters_adjusted <- batters_adjusted %>% 
    filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
  batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
  
  
  ## remove tails 
  foo <- split(batters_adjusted, f = batters_adjusted$playerID)
  bar <- lapply(foo, function(m){
    bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
    bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                      ifelse(sum(tail(bad, 3)) >= 5,1,0),
                      ifelse(sum(tail(bad, 4)) >= 7,1,0),
                      ifelse(sum(tail(bad, 5)) >= 9,1,0),
                      ifelse(sum(tail(bad, 6)) >= 11,1,0)))
    1:(length(bad)-bad_tail)
  })
  batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
    foo[[j]][bar[[j]], ]
  })) %>% arrange(year)
  
  foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
  bar <- lapply(foo, function(m){
    bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
    bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                      ifelse(sum(tail(bad, 3)) >= 3,1,0),
                      ifelse(sum(tail(bad, 4)) >= 4,1,0),
                      ifelse(sum(tail(bad, 5)) >= 5,1,0),
                      ifelse(sum(tail(bad, 6)) >= 6,1,0)))
    1:(length(bad)-bad_tail)
  })
  batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
    foo[[j]][bar[[j]], ]
  })) %>% arrange(year)
  
  foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
  bar <- lapply(foo, function(m){
    bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
    bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                      ifelse(sum(tail(bad, 3)) >= 3,1,0),
                      ifelse(sum(tail(bad, 4)) >= 4,1,0),
                      ifelse(sum(tail(bad, 5)) >= 5,1,0),
                      ifelse(sum(tail(bad, 6)) >= 6,1,0)))
    1:(length(bad)-bad_tail)
  })
  batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
    foo[[j]][bar[[j]], ]
  })) %>% arrange(year)
  
  ## remove starts
  foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
  bar <- lapply(foo, function(m){
    bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
    bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                      ifelse(sum(head(bad, 2)) >= 3,1,0),
                      ifelse(sum(head(bad, 3)) >= 5,1,0),
                      ifelse(sum(head(bad, 4)) >= 7,1,0),
                      ifelse(sum(head(bad, 5)) >= 9,1,0),
                      ifelse(sum(head(bad, 6)) >= 11,1,0)))
    if (bad_head < length(bad)) {
      (bad_head + 1):length(bad)
    }
  })
  batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
    foo[[j]][bar[[j]], ]
  })) %>% arrange(year)
  
  batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)
  
  # taper down average WAR for players with small PAs
  batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
    round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
  batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
    round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	
  
  batters_adjusted <- do.call(rbind, mclapply(
    split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
    mc.cores = ncores, FUN = function(xx){
      ## natural cubic spline
      ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
      nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
      ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
      nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
      ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
      nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
      ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
      nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
      ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
      nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
      
      xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
        mutate(HR = round((adj_HR + nn_HR)/2)) %>%
        mutate(BB = round((adj_BB + nn_BB)/2)) %>%
        mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
        mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
    })) 
  
  bat_season <- batters_adjusted %>% 
    mutate(PA = adj_AB + BB + HBP + SF)
  bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
    bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB

 bat_season <- bat_season %>% 
   dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
 bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
   mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
   mutate(HR = ifelse(HR > 0, HR, 0)) %>%
   mutate(BB = ifelse(BB > 0, BB, 0)) %>%
   mutate(OBP = ifelse(OBP > 0, OBP, 0))
 
 colnames(bat_season)[5] <- 'AB'
 colnames(bat_season)[8] <- 'BA'
 bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
   mutate(BA = round(H / AB, 3)) %>%
   mutate(BA = ifelse(AB == 0, 0, BA)) %>%
   mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
   mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))
 
  bat_career_nonpara <- bat_season_nonpara %>% group_by(playerID) %>% 
    summarise(name = unique(name), 
              playerID = unique(playerID), 
              PA = sum(round(PA)), 
              AB = sum(AB), 
              H = sum(H), 
              HR = sum(round(HR)), 
              BB = sum(round(BB)), 
              BA = round(H/AB, 3), 
              HBP = sum(HBP), 
              SF = sum(SF), 
              OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
              ebWAR = sum(ebWAR), 
              efWAR = sum(efWAR)) %>% ungroup() %>% 
    arrange(desc(ebWAR))
  
  bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
  bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))
  
```

```{r cache=TRUE}
AVG_part <- mapped_batters_AVG_para %>%
    mutate(adj_AVG = round(adj_AVG, 3)) %>% 
    select(yearID, playerID, name, adj_AVG) 
  HR_part <- mapped_batters_HR %>% 
    mutate(mapped_PA = round(mapped_PA)) %>% 
    mutate(adj_HR = round(adj_HR)) %>%
    mutate(adj_AB = round(adj_AB)) %>%
    select(yearID, playerID, adj_HR, adj_AB, HBP, SF, mapped_PA) 
  bWAR_part <- mapped_batters_bWAR %>%
    mutate(adj_bWAR = round(adj_bWAR, 2)) %>%
    select(yearID, playerID, adj_bWAR, mapped_G_bWAR) 
  fWAR_part <- mapped_batters_fWAR %>%
    mutate(adj_fWAR = round(adj_fWAR, 2)) %>%
    select(yearID, playerID, age, adj_fWAR, mapped_G_fWAR) 
  BB_part <- mapped_batters_HR %>% 
    mutate(adj_BB = round(adj_BB)) %>%
    select(yearID, playerID, BB, adj_BB)
  master_batters <- merge(BB_part, merge(AVG_part, 
                                         merge(HR_part, merge(bWAR_part, fWAR_part, 
                                                              by = c('yearID', 'playerID')), 
                                               by = c('yearID', 'playerID')), 
                                         by = c('yearID', 'playerID')), 
                          by = c('yearID', 'playerID'))
  
  master_batters <- master_batters %>% 
    mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
  master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0
  
  master_batters_para <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
    mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))
  master_batters_para$mapped_G <- apply(master_batters_para[,c(13,16)], 1, min)
  
  ## Batters
  batters <- master_batters_para

  ## extract and remove bad players 
  foo <- batters %>% 
    arrange(desc(adj_AVG)) %>% 
    filter(adj_AB >= 300) %>% 
    dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
    mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
  bar <- split(foo, as.factor(foo$playerID))
  baz <- do.call(rbind, lapply(bar, function(m){
    m[which.max(m$adj_fWAR), ]
  }))
  baz <- baz %>% arrange(adj_fWAR)
  bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
  
  baz <- do.call(rbind, lapply(bar, function(m){
    m[which.max(m$adj_bWAR), ]
  }))
  baz <- baz %>% arrange(adj_bWAR)
  bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
  bad_players <- union(bad_players_bWAR, bad_players_fWAR)
  batters <- batters[!batters$playerID %in% bad_players, ]
  
  ###### investigate anomalies ######
  
  ## more on base events than PAs
  
  # check average for minimal at bats and correct issues
  batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
  batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
  batters[batters$adj_AB > 0, ]$adj_AVG <- 
    round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)
  
  ## build adjusted data set
  batters_adjusted <- batters %>% 
    dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                  adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
  colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                  "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
  batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))

  
  ## trim out bad players
  # first round
  foo <- split(batters_adjusted, f = batters_adjusted$playerID)
  bar <- lapply(foo, function(m){
    ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
  })
  checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                        m_bad = unlist(lapply(bar, mean)), 
                        len = unlist(lapply(bar, length)))
  batters_adjusted <- batters_adjusted %>% 
    filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
  batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
  
  # second round
  foo <- split(batters_adjusted, f = batters_adjusted$playerID)
  bar <- lapply(foo, function(m){
    ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
  })
  checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                        m_bad = unlist(lapply(bar, mean)), 
                        len = unlist(lapply(bar, length)))
  batters_adjusted <- batters_adjusted %>% 
    filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
  batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
  
  # third round
  foo <- split(batters_adjusted, f = batters_adjusted$playerID)
  bar <- lapply(foo, function(m){
    min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
  })
  checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                        m_bad = unlist(lapply(bar, mean)), 
                        len = unlist(lapply(bar, length)))
  batters_adjusted <- batters_adjusted %>% 
    filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
  batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
  
  # forth round
  foo <- split(batters_adjusted, f = batters_adjusted$playerID)
  bar <- lapply(foo, function(m){
    ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
  })
  checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                        m_bad = unlist(lapply(bar, mean)), 
                        len = unlist(lapply(bar, length)))
  batters_adjusted <- batters_adjusted %>% 
    filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
  batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
  
  
  ## remove tails 
  foo <- split(batters_adjusted, f = batters_adjusted$playerID)
  bar <- lapply(foo, function(m){
    bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
    bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                      ifelse(sum(tail(bad, 3)) >= 5,1,0),
                      ifelse(sum(tail(bad, 4)) >= 7,1,0),
                      ifelse(sum(tail(bad, 5)) >= 9,1,0),
                      ifelse(sum(tail(bad, 6)) >= 11,1,0)))
    1:(length(bad)-bad_tail)
  })
  batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
    foo[[j]][bar[[j]], ]
  })) %>% arrange(year)
  
  foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
  bar <- lapply(foo, function(m){
    bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
    bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                      ifelse(sum(tail(bad, 3)) >= 3,1,0),
                      ifelse(sum(tail(bad, 4)) >= 4,1,0),
                      ifelse(sum(tail(bad, 5)) >= 5,1,0),
                      ifelse(sum(tail(bad, 6)) >= 6,1,0)))
    1:(length(bad)-bad_tail)
  })
  batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
    foo[[j]][bar[[j]], ]
  })) %>% arrange(year)
  
  foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
  bar <- lapply(foo, function(m){
    bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
    bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                      ifelse(sum(tail(bad, 3)) >= 3,1,0),
                      ifelse(sum(tail(bad, 4)) >= 4,1,0),
                      ifelse(sum(tail(bad, 5)) >= 5,1,0),
                      ifelse(sum(tail(bad, 6)) >= 6,1,0)))
    1:(length(bad)-bad_tail)
  })
  batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
    foo[[j]][bar[[j]], ]
  })) %>% arrange(year)
  
  ## remove starts
  foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
  bar <- lapply(foo, function(m){
    bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
    bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                      ifelse(sum(head(bad, 2)) >= 3,1,0),
                      ifelse(sum(head(bad, 3)) >= 5,1,0),
                      ifelse(sum(head(bad, 4)) >= 7,1,0),
                      ifelse(sum(head(bad, 5)) >= 9,1,0),
                      ifelse(sum(head(bad, 6)) >= 11,1,0)))
    if (bad_head < length(bad)) {
      (bad_head + 1):length(bad)
    }
  })
  batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
    foo[[j]][bar[[j]], ]
  })) %>% arrange(year)
  
  batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)
  
  # taper down average WAR for players with small PAs
  batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
    round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
  batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
    round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	
  
  batters_adjusted <- do.call(rbind, mclapply(
    split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
    mc.cores = ncores, FUN = function(xx){
      ## natural cubic spline
      ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
      nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
      ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
      nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
      ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
      nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
      ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
      nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
      ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
      nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
      
      xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
        mutate(HR = round((adj_HR + nn_HR)/2)) %>%
        mutate(BB = round((adj_BB + nn_BB)/2)) %>%
        mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
        mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
    })) 
  
  bat_season <- batters_adjusted %>% 
    mutate(PA = adj_AB + BB + HBP + SF)
  bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
    bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB

 bat_season <- bat_season %>% 
   dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
 bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
   mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
   mutate(HR = ifelse(HR > 0, HR, 0)) %>%
   mutate(BB = ifelse(BB > 0, BB, 0)) %>%
   mutate(OBP = ifelse(OBP > 0, OBP, 0))
 
 colnames(bat_season)[5] <- 'AB'
 colnames(bat_season)[8] <- 'BA'
 bat_season_para <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
   mutate(BA = round(H / AB, 3)) %>%
   mutate(BA = ifelse(AB == 0, 0, BA)) %>%
   mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
   mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))
 
  bat_career_para <- bat_season_para %>% group_by(playerID) %>% 
    summarise(name = unique(name), 
              playerID = unique(playerID), 
              PA = sum(round(PA)), 
              AB = sum(AB), 
              H = sum(H), 
              HR = sum(round(HR)), 
              BB = sum(round(BB)), 
              BA = round(H/AB, 3), 
              HBP = sum(HBP), 
              SF = sum(SF), 
              OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
              ebWAR = sum(ebWAR), 
              efWAR = sum(efWAR)) %>% ungroup() %>% 
    arrange(desc(ebWAR))
  
  bat_career_para <- bat_career_para %>% mutate(BA = ifelse(AB == 0, 0, BA))
  bat_career_para <- bat_career_para %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))
  
```

The career results for batters uses non-parametric distribution measuring the BA with top 15 bWAR batting leaders. 
```{r echo=FALSE}
library("knitr")
kable(head(bat_career_nonpara, 15))
```

The career results for batters uses parametric distribution measuring the BA with top 15 bWAR batting leaders. 
```{r echo=FALSE}
kable(head(bat_career_para, 15))
```

# Pitchers

We apply our Full House Model to the bWAR, fWAR, SO, ERA for pitchers using the non-parametric distribution to measure the components. 


```{r echo=FALSE}
foo <- getRetrosheet(type = "game", year = 2022)
rotation_bound <- as.data.frame(cbind(years, unlist(mclapply(years, mc.cores = ncores, function(yr){
    foo <- getRetrosheet(type = "game", year = yr)
    Tms <- unique(foo$HmTm)
    
    starter <- lapply(Tms, function(tm){
      bar <- foo %>% filter(VisTm == tm | HmTm == tm) %>% 
        select(VisTm, HmTm, VisStPchID, HmStPchID, VisTmGNum, HmTmGNum)
      t(apply(bar, 1, function(xx){
        y <- NULL
        if(xx[2] == tm){
          y <- xx[4]
        }
        else{
          y <- xx[3]
        }
      })) 
    })
    
    y <- unlist(lapply(starter, function(xx){
      unlist(lapply(1:length(xx), function(j){
        flag <- TRUE
        k <- 1
        if(j > 1){
          while(flag){
            flag <- length(xx[(j-k):j]) == length(unique(xx[(j-k):j]))
            if(!flag){
              break
            }
            else{
              k <- k + 1
            }
            if(k == j){
              break
            }
          }
        }
        k
      }))
    }))
    mean(y)
    
  }))))
```


```{r cache=TRUE, echo=FALSE}
pitchers <- pit_dat %>% 
    select(playerID, yearID, name, age, lgID, teamID, IP, pops, bWAR)
  pitchers <- pitchers %>% mutate(comp = bWAR / IP)
  pitchers$comp[is.na(pitchers$comp)] = 0
  
  rotation_bound <- as.data.frame(cbind(years, unlist(mclapply(years, mc.cores = ncores, function(yr){
    foo <- getRetrosheet(type = "game", year = yr)
    Tms <- unique(foo$HmTm)
    
    starter <- lapply(Tms, function(tm){
      bar <- foo %>% filter(VisTm == tm | HmTm == tm) %>% 
        select(VisTm, HmTm, VisStPchID, HmStPchID, VisTmGNum, HmTmGNum)
      t(apply(bar, 1, function(xx){
        y <- NULL
        if(xx[2] == tm){
          y <- xx[4]
        }
        else{
          y <- xx[3]
        }
      })) 
    })
    
    y <- unlist(lapply(starter, function(xx){
      unlist(lapply(1:length(xx), function(j){
        flag <- TRUE
        k <- 1
        if(j > 1){
          while(flag){
            flag <- length(xx[(j-k):j]) == length(unique(xx[(j-k):j]))
            if(!flag){
              break
            }
            else{
              k <- k + 1
            }
            if(k == j){
              break
            }
          }
        }
        k
      }))
    }))
    mean(y)
    
  }))))
  
  unique_team <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    c(xx, nrow(unique(pitchers %>% filter(yearID == xx) %>% select(teamID))))
  }))
  
  rotation_player <- data.frame(yearID = years, rotation = ceiling(rotation_bound[,2] * unique_team[,2]))
  
  cutoff <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    m <- pitchers %>% filter(yearID == xx) %>% arrange(-IP)
    index <- rotation_player$rotation[rotation_player$yearID == xx]
    data.frame(thres = (m$IP[index]), yearID = xx)
  }))
  
  pitchers <- merge(pitchers, cutoff, by = 'yearID')
  
  pitchers <- pitchers %>% mutate(full_time = ifelse(IP >= thres, 'Y', 'N'))
  
  pitchers_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- pitchers %>% filter(yearID == xx)
    lg_avg <- sum(int$bWAR)/sum(int$IP)
    int %>% mutate(comp = (bWAR + lg_avg * 14)/(IP + 14))
  }))
  
  pitchers_talent_bWAR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
    talent_computing_nonpara(dataset = pitchers_schell, component_name = "bWAR_p", year = yy, 
                             ystar = thresh_fun(component = pitchers_schell %>% 
                                                 filter(full_time =='Y', yearID == yy) %>%
                                                 select(comp), component_name = 'bWAR_p'), alpha = 1.16)
  })) %>% arrange(-WAR_talent)
  
  no_strike <- pitchers_talent_bWAR %>% 
    filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  
  min_refbWAR <- -2
  
  t <- isoreg(no_strike$WAR_talent, no_strike$comp)
  
  talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,154)/154)
  comp_new <- as.stepfun(t)(talent_new)
  
  ystar <- thresh_fun(comp_new, component_name = 'bWAR_p')
  pop_new <- round(mean(no_strike$pops))
  component_name = 'bWAR_p'
  yy <- sort(comp_new)
  n <- length(yy)
  ytilde <- rep(0, n + 1)
  if (component_name == 'ERA') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
  }
  if (component_name == 'bWAR_p'| component_name == 'fWAR_p') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])/10
  }
  if (component_name == 'SO') {
    ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
  }
  ytilde[n+1] <- yy[n] + ystar
  ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2 
  }))
  
  career_kAB <- do.call(rbind, mclapply(1:nrow(pitchers_talent_bWAR), function(xx){
    int <- career_talent_nonpara(dataset = pitchers_talent_bWAR, component_name = 'bWAR_p', 
                         snippet = pitchers_talent_bWAR[xx,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
  ## mapping statistics
  
  mapped_quan_p <- do.call(rbind, mclapply(years, function(xx){
    pitchers_full <- pitchers %>% filter(yearID == xx) %>% 
      filter(full_time == 'Y') %>% arrange(-IP)
    pitchers_less <- pitchers %>% filter(yearID == xx) %>% 
      filter(full_time == 'N') %>% arrange(-IP)
    
    n1 <- nrow(pitchers_full)
    n2 <- nrow(pitchers_less)
    
    mapped_IP_full <- c()
    mapped_IP_less <- c()
    for (yy in c(1977:1980, 1982:1989)) {
      pitchers_ref_full <- pitchers %>% 
        filter(yearID == yy, full_time == 'Y') %>% arrange(-IP)
      pitchers_ref_less <- pitchers %>% 
        filter(yearID == yy, full_time == 'N') %>% arrange(-IP)
      n1r <- nrow(pitchers_ref_full)
      n2r <- nrow(pitchers_ref_less)
      
      mapped_IP_full <- cbind(mapped_IP_full, approx(x = seq((n1r-1),0)/(n1r-1), 
                                                     y = pitchers_ref_full$IP,
                                                     xout = seq((n1-1),0)/(n1-1))$y)
      mapped_IP_less <- cbind(mapped_IP_less, approx(x = seq((n2r-1),0)/(n2r-1), 
                                                     y = pitchers_ref_less$IP, 
                                                     xout = seq((n2-1),0)/(n2-1))$y)
    }
    
    pitchers_full$mapped_IP <- rowMeans(mapped_IP_full)
    pitchers_less$mapped_IP <- rowMeans(mapped_IP_less)
    
    m <- rbind(pitchers_full, pitchers_less)
    data.frame(playerID = m$playerID, yearID = m$yearID, 
               mapped_IP_raw = round(m$mapped_IP))
    
  }, mc.cores = ncores))
  
  mapped_pitchers_1 <- merge(career_kAB, mapped_quan_p, 
                             by = c('playerID', 'yearID'))
  
  mapped_pitchers_bWAR <- mapped_pitchers_1 %>% 
    mutate(adj_bWAR = adj_comp * mapped_IP_raw) %>%
    mutate(adj_bWAR = ifelse(adj_bWAR < min_refbWAR, min_refbWAR, adj_bWAR)) %>%
    mutate(mapped_IP_bWAR = round(adj_bWAR / adj_comp))
  
```

```{r cache=TRUE, echo=FALSE}
pitchers <- pit_dat %>% 
    select(playerID, yearID, name, age, lgID, teamID, IP, pops, fWAR)
  pitchers <- pitchers %>% mutate(comp = fWAR / IP)
  pitchers$comp[is.na(pitchers$comp)] = 0
  
  pitchers <- merge(pitchers, cutoff, by = 'yearID')
  
  pitchers <- pitchers %>% mutate(full_time = ifelse(IP >= thres, 'Y', 'N'))
  
  pitchers_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- pitchers %>% filter(yearID == xx)
    lg_avg <- sum(int$fWAR)/sum(int$IP)
    int %>% mutate(comp = (fWAR + lg_avg * 14)/(IP + 14))
  }))
  
  
  pitchers_talent_fWAR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
    talent_computing_nonpara(dataset = pitchers_schell, component_name = "fWAR_p", year = yy, 
                             ystar = thresh_fun(component = pitchers_schell %>% 
                                                 filter(full_time =='Y', yearID == yy) %>%
                                                 select(comp), component_name = 'fWAR_p'), alpha = 1.16)
  })) %>% arrange(-WAR_talent)
  
  ## rotation talent adjustment
  
  no_strike <- pitchers_talent_fWAR %>% 
    filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  min_reffWAR <- -2
  t <- isoreg(no_strike$WAR_talent, no_strike$comp)
  
  
  talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,154)/154)
  comp_new <- as.stepfun(t)(talent_new)
  
  ystar <- thresh_fun(comp_new, component_name = 'fWAR_p')
  pop_new <- round(mean(no_strike$pops))
  component_name = 'fWAR_p'
  yy <- sort(comp_new)
  n <- length(yy)
  ytilde <- rep(0, n + 1)
  if (component_name == 'ERA') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
  }
  if (component_name == 'bWAR_p'| component_name == 'fWAR_p') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])/10
  }
  if (component_name == 'SO') {
    ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
  }
  ytilde[n+1] <- yy[n] + ystar
  ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2 
  }))
  
  career_kAB <- do.call(rbind, mclapply(1:nrow(pitchers_talent_fWAR), function(xx){
    int <- career_talent_nonpara(dataset = pitchers_talent_fWAR, component_name = 'fWAR_p', 
                         snippet = pitchers_talent_fWAR[xx,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
  mapped_pitchers_1 <- merge(career_kAB, mapped_quan_p, 
                             by = c('playerID', 'yearID'))
  
  mapped_pitchers_fWAR <- mapped_pitchers_1 %>% 
    mutate(adj_fWAR = adj_comp * mapped_IP_raw) %>%
    mutate(adj_fWAR = ifelse(adj_fWAR < min_reffWAR, min_reffWAR, adj_fWAR)) %>%
    mutate(mapped_IP_fWAR = round(adj_fWAR / adj_comp))
  
  mapped_quan_p_merge <- merge(mapped_pitchers_bWAR %>% select(yearID, playerID, mapped_IP_bWAR), 
                         mapped_pitchers_fWAR %>% select(yearID, playerID, mapped_IP_fWAR), 
                         by = c('yearID', 'playerID')) 
  mapped_quan_p_merge$mapped_IP <- apply(mapped_quan_p_merge[,c(3,4)], 1, min)
  mapped_quan_p <- mapped_quan_p_merge %>% select(yearID, playerID, mapped_IP)
  
```

```{r cache=TRUE, echo=FALSE}
pitchers <- pit_dat %>% 
    select(playerID, yearID, name, age, lgID, teamID, IP, pops, SO)
  pitchers <- pitchers %>% mutate(comp = SO / IP *9)
  pitchers$comp[is.na(pitchers$comp)] = 0
  
  pitchers <- merge(pitchers, cutoff, by = 'yearID')
  
  pitchers <- pitchers %>% mutate(full_time = ifelse(IP >= thres, 'Y', 'N'))
  
  pitchers_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- pitchers %>% filter(yearID == xx)
    lg_avg <- sum(int$SO)/sum(int$IP)
    int %>% mutate(comp = (SO + lg_avg * 14)/(IP + 14) * 9)
  }))
  
  pitchers_talent_SO <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
    talent_computing_nonpara(dataset = pitchers_schell, component_name = "SO", year = yy, 
                             ystar = thresh_fun(component = pitchers_schell %>% 
                                                 filter(full_time =='Y', yearID == yy) %>%
                                                 select(comp), component_name = 'SO'), alpha = 1.16)
  })) %>% arrange(-WAR_talent)
  
  ## rotation talent adjustment
  
  no_strike <- pitchers_talent_SO %>% 
    filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  min_refSO <- min(no_strike$SO)
  t <- isoreg(no_strike$WAR_talent, no_strike$comp)
  
  talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,154)/154)
  comp_new <- as.stepfun(t)(talent_new)
  
  ystar <- thresh_fun(comp_new, component_name = 'SO')
  pop_new <- round(mean(no_strike$pops))
  component_name = 'SO'
  yy <- sort(comp_new)
  n <- length(yy)
  ytilde <- rep(0, n + 1)
  if (component_name == 'ERA') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
  }
  if (component_name == 'bWAR_p'| component_name == 'fWAR_p') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])/10
  }
  if (component_name == 'SO') {
    ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
  }
  ytilde[n+1] <- yy[n] + ystar
  ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2 
  }))
  
  career_kAB <- do.call(rbind, mclapply(1:nrow(pitchers_talent_SO), function(xx){
    int <- career_talent_nonpara(dataset = pitchers_talent_SO, component_name = 'SO', 
                         snippet = pitchers_talent_SO[xx,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
  mapped_pitchers_1 <- merge(career_kAB, mapped_quan_p, 
                             by = c('playerID', 'yearID'))
  
  mapped_pitchers_SO <- mapped_pitchers_1 %>% 
    mutate(adj_SO = adj_comp * mapped_IP / 9) %>%
    mutate(adj_SO = ifelse(adj_SO < min_refSO, min_refSO, adj_SO))
  
```

```{r cache=TRUE, echo=FALSE}
pitchers <- pit_dat %>% 
    select(playerID, yearID, name, age, lgID, teamID, IP, pops, ER)
  pitchers <- pitchers %>% mutate(comp = -9*ER / IP)
  pitchers$comp[is.na(pitchers$comp)] = 0
  
  pitchers <- merge(pitchers, cutoff, by = 'yearID')
  
  pitchers <- pitchers %>% mutate(full_time = ifelse(IP >= thres, 'Y', 'N'))
  
  pitchers_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- pitchers %>% filter(yearID == xx)
    lg_avg <- sum(int$ER)/sum(int$IP)
    int %>% mutate(comp = -9*(ER + lg_avg * 14)/(IP + 14) )
  }))
  
  pitchers_talent_ERA <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
    talent_computing_nonpara(dataset = pitchers_schell, component_name = "ERA", year = yy, 
                             ystar = thresh_fun(component = pitchers_schell %>% 
                                                 filter(full_time =='Y', yearID == yy) %>%
                                                 select(comp), component_name = 'ERA'), alpha = 1.16)
  })) %>% arrange(-WAR_talent)
  
  ## rotation talent adjustment
  
  no_strike <- pitchers_talent_ERA %>% 
    filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  min_refERA <- min(no_strike$ERA)
  
  t <- isoreg(no_strike$WAR_talent, no_strike$comp)
  
  
  talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,154)/154)
  comp_new <- as.stepfun(t)(talent_new)
  
  ystar <- thresh_fun(comp_new, component_name = 'ERA')
  pop_new <- round(mean(no_strike$pops))
  component_name = 'ERA'
  yy <- sort(comp_new)
  n <- length(yy)
  ytilde <- rep(0, n + 1)
  if (component_name == 'ERA') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
  }
  if (component_name == 'bWAR_p'| component_name == 'fWAR_p') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])/10
  }
  if (component_name == 'SO') {
    ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
  }
  ytilde[n+1] <- yy[n] + ystar
  ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2 
  }))
  
  career_kAB <- do.call(rbind, mclapply(1:nrow(pitchers_talent_ERA), function(xx){
    int <- career_talent_nonpara(dataset = pitchers_talent_ERA, component_name = 'ERA', 
                         snippet = pitchers_talent_ERA[xx,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
  mapped_pitchers_1 <- merge(career_kAB, mapped_quan_p, 
                           by = c('playerID', 'yearID'))
  
  mapped_pitchers_ERA <- mapped_pitchers_1 %>% 
    mutate(adj_ERA = ifelse(adj_comp > min_refERA, min_refERA, adj_comp))
  
```

```{r echo=FALSE}
ERA_part <- mapped_pitchers_ERA %>% 
    mutate(mapped_IP = round(mapped_IP, 1)) %>%
    mutate(adj_ERA = round(-adj_comp, 3)) %>%
    select(yearID, playerID, name, IP, mapped_IP, adj_ERA)
  SO_part <- mapped_pitchers_SO %>% 
    mutate(adj_SO = round(adj_SO))%>%
    select(yearID, playerID, SO, adj_SO)
  bWAR_part <- mapped_pitchers_bWAR %>% 
    mutate(adj_bWAR = round(adj_bWAR, 2)) %>% 
    select(yearID, playerID, adj_bWAR, full_time)
  fWAR_part <- mapped_pitchers_fWAR %>%
    mutate(adj_fWAR = round(adj_fWAR, 2)) %>% 
    select(yearID, age, playerID, adj_fWAR) 
  
  master_pitchers <- merge(ERA_part, merge(SO_part, merge(bWAR_part, fWAR_part, by = c('yearID', 'playerID')), 
                                           by = c('yearID', 'playerID')), by = c('yearID', 'playerID'))
  ## Pitchers
  pitchers <- master_pitchers %>% 
    mutate(adj_K9 = round(adj_SO/mapped_IP*9,1), 
           K9 = round(SO/IP*9,1), 
           adj_fWAR = round(adj_fWAR, 2))
  pitchers <- as.data.frame(pitchers)
  #pitchers$avg_ERA[pitchers$avg_ERA > 6.20] <- 6.20
  #pitchers <- pitchers[pitchers$adj_bWAR != 0, ]
  
  ## extract and remove bad pitchers 
  foo <- pitchers %>% 
    arrange(adj_ERA) %>% 
    filter(mapped_IP >= 100) %>% 
    dplyr::select(name, playerID, yearID, mapped_IP, adj_ERA, adj_SO, adj_fWAR, adj_bWAR)
  bar <- split(foo, as.factor(foo$playerID))
  baz <- do.call(rbind, lapply(bar, function(m){
    m[which.max(m$adj_fWAR), ]
  }))
  baz <- baz %>% arrange(adj_fWAR)
  bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
  
  baz <- do.call(rbind, lapply(bar, function(m){
    m[which.max(m$adj_bWAR), ]
  }))
  baz <- baz %>% arrange(adj_bWAR)
  bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
  bad_players <- union(bad_players_bWAR, bad_players_fWAR)
  pitchers <- pitchers[!pitchers$playerID %in% bad_players, ]
  
  
  ## build adjusted data set
  pitchers_adjusted <- pitchers %>% dplyr::select(name, playerID, age, yearID, 
                                                  mapped_IP, adj_ERA, adj_SO, adj_bWAR, adj_fWAR, full_time)
  colnames(pitchers_adjusted) <- c("name", "playerID", "age", "year", "IP", 
                                   "adj_ERA", "adj_SO", "adj_bWAR", "adj_fWAR", "full_time")
  pitchers_adjusted$playerID <- droplevels(as.factor(pitchers_adjusted$playerID))
  
  ## trim out bad players
  # first round
  foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
  bar <- lapply(foo, function(m){
    ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
  })
  checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                        m_bad = unlist(lapply(bar, mean)),
                        len = unlist(lapply(bar, length)))
  pitchers_adjusted <- pitchers_adjusted %>%
    filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
  pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)

  # second round
  foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
  bar <- lapply(foo, function(m){
    ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
  })
  checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                        m_bad = unlist(lapply(bar, mean)),
                        len = unlist(lapply(bar, length)))
  pitchers_adjusted <- pitchers_adjusted %>%
    filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
  pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)

  # third round
  foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
  bar <- lapply(foo, function(m){
    min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
  })
  checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                        m_bad = unlist(lapply(bar, mean)),
                        len = unlist(lapply(bar, length)))
  pitchers_adjusted <- pitchers_adjusted %>%
    filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
  pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)

  # forth round
  foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
  bar <- lapply(foo, function(m){
    ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
  })
  checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                        m_bad = unlist(lapply(bar, mean)),
                        len = unlist(lapply(bar, length)))
  pitchers_adjusted <- pitchers_adjusted %>%
    filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
  pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)
  
  
  ## remove tails 
  foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
  bar <- lapply(foo, function(m){
    bad <- ifelse(m$adj_bWAR <= 0.41, 1, 0) + ifelse(m$adj_fWAR <= 0.4, 1, 0)
    bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                      ifelse(sum(tail(bad, 3)) >= 5,1,0),
                      ifelse(sum(tail(bad, 4)) >= 7,1,0),
                      ifelse(sum(tail(bad, 5)) >= 9,1,0),
                      ifelse(sum(tail(bad, 6)) >= 11,1,0)))
    1:(length(bad)-bad_tail)
  })
  pitchers_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
    foo[[j]][bar[[j]], ]
  })) %>% arrange(year)
  
  foo <- split(pitchers_adjusted_1, f = pitchers_adjusted_1$playerID)
  bar <- lapply(foo, function(m){
    bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
    bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                      ifelse(sum(tail(bad, 3)) >= 3,1,0),
                      ifelse(sum(tail(bad, 4)) >= 4,1,0),
                      ifelse(sum(tail(bad, 5)) >= 5,1,0),
                      ifelse(sum(tail(bad, 6)) >= 6,1,0)))
    1:(length(bad)-bad_tail)
  })
  pitchers_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
    foo[[j]][bar[[j]], ]
  })) %>% arrange(year)
  
  foo <- split(pitchers_adjusted_2, f = pitchers_adjusted_2$playerID)
  bar <- lapply(foo, function(m){
    bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
    bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                      ifelse(sum(tail(bad, 3)) >= 3,1,0),
                      ifelse(sum(tail(bad, 4)) >= 4,1,0),
                      ifelse(sum(tail(bad, 5)) >= 5,1,0),
                      ifelse(sum(tail(bad, 6)) >= 6,1,0)))
    1:(length(bad)-bad_tail)
  })
  pitchers_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
    foo[[j]][bar[[j]], ]
  })) %>% arrange(year)
  
  ## remove starts
  foo <- split(pitchers_adjusted_3, f = pitchers_adjusted_3$playerID)
  bar <- lapply(foo, function(m){
    bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
    bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                      ifelse(sum(head(bad, 2)) >= 3,1,0),
                      ifelse(sum(head(bad, 3)) >= 5,1,0),
                      ifelse(sum(head(bad, 4)) >= 7,1,0),
                      ifelse(sum(head(bad, 5)) >= 9,1,0),
                      ifelse(sum(head(bad, 6)) >= 11,1,0)))
    if (bad_head < length(bad)) {
      (bad_head + 1):length(bad)
    }
  })
  pitchers_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
    foo[[j]][bar[[j]], ]
  })) %>% arrange(year)
  
  pitchers_adjusted_4$playerID <- droplevels(pitchers_adjusted_4$playerID)
  
  # taper down average WAR for players with small innings
  pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_fWAR <- 
    round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_fWAR/9,2)
  pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_bWAR <- 
    round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_bWAR/9,2)	
  pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                        pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_fWAR <- 
    round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                                pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_fWAR/9, 2)
  pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                        pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_bWAR <- 
    round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                                pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_bWAR/9, 2)
  
  
  pitchers_adjusted <- do.call(rbind, mclapply(
    split(pitchers_adjusted_4, f = droplevels(as.factor(pitchers_adjusted_4$playerID))), 
    mc.cores = ncores, FUN = function(xx){
      ## natural cubic spline
      ns_ERA = lm(adj_ERA ~ ns(year, df=6), data=xx)
      nn_ERA <- predict(ns_ERA, data.frame("year"= xx$year))
      ns_SO = lm(adj_SO ~ ns(year, df=6), data=xx)
      nn_SO <- predict(ns_SO, data.frame("year"= xx$year))
      ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
      nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
      ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
      nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
      
      xx %>% mutate(ERA = round((adj_ERA + nn_ERA)/2, 3)) %>% 
        mutate(SO = round((adj_SO + nn_SO)/2)) %>%
        mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
        mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
    })) 
  
  pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)
  pitchers_adjusted <- pitchers_adjusted %>% 
    mutate(ER = round(ERA * IP / 9)) %>%
    mutate(ERA = round(ER / IP *9, 2)) %>% 
    mutate(ERA = ifelse(is.na(ERA), 0, ERA))
  
  rownames(pitchers_adjusted) <- c()
  
  pit_season <- pitchers_adjusted %>% 
    mutate(IP = ceiling(IP)) %>% 
    mutate(ERA = round(ER/IP*9, 2))
  colnames(pit_season)[12] <- 'K'
  pit_season[which(pit_season$K >= 1.5*pit_season$IP), ]$K <- 
    round(1.5*pit_season[which(pit_season$K >= 1.5*pit_season$IP), ]$IP)
  
  pit_season <- pit_season %>% dplyr::select(-c(adj_bWAR, adj_fWAR, adj_ERA, adj_SO, full_time))
  
  pit_career <- pit_season %>% group_by(playerID) %>% 
    summarise(name = unique(name), 
              playerID = unique(playerID), 
              IP = sum(IP), 
              ER = sum(ER), 
              ERA = round(ER/IP*9,2), 
              K = sum(K), 
              ebWAR = sum(ebWAR), 
              efWAR = sum(efWAR)) %>% 
    arrange(desc(ebWAR))
```

The career results for pitchers with top 15 bWAR pitching leaders. 
```{r echo=FALSE}
kable(head(pit_career, 15))
```


## Table 1: Top 25 greatest baseball players from different scources. 

```{r echo=FALSE}
## bWAR
m_b <- bat_career_nonpara %>% 
  select(name, playerID, ebWAR)

m_p <- pit_career %>% 
  select(name, playerID, ebWAR)

m_ebWAR<- rbind(m_b, m_p)

index <- which(m_ebWAR$name == "Babe Ruth")
m_ebWAR$ebWAR[index[1]] <- sum(m_ebWAR$ebWAR[index])
index <- which(m_ebWAR$name == "Shohei Ohtani")
m_ebWAR$ebWAR[index[1]] <- sum(m_ebWAR$ebWAR[index])

## fWAR
m_b <- bat_career_nonpara %>% 
  select(name, playerID, efWAR)

m_p <- pit_career %>% 
  select(name, playerID, efWAR)

m_efWAR<- rbind(m_b, m_p)

index <- which(m_efWAR$name == "Babe Ruth")
m_efWAR$efWAR[index[1]] <- sum(m_efWAR$efWAR[index])
index <- which(m_efWAR$name == "Shohei Ohtani")
m_efWAR$efWAR[index[1]] <- sum(m_efWAR$efWAR[index])

bWAR <- c('Babe Ruth', 'Walter Johnson', 'Cy Young', 
          'Barry Bonds', 'Willie Mays', 'Ty Cobb', 
          'Hank Aaron', 'Roger Clements', 'Tris Speaker', 
          'Honus Wagner', 'Stan Musial', 'Rogers Hornsby', 
          'Eddie Collins', 'Ted Williams', 'Pete Alexander',
          'Alex Rodrigues', 'Kid Nichols', 'Lou Gehrig', 
          'Rickey Herderson', 'Mel Ott', 'Mickey Mantle', 
          'Tom Seaver', 'Frank Robinson', 'Nap Lajole', 
          'Mike Schmidt')

fWAR <- c('Babe Ruth', 'Barry Bonds', 'Willie Mays', 
          'Ty Cobb', 'Honus Wagner', 'Hank Aaron', 
          'Roger Clemens', 'Cy Young', 'Tris Speaker', 
          'Ted Williams', 'Rogers Hornsby', 'Stan Musial',
          'Eddie Collins', 'Walter Johnson', 'Greg Maddux',
          'Lou Gehrig', 'Alex Rodriguez', 'Mickey Mantle', 
          'Mel Ott', 'Randy Johnson', 'Nolan Ryan', 
          'Mike Schmidt', 'Rickey Henderson', 
          'Frank Robinson', 'Bert Blyleven')

ESPN <- c('Babe Ruth', 'Willie Mays', 'Hank Aaron', 
          'Ty Cobb', 'Ted Williams', 'Lou Gehrig', 
          'Mickey Mantle', 'Barry Bonds', 'Walter Johnson',
          'Stan Musial', 'Pedro Martinez', 'Honus Wagner',
          'Ken Griffey Jr.', 'Greg Maddux', 'Mike Trout',
          'Joe DiMaggio', 'Roger Clemens', 'Mike Schmidt',
          'Frank Robinson', 'Rogeres Hornsby', 'Cy Young',
          'Tom Seaver', 'Rickey Henderson', 'Randy Johnson',
          'Christy Mathewson')

HOS <- c('Babe Ruth', 'Barry Bonds', 'Walter Johnson', 
         'Willie Mays', 'Cy Young', 'Ty Cobb', 
         'Hank Aaron', 'Roger Clemens', 'Rogers Hornsby',
         'Houns Wagner', 'Tris Speaker', 'Ted Williams',
         'Stan Musial', 'Eddie Collins', 'Pete Alexander',
         'Alex Rodriguez', 'Lou Gehrig', 'Mickey Mantle',
         'Lefty Grove', 'Mel Ott', 'Rickey Henderson', 
         'Kid Nichols', 'Mike Schmidt', 'Nap Lajoie',
         'Christy Mathewson')

WAR_rankings <- cbind((m_ebWAR%>% arrange(desc(ebWAR)))$name[1:25], (m_efWAR%>% arrange(desc(efWAR)))$name[1:25], bWAR, fWAR, ESPN, HOS)

colnames(WAR_rankings) <- c('ebWAR', 'efWAR', 'bWAR', 'fWAR', 'ESPN', 'Hall of Stats')

## pre-1950 in top 10
WAR_rankings <- rbind(WAR_rankings, c(3,3,6,6,6,6))

## pre-1950 in top 25
WAR_rankings <- rbind(WAR_rankings, c(8,8,15,12,11,17))

## proportion before 1950

WAR_rankings <- rbind(WAR_rankings, rep(0.292,6))

## chances of observing old era players in top 10

chance_10 <- round(c(1 / (1 - pbinom(as.numeric(WAR_rankings[26,1])-1, 10, as.numeric(WAR_rankings[28,1]))), 1 / (1 - pbinom(as.numeric(WAR_rankings[26,2])-1, 10, as.numeric(WAR_rankings[28,2]))), 1 / (1 - pbinom(as.numeric(WAR_rankings[26,3])-1, 10, as.numeric(WAR_rankings[28,3]))), 1 / (1 - pbinom(as.numeric(WAR_rankings[26,4])-1, 10, as.numeric(WAR_rankings[28,4]))), 1 / (1 - pbinom(as.numeric(WAR_rankings[26,5])-1, 10, as.numeric(WAR_rankings[28,5]))), 1 / (1 - pbinom(as.numeric(WAR_rankings[26,6])-1, 10, as.numeric(WAR_rankings[28,6])))), 2)

## chances of observing old era players in top 25

chance_25 <- round(c(1 / (1 - pbinom(as.numeric(WAR_rankings[27,1])-1, 25, as.numeric(WAR_rankings[28,1]))), 1 / (1 - pbinom(as.numeric(WAR_rankings[27,2])-1, 25, as.numeric(WAR_rankings[28,2]))), 1 / (1 - pbinom(as.numeric(WAR_rankings[27,3])-1, 25, as.numeric(WAR_rankings[28,3]))), 1 / (1 - pbinom(as.numeric(WAR_rankings[27,4])-1, 25, as.numeric(WAR_rankings[28,4]))), 1 / (1 - pbinom(as.numeric(WAR_rankings[27,5])-1, 25, as.numeric(WAR_rankings[28,5]))), 1 / (1 - pbinom(as.numeric(WAR_rankings[27,6])-1, 25, as.numeric(WAR_rankings[28,6])))), 2)


row_name <- data.frame(rank = c(seq(1,25), 'pre-1950 in top 10', 'pre-1950 in top 25', 'proportion before 1950', 'chance in top 10', 'chance in top 10'))

kable(cbind(row_name, rbind(WAR_rankings, sapply(chance_10, function(x) paste('1 in', x)), sapply(chance_25, function(x) paste('1 in', x)))))

```


## Table 2: BA rankings from different sources in the paper.

```{r echo=FALSE}
foo <- mapped_batters_AVG_nonpara %>% filter(AB >= 500)
foo$playerID <- droplevels(as.factor(foo$playerID))
bar <- split(foo, f = foo$playerID)
baz <- (do.call(rbind, mclapply(bar, mc.cores = ncores, function(xx){
  xx[which.max(xx$WAR_talent), ]
})) %>% arrange(-WAR_talent))

rookie_year <- master_batters_nonpara %>% group_by(playerID) %>% 
  summarise(rookie_year = min(yearID))

m <- merge(baz, rookie_year, by = c('playerID'))

peak_fullhouse <- (m %>% filter(rookie_year <= 2011) %>% 
arrange(-WAR_talent))

batcar_year <- merge(bat_career_nonpara, rookie_year, by = 'playerID')

career_fullhouse <- (batcar_year %>% 
                       filter(AB >= 3000, rookie_year <= 2011) %>% 
  arrange(desc(BA)))

raw_career <- data.frame(name = c('Ty Cobb',  
'Rogers Hornsby', 'Shoeless Joe Jackson',  
"Lefty O'Doul", "Ed Delahanty", "Tris Speaker", 
"Bill Hamilton", "Ted Williams", "Dan Brouthers", "Babe Ruth", 
"Dave Orr", "Harry Heilmann","Pete Browning", "Willie Keeler", 
"Bill Terry", "Lou Gehrig", "George Sisler",  
"Jesse Burkett", "Tony Gwynn", "Nap Lajoie", "Jake Stenzel", 
"Riggs Stephenson", "Al Simmons", "Cap Anson", "John McGraw"
))

Schell_career_1 <- data.frame(name = c("Tony Gwynn", "Ty Cobb", 
"Rod Carew", "Shoeless Joe Jackson", "Rogers Hornsby","Ted Williams",
"Honus Wagner", "Stan Musial", "Wade Boggs", "Nap Lajoie", 
"Tris Speaker", "Pete Browning", "Willie Mays", "Dan Brouthers", "Kirby Puckett",
"Babe Ruth", "Tip O'Neill", "Willie Keeler", "Joe DiMaggio", "Tony Oliva", "Jesse Burkett", 
"Eddie Collins", "George Sisler", "Lou Gehrig", "Don Mattingly"))

Schell_career_2 <- data.frame(name = c("Tony Gwynn", "Ty Cobb", 
"Rod Carew", "Rogers Hornsby", "Stan Musial", "Nap Lajoie", 
"Shoeless Joe Jackson", "Honus Wagner", "Ted Williams", 
"Wade Boggs", "Pete Browning", "Tris Speaker", "Mike Piazza", 
"Dan Brouthers", "Tip O'Neill", "Kirby Puckett", "Tony Oliva", 
"Vladimir Guerrero", "Mike Donlin", "Willie Keeler", "Edgar Martinez", "Henry Aaron", "Derek Aaron", "Joe DiMaggio", "Babe Ruth"))

Era_bridging <- data.frame(name = c('Ty Cobb', 'Tony Gwynn', 'Ted Williams', 'Wade Boggs', 'Rod Carew', 'Shoeless Jos Jackson', 'Nap Lajoie', 'Stan Musial', 'Frank Thomas', 'Ed Delahanty', 'Tris Speaker', 'Rogers Hornsby', 'Hank Aaron', 'Alex Rodriguez', 'Pete Rose', 'Honus Wagner', 'Roberto Clements', 'George Brett', 'Don Mattingsly', 'Kirby Puckett', 'Mike Piazza', 'Eddie Collins', 'Edgar Martinez', 'Paul Molitor', 'Willie Mays'))

combined_AVG <- cbind(peak_fullhouse$name[1:25], career_fullhouse$name[1:25], Schell_career_1, Schell_career_2, Era_bridging, raw_career)

colnames(combined_AVG) <- c('Peak in Full House', 'Career in Full House', 'Schell Method 1', 'Schell Method 2', 'Era-bridging Method', 'Raw Career')

## pre-1950 in top 10
combined_AVG <- rbind(combined_AVG, c(1,3,7,7,6,10))

## pre-1950 in top 25
combined_AVG <- rbind(combined_AVG, c(2,6,18,15,10,24))

## proportion before 1950

combined_AVG <- rbind(combined_AVG, c(0.250, 0.250, 0.408, 0.334, 0.326, 0.250))

## MLB-eligible population range

combined_AVG <- rbind(combined_AVG, c('1871-2011', '1871-2011', '1876-1984', '1876-1997', '1901-1996', '1871-2011'))

## chances of observing old era batters in top 10

chance_10 <- round(c(1 / (1 - pbinom(as.numeric(combined_AVG[26,1])-1, 10, as.numeric(combined_AVG[28,1]))), 1 / (1 - pbinom(as.numeric(combined_AVG[26,2])-1, 10, as.numeric(combined_AVG[28,2]))), 1 / (1 - pbinom(as.numeric(combined_AVG[26,3])-1, 10, as.numeric(combined_AVG[28,3]))), 1 / (1 - pbinom(as.numeric(combined_AVG[26,4])-1, 10, as.numeric(combined_AVG[28,4]))), 1 / (1 - pbinom(as.numeric(combined_AVG[26,5])-1, 10, as.numeric(combined_AVG[28,5]))), 1 / (1 - pbinom(as.numeric(combined_AVG[26,6])-1, 10, as.numeric(combined_AVG[28,6])))), 2)


## chances of observing old era batters in top 25

chance_25 <- round(c(1 / (1 - pbinom(as.numeric(combined_AVG[27,1])-1, 25, as.numeric(combined_AVG[28,1]))), 1 / (1 - pbinom(as.numeric(combined_AVG[27,2])-1, 25, as.numeric(combined_AVG[28,2]))), 1 / (1 - pbinom(as.numeric(combined_AVG[27,3])-1, 25, as.numeric(combined_AVG[28,3]))), 1 / (1 - pbinom(as.numeric(combined_AVG[27,4])-1, 25, as.numeric(combined_AVG[28,4]))), 1 / (1 - pbinom(as.numeric(combined_AVG[27,5])-1, 25, as.numeric(combined_AVG[28,5]))), 1 / (1 - pbinom(as.numeric(combined_AVG[27,6])-1, 25, as.numeric(combined_AVG[28,6])))), 2)

row_name <- data.frame(rank = c(seq(1,25), 'pre-1950 in top 10', 'pre-1950 in top 25', 'proportion before 1950', 'MLB-eligible population', 'chance in top 10', 'chance in top 10'))

knitr::kable(cbind(row_name, rbind(combined_AVG, sapply(chance_10, function(x) paste('1 in', x)), sapply(chance_25, function(x) paste('1 in', x)))))

```

## Table 3: HR rankings from different sources in the paper.

```{r echo=FALSE}
bar <- bat_season_nonpara %>%
  filter(AB >= 500) %>% mutate(ABpHR = AB / HR) %>%
  group_by(playerID) %>%
  summarise(name = unique(name), ABpHR = min(ABpHR)) %>%
  arrange(ABpHR) %>% head(25) %>% left_join(rookie_year)

career_fullhouse_HR_AB <- batcar_year %>% mutate(HR_AB = HR / AB) %>%
  filter(rookie_year <= 2005, AB >= 3000) %>% left_join(rookie_year) %>% 
  arrange(desc(HR_AB))

Era_bridging_HR <- data.frame(name = c('Mark McGwire', 'Juan Gonzalez', 'Babe Ruth', 'Dave Kingman', 'Mike Schmidt', 'Harmon Killebrew', 'Frank Thomas', 'Jose Canseco', 'Ron Kittle', 'Willie Stargell', 'Willie McCovey', 'Darryl Strawberry', 'Bo Jackson', 'Ted Williams', 'Ralph Kiner', 'Pat Seerey', 'Reggie Jackson', 'Ken Griffey', 'Albert Belle', 'Dick Allen', 'Barry Bonds', 'Dean Palmer', 'Hank Aaron', 'Jimmie Foxx', 'Mike Piazza'))

PPS_1 <- data.frame(name = c("Babe Ruth", "Mel Ott", "Lou Gehrig", 
"Jimmie Foxx", "Hank Aaron", "Rogers Hornsby", "Cy Williams", 
"Barry Bonds", "Willie Mays", "Ted Williams", "Reggie Jackson", 
"Mike Schmidt", "Frank Robinson", "Harmon Killebrew", "Gavvy Cravath", 
"Honus Wagner", "Willie McCovey", "Harry Stovey", "Ken Griffey Jr.", 
"Stan Musial", "Willie Stargell", "Eddie Murray", "Mark McGwire", 
"Mickey Mantle", "Al Simmons"))

raw_AB_HR <- data.frame(name = c("Mark McGwire", "Babe Ruth", 
"Barry Bonds", "Jim Thome", "Giancarlo Stanton", "Ralph Kiner", 
"Harmon Killebrew", "Sammy Sosa", "Ted Williams", "Manny Ramirez", 
"Mike Trout", "Adam Dunn", "Ryan Howard", "Juan Gonzalez", 
"Dave Kingman", "Russell Branyan", "Mickey Mantle", "Alex Rodriguez", 
"Jimmie Foxx", "Mike Schmidt", "Jose Canseco", "Albert Belle", 
"Khris Davis", "Ron Kittle", "Carlos Delgado"))

Schell_career_HR_AB <- data.frame(name = c("Babe Ruth", "Mark McGwire", 
"Ted Williams", "Barry Bonds", "Mike Schmidt", "Lou Gehrig", 
"Harmon Killebrew", "Jimmie Foxx", "Dave Kingman", "Reggic Jackson", 
"Bill Nicholson", "Mickey Mantle", "Ralph Kiner", "Joe DiMaggio", 
"Willie Stargell", "Hack Wilson", "Rogers Hornsby", "Darryl Strawberry", 
"Willie McCovey", "Glenn Davis", "Wally Berger", "Eddie Mathews", 
"Harry Stovey", "Frank Howard", "Mel Ott"))

Schell_peak_HR_AB <- c('Barry Bonds', 'Babe Ruth', 'Mark McGwire',
'Buck Frecman', 'Ed Delahanty', 'Tim Jordan','Willie Stargell', 
'Rogers Hornsby','Jim Thome','Dave Kingman','Roy Sievers',
'Jeff Bagwell','Ted Williams','Kevin Mitchell','Mike Schmidt','Lou Gehrig', 
'Fred Dunlap','Harry Stovey','Charlie Hickman', 'Bill Nicholson',
'Boog Powell', 'Joe DiMaggio', 'Eddie Mathews', 'Mickey Mantle', 
'Tris Speaker')

combined_HR <- cbind(bar$name[1:25], career_fullhouse_HR_AB$name[1:25], Era_bridging_HR, PPS_1, Schell_peak_HR_AB, Schell_career_HR_AB, raw_AB_HR)

colnames(combined_HR) <- c('Peak in Full House', 'Career in Full House', 'Era-bridging Method', 'PPS detrending method', 'Peak in Schell', 'Career in Schell', 'Raw AB per HR')

## pre-1950 in top 10
combined_HR <- rbind(combined_HR, c(1,2,1,7,5,4,3))

## pre-1950 in top 25
combined_HR <- rbind(combined_HR, c(6,6,5,12,13,12,4))

## proportion before 1950

combined_HR <- rbind(combined_HR, 
                c(0.212, 0.292, 0.326, 0.355, 0.284, 0.381, 0.292))

## MLB-eligible population range

combined_HR <- rbind(combined_HR, c('1871-2021', '1871-2005', '1901-1996', '1871-1993', '1876-2003', '1876-1988', '1871-2005'))


## chances of observing old era players in top 10

chance_10 <- round(c(1 / (1 - pbinom(as.numeric(combined_HR[26,1])-1, 10, as.numeric(combined_HR[28,1]))), 1 / (1 - pbinom(as.numeric(combined_HR[26,2])-1, 10, as.numeric(combined_HR[28,2]))), 1 / (1 - pbinom(as.numeric(combined_HR[26,3])-1, 10, as.numeric(combined_HR[28,3]))), 1 / (1 - pbinom(as.numeric(combined_HR[26,4])-1, 10, as.numeric(combined_HR[28,4]))), 1 / (1 - pbinom(as.numeric(combined_HR[26,5])-1, 10, as.numeric(combined_HR[28,5]))), 1 / (1 - pbinom(as.numeric(combined_HR[26,6])-1, 10, as.numeric(combined_HR[28,6]))), 1 / (1 - pbinom(as.numeric(combined_HR[26,7])-1, 10, as.numeric(combined_HR[28,7])))), 2)

## chances of observing old era players in top 25

chance_25 <- round(c(1 / (1 - pbinom(as.numeric(combined_HR[27,1])-1, 25, as.numeric(combined_HR[28,1]))), 1 / (1 - pbinom(as.numeric(combined_HR[27,2])-1, 25, as.numeric(combined_HR[28,2]))), 1 / (1 - pbinom(as.numeric(combined_HR[27,3])-1, 25, as.numeric(combined_HR[28,3]))), 1 / (1 - pbinom(as.numeric(combined_HR[27,4])-1, 25, as.numeric(combined_HR[28,4]))), 1 / (1 - pbinom(as.numeric(combined_HR[27,5])-1, 25, as.numeric(combined_HR[28,5]))), 1 / (1 - pbinom(as.numeric(combined_HR[27,6])-1, 25, as.numeric(combined_HR[28,6]))), 1 / (1 - pbinom(as.numeric(combined_HR[26,7])-1, 25, as.numeric(combined_HR[28,7])))), 2)

row_name <- data.frame(rank = c(seq(1,25), 'pre-1950 in top 10', 'pre-1950 in top 25', 'proportion before 1950', 'MLB-eligible population', 'chance in top 10', 'chance in top 10'))

kable(cbind(row_name, rbind(combined_HR, sapply(chance_10, function(x) paste('1 in', x)), sapply(chance_25, function(x) paste('1 in', x)))))

```

## Table 1: OBP rankings from different sources in the Supplementary materials.

```{r echo=FALSE}
OBP_fullhouse <- (batcar_year %>% 
                    filter(PA >= 3000, rookie_year <= 2011) %>%
  arrange(desc(OBP)))

raw_career_OBP <- data.frame(name = c("Ted Williams", "Babe Ruth", 
"John McGraw", "Billy Hamilton", "Oscar Charleston", "Lou Gehrig", 
"Barry Bonds", "Jud Wilson", "Bill Joyce", "Rogers Hornsby", 
"Ty Cobb", "Jimmie Foxx", "Tris Speaker", "Eddie Collins", 
"Ferris Fain", "Dan Brouthers", "Max Bishop", "Shoeless Joe Jackson", 
"Mickey Mantle", "Mickey Cochrane", "Frank Thomas", "Mike Trout", 
"Edgar Martinez", "Turkey Stearnes", "Stan Musial"))

Schell_career_OBP <- data.frame(name = c("Ted Williams", "Babe Ruth", 
"Rogers Hornsby", "Barry Bonds", "John McGraw", "Billy Hamilton", 
"Topsy Hartsel", "Mel Ott", "Roy Thomas", "Mickey Mantle", 
"Wade Boggs", "Frank Thomas", "Lou Gehrig", "Rickey Henderson", 
"Stan Musial", "Edgar Martinez", "Ty Cobb", "Dan Brouthers", 
"Tris Speaker", "Joe Cunningham", "George Gore", "Eddie Collins", 
"Ross Youngs", "Mike Hargrove", "Jeff Bagwell"))

combined_OBP <- cbind(OBP_fullhouse$name[1:25], Schell_career_OBP, raw_career_OBP)

colnames(combined_OBP) <- c('Career Full House', 'Schell Method', 'Raw Career')

## pre-1950 in top 10
combined_OBP <- rbind(combined_OBP, c(3,8,9))

## pre-1950 in top 25
combined_OBP <- rbind(combined_OBP, c(3,16,19))

## proportion before 1950

combined_OBP <- rbind(combined_OBP, c(0.250, 0.354, 0.250))

## MLB-eligible population range

combined_OBP <- rbind(combined_OBP, c('1871-2011', '1876-1993', '1871-2011'))

## chances of observing old era batters in top 10

chance_10 <- round(c(1 / (1 - pbinom(as.numeric(combined_OBP[26,1])-1, 10, as.numeric(combined_OBP[28,1]))), 1 / (1 - pbinom(as.numeric(combined_OBP[26,2])-1, 10, as.numeric(combined_OBP[28,2]))), 1 / (1 - pbinom(as.numeric(combined_OBP[26,3])-1, 10, as.numeric(combined_OBP[28,3])))), 2)

## chances of observing old era batters in top 25

chance_25 <- round(c(1 / (1 - pbinom(as.numeric(combined_OBP[27,1])-1, 25, as.numeric(combined_OBP[28,1]))), 1 / (1 - pbinom(as.numeric(combined_OBP[27,2])-1, 25, as.numeric(combined_OBP[28,2]))), 1 / (1 - pbinom(as.numeric(combined_OBP[27,3])-1, 25, as.numeric(combined_OBP[28,3])))), 2)

row_name <- data.frame(rank = c(seq(1,25), 'pre-1950 in top 10', 'pre-1950 in top 25', 'proportion before 1950', 'MLB-eligible population', 'chance in top 10', 'chance in top 10'))

kable(cbind(row_name, rbind(combined_OBP, sapply(chance_10, function(x) paste('1 in', x)), sapply(chance_25, function(x) paste('1 in', x)))))

```

## Table 2: MLB-eligible population throughout the years in the Supplementary materials.

```{r echo=FALSE}
MLBpops <- bat_dat %>% group_by(yearID, lgID) %>% summarise(pops = unique(pops))
MLBpops_long <- MLBpops %>% pivot_wider(names_from = lgID, values_from = pops)
MLBpops_long[MLBpops_long$yearID <= 1900, ]$AL <- MLBpops_long[MLBpops_long$yearID <= 1900, ]$NL
m <- data.frame(year = MLBpops_long$yearID, population = apply(MLBpops_long[,2:3], 1, mean) / 1e6)
m <- rbind(c(1870, 0.240569*2-0.253847), m)

n <- m[m$year %in% seq(1870, 2020, 10),]

o <- n %>% mutate(population = round(population, 2)) %>% 
  mutate(cpp = round(cumsum(population)/(sum(population)), 3))
kable(o)
```

## Table 3: percent of seasons in which BA failed the Shapiro-Wilk test based on different p-value thresholds in the Supplementary materials.

```{r echo=FALSE}
batters <- bat_dat
batters <- merge(batters, cutoff, by = 'yearID')
batters <- batters %>% select(playerID, yearID, name, AB, PA, H, thres) %>%
  mutate(comp = ifelse(AB != 0, H / AB, 0), full_time = ifelse(PA >= thres, 'Y', 'N'))
batters_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- batters %>% filter(yearID == xx)
    lg_avg <- sum(int$H)/sum(int$AB)
    int %>% mutate(comp = (H + lg_avg * 25)/(AB + 25))
  }))
normality <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
  m <- batters_schell %>% filter(yearID == xx, full_time == 'Y')
  return(data.frame(yearID = xx, p_value = shapiro.test(m$comp)$p.value))
}))

foo <- data.frame(p_value = c(0.05, 0.1, 0.2, 0.3), 
                  number_season = sapply(c(0.05, 0.1, 0.2, 0.3), function(x) round(sum(normality[,2] < x)/152, 2)))
kable(foo)
```

```{r echo=FALSE}
ggplot(normality, aes(x=p_value)) + geom_histogram(binwidth=0.02, aes(y=..density..)) +
 geom_density() 
```

```{r echo=FALSE}
Ty_Cobb_1911_para <- mapped_batters_AVG_para %>% filter(yearID == 1911, playerID == 'cobbty01') %>% select(adj_AVG)
Ty_Cobb_1911_nonpara <- mapped_batters_AVG_nonpara %>% filter(yearID == 1911, playerID == 'cobbty01') %>% select(adj_AVG)
Tony_Gwynn_1997_para <- mapped_batters_AVG_para %>% filter(yearID == 1997, playerID == 'gwynnto01') %>% select(adj_AVG)
Tony_Gwynn_1997_nonpara <- mapped_batters_AVG_nonpara %>% filter(yearID == 1997, playerID == 'gwynnto01') %>% select(adj_AVG)

res <- data.frame(para = c(Ty_Cobb_1911_para[1,1], Tony_Gwynn_1997_para[1,1]), 
                  nonpara = c(Ty_Cobb_1911_nonpara[1,1], Tony_Gwynn_1997_nonpara[1,1]))
rownames(res) <- c('Ty_cobb_1911', 'Tony_Gwynn_1977')

```

## Table 4: Top 25 BA, OBP and HR leaders in the Supplementary materials.

```{r echo=FALSE}
rookie_year <- master_batters_nonpara %>% group_by(playerID) %>% 
  summarise(rookie_year = min(yearID))
batcar_year <- merge(bat_career_nonpara, rookie_year, by = 'playerID')
rownames(batcar_year) <- c()

zz_BA <- (batcar_year %>% arrange(desc(BA)) %>% 
             filter(AB >= 3000, rookie_year <= 2011) %>%
  select(name, BA))[1:25,]
zz_OBP <- (batcar_year %>% arrange(desc(OBP)) %>% 
             filter(AB >= 3000, rookie_year <= 2011) %>%
         select(name, OBP))[1:25,]
zz_HR <- (batcar_year %>% arrange(desc(HR))  %>% 
            filter(rookie_year <= 2005) %>%
         select(name, HR))[1:25,]

BA_OBP_HR <- cbind(zz_BA, zz_OBP, zz_HR)
colnames(BA_OBP_HR) <- c('name', 'BA', 'name', 'OBP', 'name', 'HR')

## pre-1950 in top 10
BA_OBP_HR <- rbind(BA_OBP_HR, c(3, '', 3, '', 1, ''))

## pre-1950 in top 25
BA_OBP_HR <- rbind(BA_OBP_HR, c(6, '', 3, '', 5, ''))

## proportion before 1950

BA_OBP_HR <- rbind(BA_OBP_HR, c(0.250, '', 0.250, '', 0.292, ''))

## MLB-eligible population range

BA_OBP_HR <- rbind(BA_OBP_HR, c('1871-2011','', '1871-2011','', '1871-2005',''))

## chances of observing old era batters in top 10

chance_10 <- c(paste('1 in', round(1 / (1 - pbinom(as.numeric(BA_OBP_HR[26,1])-1, 10, as.numeric(BA_OBP_HR[28,1]))), 2)), '', paste('1 in', round(1 / (1 - pbinom(as.numeric(BA_OBP_HR[26,3])-1, 10, as.numeric(BA_OBP_HR[28,3]))), 2)), '', paste('1 in', round(1 / (1 - pbinom(as.numeric(BA_OBP_HR[26,5])-1, 10, as.numeric(BA_OBP_HR[28,5]))), 2)), '')

## chances of observing old era batters in top 25

chance_25 <- c(paste('1 in', round(1 / (1 - pbinom(as.numeric(BA_OBP_HR[27,1])-1, 25, as.numeric(BA_OBP_HR[28,1]))), 2)), '', paste('1 in', round(1 / (1 - pbinom(as.numeric(BA_OBP_HR[27,3])-1, 25, as.numeric(BA_OBP_HR[28,3]))), 2)), '', paste('1 in', round(1 / (1 - pbinom(as.numeric(BA_OBP_HR[27,5])-1, 25, as.numeric(BA_OBP_HR[28,5]))), 2)),'')

row_name <- data.frame(rank = c(seq(1,25), 'pre-1950 in top 10', 'pre-1950 in top 25', 'proportion before 1950', 'MLB-eligible population', 'chance in top 10', 'chance in top 10'))

knitr::kable(cbind(row_name, rbind(BA_OBP_HR, chance_10, chance_25)))

```

## Table 5: Top 25 bWAR and fWAR leaders for MLB batters in the Supplementary materials.

```{r echo=FALSE}
zz_bWAR <- (batcar_year %>% arrange(desc(ebWAR))  %>%
              filter(rookie_year <= 2005) %>%
         select(name, ebWAR))[1:25,]
zz_fWAR <- (batcar_year %>% arrange(desc(efWAR))  %>%
              filter(rookie_year <= 2005) %>%
         select(name, efWAR))[1:25,]

ebWAR_efWAR_b <- cbind(zz_bWAR, zz_fWAR)
colnames(ebWAR_efWAR_b) <- c('name', 'ebWAR', 'name', 'efWAR')

## pre-1950 in top 10
ebWAR_efWAR_b <- rbind(ebWAR_efWAR_b, c(4, '', 4, ''))

## pre-1950 in top 25
ebWAR_efWAR_b <- rbind(ebWAR_efWAR_b, c(9, '', 9, ''))

## proportion before 1950

ebWAR_efWAR_b <- rbind(ebWAR_efWAR_b, c(0.292, '', 0.292, ''))

## chances of observing old era batters in top 10

chance_10 <- c(paste('1 in', round(1 / (1 - pbinom(as.numeric(ebWAR_efWAR_b[26,1])-1, 10, as.numeric(ebWAR_efWAR_b[28,1]))), 2)), '', paste('1 in', round(1 / (1 - pbinom(as.numeric(ebWAR_efWAR_b[26,3])-1, 10, as.numeric(ebWAR_efWAR_b[28,3]))), 2)), '')

## chances of observing old era batters in top 25

chance_25 <- c(paste('1 in', round(1 / (1 - pbinom(as.numeric(ebWAR_efWAR_b[27,1])-1, 25, as.numeric(ebWAR_efWAR_b[28,1]))), 2)), '', paste('1 in', round(1 / (1 - pbinom(as.numeric(ebWAR_efWAR_b[27,3])-1, 25, as.numeric(ebWAR_efWAR_b[28,3]))), 2)), '')

row_name <- data.frame(rank = c(seq(1,25), 'pre-1950 in top 10', 'pre-1950 in top 25', 'proportion before 1950', 'chance in top 10', 'chance in top 10'))

kable(cbind(row_name, rbind(ebWAR_efWAR_b, chance_10, chance_25)))

```

## Table 6: Top 25 IP, ERA, SO leaders in the Supplementary materials.

```{r echo=FALSE}
rookie_year <- master_pitchers %>% group_by(playerID) %>% 
  summarise(rookie_year = min(yearID))
pitcar_year <- merge(pit_career, rookie_year, by = 'playerID')

zz_IP <- (pitcar_year %>% arrange(desc(IP)) %>%
            filter(rookie_year <= 2005) %>%
             select(name,IP))[1:25,]
zz_ERA <- (pitcar_year %>% arrange(ERA) %>% filter(IP >= 1500) %>% filter(rookie_year <= 2011) %>%
         select(name,ERA))[1:25,]
zz_K <- (pitcar_year %>% arrange(desc(K)) %>%
           filter(rookie_year <= 2005) %>%
         select(name, K))[1:25,]

IP_ERA_K <- cbind(zz_IP, zz_ERA, zz_K)
colnames(IP_ERA_K) <- c('name', 'IP', 'name', 'ERA', 'name', 'SO')

## pre-1950 in top 10
IP_ERA_K <- rbind(IP_ERA_K, c(1, '', 1, '', 1, ''))

## pre-1950 in top 25
IP_ERA_K <- rbind(IP_ERA_K, c(6, '', 3, '', 4, ''))

## proportion before 1950

IP_ERA_K <- rbind(IP_ERA_K, c(0.292, '', 0.250, '', 0.292, ''))

## MLB-eligible population range

IP_ERA_K <- rbind(IP_ERA_K, c('1871-2005','', '1871-2011','', '1871-2005',''))

## chances of observing old era pitchers in top 10

chance_10 <- c(paste('1 in', round(1 / (1 - pbinom(as.numeric(IP_ERA_K[26,1])-1, 10, as.numeric(IP_ERA_K[28,1]))), 2)), '', paste('1 in', round(1 / (1 - pbinom(as.numeric(IP_ERA_K[26,3])-1, 10, as.numeric(IP_ERA_K[28,3]))), 2)), '', paste('1 in', round(1 / (1 - pbinom(as.numeric(IP_ERA_K[26,5])-1, 10, as.numeric(IP_ERA_K[28,5]))), 2)), '')

## chances of observing old era pitchers in top 25

chance_25 <- c(paste('1 in', round(1 / (1 - pbinom(as.numeric(IP_ERA_K[27,1])-1, 25, as.numeric(IP_ERA_K[28,1]))), 2)), '', paste('1 in', round(1 / (1 - pbinom(as.numeric(IP_ERA_K[27,3])-1, 25, as.numeric(IP_ERA_K[28,3]))), 2)), '', paste('1 in', round(1 / (1 - pbinom(as.numeric(IP_ERA_K[27,5])-1, 25, as.numeric(IP_ERA_K[28,5]))), 2)),'')

row_name <- data.frame(rank = c(seq(1,25), 'pre-1950 in top 10', 'pre-1950 in top 25', 'proportion before 1950', 'MLB-eligible population', 'chance in top 10', 'chance in top 10'))

kable(cbind(row_name, rbind(IP_ERA_K, chance_10, chance_25)))
```

## Table 7: Top 25 bWAR and fWAR leaders for MLB pitchers in the Supplementary materials.

```{r echo=FALSE}
zz_bWAR <- (pitcar_year %>% arrange(desc(ebWAR))  %>%
              filter(rookie_year <= 2005) %>%
         select(name, ebWAR))[1:25,]
zz_fWAR <- (pitcar_year %>% arrange(desc(efWAR))  %>%
              filter(rookie_year <= 2005) %>%
         select(name, efWAR))[1:25,]

ebWAR_efWAR_p <- cbind(zz_bWAR, zz_fWAR)
colnames(ebWAR_efWAR_p) <- c('name', 'ebWAR', 'name', 'efWAR')

## pre-1950 in top 10
ebWAR_efWAR_p <- rbind(ebWAR_efWAR_p, c(2, '', 2, ''))

## pre-1950 in top 25
ebWAR_efWAR_p <- rbind(ebWAR_efWAR_p, c(4, '', 4, ''))

## proportion before 1950

ebWAR_efWAR_p <- rbind(ebWAR_efWAR_p, c(0.292, '', 0.292, ''))

## chances of observing old era pitchers in top 10

chance_10 <- c(paste('1 in', round(1 / (1 - pbinom(as.numeric(ebWAR_efWAR_p[26,1])-1, 10, as.numeric(ebWAR_efWAR_p[28,1]))), 2)), '', paste('1 in', round(1 / (1 - pbinom(as.numeric(ebWAR_efWAR_p[26,3])-1, 10, as.numeric(ebWAR_efWAR_p[28,3]))), 2)), '')

## chances of observing old era pitchers in top 25

chance_25 <- c(paste('1 in', round(1 / (1 - pbinom(as.numeric(ebWAR_efWAR_p[27,1])-1, 25, as.numeric(ebWAR_efWAR_p[28,1]))), 2)), '', paste('1 in', round(1 / (1 - pbinom(as.numeric(ebWAR_efWAR_p[27,3])-1, 25, as.numeric(ebWAR_efWAR_p[28,3]))), 2)), '')

row_name <- data.frame(rank = c(seq(1,25), 'pre-1950 in top 10', 'pre-1950 in top 25', 'proportion before 1950', 'chance in top 10', 'chance in top 10'))

kable(cbind(row_name, rbind(ebWAR_efWAR_p, chance_10, chance_25)))

```

# Discussion

## Year Effect on the Talent of the Replacement-level Batters

The year effect for bWAR from the talent perspective and the era-adjusted bWAR perspective will be covered in this section. 

The two figures below show that the bWAR and fWAR talent of the replacement-level batters from 1871 to 2022. The line in the plot is the smoothed line after apply natural cubic spline method. The changing pattern is the similar for the talent of the replacement-level batters and MLB-eligible population. The seasons that deviate from the smoothed line are those associated with strikes and World War II, such as 1943 - 1946, 1981, 1994, 1995 and 2020 seasons. 

```{r echo=FALSE}
spline_d <- batters_talent_bWAR %>% filter(full_time == 'Y') %>% group_by(yearID) %>% 
  summarise(rep_talent = min(WAR_talent[comp >= 0]))

ns_talent <- lm(rep_talent ~ ns(yearID, df=15), data=spline_d)
spline_d <- spline_d %>% 
  mutate(nn_talent = predict(ns_talent, data.frame("yearID"= spline_d$yearID)))

p <- ggplot(spline_d, aes(yearID, rep_talent)) +
  geom_point()
p +  geom_line(aes(x = yearID, y = nn_talent)) + labs(x = 'year', y = 'replacement talent for bWAR')

```



```{r echo=FALSE}
spline_d <- batters_talent_fWAR %>% filter(full_time == 'Y') %>% group_by(yearID) %>% 
  summarise(rep_talent = min(WAR_talent[comp >= 0]))

ns_talent <- lm(rep_talent ~ ns(yearID, df=15), data=spline_d)
spline_d <- spline_d %>% 
  mutate(nn_talent = predict(ns_talent, data.frame("yearID"= spline_d$yearID)))

p <- ggplot(spline_d, aes(yearID, rep_talent)) +
  geom_point()
p +  geom_line(aes(x = yearID, y = nn_talent)) + labs(x = 'year', y = 'replacement talent for fWAR')

```


## Year Effect on the Era-adjusted bWAR of the Hypothetical Batters from 2022. 

In this section we calculate the bWAR talent of a hypothetical 2022 hitter with 0 bWAR. Then, we compute his era-adjusted bWAR by mapping this hypothetical player to the other seasons from 1871 through 2021. 

```{r echo=FALSE}

# bWAR

ref_2022 <- batters_talent_bWAR %>% filter(yearID == 2022) %>% filter(full_time == 'Y') %>% 
  select(yearID, playerID, full_time, comp, pops, thres)
fake_player <- data.frame(yearID = 2022, playerID = "fake01", full_time = 'Y', comp = 0/120, 
                          pops = unique(ref_2022$pops), thres = 342 )
ref_2022 <- rbind(ref_2022, fake_player)
bar <- ref_2022 %>% arrange(comp)

## batter WAR talent

talent_2022 <- talent_computing_nonpara(dataset = bar, component_name = "bWAR", year = 2022, ystar = thresh_fun(component = bar %>% select(comp), component_name = 'bWAR'), alpha = 1.16)

foo <- batters_talent_bWAR %>% 
  select(yearID, playerID, full_time, comp, pops, thres, WAR_talent, ystar)

career_talent_0 <- function(snippet, target_year){
  Rev_Aptitude_nonpara <- function(x, ytilde, alpha = 1.16, npop){
    
    # transforms ordered Pareto values corresponding to 
    # the general population to percentiles from order stats 
    # (in increasing order)
    n <- length(x)
    if(length(npop) == 1) npop <- rep(npop, n)  
    u = unlist(lapply(1:n, function(j){
      pbeta(pPareto(x[j], t = 1, alpha = alpha), j + npop[j]-n, n + 1 - j)
    }))
    
    
    ## map the quantile to the a predicated sample value
    map_Y <- function(u, ytilde){
      n <- length(ytilde)-1
      seqence <- seq(0, 1, 1/n)
      pos <- findInterval(u, seqence)
      out <- (n*u -pos + 1) * (ytilde[(pos+1)] - ytilde[pos]) + ytilde[pos]
      return(out)
    }
    
    ## map the vector of quantiles to the predicated sample values 
    n <- length(u)
    a <- qbeta(u, shape1 = 1:n, shape2 = n:1)
    out <- sapply(1:n, function(x) map_Y(a[x], ytilde = ytilde))
    out
    
  }
  
  snippet <- snippet %>% mutate(playerID = paste(playerID, "_proj", sep = ""))
  do.call(rbind, lapply(snippet$yearID, function(xx){
    batters_int <- foo %>% filter(yearID == target_year) %>% filter(full_time == 'Y')
    
    yy <- sort(batters_int$comp)
    n <- length(yy)
    ytilde <- rep(0, n + 1)
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
    ytilde[n+1] <- yy[n] + unique(batters_int$ystar)
    ytilde[2:n] <- unlist(lapply(2:n, function(j){
      (yy[j]+yy[j-1])/2 
    }))
    
    batters_int <- rbind(batters_int, snippet %>% filter(yearID == xx))
    batters_int$pops[nrow(batters_int)] <- batters_int$pops[1]
    batters_int <- batters_int %>% arrange(WAR_talent) %>% 
      mutate(adj_comp = Rev_Aptitude_nonpara(WAR_talent, ytilde = ytilde, npop = pops)) %>% 
      filter(playerID == unique(snippet$playerID))
    
    batters_int
  })) %>% mutate(ref_year = target_year)
}

adj_0_bWAR_G <- do.call(rbind, mclapply(1871:2022, function(xx){
  int <- career_talent_0(snippet = talent_2022 %>% filter(playerID == 'fake01'), target_year = xx) 
  int
}, mc.cores = ncores))

## mapping statistics
batters <- bat_dat %>% select(yearID, playerID, lgID, name, age, PA, G, bWAR, pops)
cutoff <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    m <- batters %>% filter(yearID == xx) %>% filter(PA >= 75)
    data.frame(thres = median(m$PA), yearID = xx)
  }))
batters <- merge(batters, cutoff, by = 'yearID')
batters <- batters %>% mutate(comp =  bWAR / G, full_time = ifelse(PA >= thres, 'Y', 'N'))

mapped_quan_b_raw <- do.call(rbind, mclapply(years, function(xx){
    batters_full <- batters %>% filter(yearID == xx) %>% 
      filter(full_time == 'Y') %>% arrange(-G)
    batters_less <- batters %>% filter(yearID == xx) %>% 
      filter(full_time == 'N') %>% arrange(-G)
    
    n1 <- nrow(batters_full)
    n2 <- nrow(batters_less)
    
    mapped_G_full <- c()
    mapped_G_less <- c()
    for (yy in c(1977:1980, 1982:1989)) {
      batters_ref_full <- batters %>% 
        filter(yearID == yy, full_time == 'Y') %>% arrange(-G)
      batters_ref_less <- batters %>% 
        filter(yearID == yy, full_time == 'N') %>% arrange(-G)
      n1r <- nrow(batters_ref_full)
      n2r <- nrow(batters_ref_less)
      
      mapped_G_full <- cbind(mapped_G_full, approx(x = seq((n1r-1),0)/(n1r-1), 
                                                   y = batters_ref_full$G, 
                                                   xout = seq((n1-1),0)/(n1-1))$y)
      mapped_G_less <- cbind(mapped_G_less, approx(x = seq((n2r-1),0)/(n2r-1), 
                                                   y = batters_ref_less$G, 
                                                   xout = seq((n2-1),0)/(n2-1))$y)
    }
    
    batters_full$mapped_G <- rowMeans(mapped_G_full)
    batters_less$mapped_G <- rowMeans(mapped_G_less)
    
    m <- rbind(batters_full, batters_less)
    data.frame(playerID = m$playerID, yearID = m$yearID,
               mapped_G_raw = round(m$mapped_G), G = round(m$G))
    
  }, mc.cores = ncores))

## quantile mapping
m <- mapped_quan_b_raw %>% select(yearID, G, mapped_G_raw)

adj_season_G <- do.call(rbind, mclapply(1871:2022, function(xx){
  s <- m %>% filter(yearID == xx)
  c(ref_year = xx, mapped_G = approx(s$mapped_G_raw, s$G, xout = 120)$y)
}, mc.cores = ncores))  

adj_0_bWAR <- merge(adj_0_bWAR_G, adj_season_G, by = c('ref_year'))

adj_0_bWAR <- adj_0_bWAR %>% mutate(adj_bWAR = adj_comp * mapped_G) %>% select(ref_year, adj_bWAR)

```

```{r echo=FALSE}
adj_0_bWAR$adj_bWAR <- ifelse(adj_0_bWAR$adj_bWAR < -2, -2, adj_0_bWAR$adj_bWAR)
adj_0_bWAR_trim <- adj_0_bWAR[-c(111, 150),]
ns_0_bWAR <- lm(adj_bWAR ~ ns(ref_year, df=30), data=adj_0_bWAR_trim)
adj_0_bWAR_trim <- adj_0_bWAR_trim %>% 
  mutate(nn_0_bWAR = predict(ns_0_bWAR, data.frame("ref_year"= adj_0_bWAR_trim$ref_year)))
#adj_0_bWAR <- rbind(adj_0_bWAR, data.frame(ref_year = 2022, adj_bWAR = 0, nn_0_bWAR = 0))
adj_0_bWAR_trim$nn_0_bWAR <- ifelse(adj_0_bWAR_trim$nn_0_bWAR < -2, -2, adj_0_bWAR_trim$nn_0_bWAR)

p <- ggplot(adj_0_bWAR_trim, aes(ref_year, adj_bWAR)) +
  geom_point()
p +  geom_line(aes(x = ref_year, y = nn_0_bWAR)) + labs(x = 'year', y = 'era-adjusted bWAR') +
  geom_point(data = adj_0_bWAR[c(111, 150),], aes(x = ref_year, y = adj_bWAR))

```

The figure above shows the era-adjusted bWAR values over time corresponding to a hypothetical batter with 0 bWAR in 2022 using the Full House Model. The fall in the mid-2000s corresponds to increase of MLB-eligible population. Despite the sharp decline in era-adjusted bWAR values in 1981 season, it is untrue that the 1981 batters with 0 bWAR would perform better than the 2022 batters. This is because the 1981 season was brief and a large number of batters underperformed replacement-level players. The problem of the sharp decline in era-adjusted bWAR values in the 1981 season is resolved when we look at the era-adjusted bWAR and era-adjusted bWAR per game of the hypothetical hitters from 2022 with 2 bWAR. 

The two figures below shows the era-adjusted bWAR and era-adjusted bWAR per game of the hypothetical hitters from 2022 with 2 bWAR. 

```{r echo=FALSE}

# bWAR

ref_2022 <- batters_talent_bWAR %>% filter(yearID == 2022) %>% filter(full_time == 'Y') %>% 
  select(yearID, playerID, full_time, comp, pops, thres)
fake_player <- data.frame(yearID = 2022, playerID = "fake01", full_time = 'Y', comp = 2/120, 
                          pops = unique(ref_2022$pops), thres = 342 )
ref_2022 <- rbind(ref_2022, fake_player)
bar <- ref_2022 %>% arrange(comp)

## batter WAR talent

talent_2022 <- talent_computing_nonpara(dataset = bar, component_name = "bWAR", year = 2022, ystar = thresh_fun(component = bar %>% select(comp), component_name = 'bWAR'), alpha = 1.16)

foo <- batters_talent_bWAR %>% 
  select(yearID, playerID, full_time, comp, pops, thres, WAR_talent, ystar)

career_talent_0 <- function(snippet, target_year){
  Rev_Aptitude_nonpara <- function(x, ytilde, alpha = 1.16, npop){
    
    # transforms ordered Pareto values corresponding to 
    # the general population to percentiles from order stats 
    # (in increasing order)
    n <- length(x)
    if(length(npop) == 1) npop <- rep(npop, n)  
    u = unlist(lapply(1:n, function(j){
      pbeta(pPareto(x[j], t = 1, alpha = alpha), j + npop[j]-n, n + 1 - j)
    }))
    
    
    ## map the quantile to the a predicated sample value
    map_Y <- function(u, ytilde){
      n <- length(ytilde)-1
      seqence <- seq(0, 1, 1/n)
      pos <- findInterval(u, seqence)
      out <- (n*u -pos + 1) * (ytilde[(pos+1)] - ytilde[pos]) + ytilde[pos]
      return(out)
    }
    
    ## map the vector of quantiles to the predicated sample values 
    n <- length(u)
    a <- qbeta(u, shape1 = 1:n, shape2 = n:1)
    out <- sapply(1:n, function(x) map_Y(a[x], ytilde = ytilde))
    out
    
  }
  
  snippet <- snippet %>% mutate(playerID = paste(playerID, "_proj", sep = ""))
  do.call(rbind, lapply(snippet$yearID, function(xx){
    batters_int <- foo %>% filter(yearID == target_year) %>% filter(full_time == 'Y')
    
    yy <- sort(batters_int$comp)
    n <- length(yy)
    ytilde <- rep(0, n + 1)
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
    ytilde[n+1] <- yy[n] + unique(batters_int$ystar)
    ytilde[2:n] <- unlist(lapply(2:n, function(j){
      (yy[j]+yy[j-1])/2 
    }))
    
    batters_int <- rbind(batters_int, snippet %>% filter(yearID == xx))
    batters_int$pops[nrow(batters_int)] <- batters_int$pops[1]
    batters_int <- batters_int %>% arrange(WAR_talent) %>% 
      mutate(adj_comp = Rev_Aptitude_nonpara(WAR_talent, ytilde = ytilde, npop = pops)) %>% 
      filter(playerID == unique(snippet$playerID))
    
    batters_int
  })) %>% mutate(ref_year = target_year)
}

adj_0_bWAR_G <- do.call(rbind, mclapply(1871:2022, function(xx){
  int <- career_talent_0(snippet = talent_2022 %>% filter(playerID == 'fake01'), target_year = xx) 
  int
}, mc.cores = ncores))

## mapping statistics
batters <- bat_dat %>% select(yearID, playerID, lgID, name, age, PA, G, bWAR, pops)
cutoff <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    m <- batters %>% filter(yearID == xx) %>% filter(PA >= 75)
    data.frame(thres = median(m$PA), yearID = xx)
  }))
batters <- merge(batters, cutoff, by = 'yearID')
batters <- batters %>% mutate(comp =  bWAR / G, full_time = ifelse(PA >= thres, 'Y', 'N'))

mapped_quan_b_raw <- do.call(rbind, mclapply(years, function(xx){
    batters_full <- batters %>% filter(yearID == xx) %>% 
      filter(full_time == 'Y') %>% arrange(-G)
    batters_less <- batters %>% filter(yearID == xx) %>% 
      filter(full_time == 'N') %>% arrange(-G)
    
    n1 <- nrow(batters_full)
    n2 <- nrow(batters_less)
    
    mapped_G_full <- c()
    mapped_G_less <- c()
    for (yy in c(1977:1980, 1982:1989)) {
      batters_ref_full <- batters %>% 
        filter(yearID == yy, full_time == 'Y') %>% arrange(-G)
      batters_ref_less <- batters %>% 
        filter(yearID == yy, full_time == 'N') %>% arrange(-G)
      n1r <- nrow(batters_ref_full)
      n2r <- nrow(batters_ref_less)
      
      mapped_G_full <- cbind(mapped_G_full, approx(x = seq((n1r-1),0)/(n1r-1), 
                                                   y = batters_ref_full$G, 
                                                   xout = seq((n1-1),0)/(n1-1))$y)
      mapped_G_less <- cbind(mapped_G_less, approx(x = seq((n2r-1),0)/(n2r-1), 
                                                   y = batters_ref_less$G, 
                                                   xout = seq((n2-1),0)/(n2-1))$y)
    }
    
    batters_full$mapped_G <- rowMeans(mapped_G_full)
    batters_less$mapped_G <- rowMeans(mapped_G_less)
    
    m <- rbind(batters_full, batters_less)
    data.frame(playerID = m$playerID, yearID = m$yearID,
               mapped_G_raw = round(m$mapped_G), G = round(m$G))
    
  }, mc.cores = ncores))

## quantile mapping
m <- mapped_quan_b_raw %>% select(yearID, G, mapped_G_raw)

adj_season_G <- do.call(rbind, mclapply(1871:2022, function(xx){
  s <- m %>% filter(yearID == xx)
  c(ref_year = xx, mapped_G = approx(s$mapped_G_raw, s$G, xout = 120)$y)
}, mc.cores = ncores))  

adj_0_bWAR <- merge(adj_0_bWAR_G, adj_season_G, by = c('ref_year'))

adj_0_bWAR <- adj_0_bWAR %>% mutate(adj_bWAR = adj_comp * mapped_G) %>% 
  select(ref_year, adj_comp, adj_bWAR)

```

```{r echo=FALSE}
adj_0_bWAR$adj_bWAR <- ifelse(adj_0_bWAR$adj_bWAR < -2, -2, adj_0_bWAR$adj_bWAR)
adj_0_bWAR$adj_bWAR[152] <- 2
adj_0_bWAR_trim <- adj_0_bWAR[-c(111, 150),]
ns_0_bWAR <- lm(adj_bWAR ~ ns(ref_year, df=30), data=adj_0_bWAR_trim)
adj_0_bWAR_trim <- adj_0_bWAR_trim %>% 
  mutate(nn_0_bWAR = predict(ns_0_bWAR, data.frame("ref_year"= adj_0_bWAR_trim$ref_year)))
#adj_0_bWAR <- rbind(adj_0_bWAR, data.frame(ref_year = 2022, adj_bWAR = 0, nn_0_bWAR = 0))
adj_0_bWAR_trim$nn_0_bWAR <- ifelse(adj_0_bWAR_trim$nn_0_bWAR < -2, -2, adj_0_bWAR_trim$nn_0_bWAR)

p <- ggplot(adj_0_bWAR_trim, aes(ref_year, adj_bWAR)) +
  geom_point()
p +  geom_line(aes(x = ref_year, y = nn_0_bWAR)) + labs(x = 'year', y = 'era-adjusted bWAR') +
  geom_point(data = adj_0_bWAR[c(111, 150),], aes(x = ref_year, y = adj_bWAR))

```

```{r echo=FALSE}
adj_0_bWAR_trim <- adj_0_bWAR[-c(111, 150),]
ns_0_bWAR <- lm(adj_comp ~ ns(ref_year, df=15), data=adj_0_bWAR_trim)
adj_0_bWAR_trim <- adj_0_bWAR_trim %>% 
  mutate(nn_0_bWAR = predict(ns_0_bWAR, data.frame("ref_year"= adj_0_bWAR_trim$ref_year)))

p <- ggplot(adj_0_bWAR_trim, aes(ref_year, adj_comp)) +
  geom_point()
p +  geom_line(aes(x = ref_year, y = nn_0_bWAR)) + labs(x = 'year', y = 'era-adjusted bWAR per game') +
  geom_point(data = adj_0_bWAR[c(111, 150),], aes(x = ref_year, y = adj_comp))
```

Then we also calculate the fWAR talent of a hypothetical 2022 hitter with 0 fWAR. Then, we compute his era-adjusted fWAR by mapping this hypothetical player to the other seasons from 1871 through 2021. 

```{r echo=FALSE}

# fWAR

ref_2022 <- batters_talent_fWAR %>% filter(yearID == 2022) %>% filter(full_time == 'Y') %>% 
  select(yearID, playerID, full_time, comp, pops, thres)
fake_player <- data.frame(yearID = 2022, playerID = "fake01", full_time = 'Y', comp = 0/120, 
                          pops = unique(ref_2022$pops), thres = 342 )
ref_2022 <- rbind(ref_2022, fake_player)
bar <- ref_2022 %>% arrange(comp)

## batter WAR talent

talent_2022 <- talent_computing_nonpara(dataset = bar, component_name = "fWAR", year = 2022, ystar = thresh_fun(component = bar %>% select(comp), component_name = 'fWAR'), alpha = 1.16)

foo <- batters_talent_fWAR %>% 
  select(yearID, playerID, full_time, comp, pops, thres, WAR_talent, ystar)

adj_0_fWAR_G <- do.call(rbind, mclapply(1871:2022, function(xx){
  int <- career_talent_0(snippet = talent_2022 %>% filter(playerID == 'fake01'), target_year = xx) 
  int
}, mc.cores = ncores))

## quantile mapping
m <- mapped_quan_b_raw %>% select(yearID, G, mapped_G_raw)

adj_season_G <- do.call(rbind, mclapply(1871:2022, function(xx){
  s <- m %>% filter(yearID == xx)
  c(ref_year = xx, mapped_G = approx(s$mapped_G_raw, s$G, xout = 120)$y)
}, mc.cores = ncores))  

adj_0_fWAR <- merge(adj_0_fWAR_G, adj_season_G, by = c('ref_year'))

adj_0_fWAR <- adj_0_fWAR %>% mutate(adj_fWAR = adj_comp * mapped_G) %>% select(ref_year, adj_fWAR)

```

```{r echo=FALSE}

adj_0_fWAR$adj_fWAR <- ifelse(adj_0_fWAR$adj_fWAR < -2, -2, adj_0_fWAR$adj_fWAR)
adj_0_fWAR_trim <- adj_0_fWAR[-c(111, 150),]
ns_0_fWAR <- lm(adj_fWAR ~ ns(ref_year, df=30), data=adj_0_fWAR_trim)
adj_0_fWAR_trim <- adj_0_fWAR_trim %>% 
  mutate(nn_0_fWAR = predict(ns_0_fWAR, data.frame("ref_year"= adj_0_fWAR_trim$ref_year)))
#adj_0_fWAR <- rbind(adj_0_fWAR, data.frame(ref_year = 2022, adj_fWAR = 0, nn_0_fWAR = 0))
adj_0_fWAR_trim$nn_0_fWAR <- ifelse(adj_0_fWAR_trim$nn_0_fWAR < -2, -2, adj_0_fWAR_trim$nn_0_fWAR)

p <- ggplot(adj_0_fWAR_trim, aes(ref_year, adj_fWAR)) +
  geom_point()
p +  geom_line(aes(x = ref_year, y = nn_0_fWAR)) + labs(x = 'year', y = 'era-adjusted fWAR') +
  geom_point(data = adj_0_fWAR[c(111, 150),], aes(x = ref_year, y = adj_fWAR))

```

The figure above shows the era-adjusted fWAR values over time corresponding to a hypothetical batter with 0 fWAR in 2022 using the Full House Model. The fall in the mid-2000s corresponds to increase of MLB-eligible population. The problem of the sharp decline in era-adjusted fWAR values in the 1981 season can also be resolved when we look at the era-adjusted fWAR and era-adjusted fWAR per game of the hypothetical hitters from 2022 with 2 fWAR. 

The two figures below show he era-adjusted fWAR and era-adjusted fWAR per game of the hypothetical hitters from 2022 with 2 fWAR. 

```{r echo=FALSE}

# bWAR

ref_2022 <- batters_talent_fWAR %>% filter(yearID == 2022) %>% filter(full_time == 'Y') %>% 
  select(yearID, playerID, full_time, comp, pops, thres)
fake_player <- data.frame(yearID = 2022, playerID = "fake01", full_time = 'Y', comp = 2/120, 
                          pops = unique(ref_2022$pops), thres = 342 )
ref_2022 <- rbind(ref_2022, fake_player)
bar <- ref_2022 %>% arrange(comp)

## batter WAR talent

talent_2022 <- talent_computing_nonpara(dataset = bar, component_name = "fWAR", year = 2022, ystar = thresh_fun(component = bar %>% select(comp), component_name = 'fWAR'), alpha = 1.16)

foo <- batters_talent_fWAR %>% 
  select(yearID, playerID, full_time, comp, pops, thres, WAR_talent, ystar)

adj_0_fWAR_G <- do.call(rbind, mclapply(1871:2022, function(xx){
  int <- career_talent_0(snippet = talent_2022 %>% filter(playerID == 'fake01'), target_year = xx) 
  int
}, mc.cores = ncores))

## quantile mapping
m <- mapped_quan_b_raw %>% select(yearID, G, mapped_G_raw)

adj_season_G <- do.call(rbind, mclapply(1871:2022, function(xx){
  s <- m %>% filter(yearID == xx)
  c(ref_year = xx, mapped_G = approx(s$mapped_G_raw, s$G, xout = 120)$y)
}, mc.cores = ncores))  

adj_0_fWAR <- merge(adj_0_fWAR_G, adj_season_G, by = c('ref_year'))

adj_0_fWAR <- adj_0_fWAR %>% mutate(adj_fWAR = adj_comp * mapped_G) %>% 
  select(ref_year, adj_comp, adj_fWAR)

```

```{r echo=FALSE}
adj_0_fWAR$adj_fWAR <- ifelse(adj_0_fWAR$adj_fWAR < -2, -2, adj_0_fWAR$adj_fWAR)
adj_0_fWAR$adj_fWAR[152] <- 2
adj_0_fWAR_trim <- adj_0_fWAR[-c(111, 150),]
ns_0_fWAR <- lm(adj_fWAR ~ ns(ref_year, df=30), data=adj_0_fWAR_trim)
adj_0_fWAR_trim <- adj_0_fWAR_trim %>% 
  mutate(nn_0_fWAR = predict(ns_0_fWAR, data.frame("ref_year"= adj_0_fWAR_trim$ref_year)))
#adj_0_fWAR <- rbind(adj_0_fWAR, data.frame(ref_year = 2022, adj_fWAR = 0, nn_0_fWAR = 0))
adj_0_fWAR_trim$nn_0_fWAR <- ifelse(adj_0_fWAR_trim$nn_0_fWAR < -2, -2, adj_0_fWAR_trim$nn_0_fWAR)
adj_0_fWAR_trim$nn_0_fWAR[150] <- 2

p <- ggplot(adj_0_fWAR_trim, aes(ref_year, adj_fWAR)) +
  geom_point()
p +  geom_line(aes(x = ref_year, y = nn_0_fWAR)) + labs(x = 'year', y = 'era-adjusted fWAR') +
  geom_point(data = adj_0_fWAR[c(111, 150),], aes(x = ref_year, y = adj_fWAR))

```

```{r echo=FALSE}
adj_0_fWAR_trim <- adj_0_fWAR[-c(111, 150),]
ns_0_fWAR <- lm(adj_comp ~ ns(ref_year, df=15), data=adj_0_fWAR_trim)
adj_0_fWAR_trim <- adj_0_fWAR_trim %>% 
  mutate(nn_0_fWAR = predict(ns_0_fWAR, data.frame("ref_year"= adj_0_fWAR_trim$ref_year)))

p <- ggplot(adj_0_fWAR_trim, aes(ref_year, adj_comp)) +
  geom_point()
p +  geom_line(aes(x = ref_year, y = nn_0_fWAR)) + labs(x = 'year', y = 'era-adjusted fWAR per game') +
  geom_point(data = adj_0_fWAR[c(111, 150),], aes(x = ref_year, y = adj_comp))

```

## Expansion Effect 

It is actually supposed that the Major League's expansion effect has a significant impact on how the talent scores vary over time and the magnitude of talent will be diluted with the expansion. However, after adding some hypothetical players who had poor performance in the early seasons, when there were fewer players, we discover that the real players did not much benefit from the adjustment of adding hypothetical players. Additionally, we make an effort to establish replacement player baselines throughout all seasons and adjust these baselines at the same level. However, the baselines we construct for every season are quite similar, and the talents of the players from earlier eras do not get much improved. 

We also perform several simulations to examine the effect of season size. Using the same talent-generating process, we randomly generate different numbers of components from the same distribution and compare the top 1 talent score, top 50 talent scores, top 100 talent scores and top 300 talent scores. In each simulation, we generate two groups of components from the standard normal distribution, one consists 600 components and the other consists 300 components. Then we record the number of largest talents that group 1 is larger than the group 2. We run this simulation 1000 times and diplay the distribution of the result from each simulation. These graphs below show that top talent scores for various amounts of components from the same distribution are identical. 


```{r cache=TRUE, echo=FALSE}

test_n <- function(n){
  Y <- rnorm(n)
  Y[n] <- Y[n]
  
  p <- sort(pnorm(Y))
  
  # converts order stats to their percentiles
  order_pbino <- function(p = 0, k = 1, n = 1e4){
    pbinom(k - 1, prob = p, size = n, lower.tail = FALSE)
  }
  
  # converts a vector of order stats 
  # to their percentiles. This vector should be the entire 
  # sample sorted in increasing order
  p <- sort(p) # just in case
  n <- length(p)
  u = unlist(lapply(1:n, function(j){
    order_pbino(p[j], k = j, n = n)
  }))
  
  # transforms percentiles from order stats (in increasing order)
  # to Pareto values corresponding to the general population 
  # of a greater than or equal to size
  # default alpha is that of the Pareto principle 80-20
  n <- length(u)
  X <- unlist(lapply(1:n, function(j){
    qPareto(qbeta(u[j], j + 1e6 -n , n + 1 - j), t = 1, alpha = 1.16)
  }))
  return(data.frame(n = n, X = sort(X, decreasing = TRUE)))
}

set.seed(123)
m <- do.call(rbind, mclapply(1:1000, function(xx){
  sum(test_n(600)[1,]$X < test_n(300)[1,]$X)
}, mc.cores = 7)) 

m_50 <- do.call(rbind, mclapply(1:1000, function(xx){
  sum(test_n(600)[1:50,]$X < test_n(300)[1:50,]$X)
}, mc.cores = 7)) 

m_100 <- do.call(rbind, mclapply(1:1000, function(xx){
  sum(test_n(600)[1:100,]$X < test_n(300)[1:100,]$X)
}, mc.cores = 7)) 

m_300 <- do.call(rbind, mclapply(1:1000, function(xx){
  sum(test_n(600)[1:300,]$X < test_n(300)[1:300,]$X)
}, mc.cores = 7)) 

par(mfrow=c(2,2))
hist(m, main = 'compare the largest talent')
hist(m_50, main = 'compare the largest 50 talents')
hist(m_100, main = 'compare the largest 100 talents')
hist(m_300, main = 'compare the largest 300 talents')

```

We also run another simulation to test the effect of season size. Instead of generating 600 components in the group 1, I generate 900 components and repeat the rest of the simulation. Then we have the similar results. 

```{r cache=TRUE, echo=FALSE}
set.seed(123)
m <- do.call(rbind, mclapply(1:1000, function(xx){
  sum(test_n(900)[1,]$X < test_n(300)[1,]$X)
}, mc.cores = 7)) 

m_50 <- do.call(rbind, mclapply(1:1000, function(xx){
  sum(test_n(900)[1:50,]$X < test_n(300)[1:50,]$X)
}, mc.cores = 7)) 

m_100 <- do.call(rbind, mclapply(1:1000, function(xx){
  sum(test_n(900)[1:100,]$X < test_n(300)[1:100,]$X)
}, mc.cores = 7)) 

m_300 <- do.call(rbind, mclapply(1:1000, function(xx){
  sum(test_n(900)[1:300,]$X < test_n(300)[1:300,]$X)
}, mc.cores = 7)) 

par(mfrow=c(2,2))
hist(m, main = 'compare the largest talent')
hist(m_50, main = 'compare the largest 50 talents')
hist(m_100, main = 'compare the largest 100 talents')
hist(m_300, main = 'compare the largest 300 talents')

```

In this part, we compare the BA before and in the expansion seasons and see if there is a significant difference between them. The expansion seasons are collected from [Wikipedia](https://en.wikipedia.org/wiki/Major_League_Baseball) and they are 1879, 1892, 1900, 1901, 1961, 1962, 1969, 1977, 1993, and 1998. We compute the average and standard deviation of full-time batters' BA before and in the expansion seasons and the results are shown below. 

```{r echo=FALSE}
#library(Lahman)
#foo <- Batting %>% filter(yearID %in% c(1997, 1998)) %>%
#  filter(AB >= 324) %>%
#  mutate(BA = H/AB) %>%
#  dplyr::select(yearID, playerID, BA, AB)
#foo %>% group_by(yearID) %>%
#  summarise(mBA = mean(BA), sdBA = sd(BA))

batters <- bat_dat
batters <- merge(batters, cutoff, by = 'yearID')
batters <- batters %>% select(playerID, yearID, name, AB, PA, H, thres) %>%
  mutate(comp = ifelse(AB != 0, H / AB, 0), full_time = ifelse(PA >= thres, 'Y', 'N'))
batters_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- batters %>% filter(yearID == xx)
    lg_avg <- sum(int$H)/sum(int$AB)
    int %>% mutate(comp = (H + lg_avg * 25)/(AB + 25))
  }))
batters_avg_sd <- batters_schell %>% filter(full_time == 'Y') %>% group_by(yearID) %>%
  summarise(mean = round(mean(comp),3), sd = round(sd(comp),3))

before_yearID <- c(1878, 1891, 1899, 1900, 1960, 1961, 1968, 1976, 1992, 1997)
after_yearID <- before_yearID + 1
batters_avg_sd_before <- batters_avg_sd %>% filter(yearID %in% before_yearID)
batters_avg_sd_after <- batters_avg_sd %>% filter(yearID %in% after_yearID)

knitr::kable(cbind(batters_avg_sd_before, batters_avg_sd_after))
```

The average and standard error of the difference between the full-time batters' BA before and in the expansion seasons are shown below.

```{r echo=FALSE}
knitr::kable(data.frame(avg = mean(batters_avg_sd_before$mean - batters_avg_sd_after$mean), 
                        se = sd(batters_avg_sd_before$mean - batters_avg_sd_after$mean)/(sqrt(10))))
```



We also show Willie Mays's seasonal bWAR per game in his 22 years MLB career from 1951 to 1973 season except the 1953 season. The red dots represent the seasons that the MLB were experiencing the expansion. The result show that the expansion did not have any significant positive or negative effects on Willie Mays's prime season or the tail of his career. 

```{r echo=FALSE}
willie_mays <- batters_talent_bWAR %>% filter(playerID == 'mayswi01')
willie_mays %>% ggplot(aes(x = yearID, y = comp)) + geom_point() + geom_smooth(se = FALSE) + geom_point(data = willie_mays %>% filter(yearID %in% c(1960, 1961, 1962, 1968, 1969)), aes(x = yearID, y = comp), color = 'red') + labs(x = 'year', y = 'bWAR per game')
```

We also show Randy Johnson's seasonal bWAR per game in his 22 years MLB career from 1988 to 2009 season. The red dots represent the seasons that the MLB were experiencing the expansion. The result show that the expansion did not have any significant positive or negative effects on Randy Johnson's prime season. 

```{r echo=FALSE}
randy_johnson <- pitchers_talent_bWAR %>% filter(playerID == 'johnsra05')
randy_johnson %>% ggplot(aes(x = yearID, y = comp)) + geom_point() + geom_smooth(se = FALSE) + geom_point(data = randy_johnson %>% filter(yearID %in% c(1992, 1993, 1997, 1998)), aes(x = yearID, y = comp), color = 'red') + labs(x = 'year', y = 'bWAR per game')
```


```{r echo=FALSE, fig.show='hide'}
dist_2 <- batters_talent_bWAR %>% filter(full_time == 'Y') %>% arrange(desc(comp)) %>% 
  group_by(yearID) %>% summarise(dist = comp[1] - comp[2])

dist_2 %>% ggplot(aes(x = yearID, y = dist)) + 
  geom_point() + geom_line() + geom_smooth(se = FALSE) + 
  geom_point(data = dist_2 %>% filter(yearID %in% c(1878, 1879, 1891, 1892, 1899, 1900, 1901, 1960, 1961, 1962, 1968, 1969, 1976, 1977, 1992, 1993, 1997, 1998)) , aes(x = yearID, y = dist), color = 'red') + geom_line(data = dist_2 %>% filter(yearID %in% c(1878, 1879)) , aes(x = yearID, y = dist), color = 'red') + geom_line(data = dist_2 %>% filter(yearID %in% c(1891, 1892)) , aes(x = yearID, y = dist), color = 'red') + geom_line(data = dist_2 %>% filter(yearID %in% c(1899, 1900)) , aes(x = yearID, y = dist), color = 'red') + geom_line(data = dist_2 %>% filter(yearID %in% c(1900, 1901)) , aes(x = yearID, y = dist), color = 'red') + geom_line(data = dist_2 %>% filter(yearID %in% c(1960, 1961)) , aes(x = yearID, y = dist), color = 'red') + geom_line(data = dist_2 %>% filter(yearID %in% c(1961, 1962)) , aes(x = yearID, y = dist), color = 'red') + geom_line(data = dist_2 %>% filter(yearID %in% c(1968, 1969)) , aes(x = yearID, y = dist), color = 'red') + geom_line(data = dist_2 %>% filter(yearID %in% c(1976, 1977)) , aes(x = yearID, y = dist), color = 'red') + geom_line(data = dist_2 %>% filter(yearID %in% c(1992, 1993)) , aes(x = yearID, y = dist), color = 'red') + geom_line(data = dist_2 %>% filter(yearID %in% c(1997, 1998)) , aes(x = yearID, y = dist), color = 'red') +
  labs(x = 'year', y = 'difference between top 2 bWAR per game leaders')
```


## Figure 1: 4 moments of BA in Supplementary Materials

This figure below shows that four statistical moments of the batting average distribution from 1871 to 2021 season. Points in red correspond to seasons surrounding the peak of WWII (1941-1946). 

```{r echo=FALSE}
batters_mom <- batters_talent_AVG %>% filter(full_time == 'Y') %>%
  select(yearID, comp)

library(moments)
years = c(1871:2021)
mom1st <- sapply(years, function(x) mean(batters_mom %>% 
                                           filter(yearID == x) %>%
                                           pull(comp)))
mom2nd <- sapply(years, function(x) sd(batters_mom %>% 
                                           filter(yearID == x) %>%
                                           pull(comp)))
mom3rd <- sapply(years, function(x) skewness(batters_mom %>% 
                                         filter(yearID == x) %>%
                                         pull(comp)))
mom4th <- sapply(years, function(x) kurtosis(batters_mom %>% 
                                               filter(yearID == x) %>%
                                               pull(comp)))

par(mfrow = c(2,2), oma = c(4,4,1,0), mar = c(1,2,1,1))
plot.new()
title('mean of batting averages')
plot.window(xlim = c(1871,2022), ylim = c(0.25,0.32))
points(years[-c(71:76)], mom1st[-c(71:76)], pch = 19)
points(years[c(71:76)], mom1st[c(71:76)], pch = 19, col = 'red')
axis(2)
plot.new()
title('sd of batting averages')
plot.window(xlim = c(1871,2022), ylim = c(0.02, 0.06))
points(years[-c(71:76)], mom2nd[-c(71:76)], pch = 19)
points(years[c(71:76)], mom2nd[c(71:76)], pch = 19, col = 'red')
axis(2)
plot.new()
title('skewness of batting averages')
plot.window(xlim = c(1871,2022), ylim = c(-0.46,0.98))
points(years[-c(71:76)], mom3rd[-c(71:76)], pch = 19)
points(years[c(71:76)], mom3rd[c(71:76)], pch = 19, col = 'red')
axis(1, xaxp=c(1870, 2020, 15), las=1)
axis(2)
plot.new()
title('kurtosis of batting averages')
plot.window(xlim = c(1871,2022), ylim = c(1.78,4.57))
points(years[-c(71:76)], mom4th[-c(71:76)], pch = 19)
points(years[c(71:76)], mom4th[c(71:76)], pch = 19, col = 'red')
axis(1, xaxp=c(1870, 2020, 15), las=1)
axis(2)

```

## Distribution Sensitity Analysis

```{r cache=TRUE, echo=FALSE}
library(tidyverse)
library(orderstats)
library(Pareto)
library(parallel)
library(doParallel)
library(xtable)
library(VGAM)
RNGkind("L'Ecuyer-CMRG")


## order_pnorm function
# converts normal order stats to their percentiles
order_pnorm <- function(q = 0, mean = 0, sd = 1, k = 1, n = 1e4){
	p <- pnorm(q, mean = mean, sd = sd)
	pbinom(k - 1, prob = p, size = n, lower.tail = FALSE)
}

## order_pnorm_vec function
# this function converts a vector of normal order stats 
# to their percentiles. This vector should be the entire 
# sample sorted in increasing order
order_pnorm_vec <- function(q, mean = 0, sd = 1){
	q <- sort(q) # just in case
	n <- length(q)
	unlist(lapply(1:n, function(j){
		order_pnorm(q[j], k = j, n = n, mean = mean, sd = sd)
	}))
}

## order_Pareto_vec function 
# this function transform percentiles from order stats (in increasing order)
# to Pareto values corresponding to the general population 
# of a greater than or equal to size
# default alpha is that of the Pareto principle 80-20
order_Pareto_vec <- function(u, t = 1, alpha = 1.16, npop = 1e4){
	n <- length(u)
	if(length(npop) == 1) npop <- rep(npop, n)
	unlist(lapply(1:n, function(j){
		qPareto(qbeta(u[j], j + npop[j]-n, n + 1 - j), t = t, alpha = alpha)
	}))
}
## order_normal_vec function 
# this function transform percentiles from order stats (in increasing order)
# to normal values corresponding to the general population 
# of a greater than or equal to size
# default alpha is that of the Pareto principle 80-20
order_normal_vec <- function(u, mean = 0, sd = 1, npop = 1e4){
  n <- length(u)
  if(length(npop) == 1) npop <- rep(npop, n)
  unlist(lapply(1:n, function(j){
    qnorm(qbeta(u[j], j + npop[j]-n, n + 1 - j), mean = mean, sd = sd)
  }))
}

## map_Pareto_vals_vec function 
# this function transforms ordered Pareto values corresponding to 
# the general population to percentiles from order stats 
# (in increasing order)
map_Pareto_vals_vec <- function(x, t = 1, alpha = 1.16, npop = 1e4){
	n <- length(x)
	if(length(npop) == 1) npop <- rep(npop, n)  
	unlist(lapply(1:n, function(j){
		pbeta(pPareto(x[j], t = t, alpha = alpha), j + npop[j]-n, n + 1 - j)
	}))
}

## map_Normal_vals_vec function 
# this function transforms ordered Normal values corresponding to 
# the general population to percentiles from order stats 
# (in increasing order)
map_Normal_vals_vec <- function(x, mean = 0, sd = 1, npop = 1e4){
	n <- length(x)
	if(length(npop) == 1) npop <- rep(npop, n)  
	unlist(lapply(1:n, function(j){
		pbeta(pnorm(x[j], mean = mean, sd = sd), j + npop[j]-n, n + 1 - j)
	}))
}

## order_foldedN_vec function 
# this function transform percentiles from order stats (in increasing order)
# to folded normal values corresponding to the general population 
# of a greater than or equal to size
# default alpha is that of the Pareto principle 80-20
order_foldedN_vec <- function(u, mean = 0, sd = 1, npop = 1e4){
  n <- length(u)
  if(length(npop) == 1) npop <- rep(npop, n)
  unlist(lapply(1:n, function(j){
    qfoldnorm(qbeta(u[j], j + npop[j]-n, n + 1 - j), mean = 0, sd = 1)
  }))
}

## map_foldedN_vals_vec function 
# this function transforms ordered folded normal values corresponding to 
# the general population to percentiles from order stats 
# (in increasing order)
map_foldedN_vals_vec <- function(x, mean = 0, sd = 1, npop = 1e4){
  n <- length(x)
  if(length(npop) == 1) npop <- rep(npop, n)  
  unlist(lapply(1:n, function(j){
    pbeta(pfoldnorm(x[j], mean = mean, sd = sd), j + npop[j]-n, n + 1 - j)
  }))
}


## oder_qnorm function
# take the ordered percentiles and convert them to order statistics 
# from a normal distribution
order_qnorm <- function(u, mean = 0, sd = 1){
	n <- length(u)
	qnorm(qbeta(u, shape1 = 1:n, shape2 = n:1), mean = mean, sd = sd)
}


Full_House_averages_simulator <- function(l_size = 300, alpha = 1.16, alpha2 = 3, ncores = 1){

	### Correct Pareto talent model (alpha)	
	league1 <- sort(rPareto(n = 1e6, t = 1, alpha = alpha))
	league2 <- sort(rPareto(n = 2e6, t = 1, alpha = alpha))
	league3 <- sort(rPareto(n = 4e6, t = 1, alpha = alpha))
	league4 <- sort(rPareto(n = 8e6, t = 1, alpha = alpha))
	league5 <- sort(rPareto(n = 16e6, t = 1, alpha = alpha))

	dat_talent = data.frame(
		id = 1:(5*l_size), 
		league = c(rep(1, l_size), rep(2, l_size), rep(3, l_size), rep(4, l_size), rep(5, l_size)), 
		talent = c(tail(league1, l_size), tail(league2, l_size), tail(league3, l_size), 
							 tail(league4, l_size), tail(league5, l_size)))
	
	averages1 <- order_qnorm(map_Pareto_vals_vec(tail(league1, l_size), alpha = alpha, npop = 1e6), mean = 0.280, sd = 0.040)
	averages2 <- order_qnorm(map_Pareto_vals_vec(tail(league2, l_size), alpha = alpha, npop = 2e6), mean = 0.275, sd = 0.0375)
	averages3 <- order_qnorm(map_Pareto_vals_vec(tail(league3, l_size), alpha = alpha, npop = 4e6), mean = 0.270, sd = 0.035)
	averages4 <- order_qnorm(map_Pareto_vals_vec(tail(league4, l_size), alpha = alpha, npop = 8e6), mean = 0.265, sd = 0.0325)
	averages5 <- order_qnorm(map_Pareto_vals_vec(tail(league5, l_size), alpha = alpha, npop = 16e6), mean = 0.260, sd = 0.03)
	
	dat_averages = data.frame(
		id = 1:(5*l_size),   
		league = c(rep(1, l_size), rep(2, l_size), rep(3, l_size), rep(4, l_size), rep(5, l_size)), 
		averages = c(as.vector(averages1), as.vector(averages2), as.vector(averages3), 
								 as.vector(averages4), as.vector(averages5)))
	dat_Zscores = data.frame(
		id = 1:(5*l_size),   
		league = c(rep(1, l_size), rep(2, l_size), rep(3, l_size), rep(4, l_size), rep(5, l_size)), 
		Zscores = c(as.vector(scale(averages1)), as.vector(scale(averages2)), as.vector(scale(averages3)),
								as.vector(scale(averages4)), as.vector(scale(averages5))))
	
	# correct population
	batters_talent_AVG <- do.call(rbind, mclapply(1:5, mc.cores = ncores, function(yy){
		foo <- dat_averages %>% filter(league == yy) %>% arrange(averages)
		nsys <- nrow(foo)
		mu_AVG <- mean(foo$averages)
		sd_AVG <- sd(foo$averages)
		AVG_sorted <- foo$averages
		pops <- 1e6 * 2^(yy - 1)
		u_int <- order_pnorm_vec(AVG_sorted, mean = mu_AVG, sd = sd_AVG)
		foo <- foo %>% mutate(AVG_talent = order_Pareto_vec(u_int, npop = pops))
		foo
	})) %>% arrange(-AVG_talent)
	
	# missed population (1/2, 3/4, 5/6, 7/8, 9/10)
	batters_talent_AVG_Nmiss1 <- do.call(rbind, mclapply(1:5, mc.cores = ncores, function(yy){
		foo <- dat_averages %>% filter(league == yy) %>% arrange(averages)
		nsys <- nrow(foo)
		mu_AVG <- mean(foo$averages)
		sd_AVG <- sd(foo$averages)
		AVG_sorted <- foo$averages
		pops <- 1e6 * 2^(yy - 1) * (1 - 1/(2*yy))
		u_int <- order_pnorm_vec(AVG_sorted, mean = mu_AVG, sd = sd_AVG)
		foo <- foo %>% mutate(AVG_talent = order_Pareto_vec(u_int, npop = pops))
		foo
	})) %>% arrange(-AVG_talent)

	# missed population (1, 1/2, 1/3, 1/4, 1/5)
	batters_talent_AVG_Nmiss2 <- do.call(rbind, mclapply(1:5, mc.cores = ncores, function(yy){
		foo <- dat_averages %>% filter(league == yy) %>% arrange(averages)
		nsys <- nrow(foo)
		mu_AVG <- mean(foo$averages)
		sd_AVG <- sd(foo$averages)
		AVG_sorted <- foo$averages
		pops <- 1e6 * 2^(yy - 1) * (1/yy)
		u_int <- order_pnorm_vec(AVG_sorted, mean = mu_AVG, sd = sd_AVG)
		foo <- foo %>% mutate(AVG_talent = order_Pareto_vec(u_int, npop = pops))
		foo
	})) %>% arrange(-AVG_talent)
	
	# how many in top 25 correctly identified
	Pareto_correct <- c(
		## Full House Method (N correct)
		length(which((batters_talent_AVG %>% arrange(-AVG_talent))[1:25, 1] %in% 
								 	(dat_talent %>% arrange(-talent))[1:25, 1])), 
		## Full House Method (N incorrect 1)
		length(which((batters_talent_AVG_Nmiss1 %>% arrange(-AVG_talent))[1:25, 1] %in% 
								 	(dat_talent %>% arrange(-talent))[1:25, 1])),
		## Full House Method (N incorrect 2)
		length(which((batters_talent_AVG_Nmiss2 %>% arrange(-AVG_talent))[1:25, 1] %in% 
								 	(dat_talent %>% arrange(-talent))[1:25, 1])),
		## Z scores
		length(which((dat_Zscores %>% arrange(-Zscores))[1:25, 1] %in% 
								 	(dat_talent %>% arrange(-talent))[1:25, 1])),
		## raw averages
		length(which((dat_averages %>% arrange(-averages))[1:25, 1] %in% 
								 	(dat_talent %>% arrange(-talent))[1:25, 1])))
	
	
	### Misspecified Pareto talent model (alpha2)
	league1 <- sort(rPareto(n = 1e6, t = 1, alpha = alpha2))
	league2 <- sort(rPareto(n = 2e6, t = 1, alpha = alpha2))
	league3 <- sort(rPareto(n = 4e6, t = 1, alpha = alpha2))
	league4 <- sort(rPareto(n = 8e6, t = 1, alpha = alpha2))
	league5 <- sort(rPareto(n = 16e6, t = 1, alpha = alpha2))
	
	dat_talent = data.frame(
		id = 1:(5*l_size), 
		league = c(rep(1, l_size), rep(2, l_size), rep(3, l_size), rep(4, l_size), rep(5, l_size)), 
		talent = c(tail(league1, l_size), tail(league2, l_size), tail(league3, l_size), 
							 tail(league4, l_size), tail(league5, l_size)))

	averages1 <- order_qnorm(map_Pareto_vals_vec(tail(league1, l_size), alpha = alpha2, npop = 1e6), mean = 0.280, sd = 0.040)
	averages2 <- order_qnorm(map_Pareto_vals_vec(tail(league2, l_size), alpha = alpha2, npop = 2e6), mean = 0.275, sd = 0.0375)
	averages3 <- order_qnorm(map_Pareto_vals_vec(tail(league3, l_size), alpha = alpha2, npop = 4e6), mean = 0.270, sd = 0.035)
	averages4 <- order_qnorm(map_Pareto_vals_vec(tail(league4, l_size), alpha = alpha2, npop = 8e6), mean = 0.265, sd = 0.0325)
	averages5 <- order_qnorm(map_Pareto_vals_vec(tail(league5, l_size), alpha = alpha2, npop = 16e6), mean = 0.260, sd = 0.03)
	
	dat_averages = data.frame(
		id = 1:(5*l_size),   
		league = c(rep(1, l_size), rep(2, l_size), rep(3, l_size), rep(4, l_size), rep(5, l_size)), 
		averages = c(as.vector(averages1), as.vector(averages2), as.vector(averages3), 
								 as.vector(averages4), as.vector(averages5)))

	dat_Zscores = data.frame(
		id = 1:(5*l_size),   
		league = c(rep(1, l_size), rep(2, l_size), rep(3, l_size), rep(4, l_size), rep(5, l_size)), 
		Zscores = c(as.vector(scale(averages1)), as.vector(scale(averages2)), as.vector(scale(averages3)),
								as.vector(scale(averages4)), as.vector(scale(averages5))))

	# correct population
	batters_talent_AVG <- do.call(rbind, mclapply(1:5, mc.cores = ncores, function(yy){
		foo <- dat_averages %>% filter(league == yy) %>% arrange(averages)
		nsys <- nrow(foo)
		mu_AVG <- mean(foo$averages)
		sd_AVG <- sd(foo$averages)
		AVG_sorted <- foo$averages
		pops <- 1e6 * 2^(yy - 1)
		u_int <- order_pnorm_vec(AVG_sorted, mean = mu_AVG, sd = sd_AVG)
		foo <- foo %>% mutate(AVG_talent = order_Pareto_vec(u_int, npop = pops))
		foo
	})) %>% arrange(-AVG_talent)

	# missed population (1/2, 3/4, 5/6, 7/8, 9/10)
	batters_talent_AVG_Nmiss1 <- do.call(rbind, mclapply(1:5, mc.cores = ncores, function(yy){
		foo <- dat_averages %>% filter(league == yy) %>% arrange(averages)
		nsys <- nrow(foo)
		mu_AVG <- mean(foo$averages)
		sd_AVG <- sd(foo$averages)
		AVG_sorted <- foo$averages
		pops <- 1e6 * 2^(yy - 1) * (1 - 1/(2*yy))
		u_int <- order_pnorm_vec(AVG_sorted, mean = mu_AVG, sd = sd_AVG)
		foo <- foo %>% mutate(AVG_talent = order_Pareto_vec(u_int, npop = pops))
		foo
	})) %>% arrange(-AVG_talent)

	# missed population (1, 1/2, 1/3, 1/4, 1/5)
	batters_talent_AVG_Nmiss2 <- do.call(rbind, mclapply(1:5, mc.cores = ncores, function(yy){
		foo <- dat_averages %>% filter(league == yy) %>% arrange(averages)
		nsys <- nrow(foo)
		mu_AVG <- mean(foo$averages)
		sd_AVG <- sd(foo$averages)
		AVG_sorted <- foo$averages
		pops <- 1e6 * 2^(yy - 1) * (1/yy)
		u_int <- order_pnorm_vec(AVG_sorted, mean = mu_AVG, sd = sd_AVG)
		foo <- foo %>% mutate(AVG_talent = order_Pareto_vec(u_int, npop = pops))
		foo
	})) %>% arrange(-AVG_talent)

	# how many in top 25 correctly identified
	Pareto_incorrect <- c(
		## Full House Method (N correct)
		length(which((batters_talent_AVG %>% arrange(-AVG_talent))[1:25, 1] %in% 
								 	(dat_talent %>% arrange(-talent))[1:25, 1])), 
		## Full House Method (N incorrect 1)
		length(which((batters_talent_AVG_Nmiss1 %>% arrange(-AVG_talent))[1:25, 1] %in% 
								 	(dat_talent %>% arrange(-talent))[1:25, 1])),
		## Full House Method (N incorrect 2)
		length(which((batters_talent_AVG_Nmiss2 %>% arrange(-AVG_talent))[1:25, 1] %in% 
								 	(dat_talent %>% arrange(-talent))[1:25, 1])),
		## Z scores
		length(which((dat_Zscores %>% arrange(-Zscores))[1:25, 1] %in% 
								 	(dat_talent %>% arrange(-talent))[1:25, 1])),
		## raw averages
		length(which((dat_averages %>% arrange(-averages))[1:25, 1] %in% 
								 	(dat_talent %>% arrange(-talent))[1:25, 1])))
	
	
	### Misspecified Normal talent model
	league1 <- sort(rnorm(n = 1e6, mean = 0, sd = 1))
	league2 <- sort(rnorm(n = 2e6, mean = 0, sd = 1))
	league3 <- sort(rnorm(n = 4e6, mean = 0, sd = 1))
	league4 <- sort(rnorm(n = 8e6, mean = 0, sd = 1))
	league5 <- sort(rnorm(n = 16e6, mean = 0, sd = 1))
	
	dat_talent = data.frame(
		id = 1:(5*l_size), 
		league = c(rep(1, l_size), rep(2, l_size), rep(3, l_size), rep(4, l_size), rep(5, l_size)), 
		talent = c(tail(league1, l_size), tail(league2, l_size), tail(league3, l_size), 
							 tail(league4, l_size), tail(league5, l_size)))
	
	averages1 <- order_qnorm(map_Normal_vals_vec(tail(league1, l_size), npop = 1e6), mean = 0.280, sd = 0.040)
	averages2 <- order_qnorm(map_Normal_vals_vec(tail(league2, l_size), npop = 2e6), mean = 0.275, sd = 0.0375)
	averages3 <- order_qnorm(map_Normal_vals_vec(tail(league3, l_size), npop = 4e6), mean = 0.270, sd = 0.035)
	averages4 <- order_qnorm(map_Normal_vals_vec(tail(league4, l_size), npop = 8e6), mean = 0.265, sd = 0.0325)
	averages5 <- order_qnorm(map_Normal_vals_vec(tail(league5, l_size), npop = 16e6), mean = 0.260, sd = 0.03)
	
	dat_averages = data.frame(
		id = 1:(5*l_size),   
		league = c(rep(1, l_size), rep(2, l_size), rep(3, l_size), rep(4, l_size), rep(5, l_size)), 
		averages = c(as.vector(averages1), as.vector(averages2), as.vector(averages3), 
								 as.vector(averages4), as.vector(averages5)))
	
	dat_Zscores = data.frame(
		id = 1:(5*l_size),   
		league = c(rep(1, l_size), rep(2, l_size), rep(3, l_size), rep(4, l_size), rep(5, l_size)), 
		Zscores = c(as.vector(scale(averages1)), as.vector(scale(averages2)), as.vector(scale(averages3)),
								as.vector(scale(averages4)), as.vector(scale(averages5))))
	
	# correct population
	batters_talent_AVG <- do.call(rbind, mclapply(1:5, mc.cores = ncores, function(yy){
		foo <- dat_averages %>% filter(league == yy) %>% arrange(averages)
		nsys <- nrow(foo)
		mu_AVG <- mean(foo$averages)
		sd_AVG <- sd(foo$averages)
		AVG_sorted <- foo$averages
		pops <- 1e6 * 2^(yy - 1)
		u_int <- order_pnorm_vec(AVG_sorted, mean = mu_AVG, sd = sd_AVG)
		foo <- foo %>% mutate(AVG_talent = order_normal_vec(u_int, npop = pops))
		foo
	})) %>% arrange(-AVG_talent)
	
	# missed population (1/2, 3/4, 5/6, 7/8, 9/10)
	batters_talent_AVG_Nmiss1 <- do.call(rbind, mclapply(1:5, mc.cores = ncores, function(yy){
		foo <- dat_averages %>% filter(league == yy) %>% arrange(averages)
		nsys <- nrow(foo)
		mu_AVG <- mean(foo$averages)
		sd_AVG <- sd(foo$averages)
		AVG_sorted <- foo$averages
		pops <- 1e6 * 2^(yy - 1) * (1 - 1/(2*yy))
		u_int <- order_pnorm_vec(AVG_sorted, mean = mu_AVG, sd = sd_AVG)
		foo <- foo %>% mutate(AVG_talent = order_normal_vec(u_int, npop = pops))
		foo
	})) %>% arrange(-AVG_talent)
	
	# missed population (1, 1/2, 1/3, 1/4, 1/5)
	batters_talent_AVG_Nmiss2 <- do.call(rbind, mclapply(1:5, mc.cores = ncores, function(yy){
		foo <- dat_averages %>% filter(league == yy) %>% arrange(averages)
		nsys <- nrow(foo)
		mu_AVG <- mean(foo$averages)
		sd_AVG <- sd(foo$averages)
		AVG_sorted <- foo$averages
		pops <- 1e6 * 2^(yy - 1) * (1/yy)
		u_int <- order_pnorm_vec(AVG_sorted, mean = mu_AVG, sd = sd_AVG)
		foo <- foo %>% mutate(AVG_talent = order_normal_vec(u_int, npop = pops))
		foo
	})) %>% arrange(-AVG_talent)
	
	## Full House Method (N correct)
	length(which((batters_talent_AVG %>% arrange(-AVG_talent))[1:25, 1] %in% 
							 	(dat_talent %>% arrange(-talent))[1:25, 1]))
	
	## Full House Method (N incorrect 1)
	length(which((batters_talent_AVG_Nmiss1 %>% arrange(-AVG_talent))[1:25, 1] %in% 
							 	(dat_talent %>% arrange(-talent))[1:25, 1]))
	
	## Full House Method (N incorrect 2)
	length(which((batters_talent_AVG_Nmiss2 %>% arrange(-AVG_talent))[1:25, 1] %in% 
							 	(dat_talent %>% arrange(-talent))[1:25, 1]))
	
	## Z scores
	length(which((dat_Zscores %>% arrange(-Zscores))[1:25, 1] %in% 
							 	(dat_talent %>% arrange(-talent))[1:25, 1]))
	
	## raw averages
	length(which((dat_averages %>% arrange(-averages))[1:25, 1] %in% 
							 	(dat_talent %>% arrange(-talent))[1:25, 1]))
	
	
	# how many in top 25 correctly identified
	Normal_incorrect <- c(
		## Full House Method (N correct)
		length(which((batters_talent_AVG %>% arrange(-AVG_talent))[1:25, 1] %in% 
								 	(dat_talent %>% arrange(-talent))[1:25, 1])), 
		## Full House Method (N incorrect 1)
		length(which((batters_talent_AVG_Nmiss1 %>% arrange(-AVG_talent))[1:25, 1] %in% 
								 	(dat_talent %>% arrange(-talent))[1:25, 1])),
		## Full House Method (N incorrect 2)
		length(which((batters_talent_AVG_Nmiss2 %>% arrange(-AVG_talent))[1:25, 1] %in% 
								 	(dat_talent %>% arrange(-talent))[1:25, 1])),
		## Z scores
		length(which((dat_Zscores %>% arrange(-Zscores))[1:25, 1] %in% 
								 	(dat_talent %>% arrange(-talent))[1:25, 1])),
		## raw averages
		length(which((dat_averages %>% arrange(-averages))[1:25, 1] %in% 
								 	(dat_talent %>% arrange(-talent))[1:25, 1])))
	
	### incorrect folded normal talent model	
	league1 <- sort(rfoldnorm(n = 1e6))
	league2 <- sort(rfoldnorm(n = 2e6))
	league3 <- sort(rfoldnorm(n = 4e6))
	league4 <- sort(rfoldnorm(n = 8e6))
	league5 <- sort(rfoldnorm(n = 16e6))
	
	dat_talent = data.frame(
	  id = 1:(5*l_size), 
	  league = c(rep(1, l_size), rep(2, l_size), rep(3, l_size), rep(4, l_size), rep(5, l_size)), 
	  talent = c(tail(league1, l_size), tail(league2, l_size), tail(league3, l_size), 
	             tail(league4, l_size), tail(league5, l_size)))
	
	averages1 <- order_qnorm(map_foldedN_vals_vec(tail(league1, l_size), npop = 1e6), mean = 0.280, sd = 0.040)
	averages2 <- order_qnorm(map_foldedN_vals_vec(tail(league2, l_size), npop = 2e6), mean = 0.275, sd = 0.0375)
	averages3 <- order_qnorm(map_foldedN_vals_vec(tail(league3, l_size), npop = 4e6), mean = 0.270, sd = 0.035)
	averages4 <- order_qnorm(map_foldedN_vals_vec(tail(league4, l_size), npop = 8e6), mean = 0.265, sd = 0.0325)
	averages5 <- order_qnorm(map_foldedN_vals_vec(tail(league5, l_size), npop = 16e6), mean = 0.260, sd = 0.03)
	
	dat_averages = data.frame(
	  id = 1:(5*l_size),   
	  league = c(rep(1, l_size), rep(2, l_size), rep(3, l_size), rep(4, l_size), rep(5, l_size)), 
	  averages = c(as.vector(averages1), as.vector(averages2), as.vector(averages3), 
	               as.vector(averages4), as.vector(averages5)))
	dat_Zscores = data.frame(
	  id = 1:(5*l_size),   
	  league = c(rep(1, l_size), rep(2, l_size), rep(3, l_size), rep(4, l_size), rep(5, l_size)), 
	  Zscores = c(as.vector(scale(averages1)), as.vector(scale(averages2)), as.vector(scale(averages3)),
	              as.vector(scale(averages4)), as.vector(scale(averages5))))
	
	# correct population
	batters_talent_AVG <- do.call(rbind, mclapply(1:5, mc.cores = ncores, function(yy){
	  foo <- dat_averages %>% filter(league == yy) %>% arrange(averages)
	  nsys <- nrow(foo)
	  mu_AVG <- mean(foo$averages)
	  sd_AVG <- sd(foo$averages)
	  AVG_sorted <- foo$averages
	  pops <- 1e6 * 2^(yy - 1)
	  u_int <- order_pnorm_vec(AVG_sorted, mean = mu_AVG, sd = sd_AVG)
	  foo <- foo %>% mutate(AVG_talent = order_foldedN_vec(u_int, npop = pops))
	  foo
	})) %>% arrange(-AVG_talent)
	
	# missed population (1/2, 3/4, 5/6, 7/8, 9/10)
	batters_talent_AVG_Nmiss1 <- do.call(rbind, mclapply(1:5, mc.cores = ncores, function(yy){
	  foo <- dat_averages %>% filter(league == yy) %>% arrange(averages)
	  nsys <- nrow(foo)
	  mu_AVG <- mean(foo$averages)
	  sd_AVG <- sd(foo$averages)
	  AVG_sorted <- foo$averages
	  pops <- 1e6 * 2^(yy - 1) * (1 - 1/(2*yy))
	  u_int <- order_pnorm_vec(AVG_sorted, mean = mu_AVG, sd = sd_AVG)
	  foo <- foo %>% mutate(AVG_talent = order_foldedN_vec(u_int, npop = pops))
	  foo
	})) %>% arrange(-AVG_talent)
	
	# missed population (1, 1/2, 1/3, 1/4, 1/5)
	batters_talent_AVG_Nmiss2 <- do.call(rbind, mclapply(1:5, mc.cores = ncores, function(yy){
	  foo <- dat_averages %>% filter(league == yy) %>% arrange(averages)
	  nsys <- nrow(foo)
	  mu_AVG <- mean(foo$averages)
	  sd_AVG <- sd(foo$averages)
	  AVG_sorted <- foo$averages
	  pops <- 1e6 * 2^(yy - 1) * (1/yy)
	  u_int <- order_pnorm_vec(AVG_sorted, mean = mu_AVG, sd = sd_AVG)
	  foo <- foo %>% mutate(AVG_talent = order_foldedN_vec(u_int, npop = pops))
	  foo
	})) %>% arrange(-AVG_talent)
	
	# how many in top 25 correctly identified
	foldedN_incorrect <- c(
	  ## Full House Method (N correct)
	  length(which((batters_talent_AVG %>% arrange(-AVG_talent))[1:25, 1] %in% 
	                 (dat_talent %>% arrange(-talent))[1:25, 1])), 
	  ## Full House Method (N correct)
	  length(which((batters_talent_AVG_Nmiss1 %>% arrange(-AVG_talent))[1:25, 1] %in% 
	                 (dat_talent %>% arrange(-talent))[1:25, 1])),
	  ## Full House Method (N incorrect 4)
	  length(which((batters_talent_AVG_Nmiss2 %>% arrange(-AVG_talent))[1:25, 1] %in% 
	                 (dat_talent %>% arrange(-talent))[1:25, 1])),
	  ## Z scores (N incorrect 13)
	  length(which((dat_Zscores %>% arrange(-Zscores))[1:25, 1] %in% 
	                 (dat_talent %>% arrange(-talent))[1:25, 1])),
	  ## raw averages (N incorrect 20)
	  length(which((dat_averages %>% arrange(-averages))[1:25, 1] %in% 
	                 (dat_talent %>% arrange(-talent))[1:25, 1])))
	
	
	
	
	
	
	 # output
	 c(Pareto_correct, Pareto_incorrect, Normal_incorrect, foldedN_incorrect)
		
}

set.seed(13)
out <- do.call(rbind, mclapply(1:200, function(xx) Full_House_averages_simulator(), mc.cores = 7))
out <- as.data.frame(out)

m_out <- do.call(rbind, mclapply(1:20, function(xx) cbind(out[,xx], case = xx %% 5), mc.cores = 7))
m_out <- as.data.frame(m_out, stringsAsFactors=FALSE)
dist <- c(rep('A',1000), rep('B',1000), rep('C',1000), rep('D',1000))
m_out <- cbind(m_out, index = dist, rank = m_out$case)
m_out$rank[m_out$rank == 0] <- 5

m_out$case[m_out$case == 1] <- 'Correct Population'
m_out$case[m_out$case == 2] <- 'Population Estimation Improved'
m_out$case[m_out$case == 3] <- 'Population Estimation Deteriorated'
m_out$case[m_out$case == 4] <- 'Z-Scores'
m_out$case[m_out$case == 0] <- 'Raw BA'

library(ggpubr)
m_out$index[m_out$index == 'A'] = 'Pareto Distribution'
m_out$index[m_out$index == 'B'] = 'Misspecified Pareto Distribution'
m_out$index[m_out$index == 'C'] = 'Normal Distribution'
m_out$index[m_out$index == 'D'] = 'Folded Normal Distribution'
```

## Figure 3: Distribution sensitivity analysis in the paper

```{r echo=FALSE, fig.height = 10, fig.width = 20, fig.align = "center"}
ggplot() + geom_boxplot(data = m_out[1:1000,], mapping = aes(y=V1, x = reorder(case, -rank), color = case), lwd = 1) +
  geom_point(data = m_out[1:1000,], mapping = aes(y=V1, x = case, color = case))  + 
  geom_jitter(data = m_out[1:1000,], mapping = aes(y=V1, x = case, color = case), shape=16, position=position_jitter(0.2))  + 
  geom_boxplot(data = m_out[1001:2000,], mapping = aes(y=V1, x = case, color = case), lwd = 1) +
  geom_point(data = m_out[1001:2000,], mapping = aes(y=V1, x = case, color = case))  + 
  geom_jitter(data = m_out[1001:2000,], mapping = aes(y=V1, x = case, color = case), shape=16, position=position_jitter(0.2)) + 
  geom_boxplot(data = m_out[2001:3000,], mapping = aes(y=V1, x = case, color = case), lwd = 1) +
  geom_point(data = m_out[2001:3000,], mapping = aes(y=V1, x = case, color = case))  + 
  geom_jitter(data = m_out[2001:3000,], mapping = aes(y=V1, x = case, color = case), shape=16, position=position_jitter(0.2)) + 
  geom_boxplot(data = m_out[3001:4000,], mapping = aes(y=V1, x = case, color = case), lwd = 1) +
  geom_point(data = m_out[3001:4000,], mapping = aes(y=V1, x = case, color = case))  + 
  geom_jitter(data = m_out[3001:4000,], mapping = aes(y=V1, x = case, color = case), shape=16, position=position_jitter(0.2))  + 
  facet_grid(cols = vars(index))+ coord_flip()  +  xlab("") + ylab('Number of Players that are Correctly Identified in Top-25 Talents')
```

## Table 5: Comparsion between deteriorated estimation regime and Z-scores in the paper.

```{r echo=FALSE}

# The probability that incorrect Full House Model beats or ties Schell’s method and strictly beats Schell’s method

m <- rowMeans(apply(out, 1, function(xx){
	c(as.numeric(xx[3] >= xx[4]), as.numeric(xx[8] >= xx[9]), as.numeric(xx[13] >= xx[14]), as.numeric(xx[18] >= xx[19]), 
		as.numeric(xx[3] > xx[4]), as.numeric(xx[8] > xx[9]), as.numeric(xx[13] > xx[14]), as.numeric(xx[18] > xx[19]))
}))

n <- as.data.frame(t(matrix(m, nrow = 4)))
colnames(n) <- c('correct Pareto dist', 'incorrect Pareto dist', 'normal dist', 'folded normal dist')
rownames(n) <- c('beat or ties', 'strictly beat')
kable(n)

```

## Ranking Lists Using Different Talent Generating Process

In this section, we use different talent generating process to verify the robustness of the model. 

```{r cache=TRUE, echo=FALSE}
library(VGAM)
batters <- bat_dat %>% select(yearID, playerID, lgID, name, age, PA, G, bWAR, pops)
cutoff <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    m <- batters %>% filter(yearID == xx) %>% filter(PA >= 75)
    data.frame(thres = median(m$PA), yearID = xx)
  }))
batters <- merge(batters, cutoff, by = 'yearID')
batters <- batters %>% mutate(comp =  bWAR / G, full_time = ifelse(PA >= thres, 'Y', 'N'))

batters_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- batters %>% filter(yearID == xx)
    lg_avg <- sum(int$bWAR)/sum(int$G)
    int %>% mutate(comp = (bWAR + lg_avg * 7)/(G + 7))
  }))



batters_talent_bWAR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
  talent_computing_nonpara_folded(dataset = batters_schell, component_name = "bWAR", year = yy, ystar = thresh_fun(component = batters_schell %>% filter(full_time == 'Y', yearID == yy) %>% select(comp), component_name = 'bWAR')) })) %>% arrange(-WAR_talent)

no_strike <- batters_talent_bWAR %>% 
    filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  
t <- isoreg(no_strike$WAR_talent, no_strike$comp)
talent_new <- quantile(no_strike$WAR_talent, probs = (seq(0,250)/250))
comp_new <- as.stepfun(t)(talent_new)
 
ystar <- thresh_fun(comp_new, component_name = 'bWAR')
pop_new <- round(mean(no_strike$pops))
component_name = 'bWAR'
yy <- sort(comp_new)
n <- length(yy)
ytilde <- rep(0, n + 1)
if (component_name == 'bWAR' | component_name == 'fWAR') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
}
if (component_name == 'HR' | component_name == 'BB') {
    # since the minimal HR is greater or equal to 0.
    ytilde[1] <- 0
}
ytilde[n+1] <- yy[n] + ystar
ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2 
}))

career_kAB_1st <- do.call(rbind, mclapply(1:30000, function(zz){
    int <- career_talent_nonpara_folded(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                         snippet = batters_talent_bWAR[zz,])
    int
  }, mc.cores = ncores))
  
  
career_kAB_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
    int <- career_talent_nonpara_folded(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                         snippet = batters_talent_bWAR[zz,])
    int
  }, mc.cores = ncores)) 
  
career_kAB_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_bWAR), function(zz){
    int <- career_talent_nonpara_folded(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                         snippet = batters_talent_bWAR[zz,])
    int
  }, mc.cores = ncores)) 
  
career_kAB <- rbind(career_kAB_1st, career_kAB_2nd, career_kAB_3rd)

mapped_quan_b_raw <- do.call(rbind, mclapply(years, function(xx){
    batters_full <- batters %>% filter(yearID == xx) %>% 
      filter(full_time == 'Y') %>% arrange(-G)
    batters_less <- batters %>% filter(yearID == xx) %>% 
      filter(full_time == 'N') %>% arrange(-G)
    
    n1 <- nrow(batters_full)
    n2 <- nrow(batters_less)
    
    mapped_G_full <- c()
    mapped_G_less <- c()
    for (yy in c(1977:1980, 1982:1989)) {
      batters_ref_full <- batters %>% 
        filter(yearID == yy, full_time == 'Y') %>% arrange(-G)
      batters_ref_less <- batters %>% 
        filter(yearID == yy, full_time == 'N') %>% arrange(-G)
      n1r <- nrow(batters_ref_full)
      n2r <- nrow(batters_ref_less)
      
      mapped_G_full <- cbind(mapped_G_full, approx(x = seq((n1r-1),0)/(n1r-1), 
                                                   y = batters_ref_full$G, 
                                                   xout = seq((n1-1),0)/(n1-1))$y)
      mapped_G_less <- cbind(mapped_G_less, approx(x = seq((n2r-1),0)/(n2r-1), 
                                                   y = batters_ref_less$G, 
                                                   xout = seq((n2-1),0)/(n2-1))$y)
    }
    
    batters_full$mapped_G <- rowMeans(mapped_G_full)
    batters_less$mapped_G <- rowMeans(mapped_G_less)
    
    
    batters_full <- batters_full %>% arrange(-PA)
    batters_less <- batters_less %>% arrange(-PA)
    mapped_PA_full <- c()
    mapped_PA_less <- c()
    for (yy in c(1977:1980, 1982:1989)) {
      batters_ref_full <- batters %>% 
        filter(yearID == yy, full_time == 'Y') %>% arrange(-PA)
      batters_ref_less <- batters %>% 
        filter(yearID == yy, full_time == 'N') %>% arrange(-PA)
      n1r <- nrow(batters_ref_full)
      n2r <- nrow(batters_ref_less)
      
      mapped_PA_full <- cbind(mapped_PA_full, approx(x = seq((n1r-1),0)/(n1r-1), 
                                                     y = batters_ref_full$PA, 
                                                     xout = seq((n1-1),0)/(n1-1))$y)
      mapped_PA_less <- cbind(mapped_PA_less, approx(x = seq((n2r-1),0)/(n2r-1), 
                                                     y = batters_ref_less$PA, 
                                                     xout = seq((n2-1),0)/(n2-1))$y)
    }
    
    batters_full$mapped_PA <- rowMeans(mapped_PA_full)
    batters_less$mapped_PA <- rowMeans(mapped_PA_less)
    
    m <- rbind(batters_full, batters_less)
    data.frame(playerID = m$playerID, yearID = m$yearID,
               mapped_G_raw = round(m$mapped_G), mapped_PA_raw = round(m$mapped_PA))
    
  }, mc.cores = ncores))
   
mapped_batters_1 <- merge(career_kAB, mapped_quan_b_raw, 
                            by = c('playerID', 'yearID'))
  
min_refbWAR <- -2
  
mapped_batters_bWAR <- mapped_batters_1 %>% 
    mutate(adj_bWAR = adj_comp * mapped_G_raw) %>% 
    mutate(adj_bWAR = ifelse(adj_bWAR < min_refbWAR, min_refbWAR, adj_bWAR)) %>%
    mutate(mapped_G_bWAR = round(adj_bWAR / adj_comp))

career_bat_folded <- mapped_batters_bWAR %>% group_by(playerID) %>%
  summarise(name = unique(name), 
            adj_bWAR = sum(adj_bWAR)) %>%
  arrange(desc(adj_bWAR))
```


```{r cache=TRUE, echo=FALSE}
foo <- getRetrosheet(type = "game", year = 2022)
rotation_bound <- as.data.frame(cbind(years, unlist(mclapply(years, mc.cores = ncores, function(yr){
    foo <- getRetrosheet(type = "game", year = yr)
    Tms <- unique(foo$HmTm)
    
    starter <- lapply(Tms, function(tm){
      bar <- foo %>% filter(VisTm == tm | HmTm == tm) %>% 
        select(VisTm, HmTm, VisStPchID, HmStPchID, VisTmGNum, HmTmGNum)
      t(apply(bar, 1, function(xx){
        y <- NULL
        if(xx[2] == tm){
          y <- xx[4]
        }
        else{
          y <- xx[3]
        }
      })) 
    })
    
    y <- unlist(lapply(starter, function(xx){
      unlist(lapply(1:length(xx), function(j){
        flag <- TRUE
        k <- 1
        if(j > 1){
          while(flag){
            flag <- length(xx[(j-k):j]) == length(unique(xx[(j-k):j]))
            if(!flag){
              break
            }
            else{
              k <- k + 1
            }
            if(k == j){
              break
            }
          }
        }
        k
      }))
    }))
    mean(y)
    
  }))))

pitchers <- pit_dat %>% 
    select(playerID, yearID, name, age, lgID, teamID, IP, pops, bWAR)
  pitchers <- pitchers %>% mutate(comp = bWAR / IP)
  pitchers$comp[is.na(pitchers$comp)] = 0
  
  rotation_bound <- as.data.frame(cbind(years, unlist(mclapply(years, mc.cores = ncores, function(yr){
    foo <- getRetrosheet(type = "game", year = yr)
    Tms <- unique(foo$HmTm)
    
    starter <- lapply(Tms, function(tm){
      bar <- foo %>% filter(VisTm == tm | HmTm == tm) %>% 
        select(VisTm, HmTm, VisStPchID, HmStPchID, VisTmGNum, HmTmGNum)
      t(apply(bar, 1, function(xx){
        y <- NULL
        if(xx[2] == tm){
          y <- xx[4]
        }
        else{
          y <- xx[3]
        }
      })) 
    })
    
    y <- unlist(lapply(starter, function(xx){
      unlist(lapply(1:length(xx), function(j){
        flag <- TRUE
        k <- 1
        if(j > 1){
          while(flag){
            flag <- length(xx[(j-k):j]) == length(unique(xx[(j-k):j]))
            if(!flag){
              break
            }
            else{
              k <- k + 1
            }
            if(k == j){
              break
            }
          }
        }
        k
      }))
    }))
    mean(y)
    
  }))))
  
  unique_team <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    c(xx, nrow(unique(pitchers %>% filter(yearID == xx) %>% select(teamID))))
  }))
  
  rotation_player <- data.frame(yearID = years, rotation = ceiling(rotation_bound[,2] * unique_team[,2]))
  
  cutoff <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    m <- pitchers %>% filter(yearID == xx) %>% arrange(-IP)
    index <- rotation_player$rotation[rotation_player$yearID == xx]
    data.frame(thres = (m$IP[index]), yearID = xx)
  }))
  
  pitchers <- merge(pitchers, cutoff, by = 'yearID')
  
  pitchers <- pitchers %>% mutate(full_time = ifelse(IP >= thres, 'Y', 'N'))
  
  pitchers_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- pitchers %>% filter(yearID == xx)
    lg_avg <- sum(int$bWAR)/sum(int$IP)
    int %>% mutate(comp = (bWAR + lg_avg * 14)/(IP + 14))
  }))
  
  pitchers_talent_bWAR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
    talent_computing_nonpara_folded(dataset = pitchers_schell, component_name = "bWAR_p", year = yy, 
                             ystar = thresh_fun(component = pitchers_schell %>% 
                                                 filter(full_time =='Y', yearID == yy) %>%
                                                 select(comp), component_name = 'bWAR_p'))
  })) %>% arrange(-WAR_talent)
  
  no_strike <- pitchers_talent_bWAR %>% 
    filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  
  min_refbWAR <- -2
  
  t <- isoreg(no_strike$WAR_talent, no_strike$comp)
  
  talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,154)/154)
  comp_new <- as.stepfun(t)(talent_new)
  
  ystar <- thresh_fun(comp_new, component_name = 'bWAR_p')
  pop_new <- round(mean(no_strike$pops))
  component_name = 'bWAR_p'
  yy <- sort(comp_new)
  n <- length(yy)
  ytilde <- rep(0, n + 1)
  if (component_name == 'ERA') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
  }
  if (component_name == 'bWAR_p'| component_name == 'fWAR_p') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])/10
  }
  if (component_name == 'SO') {
    ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
  }
  ytilde[n+1] <- yy[n] + ystar
  ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2 
  }))
  
  career_kAB <- do.call(rbind, mclapply(1:nrow(pitchers_talent_bWAR), function(xx){
    int <- career_talent_nonpara_folded(dataset = pitchers_talent_bWAR, component_name = 'bWAR_p', 
                         snippet = pitchers_talent_bWAR[xx,])
    int
  }, mc.cores = ncores)) 
  
  ## mapping statistics
  
  mapped_quan_p <- do.call(rbind, mclapply(years, function(xx){
    pitchers_full <- pitchers %>% filter(yearID == xx) %>% 
      filter(full_time == 'Y') %>% arrange(-IP)
    pitchers_less <- pitchers %>% filter(yearID == xx) %>% 
      filter(full_time == 'N') %>% arrange(-IP)
    
    n1 <- nrow(pitchers_full)
    n2 <- nrow(pitchers_less)
    
    mapped_IP_full <- c()
    mapped_IP_less <- c()
    for (yy in c(1977:1980, 1982:1989)) {
      pitchers_ref_full <- pitchers %>% 
        filter(yearID == yy, full_time == 'Y') %>% arrange(-IP)
      pitchers_ref_less <- pitchers %>% 
        filter(yearID == yy, full_time == 'N') %>% arrange(-IP)
      n1r <- nrow(pitchers_ref_full)
      n2r <- nrow(pitchers_ref_less)
      
      mapped_IP_full <- cbind(mapped_IP_full, approx(x = seq((n1r-1),0)/(n1r-1), 
                                                     y = pitchers_ref_full$IP,
                                                     xout = seq((n1-1),0)/(n1-1))$y)
      mapped_IP_less <- cbind(mapped_IP_less, approx(x = seq((n2r-1),0)/(n2r-1), 
                                                     y = pitchers_ref_less$IP, 
                                                     xout = seq((n2-1),0)/(n2-1))$y)
    }
    
    pitchers_full$mapped_IP <- rowMeans(mapped_IP_full)
    pitchers_less$mapped_IP <- rowMeans(mapped_IP_less)
    
    m <- rbind(pitchers_full, pitchers_less)
    data.frame(playerID = m$playerID, yearID = m$yearID, 
               mapped_IP_raw = round(m$mapped_IP))
    
  }, mc.cores = ncores))
  
  mapped_pitchers_1 <- merge(career_kAB, mapped_quan_p, 
                             by = c('playerID', 'yearID'))
  
  mapped_pitchers_bWAR <- mapped_pitchers_1 %>% 
    mutate(adj_bWAR = adj_comp * mapped_IP_raw) %>%
    mutate(adj_bWAR = ifelse(adj_bWAR < min_refbWAR, min_refbWAR, adj_bWAR)) %>%
    mutate(mapped_IP_bWAR = round(adj_bWAR / adj_comp))
  career_pit_folded <- mapped_pitchers_bWAR %>% group_by(playerID) %>%
  summarise(name = unique(name), 
            adj_bWAR = sum(adj_bWAR)) %>%
  arrange(desc(adj_bWAR))
```


```{r echo=FALSE}
m_b <- career_bat_folded %>% 
  select(name, playerID, adj_bWAR)

m_p <- career_pit_folded %>% 
  select(name, playerID, adj_bWAR)

m_fold <- rbind(m_b, m_p)

index <- which(m_fold$name == "Babe Ruth")
m_fold$adj_bWAR[index[1]] <- sum(m_fold$adj_bWAR[index])
index <- which(m_fold$name == "Shohei Ohtani")
m_fold$adj_bWAR[index[1]] <- sum(m_fold$adj_bWAR[index])

#(m_fold %>% arrange(desc(adj_bWAR)))[1:25,]

```

```{r cache=TRUE, echo=FALSE}
batters <- bat_dat %>% select(yearID, playerID, lgID, name, age, PA, G, bWAR, pops)
cutoff <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    m <- batters %>% filter(yearID == xx) %>% filter(PA >= 75)
    data.frame(thres = median(m$PA), yearID = xx)
  }))
batters <- merge(batters, cutoff, by = 'yearID')
batters <- batters %>% mutate(comp =  bWAR / G, full_time = ifelse(PA >= thres, 'Y', 'N'))

batters_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- batters %>% filter(yearID == xx)
    lg_avg <- sum(int$bWAR)/sum(int$G)
    int %>% mutate(comp = (bWAR + lg_avg * 7)/(G + 7))
  }))



batters_talent_bWAR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
  talent_computing_nonpara_normal(dataset = batters_schell, component_name = "bWAR", year = yy, ystar = thresh_fun(component = batters_schell %>% filter(full_time == 'Y', yearID == yy) %>% select(comp), component_name = 'bWAR')) })) %>% arrange(-WAR_talent)

no_strike <- batters_talent_bWAR %>% 
    filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  
t <- isoreg(no_strike$WAR_talent, no_strike$comp)
talent_new <- quantile(no_strike$WAR_talent, probs = (seq(0,250)/250))
comp_new <- as.stepfun(t)(talent_new)
 
ystar <- thresh_fun(comp_new, component_name = 'bWAR')
pop_new <- round(mean(no_strike$pops))
component_name = 'bWAR'
yy <- sort(comp_new)
n <- length(yy)
ytilde <- rep(0, n + 1)
if (component_name == 'bWAR' | component_name == 'fWAR') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
}
if (component_name == 'HR' | component_name == 'BB') {
    # since the minimal HR is greater or equal to 0.
    ytilde[1] <- 0
}
ytilde[n+1] <- yy[n] + ystar
ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2 
}))

career_kAB_1st <- do.call(rbind, mclapply(1:30000, function(zz){
    int <- career_talent_nonpara_normal(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                         snippet = batters_talent_bWAR[zz,])
    int
  }, mc.cores = ncores))
  
  
career_kAB_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
    int <- career_talent_nonpara_normal(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                         snippet = batters_talent_bWAR[zz,])
    int
  }, mc.cores = ncores)) 
  
career_kAB_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_bWAR), function(zz){
    int <- career_talent_nonpara_normal(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                         snippet = batters_talent_bWAR[zz,])
    int
  }, mc.cores = ncores)) 
  
career_kAB <- rbind(career_kAB_1st, career_kAB_2nd, career_kAB_3rd)

mapped_quan_b_raw <- do.call(rbind, mclapply(years, function(xx){
    batters_full <- batters %>% filter(yearID == xx) %>% 
      filter(full_time == 'Y') %>% arrange(-G)
    batters_less <- batters %>% filter(yearID == xx) %>% 
      filter(full_time == 'N') %>% arrange(-G)
    
    n1 <- nrow(batters_full)
    n2 <- nrow(batters_less)
    
    mapped_G_full <- c()
    mapped_G_less <- c()
    for (yy in c(1977:1980, 1982:1989)) {
      batters_ref_full <- batters %>% 
        filter(yearID == yy, full_time == 'Y') %>% arrange(-G)
      batters_ref_less <- batters %>% 
        filter(yearID == yy, full_time == 'N') %>% arrange(-G)
      n1r <- nrow(batters_ref_full)
      n2r <- nrow(batters_ref_less)
      
      mapped_G_full <- cbind(mapped_G_full, approx(x = seq((n1r-1),0)/(n1r-1), 
                                                   y = batters_ref_full$G, 
                                                   xout = seq((n1-1),0)/(n1-1))$y)
      mapped_G_less <- cbind(mapped_G_less, approx(x = seq((n2r-1),0)/(n2r-1), 
                                                   y = batters_ref_less$G, 
                                                   xout = seq((n2-1),0)/(n2-1))$y)
    }
    
    batters_full$mapped_G <- rowMeans(mapped_G_full)
    batters_less$mapped_G <- rowMeans(mapped_G_less)
    
    
    batters_full <- batters_full %>% arrange(-PA)
    batters_less <- batters_less %>% arrange(-PA)
    mapped_PA_full <- c()
    mapped_PA_less <- c()
    for (yy in c(1977:1980, 1982:1989)) {
      batters_ref_full <- batters %>% 
        filter(yearID == yy, full_time == 'Y') %>% arrange(-PA)
      batters_ref_less <- batters %>% 
        filter(yearID == yy, full_time == 'N') %>% arrange(-PA)
      n1r <- nrow(batters_ref_full)
      n2r <- nrow(batters_ref_less)
      
      mapped_PA_full <- cbind(mapped_PA_full, approx(x = seq((n1r-1),0)/(n1r-1), 
                                                     y = batters_ref_full$PA, 
                                                     xout = seq((n1-1),0)/(n1-1))$y)
      mapped_PA_less <- cbind(mapped_PA_less, approx(x = seq((n2r-1),0)/(n2r-1), 
                                                     y = batters_ref_less$PA, 
                                                     xout = seq((n2-1),0)/(n2-1))$y)
    }
    
    batters_full$mapped_PA <- rowMeans(mapped_PA_full)
    batters_less$mapped_PA <- rowMeans(mapped_PA_less)
    
    m <- rbind(batters_full, batters_less)
    data.frame(playerID = m$playerID, yearID = m$yearID,
               mapped_G_raw = round(m$mapped_G), mapped_PA_raw = round(m$mapped_PA))
    
  }, mc.cores = ncores))
   
mapped_batters_1 <- merge(career_kAB, mapped_quan_b_raw, 
                            by = c('playerID', 'yearID'))
  
min_refbWAR <- -2
  
mapped_batters_bWAR <- mapped_batters_1 %>% 
    mutate(adj_bWAR = adj_comp * mapped_G_raw) %>% 
    mutate(adj_bWAR = ifelse(adj_bWAR < min_refbWAR, min_refbWAR, adj_bWAR)) %>%
    mutate(mapped_G_bWAR = round(adj_bWAR / adj_comp))

career_bat_normal <- mapped_batters_bWAR %>% group_by(playerID) %>%
  summarise(name = unique(name), 
            adj_bWAR = sum(adj_bWAR)) %>%
  arrange(desc(adj_bWAR))
```

```{r cache=TRUE, echo=FALSE}
pitchers <- pit_dat %>% 
    select(playerID, yearID, name, age, lgID, teamID, IP, pops, bWAR)
  pitchers <- pitchers %>% mutate(comp = bWAR / IP)
  pitchers$comp[is.na(pitchers$comp)] = 0
  
  rotation_bound <- as.data.frame(cbind(years, unlist(mclapply(years, mc.cores = ncores, function(yr){
    foo <- getRetrosheet(type = "game", year = yr)
    Tms <- unique(foo$HmTm)
    
    starter <- lapply(Tms, function(tm){
      bar <- foo %>% filter(VisTm == tm | HmTm == tm) %>% 
        select(VisTm, HmTm, VisStPchID, HmStPchID, VisTmGNum, HmTmGNum)
      t(apply(bar, 1, function(xx){
        y <- NULL
        if(xx[2] == tm){
          y <- xx[4]
        }
        else{
          y <- xx[3]
        }
      })) 
    })
    
    y <- unlist(lapply(starter, function(xx){
      unlist(lapply(1:length(xx), function(j){
        flag <- TRUE
        k <- 1
        if(j > 1){
          while(flag){
            flag <- length(xx[(j-k):j]) == length(unique(xx[(j-k):j]))
            if(!flag){
              break
            }
            else{
              k <- k + 1
            }
            if(k == j){
              break
            }
          }
        }
        k
      }))
    }))
    mean(y)
    
  }))))
  
  unique_team <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    c(xx, nrow(unique(pitchers %>% filter(yearID == xx) %>% select(teamID))))
  }))
  
  rotation_player <- data.frame(yearID = years, rotation = ceiling(rotation_bound[,2] * unique_team[,2]))
  
  cutoff <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    m <- pitchers %>% filter(yearID == xx) %>% arrange(-IP)
    index <- rotation_player$rotation[rotation_player$yearID == xx]
    data.frame(thres = (m$IP[index]), yearID = xx)
  }))
  
  pitchers <- merge(pitchers, cutoff, by = 'yearID')
  
  pitchers <- pitchers %>% mutate(full_time = ifelse(IP >= thres, 'Y', 'N'))
  
  pitchers_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- pitchers %>% filter(yearID == xx)
    lg_avg <- sum(int$bWAR)/sum(int$IP)
    int %>% mutate(comp = (bWAR + lg_avg * 14)/(IP + 14))
  }))
  
  pitchers_talent_bWAR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
    talent_computing_nonpara_normal(dataset = pitchers_schell, component_name = "bWAR_p", year = yy, 
                             ystar = thresh_fun(component = pitchers_schell %>% 
                                                 filter(full_time =='Y', yearID == yy) %>%
                                                 select(comp), component_name = 'bWAR_p'))
  })) %>% arrange(-WAR_talent)
  
  no_strike <- pitchers_talent_bWAR %>% 
    filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  
  min_refbWAR <- -2
  
  t <- isoreg(no_strike$WAR_talent, no_strike$comp)
  
  talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,154)/154)
  comp_new <- as.stepfun(t)(talent_new)
  
  ystar <- thresh_fun(comp_new, component_name = 'bWAR_p')
  pop_new <- round(mean(no_strike$pops))
  component_name = 'bWAR_p'
  yy <- sort(comp_new)
  n <- length(yy)
  ytilde <- rep(0, n + 1)
  if (component_name == 'ERA') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
  }
  if (component_name == 'bWAR_p'| component_name == 'fWAR_p') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])/10
  }
  if (component_name == 'SO') {
    ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
  }
  ytilde[n+1] <- yy[n] + ystar
  ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2 
  }))
  
  career_kAB <- do.call(rbind, mclapply(1:nrow(pitchers_talent_bWAR), function(xx){
    int <- career_talent_nonpara_normal(dataset = pitchers_talent_bWAR, component_name = 'bWAR_p', 
                         snippet = pitchers_talent_bWAR[xx,])
    int
  }, mc.cores = ncores)) 
  
  ## mapping statistics
  
  mapped_quan_p <- do.call(rbind, mclapply(years, function(xx){
    pitchers_full <- pitchers %>% filter(yearID == xx) %>% 
      filter(full_time == 'Y') %>% arrange(-IP)
    pitchers_less <- pitchers %>% filter(yearID == xx) %>% 
      filter(full_time == 'N') %>% arrange(-IP)
    
    n1 <- nrow(pitchers_full)
    n2 <- nrow(pitchers_less)
    
    mapped_IP_full <- c()
    mapped_IP_less <- c()
    for (yy in c(1977:1980, 1982:1989)) {
      pitchers_ref_full <- pitchers %>% 
        filter(yearID == yy, full_time == 'Y') %>% arrange(-IP)
      pitchers_ref_less <- pitchers %>% 
        filter(yearID == yy, full_time == 'N') %>% arrange(-IP)
      n1r <- nrow(pitchers_ref_full)
      n2r <- nrow(pitchers_ref_less)
      
      mapped_IP_full <- cbind(mapped_IP_full, approx(x = seq((n1r-1),0)/(n1r-1), 
                                                     y = pitchers_ref_full$IP,
                                                     xout = seq((n1-1),0)/(n1-1))$y)
      mapped_IP_less <- cbind(mapped_IP_less, approx(x = seq((n2r-1),0)/(n2r-1), 
                                                     y = pitchers_ref_less$IP, 
                                                     xout = seq((n2-1),0)/(n2-1))$y)
    }
    
    pitchers_full$mapped_IP <- rowMeans(mapped_IP_full)
    pitchers_less$mapped_IP <- rowMeans(mapped_IP_less)
    
    m <- rbind(pitchers_full, pitchers_less)
    data.frame(playerID = m$playerID, yearID = m$yearID, 
               mapped_IP_raw = round(m$mapped_IP))
    
  }, mc.cores = ncores))
  
  mapped_pitchers_1 <- merge(career_kAB, mapped_quan_p, 
                             by = c('playerID', 'yearID'))
  
  mapped_pitchers_bWAR <- mapped_pitchers_1 %>% 
    mutate(adj_bWAR = adj_comp * mapped_IP_raw) %>%
    mutate(adj_bWAR = ifelse(adj_bWAR < min_refbWAR, min_refbWAR, adj_bWAR)) %>%
    mutate(mapped_IP_bWAR = round(adj_bWAR / adj_comp))
  career_pit_normal <- mapped_pitchers_bWAR %>% group_by(playerID) %>%
  summarise(name = unique(name), 
            adj_bWAR = sum(adj_bWAR)) %>%
  arrange(desc(adj_bWAR))
```

```{r echo=FALSE}
m_b <- career_bat_normal %>% 
  select(name, playerID, adj_bWAR)

m_p <- career_pit_normal %>% 
  select(name, playerID, adj_bWAR)

m_normal <- rbind(m_b, m_p)

index <- which(m_normal$name == "Babe Ruth")
m_normal$adj_bWAR[index[1]] <- sum(m_normal$adj_bWAR[index])
index <- which(m_normal$name == "Shohei Ohtani")
m_normal$adj_bWAR[index[1]] <- sum(m_normal$adj_bWAR[index])

#(m_normal %>% arrange(desc(adj_bWAR)))[1:25,]

```

```{r cache=TRUE, echo=FALSE}
batters <- bat_dat %>% select(yearID, playerID, lgID, name, age, PA, G, bWAR, pops)
cutoff <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    m <- batters %>% filter(yearID == xx) %>% filter(PA >= 75)
    data.frame(thres = median(m$PA), yearID = xx)
  }))
batters <- merge(batters, cutoff, by = 'yearID')
batters <- batters %>% mutate(comp =  bWAR / G, full_time = ifelse(PA >= thres, 'Y', 'N'))

batters_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- batters %>% filter(yearID == xx)
    lg_avg <- sum(int$bWAR)/sum(int$G)
    int %>% mutate(comp = (bWAR + lg_avg * 7)/(G + 7))
  }))



batters_talent_bWAR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
  talent_computing_nonpara(dataset = batters_schell, component_name = "bWAR", year = yy, ystar = thresh_fun(component = batters_schell %>% filter(full_time == 'Y', yearID == yy) %>% select(comp), component_name = 'bWAR'), alpha = 3) })) %>% arrange(-WAR_talent)

no_strike <- batters_talent_bWAR %>% 
    filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  
t <- isoreg(no_strike$WAR_talent, no_strike$comp)
talent_new <- quantile(no_strike$WAR_talent, probs = (seq(0,250)/250))
comp_new <- as.stepfun(t)(talent_new)
 
ystar <- thresh_fun(comp_new, component_name = 'bWAR')
pop_new <- round(mean(no_strike$pops))
component_name = 'bWAR'
yy <- sort(comp_new)
n <- length(yy)
ytilde <- rep(0, n + 1)
if (component_name == 'bWAR' | component_name == 'fWAR') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
}
if (component_name == 'HR' | component_name == 'BB') {
    # since the minimal HR is greater or equal to 0.
    ytilde[1] <- 0
}
ytilde[n+1] <- yy[n] + ystar
ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2 
}))

career_kAB_1st <- do.call(rbind, mclapply(1:30000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                         snippet = batters_talent_bWAR[zz,], alpha = 3)
    int
  }, mc.cores = ncores))
  
  
career_kAB_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                         snippet = batters_talent_bWAR[zz,], alpha = 3)
    int
  }, mc.cores = ncores)) 
  
career_kAB_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_bWAR), function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                         snippet = batters_talent_bWAR[zz,], alpha = 3)
    int
  }, mc.cores = ncores)) 
  
career_kAB <- rbind(career_kAB_1st, career_kAB_2nd, career_kAB_3rd)

mapped_quan_b_raw <- do.call(rbind, mclapply(years, function(xx){
    batters_full <- batters %>% filter(yearID == xx) %>% 
      filter(full_time == 'Y') %>% arrange(-G)
    batters_less <- batters %>% filter(yearID == xx) %>% 
      filter(full_time == 'N') %>% arrange(-G)
    
    n1 <- nrow(batters_full)
    n2 <- nrow(batters_less)
    
    mapped_G_full <- c()
    mapped_G_less <- c()
    for (yy in c(1977:1980, 1982:1989)) {
      batters_ref_full <- batters %>% 
        filter(yearID == yy, full_time == 'Y') %>% arrange(-G)
      batters_ref_less <- batters %>% 
        filter(yearID == yy, full_time == 'N') %>% arrange(-G)
      n1r <- nrow(batters_ref_full)
      n2r <- nrow(batters_ref_less)
      
      mapped_G_full <- cbind(mapped_G_full, approx(x = seq((n1r-1),0)/(n1r-1), 
                                                   y = batters_ref_full$G, 
                                                   xout = seq((n1-1),0)/(n1-1))$y)
      mapped_G_less <- cbind(mapped_G_less, approx(x = seq((n2r-1),0)/(n2r-1), 
                                                   y = batters_ref_less$G, 
                                                   xout = seq((n2-1),0)/(n2-1))$y)
    }
    
    batters_full$mapped_G <- rowMeans(mapped_G_full)
    batters_less$mapped_G <- rowMeans(mapped_G_less)
    
    
    batters_full <- batters_full %>% arrange(-PA)
    batters_less <- batters_less %>% arrange(-PA)
    mapped_PA_full <- c()
    mapped_PA_less <- c()
    for (yy in c(1977:1980, 1982:1989)) {
      batters_ref_full <- batters %>% 
        filter(yearID == yy, full_time == 'Y') %>% arrange(-PA)
      batters_ref_less <- batters %>% 
        filter(yearID == yy, full_time == 'N') %>% arrange(-PA)
      n1r <- nrow(batters_ref_full)
      n2r <- nrow(batters_ref_less)
      
      mapped_PA_full <- cbind(mapped_PA_full, approx(x = seq((n1r-1),0)/(n1r-1), 
                                                     y = batters_ref_full$PA, 
                                                     xout = seq((n1-1),0)/(n1-1))$y)
      mapped_PA_less <- cbind(mapped_PA_less, approx(x = seq((n2r-1),0)/(n2r-1), 
                                                     y = batters_ref_less$PA, 
                                                     xout = seq((n2-1),0)/(n2-1))$y)
    }
    
    batters_full$mapped_PA <- rowMeans(mapped_PA_full)
    batters_less$mapped_PA <- rowMeans(mapped_PA_less)
    
    m <- rbind(batters_full, batters_less)
    data.frame(playerID = m$playerID, yearID = m$yearID,
               mapped_G_raw = round(m$mapped_G), mapped_PA_raw = round(m$mapped_PA))
    
  }, mc.cores = ncores))
   
mapped_batters_1 <- merge(career_kAB, mapped_quan_b_raw, 
                            by = c('playerID', 'yearID'))
  
min_refbWAR <- -2
  
mapped_batters_bWAR <- mapped_batters_1 %>% 
    mutate(adj_bWAR = adj_comp * mapped_G_raw) %>% 
    mutate(adj_bWAR = ifelse(adj_bWAR < min_refbWAR, min_refbWAR, adj_bWAR)) %>%
    mutate(mapped_G_bWAR = round(adj_bWAR / adj_comp))

career_bat_pareto <- mapped_batters_bWAR %>% group_by(playerID) %>%
  summarise(name = unique(name), 
            adj_bWAR = sum(adj_bWAR)) %>%
  arrange(desc(adj_bWAR))
```

```{r cache=TRUE, echo=FALSE}
foo <- getRetrosheet(type = "game", year = 2022)
rotation_bound <- as.data.frame(cbind(years, unlist(mclapply(years, mc.cores = ncores, function(yr){
    foo <- getRetrosheet(type = "game", year = yr)
    Tms <- unique(foo$HmTm)
    
    starter <- lapply(Tms, function(tm){
      bar <- foo %>% filter(VisTm == tm | HmTm == tm) %>% 
        select(VisTm, HmTm, VisStPchID, HmStPchID, VisTmGNum, HmTmGNum)
      t(apply(bar, 1, function(xx){
        y <- NULL
        if(xx[2] == tm){
          y <- xx[4]
        }
        else{
          y <- xx[3]
        }
      })) 
    })
    
    y <- unlist(lapply(starter, function(xx){
      unlist(lapply(1:length(xx), function(j){
        flag <- TRUE
        k <- 1
        if(j > 1){
          while(flag){
            flag <- length(xx[(j-k):j]) == length(unique(xx[(j-k):j]))
            if(!flag){
              break
            }
            else{
              k <- k + 1
            }
            if(k == j){
              break
            }
          }
        }
        k
      }))
    }))
    mean(y)
    
  }))))

pitchers <- pit_dat %>% 
    select(playerID, yearID, name, age, lgID, teamID, IP, pops, bWAR)
  pitchers <- pitchers %>% mutate(comp = bWAR / IP)
  pitchers$comp[is.na(pitchers$comp)] = 0

 rotation_bound <- as.data.frame(cbind(years, unlist(mclapply(years, mc.cores = ncores, function(yr){
    foo <- getRetrosheet(type = "game", year = yr)
    Tms <- unique(foo$HmTm)
    
    starter <- lapply(Tms, function(tm){
      bar <- foo %>% filter(VisTm == tm | HmTm == tm) %>% 
        select(VisTm, HmTm, VisStPchID, HmStPchID, VisTmGNum, HmTmGNum)
      t(apply(bar, 1, function(xx){
        y <- NULL
        if(xx[2] == tm){
          y <- xx[4]
        }
        else{
          y <- xx[3]
        }
      })) 
    })
    
    y <- unlist(lapply(starter, function(xx){
      unlist(lapply(1:length(xx), function(j){
        flag <- TRUE
        k <- 1
        if(j > 1){
          while(flag){
            flag <- length(xx[(j-k):j]) == length(unique(xx[(j-k):j]))
            if(!flag){
              break
            }
            else{
              k <- k + 1
            }
            if(k == j){
              break
            }
          }
        }
        k
      }))
    }))
    mean(y)
    
  }))))
  
  unique_team <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    c(xx, nrow(unique(pitchers %>% filter(yearID == xx) %>% select(teamID))))
  }))
  
  rotation_player <- data.frame(yearID = years, rotation = ceiling(rotation_bound[,2] * unique_team[,2]))
  
  cutoff <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    m <- pitchers %>% filter(yearID == xx) %>% arrange(-IP)
    index <- rotation_player$rotation[rotation_player$yearID == xx]
    data.frame(thres = (m$IP[index]), yearID = xx)
  }))
  
  pitchers <- merge(pitchers, cutoff, by = 'yearID')
  
  pitchers <- pitchers %>% mutate(full_time = ifelse(IP >= thres, 'Y', 'N'))
  
  pitchers_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- pitchers %>% filter(yearID == xx)
    lg_avg <- sum(int$bWAR)/sum(int$IP)
    int %>% mutate(comp = (bWAR + lg_avg * 14)/(IP + 14))
  }))
  
  pitchers_talent_bWAR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
    talent_computing_nonpara(dataset = pitchers_schell, component_name = "bWAR_p", year = yy, 
                             ystar = thresh_fun(component = pitchers_schell %>% 
                                                 filter(full_time =='Y', yearID == yy) %>%
                                                 select(comp), component_name = 'bWAR_p'), alpha = 3)
  })) %>% arrange(-WAR_talent)
  
  no_strike <- pitchers_talent_bWAR %>% 
    filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  
  min_refbWAR <- -2
  
  t <- isoreg(no_strike$WAR_talent, no_strike$comp)
  
  talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,154)/154)
  comp_new <- as.stepfun(t)(talent_new)
  
  ystar <- thresh_fun(comp_new, component_name = 'bWAR_p')
  pop_new <- round(mean(no_strike$pops))
  component_name = 'bWAR_p'
  yy <- sort(comp_new)
  n <- length(yy)
  ytilde <- rep(0, n + 1)
  if (component_name == 'ERA') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
  }
  if (component_name == 'bWAR_p'| component_name == 'fWAR_p') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])/10
  }
  if (component_name == 'SO') {
    ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
  }
  ytilde[n+1] <- yy[n] + ystar
  ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2 
  }))
  
  career_kAB <- do.call(rbind, mclapply(1:nrow(pitchers_talent_bWAR), function(xx){
    int <- career_talent_nonpara(dataset = pitchers_talent_bWAR, component_name = 'bWAR_p', 
                         snippet = pitchers_talent_bWAR[xx,], alpha = 3)
    int
  }, mc.cores = ncores)) 
  
  ## mapping statistics
  
  mapped_quan_p <- do.call(rbind, mclapply(years, function(xx){
    pitchers_full <- pitchers %>% filter(yearID == xx) %>% 
      filter(full_time == 'Y') %>% arrange(-IP)
    pitchers_less <- pitchers %>% filter(yearID == xx) %>% 
      filter(full_time == 'N') %>% arrange(-IP)
    
    n1 <- nrow(pitchers_full)
    n2 <- nrow(pitchers_less)
    
    mapped_IP_full <- c()
    mapped_IP_less <- c()
    for (yy in c(1977:1980, 1982:1989)) {
      pitchers_ref_full <- pitchers %>% 
        filter(yearID == yy, full_time == 'Y') %>% arrange(-IP)
      pitchers_ref_less <- pitchers %>% 
        filter(yearID == yy, full_time == 'N') %>% arrange(-IP)
      n1r <- nrow(pitchers_ref_full)
      n2r <- nrow(pitchers_ref_less)
      
      mapped_IP_full <- cbind(mapped_IP_full, approx(x = seq((n1r-1),0)/(n1r-1), 
                                                     y = pitchers_ref_full$IP,
                                                     xout = seq((n1-1),0)/(n1-1))$y)
      mapped_IP_less <- cbind(mapped_IP_less, approx(x = seq((n2r-1),0)/(n2r-1), 
                                                     y = pitchers_ref_less$IP, 
                                                     xout = seq((n2-1),0)/(n2-1))$y)
    }
    
    pitchers_full$mapped_IP <- rowMeans(mapped_IP_full)
    pitchers_less$mapped_IP <- rowMeans(mapped_IP_less)
    
    m <- rbind(pitchers_full, pitchers_less)
    data.frame(playerID = m$playerID, yearID = m$yearID, 
               mapped_IP_raw = round(m$mapped_IP))
    
  }, mc.cores = ncores))
  
  mapped_pitchers_1 <- merge(career_kAB, mapped_quan_p, 
                             by = c('playerID', 'yearID'))
  
  mapped_pitchers_bWAR <- mapped_pitchers_1 %>% 
    mutate(adj_bWAR = adj_comp * mapped_IP_raw) %>%
    mutate(adj_bWAR = ifelse(adj_bWAR < min_refbWAR, min_refbWAR, adj_bWAR)) %>%
    mutate(mapped_IP_bWAR = round(adj_bWAR / adj_comp))
  career_pit_pareto <- mapped_pitchers_bWAR %>% group_by(playerID) %>%
  summarise(name = unique(name), 
            adj_bWAR = sum(adj_bWAR)) %>%
  arrange(desc(adj_bWAR))
```


```{r echo=FALSE}
m_b <- career_bat_pareto %>% 
  select(name, playerID, adj_bWAR)

m_p <- career_pit_pareto %>% 
  select(name, playerID, adj_bWAR)

m_pareto <- rbind(m_b, m_p)

index <- which(m_pareto$name == "Babe Ruth")
m_pareto$adj_bWAR[index[1]] <- sum(m_pareto$adj_bWAR[index])
index <- which(m_pareto$name == "Shohei Ohtani")
m_pareto$adj_bWAR[index[1]] <- sum(m_pareto$adj_bWAR[index])

#(m_pareto %>% arrange(desc(adj_bWAR)))[1:25,]
```

The table below shows the top 25 bWAR players using four different talent generating process. The talent follows folded normal distribution, normal distribution, Pareto distribution with $\alpha = 3$ and Pareto distribution with $\alpha = 1.16$. Given that the ranking lists produced by the four separate generating processes are identical, we can say that our Full House model's talent generating process is fairly robust.

```{r echo=FALSE}

## bWAR
m_b <- mapped_batters_bWAR %>% group_by(playerID) %>%
  summarise(name = unique(name), 
            adj_bWAR = sum(adj_bWAR)) %>%
  select(name, playerID, adj_bWAR) %>%
  arrange(desc(adj_bWAR))

m_p <- mapped_pitchers_bWAR %>% group_by(playerID) %>%
  summarise(name = unique(name), 
            adj_bWAR = sum(adj_bWAR)) %>%
  select(name, playerID, adj_bWAR) %>%
  arrange(desc(adj_bWAR))

m_bWAR<- rbind(m_b, m_p)

index <- which(m_bWAR$name == "Babe Ruth")
m_bWAR$adj_bWAR[index[1]] <- sum(m_bWAR$adj_bWAR[index])
index <- which(m_bWAR$name == "Shohei Ohtani")
m_bWAR$adj_bWAR[index[1]] <- sum(m_bWAR$adj_bWAR[index])

dist_combined <- cbind((m_normal %>% arrange(desc(adj_bWAR)))$name[1:25], 
                       (m_fold %>% arrange(desc(adj_bWAR)))$name[1:25], 
                       (m_pareto %>% arrange(desc(adj_bWAR)))$name[1:25], 
                       (m_bWAR %>% arrange(desc(adj_bWAR)))$name[1:25])

colnames(dist_combined) <- c('standard normal', 'Folded normal (mu = 0, sigma = 1)', 'Pareto with alpha = 3', 'Pareto with alpha = 1.16')

rownames(dist_combined) <- c()


## matched name in top 10
#dist_combined <- rbind(dist_combined, c(length(Reduce(intersect, list(dist_combined[1:10,1], dist_combined[1:10,4]))), length(Reduce(intersect, list(dist_combined[1:10,2], dist_combined[1:10,4]))), length(Reduce(intersect, list(dist_combined[1:10,3], dist_combined[1:10,4]))), ''))

## matched rank in top 10

#dist_combined <- rbind(dist_combined, c(sum(dist_combined[1:10,1] == dist_combined[1:10,4]),sum(dist_combined[1:10,2] == dist_combined[1:10,4]), sum(dist_combined[1:10,3] == dist_combined[1:10,4]), ''))


## matched name in top 25
#dist_combined <- rbind(dist_combined, c(length(Reduce(intersect, list(dist_combined[1:25,1], dist_combined[1:25,4]))), length(Reduce(intersect, list(dist_combined[1:25,2], dist_combined[1:25,4]))), length(Reduce(intersect, list(dist_combined[1:25,3], dist_combined[1:25,4]))), ''))

## matched rank in top 25

#dist_combined <- rbind(dist_combined, c(sum(dist_combined[1:25,1] == dist_combined[1:25,4]),sum(dist_combined[1:25,2] == dist_combined[1:25,4]), sum(dist_combined[1:25,3] == dist_combined[1:25,4]), ''))

#row_name <- data.frame(rank = c(seq(1,25), 'matched name in top 10', 'matched rank in top 10', 'matched name in top 25', 'matched rank in top 25'))

kable(cbind(rank = seq(1,25), dist_combined))

```

## Multiverse Analysis

### Batting Average

We will test four factors in our Full House Model and use batting average to illustrate it. These four factors are park-factor effect, population change, component distribution and season size effect. The table shows the value of the BA of Tony Gwynn in the 1997 season minus the BA of Ty Cobb in the 1911 season under different configurations before or after applying the smoothing and trimming method. The Park Factor column indicates whether we apply the park-factor adjustment to the BA. The Population column indicates the population changes we apply to the MLB-eligible population. The pre_int shows we add 10\% for pre-integration seasons; The econ_effect shows we deduct 10\% for the years prior to 1980 due to the economic effect; The normal shows we use the normal MLB-eligible population. The Distribution column indicates we use parametric distribution and non-parametric distribution to measure the BA in each season. The League Size column indicates we consider two different league sizes as the number of components in each season. The Historical shows we use historical league size as the number of components in each season. The Fixed shows that we compute the maximum number of components in every season and consider this value as the fixed number of components each season. The diff_after indicates the value of the BA of Tony Gwynn in the 1997 season minus the BA of Ty Cobb in the 1911 season under different configurations after applying the smoothing and trimming method. The diff_before indicates the value of the BA of Tony Gwynn in the 1997 season minus the BA of Ty Cobb in the 1911 season under different configurations before applying the smoothing and trimming method.

```{r cache=TRUE, echo=FALSE}
load("bat_pit_pops.RData")
season_diff <- c()
batters <- bat_dat %>% left_join(master_batters_trim %>% select(playerID, yearID, adj_AB))
cutoff <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    m <- batters %>% filter(yearID == xx) %>% filter(PA >= 75)
    data.frame(thres = median(m$PA), yearID = xx)
  }))
batters <- merge(batters, cutoff, by = 'yearID')
batters <- batters %>% mutate(full_time = ifelse(PA >= thres, 'Y', 'N')) 

batters <- batters %>% select(playerID, yearID, lgID, name, lgID, AB, H, full_time, pops,adj_AB) %>%
      mutate(comp = ifelse(AB != 0, H / AB, 0))
batters_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
      int<- batters %>% filter(yearID == xx)
      lg_avg <- sum(int$H)/sum(int$AB)
      int %>% mutate(comp = (H + lg_avg * 25)/(AB + 25))
    }))
```

```{r cache=TRUE, echo=FALSE}
batters_schell <- batters_schell %>% 
          select(-pops) %>% 
          left_join(MLBpops_pre_int %>% 
                      select(year, NL_pop, AL_pop), by = c('yearID' = 'year')) %>% 
          mutate(pops = ifelse(lgID == "NL",NL_pop,AL_pop))
```

```{r cache=TRUE, echo=FALSE}
batters_talent_AVG <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
                  talent_computing_para(dataset = batters_schell, year = yy, alpha = 1.16)
                })) %>% arrange(-talent)
                
                no_strike <- batters_talent_AVG %>%
                  filter(yearID < 1990, yearID >= 1977, yearID != 1981,
                         full_time == 'Y', lgID == 'NL') %>%
                  arrange(talent)
                
                min_refAVG <- min(no_strike$comp)
                
                t <- isoreg(no_strike$talent, no_strike$comp)
                
                talent_new <- quantile(no_strike$talent, probs = seq(0,250)/250)
                comp_new <- as.stepfun(t)(talent_new)
                pop_new <- round(mean(no_strike$pops))
                
                mean_new <- mean(comp_new)
                sd_new <- sd(comp_new)
                
                career_kAB_AVG_1st <- do.call(rbind, mclapply(1:30000, function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_AVG), function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB <- rbind(career_kAB_AVG_1st, 
                                    career_kAB_AVG_2nd, 
                                    career_kAB_AVG_3rd)
                
                mapped_batters_AVG <- career_kAB %>% 
                  mutate(adj_AVG = ifelse(adj_comp < min_refAVG, min_refAVG, adj_comp))
                
                master_batters_AB <- master_batters_trim %>% select(-adj_AVG)
                
                AVG_part <- mapped_batters_AVG %>%
                  mutate(adj_AVG = round(adj_AVG, 3)) %>% 
                  select(yearID, playerID, adj_AVG)
                
        master_batters <- merge(master_batters_AB, AVG_part, by = c('yearID', 'playerID'))
        
        master_batters <- master_batters %>% 
          mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
        master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0
        
        master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
          mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))

        ## Batters
        batters <- master_batters_nonpara
        
        ## extract and remove bad players 
        foo <- batters %>% 
          arrange(desc(adj_AVG)) %>% 
          filter(adj_AB >= 300) %>% 
          dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
          mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
        bar <- split(foo, as.factor(foo$playerID))
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_fWAR), ]
        }))
        baz <- baz %>% arrange(adj_fWAR)
        bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
        
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_bWAR), ]
        }))
        baz <- baz %>% arrange(adj_bWAR)
        bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
        bad_players <- union(bad_players_bWAR, bad_players_fWAR)
        batters <- batters[!batters$playerID %in% bad_players, ]
        
        ###### investigate anomalies ######
        
        ## more on base events than PAs
        
        # check average for minimal at bats and correct issues
        batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
        batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
        batters[batters$adj_AB > 0, ]$adj_AVG <- 
          round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)
        
        ## build adjusted data set
        batters_adjusted <- batters %>% 
          dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                        adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
        colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                        "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
        batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))
        
        
        ## trim out bad players
        # first round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # second round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # third round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # forth round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        
        ## remove tails 
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                            ifelse(sum(tail(bad, 3)) >= 5,1,0),
                            ifelse(sum(tail(bad, 4)) >= 7,1,0),
                            ifelse(sum(tail(bad, 5)) >= 9,1,0),
                            ifelse(sum(tail(bad, 6)) >= 11,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        ## remove starts
        foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
          bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                            ifelse(sum(head(bad, 2)) >= 3,1,0),
                            ifelse(sum(head(bad, 3)) >= 5,1,0),
                            ifelse(sum(head(bad, 4)) >= 7,1,0),
                            ifelse(sum(head(bad, 5)) >= 9,1,0),
                            ifelse(sum(head(bad, 6)) >= 11,1,0)))
          if (bad_head < length(bad)) {
            (bad_head + 1):length(bad)
          }
        })
        batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)
        
        # taper down average WAR for players with small PAs
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	
        
        batters_adjusted <- do.call(rbind, mclapply(
          split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
          mc.cores = ncores, FUN = function(xx){
            ## natural cubic spline
            ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
            nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
            ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
            nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
            ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
            nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
            ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
            nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
            ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
            nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
            
            xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
              mutate(HR = round((adj_HR + nn_HR)/2)) %>%
              mutate(BB = round((adj_BB + nn_BB)/2)) %>%
              mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
              mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
          })) 
        
        bat_season <- batters_adjusted %>% 
          mutate(PA = adj_AB + BB + HBP + SF)
        bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
          bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB
        
        bat_season <- bat_season %>% 
          dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
        bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
          mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
          mutate(HR = ifelse(HR > 0, HR, 0)) %>%
          mutate(BB = ifelse(BB > 0, BB, 0)) %>%
          mutate(OBP = ifelse(OBP > 0, OBP, 0))
        
        colnames(bat_season)[5] <- 'AB'
        colnames(bat_season)[8] <- 'BA'
        bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
          mutate(BA = round(H / AB, 3)) %>%
          mutate(BA = ifelse(AB == 0, 0, BA)) %>%
          mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
          mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))
        
        YES_pre_int_para_historical_season <- mapped_batters_AVG
        YES_pre_int_para_historical_season_trimmed <- bat_season_nonpara
        
        Ty_Cobb_1911 <- YES_pre_int_para_historical_season %>% filter(yearID == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997 <- YES_pre_int_para_historical_season %>% filter(yearID == 1997, playerID == 'gwynnto01')
        Ty_Cobb_1911_trimmed <- YES_pre_int_para_historical_season_trimmed %>% filter(year == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997_trimmed <- YES_pre_int_para_historical_season_trimmed %>% filter(year == 1997, playerID == 'gwynnto01')
        season_diff <- rbind(season_diff, 
                             data.frame(PF = 'YES', 
                                        pops = 'pre_int', 
                                        para = 'para', 
                                        league = 'historical', 
                                        diff_before = round(Tony_Gwynn_1997$adj_AVG - Ty_Cobb_1911$adj_AVG, 3), 
                                        diff_after = round(Tony_Gwynn_1997_trimmed$BA - Ty_Cobb_1911_trimmed$BA, 3)))

```

```{r cache=TRUE, echo=FALSE}
batters_talent_AVG <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
                  talent_computing_para_fixed(dataset = batters_schell, year = yy, alpha = 1.16)
                })) %>% arrange(-talent)
                
                no_strike <- batters_talent_AVG %>%
                  filter(yearID < 1990, yearID >= 1977, yearID != 1981,
                         full_time == 'Y', lgID == 'NL') %>%
                  arrange(talent)
                
                min_refAVG <- min(no_strike$comp)
                
                t <- isoreg(no_strike$talent, no_strike$comp)
                
                talent_new <- quantile(no_strike$talent, probs = seq(0,250)/250)
                comp_new <- as.stepfun(t)(talent_new)
                pop_new <- round(mean(no_strike$pops))
                
                mean_new <- mean(comp_new)
                sd_new <- sd(comp_new)
                
                career_kAB_AVG_1st <- do.call(rbind, mclapply(1:30000, function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_AVG), function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB <- rbind(career_kAB_AVG_1st, 
                                    career_kAB_AVG_2nd, 
                                    career_kAB_AVG_3rd)
                
                mapped_batters_AVG <- career_kAB %>% 
                  mutate(adj_AVG = ifelse(adj_comp < min_refAVG, min_refAVG, adj_comp))
                
                master_batters_AB <- master_batters_trim %>% select(-adj_AVG)
                
                AVG_part <- mapped_batters_AVG %>%
                  mutate(adj_AVG = round(adj_AVG, 3)) %>% 
                  select(yearID, playerID, adj_AVG)
                
        master_batters <- merge(master_batters_AB, AVG_part, by = c('yearID', 'playerID'))
        
        master_batters <- master_batters %>% 
          mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
        master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0
        
        master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
          mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))

        ## Batters
        batters <- master_batters_nonpara
        
        ## extract and remove bad players 
        foo <- batters %>% 
          arrange(desc(adj_AVG)) %>% 
          filter(adj_AB >= 300) %>% 
          dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
          mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
        bar <- split(foo, as.factor(foo$playerID))
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_fWAR), ]
        }))
        baz <- baz %>% arrange(adj_fWAR)
        bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
        
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_bWAR), ]
        }))
        baz <- baz %>% arrange(adj_bWAR)
        bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
        bad_players <- union(bad_players_bWAR, bad_players_fWAR)
        batters <- batters[!batters$playerID %in% bad_players, ]
        
        ###### investigate anomalies ######
        
        ## more on base events than PAs
        
        # check average for minimal at bats and correct issues
        batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
        batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
        batters[batters$adj_AB > 0, ]$adj_AVG <- 
          round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)
        
        ## build adjusted data set
        batters_adjusted <- batters %>% 
          dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                        adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
        colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                        "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
        batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))
        
        
        ## trim out bad players
        # first round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # second round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # third round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # forth round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        
        ## remove tails 
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                            ifelse(sum(tail(bad, 3)) >= 5,1,0),
                            ifelse(sum(tail(bad, 4)) >= 7,1,0),
                            ifelse(sum(tail(bad, 5)) >= 9,1,0),
                            ifelse(sum(tail(bad, 6)) >= 11,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        ## remove starts
        foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
          bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                            ifelse(sum(head(bad, 2)) >= 3,1,0),
                            ifelse(sum(head(bad, 3)) >= 5,1,0),
                            ifelse(sum(head(bad, 4)) >= 7,1,0),
                            ifelse(sum(head(bad, 5)) >= 9,1,0),
                            ifelse(sum(head(bad, 6)) >= 11,1,0)))
          if (bad_head < length(bad)) {
            (bad_head + 1):length(bad)
          }
        })
        batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)
        
        # taper down average WAR for players with small PAs
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	
        
        batters_adjusted <- do.call(rbind, mclapply(
          split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
          mc.cores = ncores, FUN = function(xx){
            ## natural cubic spline
            ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
            nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
            ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
            nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
            ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
            nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
            ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
            nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
            ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
            nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
            
            xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
              mutate(HR = round((adj_HR + nn_HR)/2)) %>%
              mutate(BB = round((adj_BB + nn_BB)/2)) %>%
              mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
              mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
          })) 
        
        bat_season <- batters_adjusted %>% 
          mutate(PA = adj_AB + BB + HBP + SF)
        bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
          bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB
        
        bat_season <- bat_season %>% 
          dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
        bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
          mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
          mutate(HR = ifelse(HR > 0, HR, 0)) %>%
          mutate(BB = ifelse(BB > 0, BB, 0)) %>%
          mutate(OBP = ifelse(OBP > 0, OBP, 0))
        
        colnames(bat_season)[5] <- 'AB'
        colnames(bat_season)[8] <- 'BA'
        bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
          mutate(BA = round(H / AB, 3)) %>%
          mutate(BA = ifelse(AB == 0, 0, BA)) %>%
          mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
          mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))
        
        YES_pre_int_para_fixed_season <- mapped_batters_AVG
        YES_pre_int_para_fixed_season_trimmed <- bat_season_nonpara
        
        Ty_Cobb_1911 <- YES_pre_int_para_fixed_season %>% filter(yearID == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997 <- YES_pre_int_para_fixed_season %>% filter(yearID == 1997, playerID == 'gwynnto01')
        Ty_Cobb_1911_trimmed <- YES_pre_int_para_fixed_season_trimmed %>% filter(year == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997_trimmed <- YES_pre_int_para_fixed_season_trimmed %>% filter(year == 1997, playerID == 'gwynnto01')
        season_diff <- rbind(season_diff, 
                             data.frame(PF = 'YES', 
                                        pops = 'pre_int', 
                                        para = 'para', 
                                        league = 'fixed', 
                                        diff_before = round(Tony_Gwynn_1997$adj_AVG - Ty_Cobb_1911$adj_AVG, 3), 
                                        diff_after = round(Tony_Gwynn_1997_trimmed$BA - Ty_Cobb_1911_trimmed$BA, 3)))

```

```{r cache=TRUE, echo=FALSE}
batters_talent_AVG <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
                  talent_computing_nonpara(dataset = batters_schell, component_name = "AVG", 
                                           year = yy, ystar = thresh_fun(component = batters_schell %>% 
                                                                           filter(full_time == 'Y', yearID == yy) %>%
                                                                           select(comp), component_name = 'AVG'), 
                                           alpha = 1.16)
                })) %>% arrange(-WAR_talent)
                
                no_strike <- batters_talent_AVG %>%
                  filter(yearID < 1990, yearID >= 1977, yearID != 1981,
                         full_time == 'Y', lgID == 'NL') %>%
                  arrange(WAR_talent)
                
                min_refAVG <- min(no_strike$comp)
                
                t <- isoreg(no_strike$WAR_talent, no_strike$comp)
                
                talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,250)/250)
                
                comp_new <- as.stepfun(t)(talent_new)
                
                ystar <- thresh_fun(comp_new, component_name = 'AVG')
                pop_new <- round(mean(no_strike$pops))
                component_name = 'AVG'
                yy <- sort(comp_new)
                n <- length(yy)
                ytilde <- rep(0, n + 1)
                if (component_name == 'bWAR' | component_name == 'fWAR') {
                  ytilde[1] <- yy[1] - (yy[2] - yy[1])
                }
                if (component_name == 'HR' | component_name == 'BB') {
                  # since the minimal HR is greater or equal to 0.
                  ytilde[1] <- 0
                }
                if (component_name == 'AVG') {
                  ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
                }
                ytilde[n+1] <- yy[n] + ystar
                ytilde[2:n] <- unlist(lapply(2:n, function(j){
                  (yy[j]+yy[j-1])/2
                }))
                
                career_kAB_AVG_1st <- do.call(rbind, mclapply(1:30000, function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB_AVG_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_AVG), function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB <- rbind(career_kAB_AVG_1st, 
                                    career_kAB_AVG_2nd, 
                                    career_kAB_AVG_3rd)
                
                mapped_batters_AVG <- career_kAB %>% 
                  mutate(adj_AVG = ifelse(adj_comp < min_refAVG, min_refAVG, adj_comp))
                
                master_batters_AB <- master_batters_trim %>% select(-adj_AVG)
                
                AVG_part <- mapped_batters_AVG %>%
                  mutate(adj_AVG = round(adj_AVG, 3)) %>% 
                  select(yearID, playerID, adj_AVG)
                
        master_batters <- merge(master_batters_AB, AVG_part, by = c('yearID', 'playerID'))
        
        master_batters <- master_batters %>% 
          mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
        master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0
        
        master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
          mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))

        ## Batters
        batters <- master_batters_nonpara
        
        ## extract and remove bad players 
        foo <- batters %>% 
          arrange(desc(adj_AVG)) %>% 
          filter(adj_AB >= 300) %>% 
          dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
          mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
        bar <- split(foo, as.factor(foo$playerID))
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_fWAR), ]
        }))
        baz <- baz %>% arrange(adj_fWAR)
        bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
        
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_bWAR), ]
        }))
        baz <- baz %>% arrange(adj_bWAR)
        bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
        bad_players <- union(bad_players_bWAR, bad_players_fWAR)
        batters <- batters[!batters$playerID %in% bad_players, ]
        
        ###### investigate anomalies ######
        
        ## more on base events than PAs
        
        # check average for minimal at bats and correct issues
        batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
        batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
        batters[batters$adj_AB > 0, ]$adj_AVG <- 
          round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)
        
        ## build adjusted data set
        batters_adjusted <- batters %>% 
          dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                        adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
        colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                        "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
        batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))
        
        
        ## trim out bad players
        # first round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # second round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # third round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # forth round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        
        ## remove tails 
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                            ifelse(sum(tail(bad, 3)) >= 5,1,0),
                            ifelse(sum(tail(bad, 4)) >= 7,1,0),
                            ifelse(sum(tail(bad, 5)) >= 9,1,0),
                            ifelse(sum(tail(bad, 6)) >= 11,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        ## remove starts
        foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
          bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                            ifelse(sum(head(bad, 2)) >= 3,1,0),
                            ifelse(sum(head(bad, 3)) >= 5,1,0),
                            ifelse(sum(head(bad, 4)) >= 7,1,0),
                            ifelse(sum(head(bad, 5)) >= 9,1,0),
                            ifelse(sum(head(bad, 6)) >= 11,1,0)))
          if (bad_head < length(bad)) {
            (bad_head + 1):length(bad)
          }
        })
        batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)
        
        # taper down average WAR for players with small PAs
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	
        
        batters_adjusted <- do.call(rbind, mclapply(
          split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
          mc.cores = ncores, FUN = function(xx){
            ## natural cubic spline
            ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
            nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
            ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
            nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
            ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
            nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
            ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
            nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
            ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
            nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
            
            xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
              mutate(HR = round((adj_HR + nn_HR)/2)) %>%
              mutate(BB = round((adj_BB + nn_BB)/2)) %>%
              mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
              mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
          })) 
        
        bat_season <- batters_adjusted %>% 
          mutate(PA = adj_AB + BB + HBP + SF)
        bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
          bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB
        
        bat_season <- bat_season %>% 
          dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
        bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
          mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
          mutate(HR = ifelse(HR > 0, HR, 0)) %>%
          mutate(BB = ifelse(BB > 0, BB, 0)) %>%
          mutate(OBP = ifelse(OBP > 0, OBP, 0))
        
        colnames(bat_season)[5] <- 'AB'
        colnames(bat_season)[8] <- 'BA'
        bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
          mutate(BA = round(H / AB, 3)) %>%
          mutate(BA = ifelse(AB == 0, 0, BA)) %>%
          mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
          mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))
        
        YES_pre_int_nonpara_historical_season <- mapped_batters_AVG
        YES_pre_int_nonpara_historical_season_trimmed <- bat_season_nonpara
        
        Ty_Cobb_1911 <- YES_pre_int_nonpara_historical_season %>% filter(yearID == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997 <- YES_pre_int_nonpara_historical_season %>% filter(yearID == 1997, playerID == 'gwynnto01')
        Ty_Cobb_1911_trimmed <- YES_pre_int_nonpara_historical_season_trimmed %>% filter(year == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997_trimmed <- YES_pre_int_nonpara_historical_season_trimmed %>% filter(year == 1997, playerID == 'gwynnto01')
        season_diff <- rbind(season_diff, 
                             data.frame(PF = 'YES', 
                                        pops = 'pre_int', 
                                        para = 'nonpara', 
                                        league = 'historical', 
                                        diff_before = round(Tony_Gwynn_1997$adj_AVG - Ty_Cobb_1911$adj_AVG, 3), 
                                        diff_after = round(Tony_Gwynn_1997_trimmed$BA - Ty_Cobb_1911_trimmed$BA, 3)))

```

```{r cache=TRUE, echo=FALSE}
batters_talent_AVG <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
                  talent_computing_nonpara_fixed(dataset = batters_schell, component_name = "AVG", 
                                                 year = yy, ystar = thresh_fun(component = batters_schell %>% 
                                                                                 filter(full_time == 'Y', yearID == yy) %>%
                                                                                 select(comp), component_name = 'AVG'), 
                                                 alpha = 1.16)
                })) %>% arrange(-WAR_talent)
                
                no_strike <- batters_talent_AVG %>%
                  filter(yearID < 1990, yearID >= 1977, yearID != 1981,
                         full_time == 'Y', lgID == 'NL') %>%
                  arrange(WAR_talent)
                
                min_refAVG <- min(no_strike$comp)
                
                t <- isoreg(no_strike$WAR_talent, no_strike$comp)
                
                talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,250)/250)
                
                comp_new <- as.stepfun(t)(talent_new)
                
                ystar <- thresh_fun(comp_new, component_name = 'AVG')
                pop_new <- round(mean(no_strike$pops))
                component_name = 'AVG'
                yy <- sort(comp_new)
                n <- length(yy)
                ytilde <- rep(0, n + 1)
                if (component_name == 'bWAR' | component_name == 'fWAR') {
                  ytilde[1] <- yy[1] - (yy[2] - yy[1])
                }
                if (component_name == 'HR' | component_name == 'BB') {
                  # since the minimal HR is greater or equal to 0.
                  ytilde[1] <- 0
                }
                if (component_name == 'AVG') {
                  ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
                }
                ytilde[n+1] <- yy[n] + ystar
                ytilde[2:n] <- unlist(lapply(2:n, function(j){
                  (yy[j]+yy[j-1])/2
                }))
                
                career_kAB_AVG_1st <- do.call(rbind, mclapply(1:30000, function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB_AVG_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_AVG), function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB <- rbind(career_kAB_AVG_1st, 
                                    career_kAB_AVG_2nd, 
                                    career_kAB_AVG_3rd)
                
                mapped_batters_AVG <- career_kAB %>% 
                  mutate(adj_AVG = ifelse(adj_comp < min_refAVG, min_refAVG, adj_comp))
                
                master_batters_AB <- master_batters_trim %>% select(-adj_AVG)
                
                AVG_part <- mapped_batters_AVG %>%
                  mutate(adj_AVG = round(adj_AVG, 3)) %>% 
                  select(yearID, playerID, adj_AVG)
                
        master_batters <- merge(master_batters_AB, AVG_part, by = c('yearID', 'playerID'))
        
        master_batters <- master_batters %>% 
          mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
        master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0
        
        master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
          mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))

        ## Batters
        batters <- master_batters_nonpara
        
        ## extract and remove bad players 
        foo <- batters %>% 
          arrange(desc(adj_AVG)) %>% 
          filter(adj_AB >= 300) %>% 
          dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
          mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
        bar <- split(foo, as.factor(foo$playerID))
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_fWAR), ]
        }))
        baz <- baz %>% arrange(adj_fWAR)
        bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
        
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_bWAR), ]
        }))
        baz <- baz %>% arrange(adj_bWAR)
        bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
        bad_players <- union(bad_players_bWAR, bad_players_fWAR)
        batters <- batters[!batters$playerID %in% bad_players, ]
        
        ###### investigate anomalies ######
        
        ## more on base events than PAs
        
        # check average for minimal at bats and correct issues
        batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
        batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
        batters[batters$adj_AB > 0, ]$adj_AVG <- 
          round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)
        
        ## build adjusted data set
        batters_adjusted <- batters %>% 
          dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                        adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
        colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                        "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
        batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))
        
        
        ## trim out bad players
        # first round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # second round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # third round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # forth round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        
        ## remove tails 
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                            ifelse(sum(tail(bad, 3)) >= 5,1,0),
                            ifelse(sum(tail(bad, 4)) >= 7,1,0),
                            ifelse(sum(tail(bad, 5)) >= 9,1,0),
                            ifelse(sum(tail(bad, 6)) >= 11,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        ## remove starts
        foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
          bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                            ifelse(sum(head(bad, 2)) >= 3,1,0),
                            ifelse(sum(head(bad, 3)) >= 5,1,0),
                            ifelse(sum(head(bad, 4)) >= 7,1,0),
                            ifelse(sum(head(bad, 5)) >= 9,1,0),
                            ifelse(sum(head(bad, 6)) >= 11,1,0)))
          if (bad_head < length(bad)) {
            (bad_head + 1):length(bad)
          }
        })
        batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)
        
        # taper down average WAR for players with small PAs
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	
        
        batters_adjusted <- do.call(rbind, mclapply(
          split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
          mc.cores = ncores, FUN = function(xx){
            ## natural cubic spline
            ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
            nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
            ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
            nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
            ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
            nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
            ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
            nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
            ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
            nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
            
            xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
              mutate(HR = round((adj_HR + nn_HR)/2)) %>%
              mutate(BB = round((adj_BB + nn_BB)/2)) %>%
              mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
              mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
          })) 
        
        bat_season <- batters_adjusted %>% 
          mutate(PA = adj_AB + BB + HBP + SF)
        bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
          bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB
        
        bat_season <- bat_season %>% 
          dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
        bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
          mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
          mutate(HR = ifelse(HR > 0, HR, 0)) %>%
          mutate(BB = ifelse(BB > 0, BB, 0)) %>%
          mutate(OBP = ifelse(OBP > 0, OBP, 0))
        
        colnames(bat_season)[5] <- 'AB'
        colnames(bat_season)[8] <- 'BA'
        bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
          mutate(BA = round(H / AB, 3)) %>%
          mutate(BA = ifelse(AB == 0, 0, BA)) %>%
          mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
          mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))
        
        YES_pre_int_nonpara_fixed_season <- mapped_batters_AVG
        YES_pre_int_nonpara_fixed_season_trimmed <- bat_season_nonpara

        Ty_Cobb_1911 <- YES_pre_int_nonpara_fixed_season %>% filter(yearID == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997 <- YES_pre_int_nonpara_fixed_season %>% filter(yearID == 1997, playerID == 'gwynnto01')
        Ty_Cobb_1911_trimmed <- YES_pre_int_nonpara_fixed_season_trimmed %>% filter(year == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997_trimmed <- YES_pre_int_nonpara_fixed_season_trimmed %>% filter(year == 1997, playerID == 'gwynnto01')
        season_diff <- rbind(season_diff, 
                             data.frame(PF = 'YES', 
                                        pops = 'pre_int', 
                                        para = 'nonpara', 
                                        league = 'fixed', 
                                        diff_before = round(Tony_Gwynn_1997$adj_AVG - Ty_Cobb_1911$adj_AVG, 3), 
                                        diff_after = round(Tony_Gwynn_1997_trimmed$BA - Ty_Cobb_1911_trimmed$BA, 3)))

```

```{r cache=TRUE, echo=FALSE}
batters_schell <- batters_schell %>% 
          select(-c('pops', 'NL_pop', 'AL_pop')) %>% 
          left_join(MLBpops_econ_effect %>% 
                      select(year, NL_pop, AL_pop), by = c('yearID' = 'year')) %>% 
          mutate(pops = ifelse(lgID == "NL",NL_pop,AL_pop))
```

```{r cache=TRUE, echo=FALSE}
batters_talent_AVG <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
                  talent_computing_para(dataset = batters_schell, year = yy, alpha = 1.16)
                })) %>% arrange(-talent)
                
                no_strike <- batters_talent_AVG %>%
                  filter(yearID < 1990, yearID >= 1977, yearID != 1981,
                         full_time == 'Y', lgID == 'NL') %>%
                  arrange(talent)
                
                min_refAVG <- min(no_strike$comp)
                
                t <- isoreg(no_strike$talent, no_strike$comp)
                
                talent_new <- quantile(no_strike$talent, probs = seq(0,250)/250)
                comp_new <- as.stepfun(t)(talent_new)
                pop_new <- round(mean(no_strike$pops))
                
                mean_new <- mean(comp_new)
                sd_new <- sd(comp_new)
                
                career_kAB_AVG_1st <- do.call(rbind, mclapply(1:30000, function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_AVG), function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB <- rbind(career_kAB_AVG_1st, 
                                    career_kAB_AVG_2nd, 
                                    career_kAB_AVG_3rd)
                
                mapped_batters_AVG <- career_kAB %>% 
                  mutate(adj_AVG = ifelse(adj_comp < min_refAVG, min_refAVG, adj_comp))
                
                master_batters_AB <- master_batters_trim %>% select(-adj_AVG)
                
                AVG_part <- mapped_batters_AVG %>%
                  mutate(adj_AVG = round(adj_AVG, 3)) %>% 
                  select(yearID, playerID, adj_AVG)
                
        master_batters <- merge(master_batters_AB, AVG_part, by = c('yearID', 'playerID'))
        
        master_batters <- master_batters %>% 
          mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
        master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0
        
        master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
          mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))

        ## Batters
        batters <- master_batters_nonpara
        
        ## extract and remove bad players 
        foo <- batters %>% 
          arrange(desc(adj_AVG)) %>% 
          filter(adj_AB >= 300) %>% 
          dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
          mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
        bar <- split(foo, as.factor(foo$playerID))
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_fWAR), ]
        }))
        baz <- baz %>% arrange(adj_fWAR)
        bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
        
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_bWAR), ]
        }))
        baz <- baz %>% arrange(adj_bWAR)
        bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
        bad_players <- union(bad_players_bWAR, bad_players_fWAR)
        batters <- batters[!batters$playerID %in% bad_players, ]
        
        ###### investigate anomalies ######
        
        ## more on base events than PAs
        
        # check average for minimal at bats and correct issues
        batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
        batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
        batters[batters$adj_AB > 0, ]$adj_AVG <- 
          round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)
        
        ## build adjusted data set
        batters_adjusted <- batters %>% 
          dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                        adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
        colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                        "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
        batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))
        
        
        ## trim out bad players
        # first round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # second round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # third round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # forth round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        
        ## remove tails 
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                            ifelse(sum(tail(bad, 3)) >= 5,1,0),
                            ifelse(sum(tail(bad, 4)) >= 7,1,0),
                            ifelse(sum(tail(bad, 5)) >= 9,1,0),
                            ifelse(sum(tail(bad, 6)) >= 11,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        ## remove starts
        foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
          bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                            ifelse(sum(head(bad, 2)) >= 3,1,0),
                            ifelse(sum(head(bad, 3)) >= 5,1,0),
                            ifelse(sum(head(bad, 4)) >= 7,1,0),
                            ifelse(sum(head(bad, 5)) >= 9,1,0),
                            ifelse(sum(head(bad, 6)) >= 11,1,0)))
          if (bad_head < length(bad)) {
            (bad_head + 1):length(bad)
          }
        })
        batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)
        
        # taper down average WAR for players with small PAs
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	
        
        batters_adjusted <- do.call(rbind, mclapply(
          split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
          mc.cores = ncores, FUN = function(xx){
            ## natural cubic spline
            ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
            nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
            ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
            nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
            ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
            nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
            ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
            nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
            ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
            nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
            
            xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
              mutate(HR = round((adj_HR + nn_HR)/2)) %>%
              mutate(BB = round((adj_BB + nn_BB)/2)) %>%
              mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
              mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
          })) 
        
        bat_season <- batters_adjusted %>% 
          mutate(PA = adj_AB + BB + HBP + SF)
        bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
          bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB
        
        bat_season <- bat_season %>% 
          dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
        bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
          mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
          mutate(HR = ifelse(HR > 0, HR, 0)) %>%
          mutate(BB = ifelse(BB > 0, BB, 0)) %>%
          mutate(OBP = ifelse(OBP > 0, OBP, 0))
        
        colnames(bat_season)[5] <- 'AB'
        colnames(bat_season)[8] <- 'BA'
        bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
          mutate(BA = round(H / AB, 3)) %>%
          mutate(BA = ifelse(AB == 0, 0, BA)) %>%
          mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
          mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))
        
        YES_econ_effect_para_historical_season <- mapped_batters_AVG
        YES_econ_effect_para_historical_season_trimmed <- bat_season_nonpara
        
        Ty_Cobb_1911 <- YES_econ_effect_para_historical_season %>% filter(yearID == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997 <- YES_econ_effect_para_historical_season %>% filter(yearID == 1997, playerID == 'gwynnto01')
        Ty_Cobb_1911_trimmed <- YES_econ_effect_para_historical_season_trimmed %>% filter(year == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997_trimmed <- YES_econ_effect_para_historical_season_trimmed %>% filter(year == 1997, playerID == 'gwynnto01')
        season_diff <- rbind(season_diff, 
                             data.frame(PF = 'YES', 
                                        pops = 'econ_effect', 
                                        para = 'para', 
                                        league = 'historical', 
                                        diff_before = round(Tony_Gwynn_1997$adj_AVG - Ty_Cobb_1911$adj_AVG, 3), 
                                        diff_after = round(Tony_Gwynn_1997_trimmed$BA - Ty_Cobb_1911_trimmed$BA, 3)))

```

```{r cache=TRUE, echo=FALSE}
batters_talent_AVG <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
                  talent_computing_para_fixed(dataset = batters_schell, year = yy, alpha = 1.16)
                })) %>% arrange(-talent)
                
                no_strike <- batters_talent_AVG %>%
                  filter(yearID < 1990, yearID >= 1977, yearID != 1981,
                         full_time == 'Y', lgID == 'NL') %>%
                  arrange(talent)
                
                min_refAVG <- min(no_strike$comp)
                
                t <- isoreg(no_strike$talent, no_strike$comp)
                
                talent_new <- quantile(no_strike$talent, probs = seq(0,250)/250)
                comp_new <- as.stepfun(t)(talent_new)
                pop_new <- round(mean(no_strike$pops))
                
                mean_new <- mean(comp_new)
                sd_new <- sd(comp_new)
                
                career_kAB_AVG_1st <- do.call(rbind, mclapply(1:30000, function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_AVG), function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB <- rbind(career_kAB_AVG_1st, 
                                    career_kAB_AVG_2nd, 
                                    career_kAB_AVG_3rd)
                
                mapped_batters_AVG <- career_kAB %>% 
                  mutate(adj_AVG = ifelse(adj_comp < min_refAVG, min_refAVG, adj_comp))
                
                master_batters_AB <- master_batters_trim %>% select(-adj_AVG)
                
                AVG_part <- mapped_batters_AVG %>%
                  mutate(adj_AVG = round(adj_AVG, 3)) %>% 
                  select(yearID, playerID, adj_AVG)
                
        master_batters <- merge(master_batters_AB, AVG_part, by = c('yearID', 'playerID'))
        
        master_batters <- master_batters %>% 
          mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
        master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0
        
        master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
          mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))

        ## Batters
        batters <- master_batters_nonpara
        
        ## extract and remove bad players 
        foo <- batters %>% 
          arrange(desc(adj_AVG)) %>% 
          filter(adj_AB >= 300) %>% 
          dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
          mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
        bar <- split(foo, as.factor(foo$playerID))
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_fWAR), ]
        }))
        baz <- baz %>% arrange(adj_fWAR)
        bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
        
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_bWAR), ]
        }))
        baz <- baz %>% arrange(adj_bWAR)
        bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
        bad_players <- union(bad_players_bWAR, bad_players_fWAR)
        batters <- batters[!batters$playerID %in% bad_players, ]
        
        ###### investigate anomalies ######
        
        ## more on base events than PAs
        
        # check average for minimal at bats and correct issues
        batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
        batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
        batters[batters$adj_AB > 0, ]$adj_AVG <- 
          round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)
        
        ## build adjusted data set
        batters_adjusted <- batters %>% 
          dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                        adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
        colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                        "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
        batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))
        
        
        ## trim out bad players
        # first round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # second round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # third round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # forth round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        
        ## remove tails 
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                            ifelse(sum(tail(bad, 3)) >= 5,1,0),
                            ifelse(sum(tail(bad, 4)) >= 7,1,0),
                            ifelse(sum(tail(bad, 5)) >= 9,1,0),
                            ifelse(sum(tail(bad, 6)) >= 11,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        ## remove starts
        foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
          bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                            ifelse(sum(head(bad, 2)) >= 3,1,0),
                            ifelse(sum(head(bad, 3)) >= 5,1,0),
                            ifelse(sum(head(bad, 4)) >= 7,1,0),
                            ifelse(sum(head(bad, 5)) >= 9,1,0),
                            ifelse(sum(head(bad, 6)) >= 11,1,0)))
          if (bad_head < length(bad)) {
            (bad_head + 1):length(bad)
          }
        })
        batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)
        
        # taper down average WAR for players with small PAs
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	
        
        batters_adjusted <- do.call(rbind, mclapply(
          split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
          mc.cores = ncores, FUN = function(xx){
            ## natural cubic spline
            ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
            nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
            ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
            nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
            ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
            nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
            ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
            nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
            ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
            nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
            
            xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
              mutate(HR = round((adj_HR + nn_HR)/2)) %>%
              mutate(BB = round((adj_BB + nn_BB)/2)) %>%
              mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
              mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
          })) 
        
        bat_season <- batters_adjusted %>% 
          mutate(PA = adj_AB + BB + HBP + SF)
        bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
          bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB
        
        bat_season <- bat_season %>% 
          dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
        bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
          mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
          mutate(HR = ifelse(HR > 0, HR, 0)) %>%
          mutate(BB = ifelse(BB > 0, BB, 0)) %>%
          mutate(OBP = ifelse(OBP > 0, OBP, 0))
        
        colnames(bat_season)[5] <- 'AB'
        colnames(bat_season)[8] <- 'BA'
        bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
          mutate(BA = round(H / AB, 3)) %>%
          mutate(BA = ifelse(AB == 0, 0, BA)) %>%
          mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
          mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))
        
        YES_econ_effect_para_fixed_season <- mapped_batters_AVG
        YES_econ_effect_para_fixed_season_trimmed <- bat_season_nonpara
        
        Ty_Cobb_1911 <- YES_econ_effect_para_fixed_season %>% filter(yearID == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997 <- YES_econ_effect_para_fixed_season %>% filter(yearID == 1997, playerID == 'gwynnto01')
        Ty_Cobb_1911_trimmed <- YES_econ_effect_para_fixed_season_trimmed %>% filter(year == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997_trimmed <- YES_econ_effect_para_fixed_season_trimmed %>% filter(year == 1997, playerID == 'gwynnto01')
        season_diff <- rbind(season_diff, 
                             data.frame(PF = 'YES', 
                                        pops = 'econ_effect', 
                                        para = 'para', 
                                        league = 'fixed', 
                                        diff_before = round(Tony_Gwynn_1997$adj_AVG - Ty_Cobb_1911$adj_AVG, 3), 
                                        diff_after = round(Tony_Gwynn_1997_trimmed$BA - Ty_Cobb_1911_trimmed$BA, 3)))

```

```{r cache=TRUE, echo=FALSE}
batters_talent_AVG <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
                  talent_computing_nonpara(dataset = batters_schell, component_name = "AVG", 
                                           year = yy, ystar = thresh_fun(component = batters_schell %>% 
                                                                           filter(full_time == 'Y', yearID == yy) %>%
                                                                           select(comp), component_name = 'AVG'), 
                                           alpha = 1.16)
                })) %>% arrange(-WAR_talent)
                
                no_strike <- batters_talent_AVG %>%
                  filter(yearID < 1990, yearID >= 1977, yearID != 1981,
                         full_time == 'Y', lgID == 'NL') %>%
                  arrange(WAR_talent)
                
                min_refAVG <- min(no_strike$comp)
                
                t <- isoreg(no_strike$WAR_talent, no_strike$comp)
                
                talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,250)/250)
                
                comp_new <- as.stepfun(t)(talent_new)
                
                ystar <- thresh_fun(comp_new, component_name = 'AVG')
                pop_new <- round(mean(no_strike$pops))
                component_name = 'AVG'
                yy <- sort(comp_new)
                n <- length(yy)
                ytilde <- rep(0, n + 1)
                if (component_name == 'bWAR' | component_name == 'fWAR') {
                  ytilde[1] <- yy[1] - (yy[2] - yy[1])
                }
                if (component_name == 'HR' | component_name == 'BB') {
                  # since the minimal HR is greater or equal to 0.
                  ytilde[1] <- 0
                }
                if (component_name == 'AVG') {
                  ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
                }
                ytilde[n+1] <- yy[n] + ystar
                ytilde[2:n] <- unlist(lapply(2:n, function(j){
                  (yy[j]+yy[j-1])/2
                }))
                
                career_kAB_AVG_1st <- do.call(rbind, mclapply(1:30000, function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB_AVG_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_AVG), function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB <- rbind(career_kAB_AVG_1st, 
                                    career_kAB_AVG_2nd, 
                                    career_kAB_AVG_3rd)
                
                mapped_batters_AVG <- career_kAB %>% 
                  mutate(adj_AVG = ifelse(adj_comp < min_refAVG, min_refAVG, adj_comp))
                
                master_batters_AB <- master_batters_trim %>% select(-adj_AVG)
                
                AVG_part <- mapped_batters_AVG %>%
                  mutate(adj_AVG = round(adj_AVG, 3)) %>% 
                  select(yearID, playerID, adj_AVG)
                
        master_batters <- merge(master_batters_AB, AVG_part, by = c('yearID', 'playerID'))
        
        master_batters <- master_batters %>% 
          mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
        master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0
        
        master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
          mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))

        ## Batters
        batters <- master_batters_nonpara
        
        ## extract and remove bad players 
        foo <- batters %>% 
          arrange(desc(adj_AVG)) %>% 
          filter(adj_AB >= 300) %>% 
          dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
          mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
        bar <- split(foo, as.factor(foo$playerID))
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_fWAR), ]
        }))
        baz <- baz %>% arrange(adj_fWAR)
        bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
        
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_bWAR), ]
        }))
        baz <- baz %>% arrange(adj_bWAR)
        bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
        bad_players <- union(bad_players_bWAR, bad_players_fWAR)
        batters <- batters[!batters$playerID %in% bad_players, ]
        
        ###### investigate anomalies ######
        
        ## more on base events than PAs
        
        # check average for minimal at bats and correct issues
        batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
        batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
        batters[batters$adj_AB > 0, ]$adj_AVG <- 
          round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)
        
        ## build adjusted data set
        batters_adjusted <- batters %>% 
          dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                        adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
        colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                        "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
        batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))
        
        
        ## trim out bad players
        # first round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # second round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # third round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # forth round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        
        ## remove tails 
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                            ifelse(sum(tail(bad, 3)) >= 5,1,0),
                            ifelse(sum(tail(bad, 4)) >= 7,1,0),
                            ifelse(sum(tail(bad, 5)) >= 9,1,0),
                            ifelse(sum(tail(bad, 6)) >= 11,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        ## remove starts
        foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
          bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                            ifelse(sum(head(bad, 2)) >= 3,1,0),
                            ifelse(sum(head(bad, 3)) >= 5,1,0),
                            ifelse(sum(head(bad, 4)) >= 7,1,0),
                            ifelse(sum(head(bad, 5)) >= 9,1,0),
                            ifelse(sum(head(bad, 6)) >= 11,1,0)))
          if (bad_head < length(bad)) {
            (bad_head + 1):length(bad)
          }
        })
        batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)
        
        # taper down average WAR for players with small PAs
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	
        
        batters_adjusted <- do.call(rbind, mclapply(
          split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
          mc.cores = ncores, FUN = function(xx){
            ## natural cubic spline
            ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
            nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
            ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
            nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
            ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
            nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
            ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
            nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
            ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
            nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
            
            xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
              mutate(HR = round((adj_HR + nn_HR)/2)) %>%
              mutate(BB = round((adj_BB + nn_BB)/2)) %>%
              mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
              mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
          })) 
        
        bat_season <- batters_adjusted %>% 
          mutate(PA = adj_AB + BB + HBP + SF)
        bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
          bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB
        
        bat_season <- bat_season %>% 
          dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
        bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
          mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
          mutate(HR = ifelse(HR > 0, HR, 0)) %>%
          mutate(BB = ifelse(BB > 0, BB, 0)) %>%
          mutate(OBP = ifelse(OBP > 0, OBP, 0))
        
        colnames(bat_season)[5] <- 'AB'
        colnames(bat_season)[8] <- 'BA'
        bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
          mutate(BA = round(H / AB, 3)) %>%
          mutate(BA = ifelse(AB == 0, 0, BA)) %>%
          mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
          mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))
        
        YES_econ_effect_nonpara_historical_season <- mapped_batters_AVG
        YES_econ_effect_nonpara_historical_season_trimmed <- bat_season_nonpara
        
        Ty_Cobb_1911 <- YES_econ_effect_nonpara_historical_season %>% filter(yearID == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997 <- YES_econ_effect_nonpara_historical_season %>% filter(yearID == 1997, playerID == 'gwynnto01')
        Ty_Cobb_1911_trimmed <- YES_econ_effect_nonpara_historical_season_trimmed %>% filter(year == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997_trimmed <- YES_econ_effect_nonpara_historical_season_trimmed %>% filter(year == 1997, playerID == 'gwynnto01')
        season_diff <- rbind(season_diff, 
                             data.frame(PF = 'YES', 
                                        pops = 'econ_effect', 
                                        para = 'nonpara', 
                                        league = 'historical', 
                                        diff_before = round(Tony_Gwynn_1997$adj_AVG - Ty_Cobb_1911$adj_AVG, 3), 
                                        diff_after = round(Tony_Gwynn_1997_trimmed$BA - Ty_Cobb_1911_trimmed$BA, 3)))

```

```{r cache=TRUE, echo=FALSE}
batters_talent_AVG <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
                  talent_computing_nonpara_fixed(dataset = batters_schell, component_name = "AVG", 
                                                 year = yy, ystar = thresh_fun(component = batters_schell %>% 
                                                                                 filter(full_time == 'Y', yearID == yy) %>%
                                                                                 select(comp), component_name = 'AVG'), 
                                                 alpha = 1.16)
                })) %>% arrange(-WAR_talent)
                
                no_strike <- batters_talent_AVG %>%
                  filter(yearID < 1990, yearID >= 1977, yearID != 1981,
                         full_time == 'Y', lgID == 'NL') %>%
                  arrange(WAR_talent)
                
                min_refAVG <- min(no_strike$comp)
                
                t <- isoreg(no_strike$WAR_talent, no_strike$comp)
                
                talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,250)/250)
                
                comp_new <- as.stepfun(t)(talent_new)
                
                ystar <- thresh_fun(comp_new, component_name = 'AVG')
                pop_new <- round(mean(no_strike$pops))
                component_name = 'AVG'
                yy <- sort(comp_new)
                n <- length(yy)
                ytilde <- rep(0, n + 1)
                if (component_name == 'bWAR' | component_name == 'fWAR') {
                  ytilde[1] <- yy[1] - (yy[2] - yy[1])
                }
                if (component_name == 'HR' | component_name == 'BB') {
                  # since the minimal HR is greater or equal to 0.
                  ytilde[1] <- 0
                }
                if (component_name == 'AVG') {
                  ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
                }
                ytilde[n+1] <- yy[n] + ystar
                ytilde[2:n] <- unlist(lapply(2:n, function(j){
                  (yy[j]+yy[j-1])/2
                }))
                
                career_kAB_AVG_1st <- do.call(rbind, mclapply(1:30000, function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB_AVG_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_AVG), function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB <- rbind(career_kAB_AVG_1st, 
                                    career_kAB_AVG_2nd, 
                                    career_kAB_AVG_3rd)
                
                mapped_batters_AVG <- career_kAB %>% 
                  mutate(adj_AVG = ifelse(adj_comp < min_refAVG, min_refAVG, adj_comp))
                
                master_batters_AB <- master_batters_trim %>% select(-adj_AVG)
                
                AVG_part <- mapped_batters_AVG %>%
                  mutate(adj_AVG = round(adj_AVG, 3)) %>% 
                  select(yearID, playerID, adj_AVG)
                
        master_batters <- merge(master_batters_AB, AVG_part, by = c('yearID', 'playerID'))
        
        master_batters <- master_batters %>% 
          mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
        master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0
        
        master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
          mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))

        ## Batters
        batters <- master_batters_nonpara
        
        ## extract and remove bad players 
        foo <- batters %>% 
          arrange(desc(adj_AVG)) %>% 
          filter(adj_AB >= 300) %>% 
          dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
          mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
        bar <- split(foo, as.factor(foo$playerID))
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_fWAR), ]
        }))
        baz <- baz %>% arrange(adj_fWAR)
        bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
        
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_bWAR), ]
        }))
        baz <- baz %>% arrange(adj_bWAR)
        bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
        bad_players <- union(bad_players_bWAR, bad_players_fWAR)
        batters <- batters[!batters$playerID %in% bad_players, ]
        
        ###### investigate anomalies ######
        
        ## more on base events than PAs
        
        # check average for minimal at bats and correct issues
        batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
        batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
        batters[batters$adj_AB > 0, ]$adj_AVG <- 
          round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)
        
        ## build adjusted data set
        batters_adjusted <- batters %>% 
          dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                        adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
        colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                        "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
        batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))
        
        
        ## trim out bad players
        # first round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # second round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # third round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # forth round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        
        ## remove tails 
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                            ifelse(sum(tail(bad, 3)) >= 5,1,0),
                            ifelse(sum(tail(bad, 4)) >= 7,1,0),
                            ifelse(sum(tail(bad, 5)) >= 9,1,0),
                            ifelse(sum(tail(bad, 6)) >= 11,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        ## remove starts
        foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
          bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                            ifelse(sum(head(bad, 2)) >= 3,1,0),
                            ifelse(sum(head(bad, 3)) >= 5,1,0),
                            ifelse(sum(head(bad, 4)) >= 7,1,0),
                            ifelse(sum(head(bad, 5)) >= 9,1,0),
                            ifelse(sum(head(bad, 6)) >= 11,1,0)))
          if (bad_head < length(bad)) {
            (bad_head + 1):length(bad)
          }
        })
        batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)
        
        # taper down average WAR for players with small PAs
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	
        
        batters_adjusted <- do.call(rbind, mclapply(
          split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
          mc.cores = ncores, FUN = function(xx){
            ## natural cubic spline
            ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
            nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
            ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
            nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
            ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
            nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
            ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
            nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
            ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
            nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
            
            xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
              mutate(HR = round((adj_HR + nn_HR)/2)) %>%
              mutate(BB = round((adj_BB + nn_BB)/2)) %>%
              mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
              mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
          })) 
        
        bat_season <- batters_adjusted %>% 
          mutate(PA = adj_AB + BB + HBP + SF)
        bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
          bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB
        
        bat_season <- bat_season %>% 
          dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
        bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
          mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
          mutate(HR = ifelse(HR > 0, HR, 0)) %>%
          mutate(BB = ifelse(BB > 0, BB, 0)) %>%
          mutate(OBP = ifelse(OBP > 0, OBP, 0))
        
        colnames(bat_season)[5] <- 'AB'
        colnames(bat_season)[8] <- 'BA'
        bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
          mutate(BA = round(H / AB, 3)) %>%
          mutate(BA = ifelse(AB == 0, 0, BA)) %>%
          mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
          mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))
        
        YES_econ_effect_nonpara_fixed_season <- mapped_batters_AVG
        YES_econ_effect_nonpara_fixed_season_trimmed <- bat_season_nonpara

        Ty_Cobb_1911 <- YES_econ_effect_nonpara_fixed_season %>% filter(yearID == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997 <- YES_econ_effect_nonpara_fixed_season %>% filter(yearID == 1997, playerID == 'gwynnto01')
        Ty_Cobb_1911_trimmed <- YES_econ_effect_nonpara_fixed_season_trimmed %>% filter(year == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997_trimmed <- YES_econ_effect_nonpara_fixed_season_trimmed %>% filter(year == 1997, playerID == 'gwynnto01')
        season_diff <- rbind(season_diff, 
                             data.frame(PF = 'YES', 
                                        pops = 'econ_effect', 
                                        para = 'nonpara', 
                                        league = 'fixed', 
                                        diff_before = round(Tony_Gwynn_1997$adj_AVG - Ty_Cobb_1911$adj_AVG, 3), 
                                        diff_after = round(Tony_Gwynn_1997_trimmed$BA - Ty_Cobb_1911_trimmed$BA, 3)))

```

```{r cache=TRUE, echo=FALSE}
batters_schell <- batters_schell %>% 
          select(-c('pops', 'NL_pop', 'AL_pop')) %>% 
          left_join(MLBpops %>% 
                      select(year, NL_pop, AL_pop), by = c('yearID' = 'year')) %>% 
          mutate(pops = ifelse(lgID == "NL",NL_pop,AL_pop))
```

```{r cache=TRUE, echo=FALSE}
batters_talent_AVG <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
                  talent_computing_para(dataset = batters_schell, year = yy, alpha = 1.16)
                })) %>% arrange(-talent)
                
                no_strike <- batters_talent_AVG %>%
                  filter(yearID < 1990, yearID >= 1977, yearID != 1981,
                         full_time == 'Y', lgID == 'NL') %>%
                  arrange(talent)
                
                min_refAVG <- min(no_strike$comp)
                
                t <- isoreg(no_strike$talent, no_strike$comp)
                
                talent_new <- quantile(no_strike$talent, probs = seq(0,250)/250)
                comp_new <- as.stepfun(t)(talent_new)
                pop_new <- round(mean(no_strike$pops))
                
                mean_new <- mean(comp_new)
                sd_new <- sd(comp_new)
                
                career_kAB_AVG_1st <- do.call(rbind, mclapply(1:30000, function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_AVG), function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB <- rbind(career_kAB_AVG_1st, 
                                    career_kAB_AVG_2nd, 
                                    career_kAB_AVG_3rd)
                
                mapped_batters_AVG <- career_kAB %>% 
                  mutate(adj_AVG = ifelse(adj_comp < min_refAVG, min_refAVG, adj_comp))
                
                master_batters_AB <- master_batters_trim %>% select(-adj_AVG)
                
                AVG_part <- mapped_batters_AVG %>%
                  mutate(adj_AVG = round(adj_AVG, 3)) %>% 
                  select(yearID, playerID, adj_AVG)
                
        master_batters <- merge(master_batters_AB, AVG_part, by = c('yearID', 'playerID'))
        
        master_batters <- master_batters %>% 
          mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
        master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0
        
        master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
          mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))

        ## Batters
        batters <- master_batters_nonpara
        
        ## extract and remove bad players 
        foo <- batters %>% 
          arrange(desc(adj_AVG)) %>% 
          filter(adj_AB >= 300) %>% 
          dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
          mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
        bar <- split(foo, as.factor(foo$playerID))
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_fWAR), ]
        }))
        baz <- baz %>% arrange(adj_fWAR)
        bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
        
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_bWAR), ]
        }))
        baz <- baz %>% arrange(adj_bWAR)
        bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
        bad_players <- union(bad_players_bWAR, bad_players_fWAR)
        batters <- batters[!batters$playerID %in% bad_players, ]
        
        ###### investigate anomalies ######
        
        ## more on base events than PAs
        
        # check average for minimal at bats and correct issues
        batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
        batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
        batters[batters$adj_AB > 0, ]$adj_AVG <- 
          round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)
        
        ## build adjusted data set
        batters_adjusted <- batters %>% 
          dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                        adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
        colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                        "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
        batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))
        
        
        ## trim out bad players
        # first round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # second round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # third round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # forth round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        
        ## remove tails 
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                            ifelse(sum(tail(bad, 3)) >= 5,1,0),
                            ifelse(sum(tail(bad, 4)) >= 7,1,0),
                            ifelse(sum(tail(bad, 5)) >= 9,1,0),
                            ifelse(sum(tail(bad, 6)) >= 11,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        ## remove starts
        foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
          bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                            ifelse(sum(head(bad, 2)) >= 3,1,0),
                            ifelse(sum(head(bad, 3)) >= 5,1,0),
                            ifelse(sum(head(bad, 4)) >= 7,1,0),
                            ifelse(sum(head(bad, 5)) >= 9,1,0),
                            ifelse(sum(head(bad, 6)) >= 11,1,0)))
          if (bad_head < length(bad)) {
            (bad_head + 1):length(bad)
          }
        })
        batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)
        
        # taper down average WAR for players with small PAs
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	
        
        batters_adjusted <- do.call(rbind, mclapply(
          split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
          mc.cores = ncores, FUN = function(xx){
            ## natural cubic spline
            ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
            nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
            ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
            nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
            ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
            nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
            ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
            nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
            ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
            nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
            
            xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
              mutate(HR = round((adj_HR + nn_HR)/2)) %>%
              mutate(BB = round((adj_BB + nn_BB)/2)) %>%
              mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
              mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
          })) 
        
        bat_season <- batters_adjusted %>% 
          mutate(PA = adj_AB + BB + HBP + SF)
        bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
          bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB
        
        bat_season <- bat_season %>% 
          dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
        bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
          mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
          mutate(HR = ifelse(HR > 0, HR, 0)) %>%
          mutate(BB = ifelse(BB > 0, BB, 0)) %>%
          mutate(OBP = ifelse(OBP > 0, OBP, 0))
        
        colnames(bat_season)[5] <- 'AB'
        colnames(bat_season)[8] <- 'BA'
        bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
          mutate(BA = round(H / AB, 3)) %>%
          mutate(BA = ifelse(AB == 0, 0, BA)) %>%
          mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
          mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))
        
        YES_normal_para_historical_season <- mapped_batters_AVG
        YES_normal_para_historical_season_trimmed <- bat_season_nonpara
        
        Ty_Cobb_1911 <- YES_normal_para_historical_season %>% filter(yearID == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997 <- YES_normal_para_historical_season %>% filter(yearID == 1997, playerID == 'gwynnto01')
        Ty_Cobb_1911_trimmed <- YES_normal_para_historical_season_trimmed %>% filter(year == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997_trimmed <- YES_normal_para_historical_season_trimmed %>% filter(year == 1997, playerID == 'gwynnto01')
        season_diff <- rbind(season_diff, 
                             data.frame(PF = 'YES', 
                                        pops = 'normal', 
                                        para = 'para', 
                                        league = 'historical', 
                                        diff_before = round(Tony_Gwynn_1997$adj_AVG - Ty_Cobb_1911$adj_AVG, 3), 
                                        diff_after = round(Tony_Gwynn_1997_trimmed$BA - Ty_Cobb_1911_trimmed$BA, 3)))

```

```{r cache=TRUE, echo=FALSE}
batters_talent_AVG <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
                  talent_computing_para_fixed(dataset = batters_schell, year = yy, alpha = 1.16)
                })) %>% arrange(-talent)
                
                no_strike <- batters_talent_AVG %>%
                  filter(yearID < 1990, yearID >= 1977, yearID != 1981,
                         full_time == 'Y', lgID == 'NL') %>%
                  arrange(talent)
                
                min_refAVG <- min(no_strike$comp)
                
                t <- isoreg(no_strike$talent, no_strike$comp)
                
                talent_new <- quantile(no_strike$talent, probs = seq(0,250)/250)
                comp_new <- as.stepfun(t)(talent_new)
                pop_new <- round(mean(no_strike$pops))
                
                mean_new <- mean(comp_new)
                sd_new <- sd(comp_new)
                
                career_kAB_AVG_1st <- do.call(rbind, mclapply(1:30000, function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_AVG), function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB <- rbind(career_kAB_AVG_1st, 
                                    career_kAB_AVG_2nd, 
                                    career_kAB_AVG_3rd)
                
                mapped_batters_AVG <- career_kAB %>% 
                  mutate(adj_AVG = ifelse(adj_comp < min_refAVG, min_refAVG, adj_comp))
                
                master_batters_AB <- master_batters_trim %>% select(-adj_AVG)
                
                AVG_part <- mapped_batters_AVG %>%
                  mutate(adj_AVG = round(adj_AVG, 3)) %>% 
                  select(yearID, playerID, adj_AVG)
                
        master_batters <- merge(master_batters_AB, AVG_part, by = c('yearID', 'playerID'))
        
        master_batters <- master_batters %>% 
          mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
        master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0
        
        master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
          mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))

        ## Batters
        batters <- master_batters_nonpara
        
        ## extract and remove bad players 
        foo <- batters %>% 
          arrange(desc(adj_AVG)) %>% 
          filter(adj_AB >= 300) %>% 
          dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
          mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
        bar <- split(foo, as.factor(foo$playerID))
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_fWAR), ]
        }))
        baz <- baz %>% arrange(adj_fWAR)
        bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
        
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_bWAR), ]
        }))
        baz <- baz %>% arrange(adj_bWAR)
        bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
        bad_players <- union(bad_players_bWAR, bad_players_fWAR)
        batters <- batters[!batters$playerID %in% bad_players, ]
        
        ###### investigate anomalies ######
        
        ## more on base events than PAs
        
        # check average for minimal at bats and correct issues
        batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
        batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
        batters[batters$adj_AB > 0, ]$adj_AVG <- 
          round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)
        
        ## build adjusted data set
        batters_adjusted <- batters %>% 
          dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                        adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
        colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                        "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
        batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))
        
        
        ## trim out bad players
        # first round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # second round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # third round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # forth round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        
        ## remove tails 
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                            ifelse(sum(tail(bad, 3)) >= 5,1,0),
                            ifelse(sum(tail(bad, 4)) >= 7,1,0),
                            ifelse(sum(tail(bad, 5)) >= 9,1,0),
                            ifelse(sum(tail(bad, 6)) >= 11,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        ## remove starts
        foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
          bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                            ifelse(sum(head(bad, 2)) >= 3,1,0),
                            ifelse(sum(head(bad, 3)) >= 5,1,0),
                            ifelse(sum(head(bad, 4)) >= 7,1,0),
                            ifelse(sum(head(bad, 5)) >= 9,1,0),
                            ifelse(sum(head(bad, 6)) >= 11,1,0)))
          if (bad_head < length(bad)) {
            (bad_head + 1):length(bad)
          }
        })
        batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)
        
        # taper down average WAR for players with small PAs
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	
        
        batters_adjusted <- do.call(rbind, mclapply(
          split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
          mc.cores = ncores, FUN = function(xx){
            ## natural cubic spline
            ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
            nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
            ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
            nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
            ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
            nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
            ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
            nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
            ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
            nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
            
            xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
              mutate(HR = round((adj_HR + nn_HR)/2)) %>%
              mutate(BB = round((adj_BB + nn_BB)/2)) %>%
              mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
              mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
          })) 
        
        bat_season <- batters_adjusted %>% 
          mutate(PA = adj_AB + BB + HBP + SF)
        bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
          bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB
        
        bat_season <- bat_season %>% 
          dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
        bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
          mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
          mutate(HR = ifelse(HR > 0, HR, 0)) %>%
          mutate(BB = ifelse(BB > 0, BB, 0)) %>%
          mutate(OBP = ifelse(OBP > 0, OBP, 0))
        
        colnames(bat_season)[5] <- 'AB'
        colnames(bat_season)[8] <- 'BA'
        bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
          mutate(BA = round(H / AB, 3)) %>%
          mutate(BA = ifelse(AB == 0, 0, BA)) %>%
          mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
          mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))
        
        YES_normal_para_fixed_season <- mapped_batters_AVG
        YES_normal_para_fixed_season_trimmed <- bat_season_nonpara
        
        Ty_Cobb_1911 <- YES_normal_para_fixed_season %>% filter(yearID == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997 <- YES_normal_para_fixed_season %>% filter(yearID == 1997, playerID == 'gwynnto01')
        Ty_Cobb_1911_trimmed <- YES_normal_para_fixed_season_trimmed %>% filter(year == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997_trimmed <- YES_normal_para_fixed_season_trimmed %>% filter(year == 1997, playerID == 'gwynnto01')
        season_diff <- rbind(season_diff, 
                             data.frame(PF = 'YES', 
                                        pops = 'normal', 
                                        para = 'para', 
                                        league = 'fixed', 
                                        diff_before = round(Tony_Gwynn_1997$adj_AVG - Ty_Cobb_1911$adj_AVG, 3), 
                                        diff_after = round(Tony_Gwynn_1997_trimmed$BA - Ty_Cobb_1911_trimmed$BA, 3)))

```

```{r cache=TRUE, echo=FALSE}
batters_talent_AVG <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
                  talent_computing_nonpara(dataset = batters_schell, component_name = "AVG", 
                                           year = yy, ystar = thresh_fun(component = batters_schell %>% 
                                                                           filter(full_time == 'Y', yearID == yy) %>%
                                                                           select(comp), component_name = 'AVG'), 
                                           alpha = 1.16)
                })) %>% arrange(-WAR_talent)
                
                no_strike <- batters_talent_AVG %>%
                  filter(yearID < 1990, yearID >= 1977, yearID != 1981,
                         full_time == 'Y', lgID == 'NL') %>%
                  arrange(WAR_talent)
                
                min_refAVG <- min(no_strike$comp)
                
                t <- isoreg(no_strike$WAR_talent, no_strike$comp)
                
                talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,250)/250)
                
                comp_new <- as.stepfun(t)(talent_new)
                
                ystar <- thresh_fun(comp_new, component_name = 'AVG')
                pop_new <- round(mean(no_strike$pops))
                component_name = 'AVG'
                yy <- sort(comp_new)
                n <- length(yy)
                ytilde <- rep(0, n + 1)
                if (component_name == 'bWAR' | component_name == 'fWAR') {
                  ytilde[1] <- yy[1] - (yy[2] - yy[1])
                }
                if (component_name == 'HR' | component_name == 'BB') {
                  # since the minimal HR is greater or equal to 0.
                  ytilde[1] <- 0
                }
                if (component_name == 'AVG') {
                  ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
                }
                ytilde[n+1] <- yy[n] + ystar
                ytilde[2:n] <- unlist(lapply(2:n, function(j){
                  (yy[j]+yy[j-1])/2
                }))
                
                career_kAB_AVG_1st <- do.call(rbind, mclapply(1:30000, function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB_AVG_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_AVG), function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB <- rbind(career_kAB_AVG_1st, 
                                    career_kAB_AVG_2nd, 
                                    career_kAB_AVG_3rd)
                
                mapped_batters_AVG <- career_kAB %>% 
                  mutate(adj_AVG = ifelse(adj_comp < min_refAVG, min_refAVG, adj_comp))
                
                master_batters_AB <- master_batters_trim %>% select(-adj_AVG)
                
                AVG_part <- mapped_batters_AVG %>%
                  mutate(adj_AVG = round(adj_AVG, 3)) %>% 
                  select(yearID, playerID, adj_AVG)
                
        master_batters <- merge(master_batters_AB, AVG_part, by = c('yearID', 'playerID'))
        
        master_batters <- master_batters %>% 
          mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
        master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0
        
        master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
          mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))

        ## Batters
        batters <- master_batters_nonpara
        
        ## extract and remove bad players 
        foo <- batters %>% 
          arrange(desc(adj_AVG)) %>% 
          filter(adj_AB >= 300) %>% 
          dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
          mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
        bar <- split(foo, as.factor(foo$playerID))
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_fWAR), ]
        }))
        baz <- baz %>% arrange(adj_fWAR)
        bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
        
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_bWAR), ]
        }))
        baz <- baz %>% arrange(adj_bWAR)
        bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
        bad_players <- union(bad_players_bWAR, bad_players_fWAR)
        batters <- batters[!batters$playerID %in% bad_players, ]
        
        ###### investigate anomalies ######
        
        ## more on base events than PAs
        
        # check average for minimal at bats and correct issues
        batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
        batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
        batters[batters$adj_AB > 0, ]$adj_AVG <- 
          round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)
        
        ## build adjusted data set
        batters_adjusted <- batters %>% 
          dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                        adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
        colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                        "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
        batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))
        
        
        ## trim out bad players
        # first round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # second round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # third round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # forth round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        
        ## remove tails 
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                            ifelse(sum(tail(bad, 3)) >= 5,1,0),
                            ifelse(sum(tail(bad, 4)) >= 7,1,0),
                            ifelse(sum(tail(bad, 5)) >= 9,1,0),
                            ifelse(sum(tail(bad, 6)) >= 11,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        ## remove starts
        foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
          bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                            ifelse(sum(head(bad, 2)) >= 3,1,0),
                            ifelse(sum(head(bad, 3)) >= 5,1,0),
                            ifelse(sum(head(bad, 4)) >= 7,1,0),
                            ifelse(sum(head(bad, 5)) >= 9,1,0),
                            ifelse(sum(head(bad, 6)) >= 11,1,0)))
          if (bad_head < length(bad)) {
            (bad_head + 1):length(bad)
          }
        })
        batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)
        
        # taper down average WAR for players with small PAs
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	
        
        batters_adjusted <- do.call(rbind, mclapply(
          split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
          mc.cores = ncores, FUN = function(xx){
            ## natural cubic spline
            ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
            nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
            ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
            nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
            ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
            nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
            ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
            nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
            ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
            nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
            
            xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
              mutate(HR = round((adj_HR + nn_HR)/2)) %>%
              mutate(BB = round((adj_BB + nn_BB)/2)) %>%
              mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
              mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
          })) 
        
        bat_season <- batters_adjusted %>% 
          mutate(PA = adj_AB + BB + HBP + SF)
        bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
          bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB
        
        bat_season <- bat_season %>% 
          dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
        bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
          mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
          mutate(HR = ifelse(HR > 0, HR, 0)) %>%
          mutate(BB = ifelse(BB > 0, BB, 0)) %>%
          mutate(OBP = ifelse(OBP > 0, OBP, 0))
        
        colnames(bat_season)[5] <- 'AB'
        colnames(bat_season)[8] <- 'BA'
        bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
          mutate(BA = round(H / AB, 3)) %>%
          mutate(BA = ifelse(AB == 0, 0, BA)) %>%
          mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
          mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))
        
        YES_normal_nonpara_historical_season <- mapped_batters_AVG
        YES_normal_nonpara_historical_season_trimmed <- bat_season_nonpara
        
        Ty_Cobb_1911 <- YES_normal_nonpara_historical_season %>% filter(yearID == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997 <- YES_normal_nonpara_historical_season %>% filter(yearID == 1997, playerID == 'gwynnto01')
        Ty_Cobb_1911_trimmed <- YES_normal_nonpara_historical_season_trimmed %>% filter(year == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997_trimmed <- YES_normal_nonpara_historical_season_trimmed %>% filter(year == 1997, playerID == 'gwynnto01')
        season_diff <- rbind(season_diff, 
                             data.frame(PF = 'YES', 
                                        pops = 'normal', 
                                        para = 'nonpara', 
                                        league = 'historical', 
                                        diff_before = round(Tony_Gwynn_1997$adj_AVG - Ty_Cobb_1911$adj_AVG, 3), 
                                        diff_after = round(Tony_Gwynn_1997_trimmed$BA - Ty_Cobb_1911_trimmed$BA, 3)))

```

```{r cache=TRUE, echo=FALSE}
batters_talent_AVG <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
                  talent_computing_nonpara_fixed(dataset = batters_schell, component_name = "AVG", 
                                                 year = yy, ystar = thresh_fun(component = batters_schell %>% 
                                                                                 filter(full_time == 'Y', yearID == yy) %>%
                                                                                 select(comp), component_name = 'AVG'), 
                                                 alpha = 1.16)
                })) %>% arrange(-WAR_talent)
                
                no_strike <- batters_talent_AVG %>%
                  filter(yearID < 1990, yearID >= 1977, yearID != 1981,
                         full_time == 'Y', lgID == 'NL') %>%
                  arrange(WAR_talent)
                
                min_refAVG <- min(no_strike$comp)
                
                t <- isoreg(no_strike$WAR_talent, no_strike$comp)
                
                talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,250)/250)
                
                comp_new <- as.stepfun(t)(talent_new)
                
                ystar <- thresh_fun(comp_new, component_name = 'AVG')
                pop_new <- round(mean(no_strike$pops))
                component_name = 'AVG'
                yy <- sort(comp_new)
                n <- length(yy)
                ytilde <- rep(0, n + 1)
                if (component_name == 'bWAR' | component_name == 'fWAR') {
                  ytilde[1] <- yy[1] - (yy[2] - yy[1])
                }
                if (component_name == 'HR' | component_name == 'BB') {
                  # since the minimal HR is greater or equal to 0.
                  ytilde[1] <- 0
                }
                if (component_name == 'AVG') {
                  ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
                }
                ytilde[n+1] <- yy[n] + ystar
                ytilde[2:n] <- unlist(lapply(2:n, function(j){
                  (yy[j]+yy[j-1])/2
                }))
                
                career_kAB_AVG_1st <- do.call(rbind, mclapply(1:30000, function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB_AVG_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_AVG), function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB <- rbind(career_kAB_AVG_1st, 
                                    career_kAB_AVG_2nd, 
                                    career_kAB_AVG_3rd)                
                mapped_batters_AVG <- career_kAB %>% 
                  mutate(adj_AVG = ifelse(adj_comp < min_refAVG, min_refAVG, adj_comp))
                
                master_batters_AB <- master_batters_trim %>% select(-adj_AVG)
                
                AVG_part <- mapped_batters_AVG %>%
                  mutate(adj_AVG = round(adj_AVG, 3)) %>% 
                  select(yearID, playerID, adj_AVG)
                
        master_batters <- merge(master_batters_AB, AVG_part, by = c('yearID', 'playerID'))
        
        master_batters <- master_batters %>% 
          mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
        master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0
        
        master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
          mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))

        ## Batters
        batters <- master_batters_nonpara
        
        ## extract and remove bad players 
        foo <- batters %>% 
          arrange(desc(adj_AVG)) %>% 
          filter(adj_AB >= 300) %>% 
          dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
          mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
        bar <- split(foo, as.factor(foo$playerID))
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_fWAR), ]
        }))
        baz <- baz %>% arrange(adj_fWAR)
        bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
        
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_bWAR), ]
        }))
        baz <- baz %>% arrange(adj_bWAR)
        bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
        bad_players <- union(bad_players_bWAR, bad_players_fWAR)
        batters <- batters[!batters$playerID %in% bad_players, ]
        
        ###### investigate anomalies ######
        
        ## more on base events than PAs
        
        # check average for minimal at bats and correct issues
        batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
        batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
        batters[batters$adj_AB > 0, ]$adj_AVG <- 
          round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)
        
        ## build adjusted data set
        batters_adjusted <- batters %>% 
          dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                        adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
        colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                        "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
        batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))
        
        
        ## trim out bad players
        # first round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # second round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # third round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # forth round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        
        ## remove tails 
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                            ifelse(sum(tail(bad, 3)) >= 5,1,0),
                            ifelse(sum(tail(bad, 4)) >= 7,1,0),
                            ifelse(sum(tail(bad, 5)) >= 9,1,0),
                            ifelse(sum(tail(bad, 6)) >= 11,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        ## remove starts
        foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
          bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                            ifelse(sum(head(bad, 2)) >= 3,1,0),
                            ifelse(sum(head(bad, 3)) >= 5,1,0),
                            ifelse(sum(head(bad, 4)) >= 7,1,0),
                            ifelse(sum(head(bad, 5)) >= 9,1,0),
                            ifelse(sum(head(bad, 6)) >= 11,1,0)))
          if (bad_head < length(bad)) {
            (bad_head + 1):length(bad)
          }
        })
        batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)
        
        # taper down average WAR for players with small PAs
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	
        
        batters_adjusted <- do.call(rbind, mclapply(
          split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
          mc.cores = ncores, FUN = function(xx){
            ## natural cubic spline
            ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
            nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
            ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
            nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
            ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
            nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
            ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
            nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
            ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
            nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
            
            xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
              mutate(HR = round((adj_HR + nn_HR)/2)) %>%
              mutate(BB = round((adj_BB + nn_BB)/2)) %>%
              mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
              mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
          })) 
        
        bat_season <- batters_adjusted %>% 
          mutate(PA = adj_AB + BB + HBP + SF)
        bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
          bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB
        
        bat_season <- bat_season %>% 
          dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
        bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
          mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
          mutate(HR = ifelse(HR > 0, HR, 0)) %>%
          mutate(BB = ifelse(BB > 0, BB, 0)) %>%
          mutate(OBP = ifelse(OBP > 0, OBP, 0))
        
        colnames(bat_season)[5] <- 'AB'
        colnames(bat_season)[8] <- 'BA'
        bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
          mutate(BA = round(H / AB, 3)) %>%
          mutate(BA = ifelse(AB == 0, 0, BA)) %>%
          mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
          mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))
        
        YES_normal_nonpara_fixed_season <- mapped_batters_AVG
        YES_normal_nonpara_fixed_season_trimmed <- bat_season_nonpara

        Ty_Cobb_1911 <- YES_normal_nonpara_fixed_season %>% filter(yearID == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997 <- YES_normal_nonpara_fixed_season %>% filter(yearID == 1997, playerID == 'gwynnto01')
        Ty_Cobb_1911_trimmed <- YES_normal_nonpara_fixed_season_trimmed %>% filter(year == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997_trimmed <- YES_normal_nonpara_fixed_season_trimmed %>% filter(year == 1997, playerID == 'gwynnto01')
        season_diff <- rbind(season_diff, 
                             data.frame(PF = 'YES', 
                                        pops = 'normal', 
                                        para = 'nonpara', 
                                        league = 'fixed', 
                                        diff_before = round(Tony_Gwynn_1997$adj_AVG - Ty_Cobb_1911$adj_AVG, 3), 
                                        diff_after = round(Tony_Gwynn_1997_trimmed$BA - Ty_Cobb_1911_trimmed$BA, 3)))

```

```{r cache=TRUE, echo=FALSE}
load("bat_pit_pops.RData")
batters <- bat_dat %>% left_join(master_batters_trim %>% select(playerID, yearID, adj_AB))
  cutoff <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    m <- batters %>% filter(yearID == xx) %>% filter(PA >= 75)
    data.frame(thres = median(m$PA), yearID = xx)
  }))
  batters <- merge(batters, cutoff, by = 'yearID')
  batters <- batters %>% mutate(full_time = ifelse(PA >= thres, 'Y', 'N')) 
  
batters <- batters %>% select(playerID, yearID, lgID, name, lgID, AB, obs_hits, full_time, pops, adj_AB) %>% mutate(comp = ifelse(AB != 0, obs_hits / AB, 0))
    
batters_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
      int<- batters %>% filter(yearID == xx)
      lg_avg <- sum(int$obs_hits)/sum(int$AB)
      int %>% mutate(comp = (obs_hits + lg_avg * 25)/(AB + 25))
    }))
```

```{r cache=TRUE, echo=FALSE}
batters_schell <- batters_schell %>% 
          select(-pops) %>% 
          left_join(MLBpops_pre_int %>% 
                      select(year, NL_pop, AL_pop), by = c('yearID' = 'year')) %>% 
          mutate(pops = ifelse(lgID == "NL",NL_pop,AL_pop))
```

```{r cache=TRUE, echo=FALSE}
batters_talent_AVG <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
                  talent_computing_para(dataset = batters_schell, year = yy, alpha = 1.16)
                })) %>% arrange(-talent)
                
                no_strike <- batters_talent_AVG %>%
                  filter(yearID < 1990, yearID >= 1977, yearID != 1981,
                         full_time == 'Y', lgID == 'NL') %>%
                  arrange(talent)
                
                min_refAVG <- min(no_strike$comp)
                
                t <- isoreg(no_strike$talent, no_strike$comp)
                
                talent_new <- quantile(no_strike$talent, probs = seq(0,250)/250)
                comp_new <- as.stepfun(t)(talent_new)
                pop_new <- round(mean(no_strike$pops))
                
                mean_new <- mean(comp_new)
                sd_new <- sd(comp_new)
                
                career_kAB_AVG_1st <- do.call(rbind, mclapply(1:30000, function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_AVG), function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB <- rbind(career_kAB_AVG_1st, 
                                    career_kAB_AVG_2nd, 
                                    career_kAB_AVG_3rd)
                
                mapped_batters_AVG <- career_kAB %>% 
                  mutate(adj_AVG = ifelse(adj_comp < min_refAVG, min_refAVG, adj_comp))
                
                master_batters_AB <- master_batters_trim %>% select(-adj_AVG)
                
                AVG_part <- mapped_batters_AVG %>%
                  mutate(adj_AVG = round(adj_AVG, 3)) %>% 
                  select(yearID, playerID, adj_AVG)
                
        master_batters <- merge(master_batters_AB, AVG_part, by = c('yearID', 'playerID'))
        
        master_batters <- master_batters %>% 
          mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
        master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0
        
        master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
          mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))

        ## Batters
        batters <- master_batters_nonpara
        
        ## extract and remove bad players 
        foo <- batters %>% 
          arrange(desc(adj_AVG)) %>% 
          filter(adj_AB >= 300) %>% 
          dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
          mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
        bar <- split(foo, as.factor(foo$playerID))
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_fWAR), ]
        }))
        baz <- baz %>% arrange(adj_fWAR)
        bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
        
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_bWAR), ]
        }))
        baz <- baz %>% arrange(adj_bWAR)
        bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
        bad_players <- union(bad_players_bWAR, bad_players_fWAR)
        batters <- batters[!batters$playerID %in% bad_players, ]
        
        ###### investigate anomalies ######
        
        ## more on base events than PAs
        
        # check average for minimal at bats and correct issues
        batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
        batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
        batters[batters$adj_AB > 0, ]$adj_AVG <- 
          round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)
        
        ## build adjusted data set
        batters_adjusted <- batters %>% 
          dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                        adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
        colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                        "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
        batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))
        
        
        ## trim out bad players
        # first round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # second round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # third round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # forth round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        
        ## remove tails 
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                            ifelse(sum(tail(bad, 3)) >= 5,1,0),
                            ifelse(sum(tail(bad, 4)) >= 7,1,0),
                            ifelse(sum(tail(bad, 5)) >= 9,1,0),
                            ifelse(sum(tail(bad, 6)) >= 11,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        ## remove starts
        foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
          bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                            ifelse(sum(head(bad, 2)) >= 3,1,0),
                            ifelse(sum(head(bad, 3)) >= 5,1,0),
                            ifelse(sum(head(bad, 4)) >= 7,1,0),
                            ifelse(sum(head(bad, 5)) >= 9,1,0),
                            ifelse(sum(head(bad, 6)) >= 11,1,0)))
          if (bad_head < length(bad)) {
            (bad_head + 1):length(bad)
          }
        })
        batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)
        
        # taper down average WAR for players with small PAs
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	
        
        batters_adjusted <- do.call(rbind, mclapply(
          split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
          mc.cores = ncores, FUN = function(xx){
            ## natural cubic spline
            ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
            nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
            ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
            nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
            ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
            nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
            ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
            nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
            ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
            nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
            
            xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
              mutate(HR = round((adj_HR + nn_HR)/2)) %>%
              mutate(BB = round((adj_BB + nn_BB)/2)) %>%
              mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
              mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
          })) 
        
        bat_season <- batters_adjusted %>% 
          mutate(PA = adj_AB + BB + HBP + SF)
        bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
          bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB
        
        bat_season <- bat_season %>% 
          dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
        bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
          mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
          mutate(HR = ifelse(HR > 0, HR, 0)) %>%
          mutate(BB = ifelse(BB > 0, BB, 0)) %>%
          mutate(OBP = ifelse(OBP > 0, OBP, 0))
        
        colnames(bat_season)[5] <- 'AB'
        colnames(bat_season)[8] <- 'BA'
        bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
          mutate(BA = round(H / AB, 3)) %>%
          mutate(BA = ifelse(AB == 0, 0, BA)) %>%
          mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
          mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))
        
        NO_pre_int_para_historical_season <- mapped_batters_AVG
        NO_pre_int_para_historical_season_trimmed <- bat_season_nonpara
        
        Ty_Cobb_1911 <- NO_pre_int_para_historical_season %>% filter(yearID == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997 <- NO_pre_int_para_historical_season %>% filter(yearID == 1997, playerID == 'gwynnto01')
        Ty_Cobb_1911_trimmed <- NO_pre_int_para_historical_season_trimmed %>% filter(year == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997_trimmed <- NO_pre_int_para_historical_season_trimmed %>% filter(year == 1997, playerID == 'gwynnto01')
        season_diff <- rbind(season_diff, 
                             data.frame(PF = 'NO', 
                                        pops = 'pre_int', 
                                        para = 'para', 
                                        league = 'historical', 
                                        diff_before = round(Tony_Gwynn_1997$adj_AVG - Ty_Cobb_1911$adj_AVG, 3), 
                                        diff_after = round(Tony_Gwynn_1997_trimmed$BA - Ty_Cobb_1911_trimmed$BA, 3)))

```

```{r cache=TRUE, echo=FALSE}
batters_talent_AVG <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
                  talent_computing_para_fixed(dataset = batters_schell, year = yy, alpha = 1.16)
                })) %>% arrange(-talent)
                
                no_strike <- batters_talent_AVG %>%
                  filter(yearID < 1990, yearID >= 1977, yearID != 1981,
                         full_time == 'Y', lgID == 'NL') %>%
                  arrange(talent)
                
                min_refAVG <- min(no_strike$comp)
                
                t <- isoreg(no_strike$talent, no_strike$comp)
                
                talent_new <- quantile(no_strike$talent, probs = seq(0,250)/250)
                comp_new <- as.stepfun(t)(talent_new)
                pop_new <- round(mean(no_strike$pops))
                
                mean_new <- mean(comp_new)
                sd_new <- sd(comp_new)
                
                career_kAB_AVG_1st <- do.call(rbind, mclapply(1:30000, function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_AVG), function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB <- rbind(career_kAB_AVG_1st, 
                                    career_kAB_AVG_2nd, 
                                    career_kAB_AVG_3rd)
                
                mapped_batters_AVG <- career_kAB %>% 
                  mutate(adj_AVG = ifelse(adj_comp < min_refAVG, min_refAVG, adj_comp))
                
                master_batters_AB <- master_batters_trim %>% select(-adj_AVG)
                
                AVG_part <- mapped_batters_AVG %>%
                  mutate(adj_AVG = round(adj_AVG, 3)) %>% 
                  select(yearID, playerID, adj_AVG)
                
        master_batters <- merge(master_batters_AB, AVG_part, by = c('yearID', 'playerID'))
        
        master_batters <- master_batters %>% 
          mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
        master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0
        
        master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
          mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))

        ## Batters
        batters <- master_batters_nonpara
        
        ## extract and remove bad players 
        foo <- batters %>% 
          arrange(desc(adj_AVG)) %>% 
          filter(adj_AB >= 300) %>% 
          dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
          mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
        bar <- split(foo, as.factor(foo$playerID))
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_fWAR), ]
        }))
        baz <- baz %>% arrange(adj_fWAR)
        bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
        
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_bWAR), ]
        }))
        baz <- baz %>% arrange(adj_bWAR)
        bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
        bad_players <- union(bad_players_bWAR, bad_players_fWAR)
        batters <- batters[!batters$playerID %in% bad_players, ]
        
        ###### investigate anomalies ######
        
        ## more on base events than PAs
        
        # check average for minimal at bats and correct issues
        batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
        batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
        batters[batters$adj_AB > 0, ]$adj_AVG <- 
          round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)
        
        ## build adjusted data set
        batters_adjusted <- batters %>% 
          dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                        adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
        colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                        "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
        batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))
        
        
        ## trim out bad players
        # first round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # second round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # third round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # forth round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        
        ## remove tails 
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                            ifelse(sum(tail(bad, 3)) >= 5,1,0),
                            ifelse(sum(tail(bad, 4)) >= 7,1,0),
                            ifelse(sum(tail(bad, 5)) >= 9,1,0),
                            ifelse(sum(tail(bad, 6)) >= 11,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        ## remove starts
        foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
          bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                            ifelse(sum(head(bad, 2)) >= 3,1,0),
                            ifelse(sum(head(bad, 3)) >= 5,1,0),
                            ifelse(sum(head(bad, 4)) >= 7,1,0),
                            ifelse(sum(head(bad, 5)) >= 9,1,0),
                            ifelse(sum(head(bad, 6)) >= 11,1,0)))
          if (bad_head < length(bad)) {
            (bad_head + 1):length(bad)
          }
        })
        batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)
        
        # taper down average WAR for players with small PAs
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	
        
        batters_adjusted <- do.call(rbind, mclapply(
          split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
          mc.cores = ncores, FUN = function(xx){
            ## natural cubic spline
            ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
            nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
            ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
            nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
            ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
            nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
            ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
            nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
            ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
            nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
            
            xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
              mutate(HR = round((adj_HR + nn_HR)/2)) %>%
              mutate(BB = round((adj_BB + nn_BB)/2)) %>%
              mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
              mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
          })) 
        
        bat_season <- batters_adjusted %>% 
          mutate(PA = adj_AB + BB + HBP + SF)
        bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
          bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB
        
        bat_season <- bat_season %>% 
          dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
        bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
          mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
          mutate(HR = ifelse(HR > 0, HR, 0)) %>%
          mutate(BB = ifelse(BB > 0, BB, 0)) %>%
          mutate(OBP = ifelse(OBP > 0, OBP, 0))
        
        colnames(bat_season)[5] <- 'AB'
        colnames(bat_season)[8] <- 'BA'
        bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
          mutate(BA = round(H / AB, 3)) %>%
          mutate(BA = ifelse(AB == 0, 0, BA)) %>%
          mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
          mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))
        
        NO_pre_int_para_fixed_season <- mapped_batters_AVG
        NO_pre_int_para_fixed_season_trimmed <- bat_season_nonpara
        
        Ty_Cobb_1911 <- NO_pre_int_para_fixed_season %>% filter(yearID == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997 <- NO_pre_int_para_fixed_season %>% filter(yearID == 1997, playerID == 'gwynnto01')
        Ty_Cobb_1911_trimmed <- NO_pre_int_para_fixed_season_trimmed %>% filter(year == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997_trimmed <- NO_pre_int_para_fixed_season_trimmed %>% filter(year == 1997, playerID == 'gwynnto01')
        season_diff <- rbind(season_diff, 
                             data.frame(PF = 'NO', 
                                        pops = 'pre_int', 
                                        para = 'para', 
                                        league = 'fixed', 
                                        diff_before = round(Tony_Gwynn_1997$adj_AVG - Ty_Cobb_1911$adj_AVG, 3), 
                                        diff_after = round(Tony_Gwynn_1997_trimmed$BA - Ty_Cobb_1911_trimmed$BA, 3)))

```

```{r cache=TRUE, echo=FALSE}
batters_talent_AVG <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
                  talent_computing_nonpara(dataset = batters_schell, component_name = "AVG", 
                                           year = yy, ystar = thresh_fun(component = batters_schell %>% 
                                                                           filter(full_time == 'Y', yearID == yy) %>%
                                                                           select(comp), component_name = 'AVG'), 
                                           alpha = 1.16)
                })) %>% arrange(-WAR_talent)
                
                no_strike <- batters_talent_AVG %>%
                  filter(yearID < 1990, yearID >= 1977, yearID != 1981,
                         full_time == 'Y', lgID == 'NL') %>%
                  arrange(WAR_talent)
                
                min_refAVG <- min(no_strike$comp)
                
                t <- isoreg(no_strike$WAR_talent, no_strike$comp)
                
                talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,250)/250)
                
                comp_new <- as.stepfun(t)(talent_new)
                
                ystar <- thresh_fun(comp_new, component_name = 'AVG')
                pop_new <- round(mean(no_strike$pops))
                component_name = 'AVG'
                yy <- sort(comp_new)
                n <- length(yy)
                ytilde <- rep(0, n + 1)
                if (component_name == 'bWAR' | component_name == 'fWAR') {
                  ytilde[1] <- yy[1] - (yy[2] - yy[1])
                }
                if (component_name == 'HR' | component_name == 'BB') {
                  # since the minimal HR is greater or equal to 0.
                  ytilde[1] <- 0
                }
                if (component_name == 'AVG') {
                  ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
                }
                ytilde[n+1] <- yy[n] + ystar
                ytilde[2:n] <- unlist(lapply(2:n, function(j){
                  (yy[j]+yy[j-1])/2
                }))
                
                career_kAB_AVG_1st <- do.call(rbind, mclapply(1:30000, function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB_AVG_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_AVG), function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB <- rbind(career_kAB_AVG_1st, 
                                    career_kAB_AVG_2nd, 
                                    career_kAB_AVG_3rd)
                
                mapped_batters_AVG <- career_kAB %>% 
                  mutate(adj_AVG = ifelse(adj_comp < min_refAVG, min_refAVG, adj_comp))
                
                master_batters_AB <- master_batters_trim %>% select(-adj_AVG)
                
                AVG_part <- mapped_batters_AVG %>%
                  mutate(adj_AVG = round(adj_AVG, 3)) %>% 
                  select(yearID, playerID, adj_AVG)
                
        master_batters <- merge(master_batters_AB, AVG_part, by = c('yearID', 'playerID'))
        
        master_batters <- master_batters %>% 
          mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
        master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0
        
        master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
          mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))

        ## Batters
        batters <- master_batters_nonpara
        
        ## extract and remove bad players 
        foo <- batters %>% 
          arrange(desc(adj_AVG)) %>% 
          filter(adj_AB >= 300) %>% 
          dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
          mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
        bar <- split(foo, as.factor(foo$playerID))
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_fWAR), ]
        }))
        baz <- baz %>% arrange(adj_fWAR)
        bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
        
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_bWAR), ]
        }))
        baz <- baz %>% arrange(adj_bWAR)
        bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
        bad_players <- union(bad_players_bWAR, bad_players_fWAR)
        batters <- batters[!batters$playerID %in% bad_players, ]
        
        ###### investigate anomalies ######
        
        ## more on base events than PAs
        
        # check average for minimal at bats and correct issues
        batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
        batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
        batters[batters$adj_AB > 0, ]$adj_AVG <- 
          round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)
        
        ## build adjusted data set
        batters_adjusted <- batters %>% 
          dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                        adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
        colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                        "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
        batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))
        
        
        ## trim out bad players
        # first round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # second round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # third round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # forth round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        
        ## remove tails 
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                            ifelse(sum(tail(bad, 3)) >= 5,1,0),
                            ifelse(sum(tail(bad, 4)) >= 7,1,0),
                            ifelse(sum(tail(bad, 5)) >= 9,1,0),
                            ifelse(sum(tail(bad, 6)) >= 11,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        ## remove starts
        foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
          bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                            ifelse(sum(head(bad, 2)) >= 3,1,0),
                            ifelse(sum(head(bad, 3)) >= 5,1,0),
                            ifelse(sum(head(bad, 4)) >= 7,1,0),
                            ifelse(sum(head(bad, 5)) >= 9,1,0),
                            ifelse(sum(head(bad, 6)) >= 11,1,0)))
          if (bad_head < length(bad)) {
            (bad_head + 1):length(bad)
          }
        })
        batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)
        
        # taper down average WAR for players with small PAs
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	
        
        batters_adjusted <- do.call(rbind, mclapply(
          split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
          mc.cores = ncores, FUN = function(xx){
            ## natural cubic spline
            ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
            nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
            ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
            nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
            ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
            nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
            ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
            nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
            ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
            nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
            
            xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
              mutate(HR = round((adj_HR + nn_HR)/2)) %>%
              mutate(BB = round((adj_BB + nn_BB)/2)) %>%
              mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
              mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
          })) 
        
        bat_season <- batters_adjusted %>% 
          mutate(PA = adj_AB + BB + HBP + SF)
        bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
          bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB
        
        bat_season <- bat_season %>% 
          dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
        bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
          mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
          mutate(HR = ifelse(HR > 0, HR, 0)) %>%
          mutate(BB = ifelse(BB > 0, BB, 0)) %>%
          mutate(OBP = ifelse(OBP > 0, OBP, 0))
        
        colnames(bat_season)[5] <- 'AB'
        colnames(bat_season)[8] <- 'BA'
        bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
          mutate(BA = round(H / AB, 3)) %>%
          mutate(BA = ifelse(AB == 0, 0, BA)) %>%
          mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
          mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))
        
        NO_pre_int_nonpara_historical_season <- mapped_batters_AVG
        NO_pre_int_nonpara_historical_season_trimmed <- bat_season_nonpara
        
        Ty_Cobb_1911 <- NO_pre_int_nonpara_historical_season %>% filter(yearID == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997 <- NO_pre_int_nonpara_historical_season %>% filter(yearID == 1997, playerID == 'gwynnto01')
        Ty_Cobb_1911_trimmed <- NO_pre_int_nonpara_historical_season_trimmed %>% filter(year == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997_trimmed <- NO_pre_int_nonpara_historical_season_trimmed %>% filter(year == 1997, playerID == 'gwynnto01')
        season_diff <- rbind(season_diff, 
                             data.frame(PF = 'NO', 
                                        pops = 'pre_int', 
                                        para = 'nonpara', 
                                        league = 'historical', 
                                        diff_before = round(Tony_Gwynn_1997$adj_AVG - Ty_Cobb_1911$adj_AVG, 3), 
                                        diff_after = round(Tony_Gwynn_1997_trimmed$BA - Ty_Cobb_1911_trimmed$BA, 3)))

```

```{r cache=TRUE, echo=FALSE}
batters_talent_AVG <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
                  talent_computing_nonpara_fixed(dataset = batters_schell, component_name = "AVG", 
                                                 year = yy, ystar = thresh_fun(component = batters_schell %>% 
                                                                                 filter(full_time == 'Y', yearID == yy) %>%
                                                                                 select(comp), component_name = 'AVG'), 
                                                 alpha = 1.16)
                })) %>% arrange(-WAR_talent)
                
                no_strike <- batters_talent_AVG %>%
                  filter(yearID < 1990, yearID >= 1977, yearID != 1981,
                         full_time == 'Y', lgID == 'NL') %>%
                  arrange(WAR_talent)
                
                min_refAVG <- min(no_strike$comp)
                
                t <- isoreg(no_strike$WAR_talent, no_strike$comp)
                
                talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,250)/250)
                
                comp_new <- as.stepfun(t)(talent_new)
                
                ystar <- thresh_fun(comp_new, component_name = 'AVG')
                pop_new <- round(mean(no_strike$pops))
                component_name = 'AVG'
                yy <- sort(comp_new)
                n <- length(yy)
                ytilde <- rep(0, n + 1)
                if (component_name == 'bWAR' | component_name == 'fWAR') {
                  ytilde[1] <- yy[1] - (yy[2] - yy[1])
                }
                if (component_name == 'HR' | component_name == 'BB') {
                  # since the minimal HR is greater or equal to 0.
                  ytilde[1] <- 0
                }
                if (component_name == 'AVG') {
                  ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
                }
                ytilde[n+1] <- yy[n] + ystar
                ytilde[2:n] <- unlist(lapply(2:n, function(j){
                  (yy[j]+yy[j-1])/2
                }))
                
                career_kAB_AVG_1st <- do.call(rbind, mclapply(1:30000, function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB_AVG_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_AVG), function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB <- rbind(career_kAB_AVG_1st, 
                                    career_kAB_AVG_2nd, 
                                    career_kAB_AVG_3rd)                
                mapped_batters_AVG <- career_kAB %>% 
                  mutate(adj_AVG = ifelse(adj_comp < min_refAVG, min_refAVG, adj_comp))
                
                master_batters_AB <- master_batters_trim %>% select(-adj_AVG)
                
                AVG_part <- mapped_batters_AVG %>%
                  mutate(adj_AVG = round(adj_AVG, 3)) %>% 
                  select(yearID, playerID, adj_AVG)
                
        master_batters <- merge(master_batters_AB, AVG_part, by = c('yearID', 'playerID'))
        
        master_batters <- master_batters %>% 
          mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
        master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0
        
        master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
          mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))

        ## Batters
        batters <- master_batters_nonpara
        
        ## extract and remove bad players 
        foo <- batters %>% 
          arrange(desc(adj_AVG)) %>% 
          filter(adj_AB >= 300) %>% 
          dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
          mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
        bar <- split(foo, as.factor(foo$playerID))
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_fWAR), ]
        }))
        baz <- baz %>% arrange(adj_fWAR)
        bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
        
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_bWAR), ]
        }))
        baz <- baz %>% arrange(adj_bWAR)
        bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
        bad_players <- union(bad_players_bWAR, bad_players_fWAR)
        batters <- batters[!batters$playerID %in% bad_players, ]
        
        ###### investigate anomalies ######
        
        ## more on base events than PAs
        
        # check average for minimal at bats and correct issues
        batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
        batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
        batters[batters$adj_AB > 0, ]$adj_AVG <- 
          round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)
        
        ## build adjusted data set
        batters_adjusted <- batters %>% 
          dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                        adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
        colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                        "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
        batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))
        
        
        ## trim out bad players
        # first round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # second round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # third round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # forth round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        
        ## remove tails 
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                            ifelse(sum(tail(bad, 3)) >= 5,1,0),
                            ifelse(sum(tail(bad, 4)) >= 7,1,0),
                            ifelse(sum(tail(bad, 5)) >= 9,1,0),
                            ifelse(sum(tail(bad, 6)) >= 11,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        ## remove starts
        foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
          bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                            ifelse(sum(head(bad, 2)) >= 3,1,0),
                            ifelse(sum(head(bad, 3)) >= 5,1,0),
                            ifelse(sum(head(bad, 4)) >= 7,1,0),
                            ifelse(sum(head(bad, 5)) >= 9,1,0),
                            ifelse(sum(head(bad, 6)) >= 11,1,0)))
          if (bad_head < length(bad)) {
            (bad_head + 1):length(bad)
          }
        })
        batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)
        
        # taper down average WAR for players with small PAs
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	
        
        batters_adjusted <- do.call(rbind, mclapply(
          split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
          mc.cores = ncores, FUN = function(xx){
            ## natural cubic spline
            ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
            nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
            ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
            nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
            ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
            nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
            ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
            nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
            ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
            nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
            
            xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
              mutate(HR = round((adj_HR + nn_HR)/2)) %>%
              mutate(BB = round((adj_BB + nn_BB)/2)) %>%
              mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
              mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
          })) 
        
        bat_season <- batters_adjusted %>% 
          mutate(PA = adj_AB + BB + HBP + SF)
        bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
          bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB
        
        bat_season <- bat_season %>% 
          dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
        bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
          mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
          mutate(HR = ifelse(HR > 0, HR, 0)) %>%
          mutate(BB = ifelse(BB > 0, BB, 0)) %>%
          mutate(OBP = ifelse(OBP > 0, OBP, 0))
        
        colnames(bat_season)[5] <- 'AB'
        colnames(bat_season)[8] <- 'BA'
        bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
          mutate(BA = round(H / AB, 3)) %>%
          mutate(BA = ifelse(AB == 0, 0, BA)) %>%
          mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
          mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))
        
        NO_pre_int_nonpara_fixed_season <- mapped_batters_AVG
        NO_pre_int_nonpara_fixed_season_trimmed <- bat_season_nonpara

        Ty_Cobb_1911 <- NO_pre_int_nonpara_fixed_season %>% filter(yearID == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997 <- NO_pre_int_nonpara_fixed_season %>% filter(yearID == 1997, playerID == 'gwynnto01')
        Ty_Cobb_1911_trimmed <- NO_pre_int_nonpara_fixed_season_trimmed %>% filter(year == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997_trimmed <- NO_pre_int_nonpara_fixed_season_trimmed %>% filter(year == 1997, playerID == 'gwynnto01')
        season_diff <- rbind(season_diff, 
                             data.frame(PF = 'NO', 
                                        pops = 'pre_int', 
                                        para = 'nonpara', 
                                        league = 'fixed', 
                                        diff_before = round(Tony_Gwynn_1997$adj_AVG - Ty_Cobb_1911$adj_AVG, 3), 
                                        diff_after = round(Tony_Gwynn_1997_trimmed$BA - Ty_Cobb_1911_trimmed$BA, 3)))

```

```{r cache=TRUE, echo=FALSE}
batters_schell <- batters_schell %>% 
          select(-c('pops', 'NL_pop', 'AL_pop')) %>% 
          left_join(MLBpops_econ_effect %>% 
                      select(year, NL_pop, AL_pop), by = c('yearID' = 'year')) %>% 
          mutate(pops = ifelse(lgID == "NL",NL_pop,AL_pop))
```

```{r cache=TRUE, echo=FALSE}
batters_talent_AVG <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
                  talent_computing_para(dataset = batters_schell, year = yy, alpha = 1.16)
                })) %>% arrange(-talent)
                
                no_strike <- batters_talent_AVG %>%
                  filter(yearID < 1990, yearID >= 1977, yearID != 1981,
                         full_time == 'Y', lgID == 'NL') %>%
                  arrange(talent)
                
                min_refAVG <- min(no_strike$comp)
                
                t <- isoreg(no_strike$talent, no_strike$comp)
                
                talent_new <- quantile(no_strike$talent, probs = seq(0,250)/250)
                comp_new <- as.stepfun(t)(talent_new)
                pop_new <- round(mean(no_strike$pops))
                
                mean_new <- mean(comp_new)
                sd_new <- sd(comp_new)
                
                career_kAB_AVG_1st <- do.call(rbind, mclapply(1:30000, function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_AVG), function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB <- rbind(career_kAB_AVG_1st, 
                                    career_kAB_AVG_2nd, 
                                    career_kAB_AVG_3rd)
                
                mapped_batters_AVG <- career_kAB %>% 
                  mutate(adj_AVG = ifelse(adj_comp < min_refAVG, min_refAVG, adj_comp))
                
                master_batters_AB <- master_batters_trim %>% select(-adj_AVG)
                
                AVG_part <- mapped_batters_AVG %>%
                  mutate(adj_AVG = round(adj_AVG, 3)) %>% 
                  select(yearID, playerID, adj_AVG)
                
        master_batters <- merge(master_batters_AB, AVG_part, by = c('yearID', 'playerID'))
        
        master_batters <- master_batters %>% 
          mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
        master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0
        
        master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
          mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))

        ## Batters
        batters <- master_batters_nonpara
        
        ## extract and remove bad players 
        foo <- batters %>% 
          arrange(desc(adj_AVG)) %>% 
          filter(adj_AB >= 300) %>% 
          dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
          mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
        bar <- split(foo, as.factor(foo$playerID))
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_fWAR), ]
        }))
        baz <- baz %>% arrange(adj_fWAR)
        bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
        
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_bWAR), ]
        }))
        baz <- baz %>% arrange(adj_bWAR)
        bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
        bad_players <- union(bad_players_bWAR, bad_players_fWAR)
        batters <- batters[!batters$playerID %in% bad_players, ]
        
        ###### investigate anomalies ######
        
        ## more on base events than PAs
        
        # check average for minimal at bats and correct issues
        batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
        batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
        batters[batters$adj_AB > 0, ]$adj_AVG <- 
          round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)
        
        ## build adjusted data set
        batters_adjusted <- batters %>% 
          dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                        adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
        colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                        "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
        batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))
        
        
        ## trim out bad players
        # first round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # second round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # third round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # forth round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        
        ## remove tails 
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                            ifelse(sum(tail(bad, 3)) >= 5,1,0),
                            ifelse(sum(tail(bad, 4)) >= 7,1,0),
                            ifelse(sum(tail(bad, 5)) >= 9,1,0),
                            ifelse(sum(tail(bad, 6)) >= 11,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        ## remove starts
        foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
          bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                            ifelse(sum(head(bad, 2)) >= 3,1,0),
                            ifelse(sum(head(bad, 3)) >= 5,1,0),
                            ifelse(sum(head(bad, 4)) >= 7,1,0),
                            ifelse(sum(head(bad, 5)) >= 9,1,0),
                            ifelse(sum(head(bad, 6)) >= 11,1,0)))
          if (bad_head < length(bad)) {
            (bad_head + 1):length(bad)
          }
        })
        batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)
        
        # taper down average WAR for players with small PAs
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	
        
        batters_adjusted <- do.call(rbind, mclapply(
          split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
          mc.cores = ncores, FUN = function(xx){
            ## natural cubic spline
            ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
            nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
            ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
            nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
            ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
            nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
            ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
            nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
            ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
            nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
            
            xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
              mutate(HR = round((adj_HR + nn_HR)/2)) %>%
              mutate(BB = round((adj_BB + nn_BB)/2)) %>%
              mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
              mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
          })) 
        
        bat_season <- batters_adjusted %>% 
          mutate(PA = adj_AB + BB + HBP + SF)
        bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
          bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB
        
        bat_season <- bat_season %>% 
          dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
        bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
          mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
          mutate(HR = ifelse(HR > 0, HR, 0)) %>%
          mutate(BB = ifelse(BB > 0, BB, 0)) %>%
          mutate(OBP = ifelse(OBP > 0, OBP, 0))
        
        colnames(bat_season)[5] <- 'AB'
        colnames(bat_season)[8] <- 'BA'
        bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
          mutate(BA = round(H / AB, 3)) %>%
          mutate(BA = ifelse(AB == 0, 0, BA)) %>%
          mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
          mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))
        
        NO_econ_effect_para_historical_season <- mapped_batters_AVG
        NO_econ_effect_para_historical_season_trimmed <- bat_season_nonpara
        
        Ty_Cobb_1911 <- NO_econ_effect_para_historical_season %>% filter(yearID == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997 <- NO_econ_effect_para_historical_season %>% filter(yearID == 1997, playerID == 'gwynnto01')
        Ty_Cobb_1911_trimmed <- NO_econ_effect_para_historical_season_trimmed %>% filter(year == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997_trimmed <- NO_econ_effect_para_historical_season_trimmed %>% filter(year == 1997, playerID == 'gwynnto01')
        season_diff <- rbind(season_diff, 
                             data.frame(PF = 'NO', 
                                        pops = 'econ_effect', 
                                        para = 'para', 
                                        league = 'historical', 
                                        diff_before = round(Tony_Gwynn_1997$adj_AVG - Ty_Cobb_1911$adj_AVG, 3), 
                                        diff_after = round(Tony_Gwynn_1997_trimmed$BA - Ty_Cobb_1911_trimmed$BA, 3)))

```

```{r cache=TRUE, echo=FALSE}
batters_talent_AVG <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
                  talent_computing_para_fixed(dataset = batters_schell, year = yy, alpha = 1.16)
                })) %>% arrange(-talent)
                
                no_strike <- batters_talent_AVG %>%
                  filter(yearID < 1990, yearID >= 1977, yearID != 1981,
                         full_time == 'Y', lgID == 'NL') %>%
                  arrange(talent)
                
                min_refAVG <- min(no_strike$comp)
                
                t <- isoreg(no_strike$talent, no_strike$comp)
                
                talent_new <- quantile(no_strike$talent, probs = seq(0,250)/250)
                comp_new <- as.stepfun(t)(talent_new)
                pop_new <- round(mean(no_strike$pops))
                
                mean_new <- mean(comp_new)
                sd_new <- sd(comp_new)
                
                career_kAB_AVG_1st <- do.call(rbind, mclapply(1:30000, function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_AVG), function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB <- rbind(career_kAB_AVG_1st, 
                                    career_kAB_AVG_2nd, 
                                    career_kAB_AVG_3rd)
                
                mapped_batters_AVG <- career_kAB %>% 
                  mutate(adj_AVG = ifelse(adj_comp < min_refAVG, min_refAVG, adj_comp))
                
                master_batters_AB <- master_batters_trim %>% select(-adj_AVG)
                
                AVG_part <- mapped_batters_AVG %>%
                  mutate(adj_AVG = round(adj_AVG, 3)) %>% 
                  select(yearID, playerID, adj_AVG)
                
        master_batters <- merge(master_batters_AB, AVG_part, by = c('yearID', 'playerID'))
        
        master_batters <- master_batters %>% 
          mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
        master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0
        
        master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
          mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))

        ## Batters
        batters <- master_batters_nonpara
        
        ## extract and remove bad players 
        foo <- batters %>% 
          arrange(desc(adj_AVG)) %>% 
          filter(adj_AB >= 300) %>% 
          dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
          mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
        bar <- split(foo, as.factor(foo$playerID))
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_fWAR), ]
        }))
        baz <- baz %>% arrange(adj_fWAR)
        bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
        
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_bWAR), ]
        }))
        baz <- baz %>% arrange(adj_bWAR)
        bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
        bad_players <- union(bad_players_bWAR, bad_players_fWAR)
        batters <- batters[!batters$playerID %in% bad_players, ]
        
        ###### investigate anomalies ######
        
        ## more on base events than PAs
        
        # check average for minimal at bats and correct issues
        batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
        batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
        batters[batters$adj_AB > 0, ]$adj_AVG <- 
          round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)
        
        ## build adjusted data set
        batters_adjusted <- batters %>% 
          dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                        adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
        colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                        "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
        batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))
        
        
        ## trim out bad players
        # first round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # second round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # third round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # forth round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        
        ## remove tails 
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                            ifelse(sum(tail(bad, 3)) >= 5,1,0),
                            ifelse(sum(tail(bad, 4)) >= 7,1,0),
                            ifelse(sum(tail(bad, 5)) >= 9,1,0),
                            ifelse(sum(tail(bad, 6)) >= 11,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        ## remove starts
        foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
          bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                            ifelse(sum(head(bad, 2)) >= 3,1,0),
                            ifelse(sum(head(bad, 3)) >= 5,1,0),
                            ifelse(sum(head(bad, 4)) >= 7,1,0),
                            ifelse(sum(head(bad, 5)) >= 9,1,0),
                            ifelse(sum(head(bad, 6)) >= 11,1,0)))
          if (bad_head < length(bad)) {
            (bad_head + 1):length(bad)
          }
        })
        batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)
        
        # taper down average WAR for players with small PAs
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	
        
        batters_adjusted <- do.call(rbind, mclapply(
          split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
          mc.cores = ncores, FUN = function(xx){
            ## natural cubic spline
            ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
            nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
            ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
            nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
            ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
            nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
            ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
            nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
            ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
            nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
            
            xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
              mutate(HR = round((adj_HR + nn_HR)/2)) %>%
              mutate(BB = round((adj_BB + nn_BB)/2)) %>%
              mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
              mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
          })) 
        
        bat_season <- batters_adjusted %>% 
          mutate(PA = adj_AB + BB + HBP + SF)
        bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
          bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB
        
        bat_season <- bat_season %>% 
          dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
        bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
          mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
          mutate(HR = ifelse(HR > 0, HR, 0)) %>%
          mutate(BB = ifelse(BB > 0, BB, 0)) %>%
          mutate(OBP = ifelse(OBP > 0, OBP, 0))
        
        colnames(bat_season)[5] <- 'AB'
        colnames(bat_season)[8] <- 'BA'
        bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
          mutate(BA = round(H / AB, 3)) %>%
          mutate(BA = ifelse(AB == 0, 0, BA)) %>%
          mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
          mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))
        
        NO_econ_effect_para_fixed_season <- mapped_batters_AVG
        NO_econ_effect_para_fixed_season_trimmed <- bat_season_nonpara
        
        Ty_Cobb_1911 <- NO_econ_effect_para_fixed_season %>% filter(yearID == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997 <- NO_econ_effect_para_fixed_season %>% filter(yearID == 1997, playerID == 'gwynnto01')
        Ty_Cobb_1911_trimmed <- NO_econ_effect_para_fixed_season_trimmed %>% filter(year == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997_trimmed <- NO_econ_effect_para_fixed_season_trimmed %>% filter(year == 1997, playerID == 'gwynnto01')
        season_diff <- rbind(season_diff, 
                             data.frame(PF = 'NO', 
                                        pops = 'econ_effect', 
                                        para = 'para', 
                                        league = 'fixed', 
                                        diff_before = round(Tony_Gwynn_1997$adj_AVG - Ty_Cobb_1911$adj_AVG, 3), 
                                        diff_after = round(Tony_Gwynn_1997_trimmed$BA - Ty_Cobb_1911_trimmed$BA, 3)))

```

```{r cache=TRUE, echo=FALSE}
batters_talent_AVG <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
                  talent_computing_nonpara(dataset = batters_schell, component_name = "AVG", 
                                           year = yy, ystar = thresh_fun(component = batters_schell %>% 
                                                                           filter(full_time == 'Y', yearID == yy) %>%
                                                                           select(comp), component_name = 'AVG'), 
                                           alpha = 1.16)
                })) %>% arrange(-WAR_talent)
                
                no_strike <- batters_talent_AVG %>%
                  filter(yearID < 1990, yearID >= 1977, yearID != 1981,
                         full_time == 'Y', lgID == 'NL') %>%
                  arrange(WAR_talent)
                
                min_refAVG <- min(no_strike$comp)
                
                t <- isoreg(no_strike$WAR_talent, no_strike$comp)
                
                talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,250)/250)
                
                comp_new <- as.stepfun(t)(talent_new)
                
                ystar <- thresh_fun(comp_new, component_name = 'AVG')
                pop_new <- round(mean(no_strike$pops))
                component_name = 'AVG'
                yy <- sort(comp_new)
                n <- length(yy)
                ytilde <- rep(0, n + 1)
                if (component_name == 'bWAR' | component_name == 'fWAR') {
                  ytilde[1] <- yy[1] - (yy[2] - yy[1])
                }
                if (component_name == 'HR' | component_name == 'BB') {
                  # since the minimal HR is greater or equal to 0.
                  ytilde[1] <- 0
                }
                if (component_name == 'AVG') {
                  ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
                }
                ytilde[n+1] <- yy[n] + ystar
                ytilde[2:n] <- unlist(lapply(2:n, function(j){
                  (yy[j]+yy[j-1])/2
                }))
                
                career_kAB_AVG_1st <- do.call(rbind, mclapply(1:30000, function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB_AVG_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_AVG), function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB <- rbind(career_kAB_AVG_1st, 
                                    career_kAB_AVG_2nd, 
                                    career_kAB_AVG_3rd)
                
                mapped_batters_AVG <- career_kAB %>% 
                  mutate(adj_AVG = ifelse(adj_comp < min_refAVG, min_refAVG, adj_comp))
                
                master_batters_AB <- master_batters_trim %>% select(-adj_AVG)
                
                AVG_part <- mapped_batters_AVG %>%
                  mutate(adj_AVG = round(adj_AVG, 3)) %>% 
                  select(yearID, playerID, adj_AVG)
                
        master_batters <- merge(master_batters_AB, AVG_part, by = c('yearID', 'playerID'))
        
        master_batters <- master_batters %>% 
          mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
        master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0
        
        master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
          mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))

        ## Batters
        batters <- master_batters_nonpara
        
        ## extract and remove bad players 
        foo <- batters %>% 
          arrange(desc(adj_AVG)) %>% 
          filter(adj_AB >= 300) %>% 
          dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
          mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
        bar <- split(foo, as.factor(foo$playerID))
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_fWAR), ]
        }))
        baz <- baz %>% arrange(adj_fWAR)
        bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
        
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_bWAR), ]
        }))
        baz <- baz %>% arrange(adj_bWAR)
        bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
        bad_players <- union(bad_players_bWAR, bad_players_fWAR)
        batters <- batters[!batters$playerID %in% bad_players, ]
        
        ###### investigate anomalies ######
        
        ## more on base events than PAs
        
        # check average for minimal at bats and correct issues
        batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
        batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
        batters[batters$adj_AB > 0, ]$adj_AVG <- 
          round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)
        
        ## build adjusted data set
        batters_adjusted <- batters %>% 
          dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                        adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
        colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                        "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
        batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))
        
        
        ## trim out bad players
        # first round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # second round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # third round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # forth round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        
        ## remove tails 
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                            ifelse(sum(tail(bad, 3)) >= 5,1,0),
                            ifelse(sum(tail(bad, 4)) >= 7,1,0),
                            ifelse(sum(tail(bad, 5)) >= 9,1,0),
                            ifelse(sum(tail(bad, 6)) >= 11,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        ## remove starts
        foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
          bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                            ifelse(sum(head(bad, 2)) >= 3,1,0),
                            ifelse(sum(head(bad, 3)) >= 5,1,0),
                            ifelse(sum(head(bad, 4)) >= 7,1,0),
                            ifelse(sum(head(bad, 5)) >= 9,1,0),
                            ifelse(sum(head(bad, 6)) >= 11,1,0)))
          if (bad_head < length(bad)) {
            (bad_head + 1):length(bad)
          }
        })
        batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)
        
        # taper down average WAR for players with small PAs
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	
        
        batters_adjusted <- do.call(rbind, mclapply(
          split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
          mc.cores = ncores, FUN = function(xx){
            ## natural cubic spline
            ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
            nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
            ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
            nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
            ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
            nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
            ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
            nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
            ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
            nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
            
            xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
              mutate(HR = round((adj_HR + nn_HR)/2)) %>%
              mutate(BB = round((adj_BB + nn_BB)/2)) %>%
              mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
              mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
          })) 
        
        bat_season <- batters_adjusted %>% 
          mutate(PA = adj_AB + BB + HBP + SF)
        bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
          bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB
        
        bat_season <- bat_season %>% 
          dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
        bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
          mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
          mutate(HR = ifelse(HR > 0, HR, 0)) %>%
          mutate(BB = ifelse(BB > 0, BB, 0)) %>%
          mutate(OBP = ifelse(OBP > 0, OBP, 0))
        
        colnames(bat_season)[5] <- 'AB'
        colnames(bat_season)[8] <- 'BA'
        bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
          mutate(BA = round(H / AB, 3)) %>%
          mutate(BA = ifelse(AB == 0, 0, BA)) %>%
          mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
          mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))
        
        NO_econ_effect_nonpara_historical_season <- mapped_batters_AVG
        NO_econ_effect_nonpara_historical_season_trimmed <- bat_season_nonpara
        
        Ty_Cobb_1911 <- NO_econ_effect_nonpara_historical_season %>% filter(yearID == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997 <- NO_econ_effect_nonpara_historical_season %>% filter(yearID == 1997, playerID == 'gwynnto01')
        Ty_Cobb_1911_trimmed <- NO_econ_effect_nonpara_historical_season_trimmed %>% filter(year == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997_trimmed <- NO_econ_effect_nonpara_historical_season_trimmed %>% filter(year == 1997, playerID == 'gwynnto01')
        season_diff <- rbind(season_diff, 
                             data.frame(PF = 'NO', 
                                        pops = 'econ_effect', 
                                        para = 'nonpara', 
                                        league = 'historical', 
                                        diff_before = round(Tony_Gwynn_1997$adj_AVG - Ty_Cobb_1911$adj_AVG, 3), 
                                        diff_after = round(Tony_Gwynn_1997_trimmed$BA - Ty_Cobb_1911_trimmed$BA, 3)))

```

```{r cache=TRUE, echo=FALSE}
batters_talent_AVG <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
                  talent_computing_nonpara_fixed(dataset = batters_schell, component_name = "AVG", 
                                                 year = yy, ystar = thresh_fun(component = batters_schell %>% 
                                                                                 filter(full_time == 'Y', yearID == yy) %>%
                                                                                 select(comp), component_name = 'AVG'), 
                                                 alpha = 1.16)
                })) %>% arrange(-WAR_talent)
                
                no_strike <- batters_talent_AVG %>%
                  filter(yearID < 1990, yearID >= 1977, yearID != 1981,
                         full_time == 'Y', lgID == 'NL') %>%
                  arrange(WAR_talent)
                
                min_refAVG <- min(no_strike$comp)
                
                t <- isoreg(no_strike$WAR_talent, no_strike$comp)
                
                talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,250)/250)
                
                comp_new <- as.stepfun(t)(talent_new)
                
                ystar <- thresh_fun(comp_new, component_name = 'AVG')
                pop_new <- round(mean(no_strike$pops))
                component_name = 'AVG'
                yy <- sort(comp_new)
                n <- length(yy)
                ytilde <- rep(0, n + 1)
                if (component_name == 'bWAR' | component_name == 'fWAR') {
                  ytilde[1] <- yy[1] - (yy[2] - yy[1])
                }
                if (component_name == 'HR' | component_name == 'BB') {
                  # since the minimal HR is greater or equal to 0.
                  ytilde[1] <- 0
                }
                if (component_name == 'AVG') {
                  ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
                }
                ytilde[n+1] <- yy[n] + ystar
                ytilde[2:n] <- unlist(lapply(2:n, function(j){
                  (yy[j]+yy[j-1])/2
                }))
                
                career_kAB_AVG_1st <- do.call(rbind, mclapply(1:30000, function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB_AVG_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_AVG), function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB <- rbind(career_kAB_AVG_1st, 
                                    career_kAB_AVG_2nd, 
                                    career_kAB_AVG_3rd)                
                mapped_batters_AVG <- career_kAB %>% 
                  mutate(adj_AVG = ifelse(adj_comp < min_refAVG, min_refAVG, adj_comp))
                
                master_batters_AB <- master_batters_trim %>% select(-adj_AVG)
                
                AVG_part <- mapped_batters_AVG %>%
                  mutate(adj_AVG = round(adj_AVG, 3)) %>% 
                  select(yearID, playerID, adj_AVG)
                
        master_batters <- merge(master_batters_AB, AVG_part, by = c('yearID', 'playerID'))
        
        master_batters <- master_batters %>% 
          mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
        master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0
        
        master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
          mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))

        ## Batters
        batters <- master_batters_nonpara
        
        ## extract and remove bad players 
        foo <- batters %>% 
          arrange(desc(adj_AVG)) %>% 
          filter(adj_AB >= 300) %>% 
          dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
          mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
        bar <- split(foo, as.factor(foo$playerID))
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_fWAR), ]
        }))
        baz <- baz %>% arrange(adj_fWAR)
        bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
        
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_bWAR), ]
        }))
        baz <- baz %>% arrange(adj_bWAR)
        bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
        bad_players <- union(bad_players_bWAR, bad_players_fWAR)
        batters <- batters[!batters$playerID %in% bad_players, ]
        
        ###### investigate anomalies ######
        
        ## more on base events than PAs
        
        # check average for minimal at bats and correct issues
        batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
        batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
        batters[batters$adj_AB > 0, ]$adj_AVG <- 
          round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)
        
        ## build adjusted data set
        batters_adjusted <- batters %>% 
          dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                        adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
        colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                        "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
        batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))
        
        
        ## trim out bad players
        # first round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # second round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # third round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # forth round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        
        ## remove tails 
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                            ifelse(sum(tail(bad, 3)) >= 5,1,0),
                            ifelse(sum(tail(bad, 4)) >= 7,1,0),
                            ifelse(sum(tail(bad, 5)) >= 9,1,0),
                            ifelse(sum(tail(bad, 6)) >= 11,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        ## remove starts
        foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
          bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                            ifelse(sum(head(bad, 2)) >= 3,1,0),
                            ifelse(sum(head(bad, 3)) >= 5,1,0),
                            ifelse(sum(head(bad, 4)) >= 7,1,0),
                            ifelse(sum(head(bad, 5)) >= 9,1,0),
                            ifelse(sum(head(bad, 6)) >= 11,1,0)))
          if (bad_head < length(bad)) {
            (bad_head + 1):length(bad)
          }
        })
        batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)
        
        # taper down average WAR for players with small PAs
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	
        
        batters_adjusted <- do.call(rbind, mclapply(
          split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
          mc.cores = ncores, FUN = function(xx){
            ## natural cubic spline
            ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
            nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
            ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
            nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
            ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
            nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
            ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
            nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
            ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
            nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
            
            xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
              mutate(HR = round((adj_HR + nn_HR)/2)) %>%
              mutate(BB = round((adj_BB + nn_BB)/2)) %>%
              mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
              mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
          })) 
        
        bat_season <- batters_adjusted %>% 
          mutate(PA = adj_AB + BB + HBP + SF)
        bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
          bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB
        
        bat_season <- bat_season %>% 
          dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
        bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
          mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
          mutate(HR = ifelse(HR > 0, HR, 0)) %>%
          mutate(BB = ifelse(BB > 0, BB, 0)) %>%
          mutate(OBP = ifelse(OBP > 0, OBP, 0))
        
        colnames(bat_season)[5] <- 'AB'
        colnames(bat_season)[8] <- 'BA'
        bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
          mutate(BA = round(H / AB, 3)) %>%
          mutate(BA = ifelse(AB == 0, 0, BA)) %>%
          mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
          mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))
        
        NO_econ_effect_nonpara_fixed_season <- mapped_batters_AVG
        NO_econ_effect_nonpara_fixed_season_trimmed <- bat_season_nonpara

        Ty_Cobb_1911 <- NO_econ_effect_nonpara_fixed_season %>% filter(yearID == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997 <- NO_econ_effect_nonpara_fixed_season %>% filter(yearID == 1997, playerID == 'gwynnto01')
        Ty_Cobb_1911_trimmed <- NO_econ_effect_nonpara_fixed_season_trimmed %>% filter(year == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997_trimmed <- NO_econ_effect_nonpara_fixed_season_trimmed %>% filter(year == 1997, playerID == 'gwynnto01')
        season_diff <- rbind(season_diff, 
                             data.frame(PF = 'NO', 
                                        pops = 'econ_effect', 
                                        para = 'nonpara', 
                                        league = 'fixed', 
                                        diff_before = round(Tony_Gwynn_1997$adj_AVG - Ty_Cobb_1911$adj_AVG, 3), 
                                        diff_after = round(Tony_Gwynn_1997_trimmed$BA - Ty_Cobb_1911_trimmed$BA, 3)))

```

```{r cache=TRUE, echo=FALSE}
batters_schell <- batters_schell %>% 
          select(-c('pops', 'NL_pop', 'AL_pop')) %>% 
          left_join(MLBpops %>% 
                      select(year, NL_pop, AL_pop), by = c('yearID' = 'year')) %>% 
          mutate(pops = ifelse(lgID == "NL",NL_pop,AL_pop))
```

```{r cache=TRUE, echo=FALSE}
batters_talent_AVG <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
                  talent_computing_para(dataset = batters_schell, year = yy, alpha = 1.16)
                })) %>% arrange(-talent)
                
                no_strike <- batters_talent_AVG %>%
                  filter(yearID < 1990, yearID >= 1977, yearID != 1981,
                         full_time == 'Y', lgID == 'NL') %>%
                  arrange(talent)
                
                min_refAVG <- min(no_strike$comp)
                
                t <- isoreg(no_strike$talent, no_strike$comp)
                
                talent_new <- quantile(no_strike$talent, probs = seq(0,250)/250)
                comp_new <- as.stepfun(t)(talent_new)
                pop_new <- round(mean(no_strike$pops))
                
                mean_new <- mean(comp_new)
                sd_new <- sd(comp_new)
                
                career_kAB_AVG_1st <- do.call(rbind, mclapply(1:30000, function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_AVG), function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB <- rbind(career_kAB_AVG_1st, 
                                    career_kAB_AVG_2nd, 
                                    career_kAB_AVG_3rd)
                
                mapped_batters_AVG <- career_kAB %>% 
                  mutate(adj_AVG = ifelse(adj_comp < min_refAVG, min_refAVG, adj_comp))
                
                master_batters_AB <- master_batters_trim %>% select(-adj_AVG)
                
                AVG_part <- mapped_batters_AVG %>%
                  mutate(adj_AVG = round(adj_AVG, 3)) %>% 
                  select(yearID, playerID, adj_AVG)
                
        master_batters <- merge(master_batters_AB, AVG_part, by = c('yearID', 'playerID'))
        
        master_batters <- master_batters %>% 
          mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
        master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0
        
        master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
          mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))

        ## Batters
        batters <- master_batters_nonpara
        
        ## extract and remove bad players 
        foo <- batters %>% 
          arrange(desc(adj_AVG)) %>% 
          filter(adj_AB >= 300) %>% 
          dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
          mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
        bar <- split(foo, as.factor(foo$playerID))
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_fWAR), ]
        }))
        baz <- baz %>% arrange(adj_fWAR)
        bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
        
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_bWAR), ]
        }))
        baz <- baz %>% arrange(adj_bWAR)
        bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
        bad_players <- union(bad_players_bWAR, bad_players_fWAR)
        batters <- batters[!batters$playerID %in% bad_players, ]
        
        ###### investigate anomalies ######
        
        ## more on base events than PAs
        
        # check average for minimal at bats and correct issues
        batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
        batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
        batters[batters$adj_AB > 0, ]$adj_AVG <- 
          round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)
        
        ## build adjusted data set
        batters_adjusted <- batters %>% 
          dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                        adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
        colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                        "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
        batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))
        
        
        ## trim out bad players
        # first round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # second round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # third round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # forth round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        
        ## remove tails 
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                            ifelse(sum(tail(bad, 3)) >= 5,1,0),
                            ifelse(sum(tail(bad, 4)) >= 7,1,0),
                            ifelse(sum(tail(bad, 5)) >= 9,1,0),
                            ifelse(sum(tail(bad, 6)) >= 11,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        ## remove starts
        foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
          bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                            ifelse(sum(head(bad, 2)) >= 3,1,0),
                            ifelse(sum(head(bad, 3)) >= 5,1,0),
                            ifelse(sum(head(bad, 4)) >= 7,1,0),
                            ifelse(sum(head(bad, 5)) >= 9,1,0),
                            ifelse(sum(head(bad, 6)) >= 11,1,0)))
          if (bad_head < length(bad)) {
            (bad_head + 1):length(bad)
          }
        })
        batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)
        
        # taper down average WAR for players with small PAs
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	
        
        batters_adjusted <- do.call(rbind, mclapply(
          split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
          mc.cores = ncores, FUN = function(xx){
            ## natural cubic spline
            ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
            nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
            ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
            nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
            ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
            nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
            ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
            nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
            ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
            nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
            
            xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
              mutate(HR = round((adj_HR + nn_HR)/2)) %>%
              mutate(BB = round((adj_BB + nn_BB)/2)) %>%
              mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
              mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
          })) 
        
        bat_season <- batters_adjusted %>% 
          mutate(PA = adj_AB + BB + HBP + SF)
        bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
          bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB
        
        bat_season <- bat_season %>% 
          dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
        bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
          mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
          mutate(HR = ifelse(HR > 0, HR, 0)) %>%
          mutate(BB = ifelse(BB > 0, BB, 0)) %>%
          mutate(OBP = ifelse(OBP > 0, OBP, 0))
        
        colnames(bat_season)[5] <- 'AB'
        colnames(bat_season)[8] <- 'BA'
        bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
          mutate(BA = round(H / AB, 3)) %>%
          mutate(BA = ifelse(AB == 0, 0, BA)) %>%
          mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
          mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))
        
        NO_normal_para_historical_season <- mapped_batters_AVG
        NO_normal_para_historical_season_trimmed <- bat_season_nonpara
        
        Ty_Cobb_1911 <- NO_normal_para_historical_season %>% filter(yearID == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997 <- NO_normal_para_historical_season %>% filter(yearID == 1997, playerID == 'gwynnto01')
        Ty_Cobb_1911_trimmed <- NO_normal_para_historical_season_trimmed %>% filter(year == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997_trimmed <- NO_normal_para_historical_season_trimmed %>% filter(year == 1997, playerID == 'gwynnto01')
        season_diff <- rbind(season_diff, 
                             data.frame(PF = 'NO', 
                                        pops = 'normal', 
                                        para = 'para', 
                                        league = 'historical', 
                                        diff_before = round(Tony_Gwynn_1997$adj_AVG - Ty_Cobb_1911$adj_AVG, 3), 
                                        diff_after = round(Tony_Gwynn_1997_trimmed$BA - Ty_Cobb_1911_trimmed$BA, 3)))

```

```{r cache=TRUE, echo=FALSE}
batters_talent_AVG <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
                  talent_computing_para_fixed(dataset = batters_schell, year = yy, alpha = 1.16)
                })) %>% arrange(-talent)
                
                no_strike <- batters_talent_AVG %>%
                  filter(yearID < 1990, yearID >= 1977, yearID != 1981,
                         full_time == 'Y', lgID == 'NL') %>%
                  arrange(talent)
                
                min_refAVG <- min(no_strike$comp)
                
                t <- isoreg(no_strike$talent, no_strike$comp)
                
                talent_new <- quantile(no_strike$talent, probs = seq(0,250)/250)
                comp_new <- as.stepfun(t)(talent_new)
                pop_new <- round(mean(no_strike$pops))
                
                mean_new <- mean(comp_new)
                sd_new <- sd(comp_new)
                
                career_kAB_AVG_1st <- do.call(rbind, mclapply(1:30000, function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_AVG), function(zz){
                  int <- career_talent_para(dataset = batters_talent_AVG, 
                                            snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB <- rbind(career_kAB_AVG_1st, 
                                    career_kAB_AVG_2nd, 
                                    career_kAB_AVG_3rd)
                
                mapped_batters_AVG <- career_kAB %>% 
                  mutate(adj_AVG = ifelse(adj_comp < min_refAVG, min_refAVG, adj_comp))
                
                master_batters_AB <- master_batters_trim %>% select(-adj_AVG)
                
                AVG_part <- mapped_batters_AVG %>%
                  mutate(adj_AVG = round(adj_AVG, 3)) %>% 
                  select(yearID, playerID, adj_AVG)
                
        master_batters <- merge(master_batters_AB, AVG_part, by = c('yearID', 'playerID'))
        
        master_batters <- master_batters %>% 
          mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
        master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0
        
        master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
          mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))

        ## Batters
        batters <- master_batters_nonpara
        
        ## extract and remove bad players 
        foo <- batters %>% 
          arrange(desc(adj_AVG)) %>% 
          filter(adj_AB >= 300) %>% 
          dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
          mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
        bar <- split(foo, as.factor(foo$playerID))
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_fWAR), ]
        }))
        baz <- baz %>% arrange(adj_fWAR)
        bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
        
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_bWAR), ]
        }))
        baz <- baz %>% arrange(adj_bWAR)
        bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
        bad_players <- union(bad_players_bWAR, bad_players_fWAR)
        batters <- batters[!batters$playerID %in% bad_players, ]
        
        ###### investigate anomalies ######
        
        ## more on base events than PAs
        
        # check average for minimal at bats and correct issues
        batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
        batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
        batters[batters$adj_AB > 0, ]$adj_AVG <- 
          round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)
        
        ## build adjusted data set
        batters_adjusted <- batters %>% 
          dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                        adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
        colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                        "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
        batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))
        
        
        ## trim out bad players
        # first round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # second round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # third round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # forth round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        
        ## remove tails 
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                            ifelse(sum(tail(bad, 3)) >= 5,1,0),
                            ifelse(sum(tail(bad, 4)) >= 7,1,0),
                            ifelse(sum(tail(bad, 5)) >= 9,1,0),
                            ifelse(sum(tail(bad, 6)) >= 11,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        ## remove starts
        foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
          bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                            ifelse(sum(head(bad, 2)) >= 3,1,0),
                            ifelse(sum(head(bad, 3)) >= 5,1,0),
                            ifelse(sum(head(bad, 4)) >= 7,1,0),
                            ifelse(sum(head(bad, 5)) >= 9,1,0),
                            ifelse(sum(head(bad, 6)) >= 11,1,0)))
          if (bad_head < length(bad)) {
            (bad_head + 1):length(bad)
          }
        })
        batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)
        
        # taper down average WAR for players with small PAs
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	
        
        batters_adjusted <- do.call(rbind, mclapply(
          split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
          mc.cores = ncores, FUN = function(xx){
            ## natural cubic spline
            ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
            nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
            ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
            nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
            ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
            nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
            ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
            nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
            ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
            nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
            
            xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
              mutate(HR = round((adj_HR + nn_HR)/2)) %>%
              mutate(BB = round((adj_BB + nn_BB)/2)) %>%
              mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
              mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
          })) 
        
        bat_season <- batters_adjusted %>% 
          mutate(PA = adj_AB + BB + HBP + SF)
        bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
          bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB
        
        bat_season <- bat_season %>% 
          dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
        bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
          mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
          mutate(HR = ifelse(HR > 0, HR, 0)) %>%
          mutate(BB = ifelse(BB > 0, BB, 0)) %>%
          mutate(OBP = ifelse(OBP > 0, OBP, 0))
        
        colnames(bat_season)[5] <- 'AB'
        colnames(bat_season)[8] <- 'BA'
        bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
          mutate(BA = round(H / AB, 3)) %>%
          mutate(BA = ifelse(AB == 0, 0, BA)) %>%
          mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
          mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))
        
        NO_normal_para_fixed_season <- mapped_batters_AVG
        NO_normal_para_fixed_season_trimmed <- bat_season_nonpara
        
        Ty_Cobb_1911 <- NO_normal_para_fixed_season %>% filter(yearID == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997 <- NO_normal_para_fixed_season %>% filter(yearID == 1997, playerID == 'gwynnto01')
        Ty_Cobb_1911_trimmed <- NO_normal_para_fixed_season_trimmed %>% filter(year == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997_trimmed <- NO_normal_para_fixed_season_trimmed %>% filter(year == 1997, playerID == 'gwynnto01')
        season_diff <- rbind(season_diff, 
                             data.frame(PF = 'NO', 
                                        pops = 'normal', 
                                        para = 'para', 
                                        league = 'fixed', 
                                        diff_before = round(Tony_Gwynn_1997$adj_AVG - Ty_Cobb_1911$adj_AVG, 3), 
                                        diff_after = round(Tony_Gwynn_1997_trimmed$BA - Ty_Cobb_1911_trimmed$BA, 3)))

```

```{r cache=TRUE, echo=FALSE}
batters_talent_AVG <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
                  talent_computing_nonpara(dataset = batters_schell, component_name = "AVG", 
                                           year = yy, ystar = thresh_fun(component = batters_schell %>% 
                                                                           filter(full_time == 'Y', yearID == yy) %>%
                                                                           select(comp), component_name = 'AVG'), 
                                           alpha = 1.16)
                })) %>% arrange(-WAR_talent)
                
                no_strike <- batters_talent_AVG %>%
                  filter(yearID < 1990, yearID >= 1977, yearID != 1981,
                         full_time == 'Y', lgID == 'NL') %>%
                  arrange(WAR_talent)
                
                min_refAVG <- min(no_strike$comp)
                
                t <- isoreg(no_strike$WAR_talent, no_strike$comp)
                
                talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,250)/250)
                
                comp_new <- as.stepfun(t)(talent_new)
                
                ystar <- thresh_fun(comp_new, component_name = 'AVG')
                pop_new <- round(mean(no_strike$pops))
                component_name = 'AVG'
                yy <- sort(comp_new)
                n <- length(yy)
                ytilde <- rep(0, n + 1)
                if (component_name == 'bWAR' | component_name == 'fWAR') {
                  ytilde[1] <- yy[1] - (yy[2] - yy[1])
                }
                if (component_name == 'HR' | component_name == 'BB') {
                  # since the minimal HR is greater or equal to 0.
                  ytilde[1] <- 0
                }
                if (component_name == 'AVG') {
                  ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
                }
                ytilde[n+1] <- yy[n] + ystar
                ytilde[2:n] <- unlist(lapply(2:n, function(j){
                  (yy[j]+yy[j-1])/2
                }))
                
                career_kAB_AVG_1st <- do.call(rbind, mclapply(1:30000, function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB_AVG_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_AVG), function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB <- rbind(career_kAB_AVG_1st, 
                                    career_kAB_AVG_2nd, 
                                    career_kAB_AVG_3rd)
                
                mapped_batters_AVG <- career_kAB %>% 
                  mutate(adj_AVG = ifelse(adj_comp < min_refAVG, min_refAVG, adj_comp))
                
                master_batters_AB <- master_batters_trim %>% select(-adj_AVG)
                
                AVG_part <- mapped_batters_AVG %>%
                  mutate(adj_AVG = round(adj_AVG, 3)) %>% 
                  select(yearID, playerID, adj_AVG)
                
        master_batters <- merge(master_batters_AB, AVG_part, by = c('yearID', 'playerID'))
        
        master_batters <- master_batters %>% 
          mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
        master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0
        
        master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
          mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))

        ## Batters
        batters <- master_batters_nonpara
        
        ## extract and remove bad players 
        foo <- batters %>% 
          arrange(desc(adj_AVG)) %>% 
          filter(adj_AB >= 300) %>% 
          dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
          mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
        bar <- split(foo, as.factor(foo$playerID))
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_fWAR), ]
        }))
        baz <- baz %>% arrange(adj_fWAR)
        bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
        
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_bWAR), ]
        }))
        baz <- baz %>% arrange(adj_bWAR)
        bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
        bad_players <- union(bad_players_bWAR, bad_players_fWAR)
        batters <- batters[!batters$playerID %in% bad_players, ]
        
        ###### investigate anomalies ######
        
        ## more on base events than PAs
        
        # check average for minimal at bats and correct issues
        batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
        batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
        batters[batters$adj_AB > 0, ]$adj_AVG <- 
          round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)
        
        ## build adjusted data set
        batters_adjusted <- batters %>% 
          dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                        adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
        colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                        "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
        batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))
        
        
        ## trim out bad players
        # first round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # second round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # third round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # forth round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        
        ## remove tails 
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                            ifelse(sum(tail(bad, 3)) >= 5,1,0),
                            ifelse(sum(tail(bad, 4)) >= 7,1,0),
                            ifelse(sum(tail(bad, 5)) >= 9,1,0),
                            ifelse(sum(tail(bad, 6)) >= 11,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        ## remove starts
        foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
          bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                            ifelse(sum(head(bad, 2)) >= 3,1,0),
                            ifelse(sum(head(bad, 3)) >= 5,1,0),
                            ifelse(sum(head(bad, 4)) >= 7,1,0),
                            ifelse(sum(head(bad, 5)) >= 9,1,0),
                            ifelse(sum(head(bad, 6)) >= 11,1,0)))
          if (bad_head < length(bad)) {
            (bad_head + 1):length(bad)
          }
        })
        batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)
        
        # taper down average WAR for players with small PAs
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	
        
        batters_adjusted <- do.call(rbind, mclapply(
          split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
          mc.cores = ncores, FUN = function(xx){
            ## natural cubic spline
            ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
            nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
            ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
            nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
            ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
            nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
            ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
            nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
            ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
            nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
            
            xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
              mutate(HR = round((adj_HR + nn_HR)/2)) %>%
              mutate(BB = round((adj_BB + nn_BB)/2)) %>%
              mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
              mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
          })) 
        
        bat_season <- batters_adjusted %>% 
          mutate(PA = adj_AB + BB + HBP + SF)
        bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
          bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB
        
        bat_season <- bat_season %>% 
          dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
        bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
          mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
          mutate(HR = ifelse(HR > 0, HR, 0)) %>%
          mutate(BB = ifelse(BB > 0, BB, 0)) %>%
          mutate(OBP = ifelse(OBP > 0, OBP, 0))
        
        colnames(bat_season)[5] <- 'AB'
        colnames(bat_season)[8] <- 'BA'
        bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
          mutate(BA = round(H / AB, 3)) %>%
          mutate(BA = ifelse(AB == 0, 0, BA)) %>%
          mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
          mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))
        
        NO_normal_nonpara_historical_season <- mapped_batters_AVG
        NO_normal_nonpara_historical_season_trimmed <- bat_season_nonpara
        
        Ty_Cobb_1911 <- NO_normal_nonpara_historical_season %>% filter(yearID == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997 <- NO_normal_nonpara_historical_season %>% filter(yearID == 1997, playerID == 'gwynnto01')
        Ty_Cobb_1911_trimmed <- NO_normal_nonpara_historical_season_trimmed %>% filter(year == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997_trimmed <- NO_normal_nonpara_historical_season_trimmed %>% filter(year == 1997, playerID == 'gwynnto01')
        season_diff <- rbind(season_diff, 
                             data.frame(PF = 'NO', 
                                        pops = 'normal', 
                                        para = 'nonpara', 
                                        league = 'historical', 
                                        diff_before = round(Tony_Gwynn_1997$adj_AVG - Ty_Cobb_1911$adj_AVG, 3), 
                                        diff_after = round(Tony_Gwynn_1997_trimmed$BA - Ty_Cobb_1911_trimmed$BA, 3)))

```

```{r cache=TRUE, echo=FALSE}
batters_talent_AVG <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
                  talent_computing_nonpara_fixed(dataset = batters_schell, component_name = "AVG", 
                                                 year = yy, ystar = thresh_fun(component = batters_schell %>% 
                                                                                 filter(full_time == 'Y', yearID == yy) %>%
                                                                                 select(comp), component_name = 'AVG'), 
                                                 alpha = 1.16)
                })) %>% arrange(-WAR_talent)
                
                no_strike <- batters_talent_AVG %>%
                  filter(yearID < 1990, yearID >= 1977, yearID != 1981,
                         full_time == 'Y', lgID == 'NL') %>%
                  arrange(WAR_talent)
                
                min_refAVG <- min(no_strike$comp)
                
                t <- isoreg(no_strike$WAR_talent, no_strike$comp)
                
                talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,250)/250)
                
                comp_new <- as.stepfun(t)(talent_new)
                
                ystar <- thresh_fun(comp_new, component_name = 'AVG')
                pop_new <- round(mean(no_strike$pops))
                component_name = 'AVG'
                yy <- sort(comp_new)
                n <- length(yy)
                ytilde <- rep(0, n + 1)
                if (component_name == 'bWAR' | component_name == 'fWAR') {
                  ytilde[1] <- yy[1] - (yy[2] - yy[1])
                }
                if (component_name == 'HR' | component_name == 'BB') {
                  # since the minimal HR is greater or equal to 0.
                  ytilde[1] <- 0
                }
                if (component_name == 'AVG') {
                  ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
                }
                ytilde[n+1] <- yy[n] + ystar
                ytilde[2:n] <- unlist(lapply(2:n, function(j){
                  (yy[j]+yy[j-1])/2
                }))
                
                career_kAB_AVG_1st <- do.call(rbind, mclapply(1:30000, function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB_AVG_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                career_kAB_AVG_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_AVG), function(zz){
                  int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                                               snippet = batters_talent_AVG[zz,], alpha = 1.16)
                  int
                }, mc.cores = ncores))
                
                
                career_kAB <- rbind(career_kAB_AVG_1st, 
                                    career_kAB_AVG_2nd, 
                                    career_kAB_AVG_3rd)                
                mapped_batters_AVG <- career_kAB %>% 
                  mutate(adj_AVG = ifelse(adj_comp < min_refAVG, min_refAVG, adj_comp))
                
                master_batters_AB <- master_batters_trim %>% select(-adj_AVG)
                
                AVG_part <- mapped_batters_AVG %>%
                  mutate(adj_AVG = round(adj_AVG, 3)) %>% 
                  select(yearID, playerID, adj_AVG)
                
        master_batters <- merge(master_batters_AB, AVG_part, by = c('yearID', 'playerID'))
        
        master_batters <- master_batters %>% 
          mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
        master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0
        
        master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
          mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))

        ## Batters
        batters <- master_batters_nonpara
        
        ## extract and remove bad players 
        foo <- batters %>% 
          arrange(desc(adj_AVG)) %>% 
          filter(adj_AB >= 300) %>% 
          dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
          mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
        bar <- split(foo, as.factor(foo$playerID))
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_fWAR), ]
        }))
        baz <- baz %>% arrange(adj_fWAR)
        bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
        
        baz <- do.call(rbind, lapply(bar, function(m){
          m[which.max(m$adj_bWAR), ]
        }))
        baz <- baz %>% arrange(adj_bWAR)
        bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
        bad_players <- union(bad_players_bWAR, bad_players_fWAR)
        batters <- batters[!batters$playerID %in% bad_players, ]
        
        ###### investigate anomalies ######
        
        ## more on base events than PAs
        
        # check average for minimal at bats and correct issues
        batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
        batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
        batters[batters$adj_AB > 0, ]$adj_AVG <- 
          round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)
        
        ## build adjusted data set
        batters_adjusted <- batters %>% 
          dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                        adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
        colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                        "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
        batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))
        
        
        ## trim out bad players
        # first round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # second round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # third round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        # forth round
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
        })
        checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                              m_bad = unlist(lapply(bar, mean)), 
                              len = unlist(lapply(bar, length)))
        batters_adjusted <- batters_adjusted %>% 
          filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
        batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
        
        
        ## remove tails 
        foo <- split(batters_adjusted, f = batters_adjusted$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                            ifelse(sum(tail(bad, 3)) >= 5,1,0),
                            ifelse(sum(tail(bad, 4)) >= 7,1,0),
                            ifelse(sum(tail(bad, 5)) >= 9,1,0),
                            ifelse(sum(tail(bad, 6)) >= 11,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
          bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                            ifelse(sum(tail(bad, 3)) >= 3,1,0),
                            ifelse(sum(tail(bad, 4)) >= 4,1,0),
                            ifelse(sum(tail(bad, 5)) >= 5,1,0),
                            ifelse(sum(tail(bad, 6)) >= 6,1,0)))
          1:(length(bad)-bad_tail)
        })
        batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        ## remove starts
        foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
        bar <- lapply(foo, function(m){
          bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
          bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                            ifelse(sum(head(bad, 2)) >= 3,1,0),
                            ifelse(sum(head(bad, 3)) >= 5,1,0),
                            ifelse(sum(head(bad, 4)) >= 7,1,0),
                            ifelse(sum(head(bad, 5)) >= 9,1,0),
                            ifelse(sum(head(bad, 6)) >= 11,1,0)))
          if (bad_head < length(bad)) {
            (bad_head + 1):length(bad)
          }
        })
        batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
          foo[[j]][bar[[j]], ]
        })) %>% arrange(year)
        
        batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)
        
        # taper down average WAR for players with small PAs
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
        batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
          round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	
        
        batters_adjusted <- do.call(rbind, mclapply(
          split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
          mc.cores = ncores, FUN = function(xx){
            ## natural cubic spline
            ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
            nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
            ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
            nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
            ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
            nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
            ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
            nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
            ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
            nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
            
            xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
              mutate(HR = round((adj_HR + nn_HR)/2)) %>%
              mutate(BB = round((adj_BB + nn_BB)/2)) %>%
              mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
              mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
          })) 
        
        bat_season <- batters_adjusted %>% 
          mutate(PA = adj_AB + BB + HBP + SF)
        bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
          bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB
        
        bat_season <- bat_season %>% 
          dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
        bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
          mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
          mutate(HR = ifelse(HR > 0, HR, 0)) %>%
          mutate(BB = ifelse(BB > 0, BB, 0)) %>%
          mutate(OBP = ifelse(OBP > 0, OBP, 0))
        
        colnames(bat_season)[5] <- 'AB'
        colnames(bat_season)[8] <- 'BA'
        bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
          mutate(BA = round(H / AB, 3)) %>%
          mutate(BA = ifelse(AB == 0, 0, BA)) %>%
          mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
          mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))
        
        NO_normal_nonpara_fixed_season <- mapped_batters_AVG
        NO_normal_nonpara_fixed_season_trimmed <- bat_season_nonpara

        Ty_Cobb_1911 <- NO_normal_nonpara_fixed_season %>% filter(yearID == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997 <- NO_normal_nonpara_fixed_season %>% filter(yearID == 1997, playerID == 'gwynnto01')
        Ty_Cobb_1911_trimmed <- NO_normal_nonpara_fixed_season_trimmed %>% filter(year == 1911, playerID == 'cobbty01')
        Tony_Gwynn_1997_trimmed <- NO_normal_nonpara_fixed_season_trimmed %>% filter(year == 1997, playerID == 'gwynnto01')
        season_diff <- rbind(season_diff, 
                             data.frame(PF = 'NO', 
                                        pops = 'normal', 
                                        para = 'nonpara', 
                                        league = 'fixed', 
                                        diff_before = round(Tony_Gwynn_1997$adj_AVG - Ty_Cobb_1911$adj_AVG, 3), 
                                        diff_after = round(Tony_Gwynn_1997_trimmed$BA - Ty_Cobb_1911_trimmed$BA, 3)))

        kable(season_diff)
```


### bWAR

We also use bWAR to test the effect of population change and season size in our Full House Model. The table shows the value of the career bWAR of Willie Mays minus the career bWAR of Babe Ruth under different configurations before and after applying the smoothing and trimming method. The pops column indicates the population changes we apply to the MLB-eligible population. The pre_int shows we add 10\% for pre-integration seasons; The econ_effect shows we deduct 10\% for the years prior to 1980 due to the economic effect; The normal shows we use the normal MLB-eligible population. The league column indicates we consider two different league sizes as the number of components in each season. The historical shows we use historical league size as the number of components in each season. The fixed shows that we compute the maximum number of components in every season and consider this value as the fixed number of components each season. The diff_after indicates the value of the career bWAR of Willie Mays minus the career bWAR of Babe Ruth under different configurations after applying the smoothing and trimming method. The diff_before indicates the value of the career bWAR of Willie Mays minus the career bWAR of Babe Ruth under different configurations before applying the smoothing and trimming method.

```{r cache=TRUE, echo=FALSE}
load('bat_pit_pops.RData')
batters <- bat_dat %>% select(yearID, playerID, lgID, name, age, PA, G, bWAR, pops)
  cutoff <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    m <- batters %>% filter(yearID == xx) %>% filter(PA >= 75)
    data.frame(thres = median(m$PA), yearID = xx)
  }))
batters <- merge(batters, cutoff, by = 'yearID')
batters <- batters %>% mutate(comp =  bWAR / G, full_time = ifelse(PA >= thres, 'Y', 'N'))

batters_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
  int<- batters %>% filter(yearID == xx)
  lg_avg <- sum(int$bWAR)/sum(int$G)
  int %>% mutate(comp = (bWAR + lg_avg * 7)/(G + 7))
}))

batters_schell <- batters_schell %>% 
  select(-pops) %>% 
  left_join(MLBpops_pre_int %>% 
              select(year, NL_pop, AL_pop), by = c('yearID' = 'year')) %>% 
  mutate(pops = ifelse(lgID == "NL",NL_pop,AL_pop))

```

```{r cache=TRUE, echo=FALSE}
batters_talent_bWAR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
  talent_computing_nonpara(dataset = batters_schell, component_name = "bWAR", year = yy, 
                           ystar = thresh_fun(component = batters_schell %>% filter(full_time == 'Y', 
                                                                                    yearID == yy) %>% 
                                                select(comp), component_name = 'bWAR'), alpha = 1.16) })) %>% 
  arrange(-WAR_talent)

no_strike <- batters_talent_bWAR %>% 
  filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
         full_time == 'Y', lgID == 'NL') %>%
  arrange(WAR_talent)

t <- isoreg(no_strike$WAR_talent, no_strike$comp)
talent_new <- quantile(no_strike$WAR_talent, probs = (seq(0,250)/250))
comp_new <- as.stepfun(t)(talent_new)

ystar <- thresh_fun(comp_new, component_name = 'bWAR')
pop_new <- round(mean(no_strike$pops))
component_name = 'bWAR'
yy <- sort(comp_new)
n <- length(yy)
ytilde <- rep(0, n + 1)
if (component_name == 'bWAR' | component_name == 'fWAR') {
  ytilde[1] <- yy[1] - (yy[2] - yy[1])
}
if (component_name == 'HR' | component_name == 'BB') {
  # since the minimal HR is greater or equal to 0.
  ytilde[1] <- 0
}
ytilde[n+1] <- yy[n] + ystar
ytilde[2:n] <- unlist(lapply(2:n, function(j){
  (yy[j]+yy[j-1])/2 
}))

career_kAB_1st <- do.call(rbind, mclapply(1:30000, function(zz){
  int <- career_talent_nonpara(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                               snippet = batters_talent_bWAR[zz,], alpha = 1.16)
  int
}, mc.cores = ncores))


career_kAB_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
  int <- career_talent_nonpara(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                               snippet = batters_talent_bWAR[zz,], alpha = 1.16)
  int
}, mc.cores = ncores)) 

career_kAB_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_bWAR), function(zz){
  int <- career_talent_nonpara(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                               snippet = batters_talent_bWAR[zz,], alpha = 1.16)
  int
}, mc.cores = ncores)) 

career_kAB <- rbind(career_kAB_1st, career_kAB_2nd, career_kAB_3rd)

mapped_batters_1 <- merge(career_kAB, mapped_quan_b_raw, 
                          by = c('playerID', 'yearID'))
min_refbWAR <- -2

mapped_batters_bWAR <- mapped_batters_1 %>% 
  mutate(adj_bWAR = adj_comp * mapped_G_raw) %>% 
  mutate(adj_bWAR = ifelse(adj_bWAR < min_refbWAR, min_refbWAR, adj_bWAR)) %>%
  mutate(mapped_G_bWAR = round(adj_bWAR / adj_comp))
career_bWAR <- mapped_batters_bWAR %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            mapped_G = sum(mapped_G_bWAR),
            adj_bWAR = sum(adj_bWAR))

master_batters_AB <- master_batters_trim %>% select(-c(adj_bWAR, mapped_G_bWAR))
bWAR_part <- mapped_batters_bWAR %>%
  mutate(adj_bWAR = round(adj_bWAR, 2)) %>%
  select(yearID, playerID, adj_bWAR, mapped_G_bWAR) 
master_batters <- merge(master_batters_AB, bWAR_part, by = c('yearID', 'playerID'))
master_batters <- master_batters %>% 
  mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0

master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
  mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))
master_batters_nonpara$mapped_G <- apply(master_batters_nonpara[,c(14,18)], 1, min)

## Batters
batters <- master_batters_nonpara

## extract and remove bad players 
foo <- batters %>% 
  arrange(desc(adj_AVG)) %>% 
  filter(adj_AB >= 300) %>% 
  dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
  mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
bar <- split(foo, as.factor(foo$playerID))
baz <- do.call(rbind, lapply(bar, function(m){
  m[which.max(m$adj_fWAR), ]
}))
baz <- baz %>% arrange(adj_fWAR)
bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)

baz <- do.call(rbind, lapply(bar, function(m){
  m[which.max(m$adj_bWAR), ]
}))
baz <- baz %>% arrange(adj_bWAR)
bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
bad_players <- union(bad_players_bWAR, bad_players_fWAR)
batters <- batters[!batters$playerID %in% bad_players, ]

# check average for minimal at bats and correct issues
batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
batters[batters$adj_AB > 0, ]$adj_AVG <- 
  round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)

## build adjusted data set
batters_adjusted <- batters %>% 
  dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))


## trim out bad players
# first round
foo <- split(batters_adjusted, f = batters_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
})
checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                      m_bad = unlist(lapply(bar, mean)), 
                      len = unlist(lapply(bar, length)))
batters_adjusted <- batters_adjusted %>% 
  filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)

# second round
foo <- split(batters_adjusted, f = batters_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
})
checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                      m_bad = unlist(lapply(bar, mean)), 
                      len = unlist(lapply(bar, length)))
batters_adjusted <- batters_adjusted %>% 
  filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)

# third round
foo <- split(batters_adjusted, f = batters_adjusted$playerID)
bar <- lapply(foo, function(m){
  min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
})
checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                      m_bad = unlist(lapply(bar, mean)), 
                      len = unlist(lapply(bar, length)))
batters_adjusted <- batters_adjusted %>% 
  filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)

# forth round
foo <- split(batters_adjusted, f = batters_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
})
checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                      m_bad = unlist(lapply(bar, mean)), 
                      len = unlist(lapply(bar, length)))
batters_adjusted <- batters_adjusted %>% 
  filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)


## remove tails 
foo <- split(batters_adjusted, f = batters_adjusted$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                    ifelse(sum(tail(bad, 3)) >= 5,1,0),
                    ifelse(sum(tail(bad, 4)) >= 7,1,0),
                    ifelse(sum(tail(bad, 5)) >= 9,1,0),
                    ifelse(sum(tail(bad, 6)) >= 11,1,0)))
  1:(length(bad)-bad_tail)
})
batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                    ifelse(sum(tail(bad, 3)) >= 3,1,0),
                    ifelse(sum(tail(bad, 4)) >= 4,1,0),
                    ifelse(sum(tail(bad, 5)) >= 5,1,0),
                    ifelse(sum(tail(bad, 6)) >= 6,1,0)))
  1:(length(bad)-bad_tail)
})
batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                    ifelse(sum(tail(bad, 3)) >= 3,1,0),
                    ifelse(sum(tail(bad, 4)) >= 4,1,0),
                    ifelse(sum(tail(bad, 5)) >= 5,1,0),
                    ifelse(sum(tail(bad, 6)) >= 6,1,0)))
  1:(length(bad)-bad_tail)
})
batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

## remove starts
foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
  bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                    ifelse(sum(head(bad, 2)) >= 3,1,0),
                    ifelse(sum(head(bad, 3)) >= 5,1,0),
                    ifelse(sum(head(bad, 4)) >= 7,1,0),
                    ifelse(sum(head(bad, 5)) >= 9,1,0),
                    ifelse(sum(head(bad, 6)) >= 11,1,0)))
  if (bad_head < length(bad)) {
    (bad_head + 1):length(bad)
  }
})
batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)

# taper down average WAR for players with small PAs
batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
  round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
  round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	

batters_adjusted <- do.call(rbind, mclapply(
  split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
  mc.cores = ncores, FUN = function(xx){
    ## natural cubic spline
    ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
    nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
    ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
    nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
    ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
    nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
    ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
    nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
    ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
    nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
    
    xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
      mutate(HR = round((adj_HR + nn_HR)/2)) %>%
      mutate(BB = round((adj_BB + nn_BB)/2)) %>%
      mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
      mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
  })) 

bat_season <- batters_adjusted %>% 
  mutate(PA = adj_AB + BB + HBP + SF)
bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
  bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB

bat_season <- bat_season %>% 
  dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
  mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
  mutate(HR = ifelse(HR > 0, HR, 0)) %>%
  mutate(BB = ifelse(BB > 0, BB, 0)) %>%
  mutate(OBP = ifelse(OBP > 0, OBP, 0))

colnames(bat_season)[5] <- 'AB'
colnames(bat_season)[8] <- 'BA'
bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
  mutate(BA = round(H / AB, 3)) %>%
  mutate(BA = ifelse(AB == 0, 0, BA)) %>%
  mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
  mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))

bat_career_nonpara <- bat_season_nonpara %>% group_by(playerID) %>% 
  summarise(name = unique(name), 
            playerID = unique(playerID), 
            PA = sum(round(PA)), 
            AB = sum(AB), 
            H = sum(H), 
            HR = sum(round(HR)), 
            BB = sum(round(BB)), 
            BA = round(H/AB, 3), 
            HBP = sum(HBP), 
            SF = sum(SF), 
            OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
            ebWAR = sum(ebWAR), 
            efWAR = sum(efWAR)) %>% ungroup() %>% 
  arrange(desc(ebWAR))

bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))

pre_int_historical_career_bat <- career_bWAR
pre_int_historical_career_trimmed_bat <- bat_career_nonpara

```

```{r cache=TRUE, echo=FALSE}
batters_talent_bWAR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
  talent_computing_nonpara_fixed(dataset = batters_schell, component_name = "bWAR", year = yy, 
                                 ystar = thresh_fun(component = batters_schell %>% filter(full_time == 'Y', 
                                                                                          yearID == yy) %>% 
                                                      select(comp), component_name = 'bWAR'), alpha = 1.16) })) %>% 
  arrange(-WAR_talent)

no_strike <- batters_talent_bWAR %>% 
  filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
         full_time == 'Y', lgID == 'NL') %>%
  arrange(WAR_talent)

t <- isoreg(no_strike$WAR_talent, no_strike$comp)
talent_new <- quantile(no_strike$WAR_talent, probs = (seq(0,250)/250))
comp_new <- as.stepfun(t)(talent_new)

ystar <- thresh_fun(comp_new, component_name = 'bWAR')
pop_new <- round(mean(no_strike$pops))
component_name = 'bWAR'
yy <- sort(comp_new)
n <- length(yy)
ytilde <- rep(0, n + 1)
if (component_name == 'bWAR' | component_name == 'fWAR') {
  ytilde[1] <- yy[1] - (yy[2] - yy[1])
}
if (component_name == 'HR' | component_name == 'BB') {
  # since the minimal HR is greater or equal to 0.
  ytilde[1] <- 0
}
ytilde[n+1] <- yy[n] + ystar
ytilde[2:n] <- unlist(lapply(2:n, function(j){
  (yy[j]+yy[j-1])/2 
}))

career_kAB_1st <- do.call(rbind, mclapply(1:30000, function(zz){
  int <- career_talent_nonpara(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                               snippet = batters_talent_bWAR[zz,], alpha = 1.16)
  int
}, mc.cores = ncores))


career_kAB_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
  int <- career_talent_nonpara(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                               snippet = batters_talent_bWAR[zz,], alpha = 1.16)
  int
}, mc.cores = ncores)) 

career_kAB_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_bWAR), function(zz){
  int <- career_talent_nonpara(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                               snippet = batters_talent_bWAR[zz,], alpha = 1.16)
  int
}, mc.cores = ncores)) 

career_kAB <- rbind(career_kAB_1st, career_kAB_2nd, career_kAB_3rd)

mapped_batters_1 <- merge(career_kAB, mapped_quan_b_raw, 
                          by = c('playerID', 'yearID'))
min_refbWAR <- -2

mapped_batters_bWAR <- mapped_batters_1 %>% 
  mutate(adj_bWAR = adj_comp * mapped_G_raw) %>% 
  mutate(adj_bWAR = ifelse(adj_bWAR < min_refbWAR, min_refbWAR, adj_bWAR)) %>%
  mutate(mapped_G_bWAR = round(adj_bWAR / adj_comp))
career_bWAR <- mapped_batters_bWAR %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            mapped_G = sum(mapped_G_bWAR),
            adj_bWAR = sum(adj_bWAR))

master_batters_AB <- master_batters_trim %>% select(-c(adj_bWAR, mapped_G_bWAR))
bWAR_part <- mapped_batters_bWAR %>%
  mutate(adj_bWAR = round(adj_bWAR, 2)) %>%
  select(yearID, playerID, adj_bWAR, mapped_G_bWAR) 
master_batters <- merge(master_batters_AB, bWAR_part, by = c('yearID', 'playerID'))
master_batters <- master_batters %>% 
  mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0

master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
  mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))
master_batters_nonpara$mapped_G <- apply(master_batters_nonpara[,c(14,18)], 1, min)

## Batters
batters <- master_batters_nonpara

## extract and remove bad players 
foo <- batters %>% 
  arrange(desc(adj_AVG)) %>% 
  filter(adj_AB >= 300) %>% 
  dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
  mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
bar <- split(foo, as.factor(foo$playerID))
baz <- do.call(rbind, lapply(bar, function(m){
  m[which.max(m$adj_fWAR), ]
}))
baz <- baz %>% arrange(adj_fWAR)
bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)

baz <- do.call(rbind, lapply(bar, function(m){
  m[which.max(m$adj_bWAR), ]
}))
baz <- baz %>% arrange(adj_bWAR)
bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
bad_players <- union(bad_players_bWAR, bad_players_fWAR)
batters <- batters[!batters$playerID %in% bad_players, ]

###### investigate anomalies ######

## more on base events than PAs

# check average for minimal at bats and correct issues
batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
batters[batters$adj_AB > 0, ]$adj_AVG <- 
  round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)

## build adjusted data set
batters_adjusted <- batters %>% 
  dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))


## trim out bad players
# first round
foo <- split(batters_adjusted, f = batters_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
})
checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                      m_bad = unlist(lapply(bar, mean)), 
                      len = unlist(lapply(bar, length)))
batters_adjusted <- batters_adjusted %>% 
  filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)

# second round
foo <- split(batters_adjusted, f = batters_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
})
checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                      m_bad = unlist(lapply(bar, mean)), 
                      len = unlist(lapply(bar, length)))
batters_adjusted <- batters_adjusted %>% 
  filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)

# third round
foo <- split(batters_adjusted, f = batters_adjusted$playerID)
bar <- lapply(foo, function(m){
  min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
})
checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                      m_bad = unlist(lapply(bar, mean)), 
                      len = unlist(lapply(bar, length)))
batters_adjusted <- batters_adjusted %>% 
  filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)

# forth round
foo <- split(batters_adjusted, f = batters_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
})
checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                      m_bad = unlist(lapply(bar, mean)), 
                      len = unlist(lapply(bar, length)))
batters_adjusted <- batters_adjusted %>% 
  filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)


## remove tails 
foo <- split(batters_adjusted, f = batters_adjusted$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                    ifelse(sum(tail(bad, 3)) >= 5,1,0),
                    ifelse(sum(tail(bad, 4)) >= 7,1,0),
                    ifelse(sum(tail(bad, 5)) >= 9,1,0),
                    ifelse(sum(tail(bad, 6)) >= 11,1,0)))
  1:(length(bad)-bad_tail)
})
batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                    ifelse(sum(tail(bad, 3)) >= 3,1,0),
                    ifelse(sum(tail(bad, 4)) >= 4,1,0),
                    ifelse(sum(tail(bad, 5)) >= 5,1,0),
                    ifelse(sum(tail(bad, 6)) >= 6,1,0)))
  1:(length(bad)-bad_tail)
})
batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                    ifelse(sum(tail(bad, 3)) >= 3,1,0),
                    ifelse(sum(tail(bad, 4)) >= 4,1,0),
                    ifelse(sum(tail(bad, 5)) >= 5,1,0),
                    ifelse(sum(tail(bad, 6)) >= 6,1,0)))
  1:(length(bad)-bad_tail)
})
batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

## remove starts
foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
  bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                    ifelse(sum(head(bad, 2)) >= 3,1,0),
                    ifelse(sum(head(bad, 3)) >= 5,1,0),
                    ifelse(sum(head(bad, 4)) >= 7,1,0),
                    ifelse(sum(head(bad, 5)) >= 9,1,0),
                    ifelse(sum(head(bad, 6)) >= 11,1,0)))
  if (bad_head < length(bad)) {
    (bad_head + 1):length(bad)
  }
})
batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)

# taper down average WAR for players with small PAs
batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
  round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
  round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	

batters_adjusted <- do.call(rbind, mclapply(
  split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
  mc.cores = ncores, FUN = function(xx){
    ## natural cubic spline
    ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
    nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
    ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
    nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
    ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
    nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
    ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
    nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
    ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
    nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
    
    xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
      mutate(HR = round((adj_HR + nn_HR)/2)) %>%
      mutate(BB = round((adj_BB + nn_BB)/2)) %>%
      mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
      mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
  })) 

bat_season <- batters_adjusted %>% 
  mutate(PA = adj_AB + BB + HBP + SF)
bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
  bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB

bat_season <- bat_season %>% 
  dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
  mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
  mutate(HR = ifelse(HR > 0, HR, 0)) %>%
  mutate(BB = ifelse(BB > 0, BB, 0)) %>%
  mutate(OBP = ifelse(OBP > 0, OBP, 0))

colnames(bat_season)[5] <- 'AB'
colnames(bat_season)[8] <- 'BA'
bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
  mutate(BA = round(H / AB, 3)) %>%
  mutate(BA = ifelse(AB == 0, 0, BA)) %>%
  mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
  mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))

bat_career_nonpara <- bat_season_nonpara %>% group_by(playerID) %>% 
  summarise(name = unique(name), 
            playerID = unique(playerID), 
            PA = sum(round(PA)), 
            AB = sum(AB), 
            H = sum(H), 
            HR = sum(round(HR)), 
            BB = sum(round(BB)), 
            BA = round(H/AB, 3), 
            HBP = sum(HBP), 
            SF = sum(SF), 
            OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
            ebWAR = sum(ebWAR), 
            efWAR = sum(efWAR)) %>% ungroup() %>% 
  arrange(desc(ebWAR))

bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))

pre_int_fixed_career_bat <- career_bWAR
pre_int_fixed_career_trimmed_bat <- bat_career_nonpara

```

```{r cache=TRUE, echo=FALSE}
load('bat_pit_pops.RData')
batters <- bat_dat %>% select(yearID, playerID, lgID, name, age, PA, G, bWAR, pops)
cutoff <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
  m <- batters %>% filter(yearID == xx) %>% filter(PA >= 75)
  data.frame(thres = median(m$PA), yearID = xx)
}))
batters <- merge(batters, cutoff, by = 'yearID')
batters <- batters %>% mutate(comp =  bWAR / G, full_time = ifelse(PA >= thres, 'Y', 'N'))
batters_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
  int<- batters %>% filter(yearID == xx)
  lg_avg <- sum(int$bWAR)/sum(int$G)
  int %>% mutate(comp = (bWAR + lg_avg * 7)/(G + 7))
}))

batters_schell <- batters_schell %>% 
  select(-pops) %>% 
  left_join(MLBpops_econ_effect %>% 
              select(year, NL_pop, AL_pop), by = c('yearID' = 'year')) %>% 
  mutate(pops = ifelse(lgID == "NL",NL_pop,AL_pop))
```

```{r cache=TRUE, echo=FALSE}
batters_talent_bWAR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
  talent_computing_nonpara(dataset = batters_schell, component_name = "bWAR", year = yy, 
                           ystar = thresh_fun(component = batters_schell %>% filter(full_time == 'Y', 
                                                                                    yearID == yy) %>% 
                                                select(comp), component_name = 'bWAR'), alpha = 1.16) })) %>% 
  arrange(-WAR_talent)

no_strike <- batters_talent_bWAR %>% 
  filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
         full_time == 'Y', lgID == 'NL') %>%
  arrange(WAR_talent)

t <- isoreg(no_strike$WAR_talent, no_strike$comp)
talent_new <- quantile(no_strike$WAR_talent, probs = (seq(0,250)/250))
comp_new <- as.stepfun(t)(talent_new)

ystar <- thresh_fun(comp_new, component_name = 'bWAR')
pop_new <- round(mean(no_strike$pops))
component_name = 'bWAR'
yy <- sort(comp_new)
n <- length(yy)
ytilde <- rep(0, n + 1)
if (component_name == 'bWAR' | component_name == 'fWAR') {
  ytilde[1] <- yy[1] - (yy[2] - yy[1])
}
if (component_name == 'HR' | component_name == 'BB') {
  # since the minimal HR is greater or equal to 0.
  ytilde[1] <- 0
}
ytilde[n+1] <- yy[n] + ystar
ytilde[2:n] <- unlist(lapply(2:n, function(j){
  (yy[j]+yy[j-1])/2 
}))

career_kAB_1st <- do.call(rbind, mclapply(1:30000, function(zz){
  int <- career_talent_nonpara(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                               snippet = batters_talent_bWAR[zz,], alpha = 1.16)
  int
}, mc.cores = ncores))


career_kAB_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
  int <- career_talent_nonpara(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                               snippet = batters_talent_bWAR[zz,], alpha = 1.16)
  int
}, mc.cores = ncores)) 

career_kAB_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_bWAR), function(zz){
  int <- career_talent_nonpara(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                               snippet = batters_talent_bWAR[zz,], alpha = 1.16)
  int
}, mc.cores = ncores)) 

career_kAB <- rbind(career_kAB_1st, career_kAB_2nd, career_kAB_3rd)

mapped_batters_1 <- merge(career_kAB, mapped_quan_b_raw, 
                          by = c('playerID', 'yearID'))

min_refbWAR <- -2

mapped_batters_bWAR <- mapped_batters_1 %>% 
  mutate(adj_bWAR = adj_comp * mapped_G_raw) %>% 
  mutate(adj_bWAR = ifelse(adj_bWAR < min_refbWAR, min_refbWAR, adj_bWAR)) %>%
  mutate(mapped_G_bWAR = round(adj_bWAR / adj_comp))
career_bWAR <- mapped_batters_bWAR %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            mapped_G = sum(mapped_G_bWAR),
            adj_bWAR = sum(adj_bWAR))

master_batters_AB <- master_batters_trim %>% select(-c(adj_bWAR, mapped_G_bWAR))
bWAR_part <- mapped_batters_bWAR %>%
  mutate(adj_bWAR = round(adj_bWAR, 2)) %>%
  select(yearID, playerID, adj_bWAR, mapped_G_bWAR) 
master_batters <- merge(master_batters_AB, bWAR_part, by = c('yearID', 'playerID'))
master_batters <- master_batters %>% 
  mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0

master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
  mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))
master_batters_nonpara$mapped_G <- apply(master_batters_nonpara[,c(14,18)], 1, min)

## Batters
batters <- master_batters_nonpara

## extract and remove bad players 
foo <- batters %>% 
  arrange(desc(adj_AVG)) %>% 
  filter(adj_AB >= 300) %>% 
  dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
  mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
bar <- split(foo, as.factor(foo$playerID))
baz <- do.call(rbind, lapply(bar, function(m){
  m[which.max(m$adj_fWAR), ]
}))
baz <- baz %>% arrange(adj_fWAR)
bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)

baz <- do.call(rbind, lapply(bar, function(m){
  m[which.max(m$adj_bWAR), ]
}))
baz <- baz %>% arrange(adj_bWAR)
bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
bad_players <- union(bad_players_bWAR, bad_players_fWAR)
batters <- batters[!batters$playerID %in% bad_players, ]

###### investigate anomalies ######

## more on base events than PAs

# check average for minimal at bats and correct issues
batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
batters[batters$adj_AB > 0, ]$adj_AVG <- 
  round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)

## build adjusted data set
batters_adjusted <- batters %>% 
  dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))


## trim out bad players
# first round
foo <- split(batters_adjusted, f = batters_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
})
checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                      m_bad = unlist(lapply(bar, mean)), 
                      len = unlist(lapply(bar, length)))
batters_adjusted <- batters_adjusted %>% 
  filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)

# second round
foo <- split(batters_adjusted, f = batters_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
})
checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                      m_bad = unlist(lapply(bar, mean)), 
                      len = unlist(lapply(bar, length)))
batters_adjusted <- batters_adjusted %>% 
  filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)

# third round
foo <- split(batters_adjusted, f = batters_adjusted$playerID)
bar <- lapply(foo, function(m){
  min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
})
checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                      m_bad = unlist(lapply(bar, mean)), 
                      len = unlist(lapply(bar, length)))
batters_adjusted <- batters_adjusted %>% 
  filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)

# forth round
foo <- split(batters_adjusted, f = batters_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
})
checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                      m_bad = unlist(lapply(bar, mean)), 
                      len = unlist(lapply(bar, length)))
batters_adjusted <- batters_adjusted %>% 
  filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)


## remove tails 
foo <- split(batters_adjusted, f = batters_adjusted$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                    ifelse(sum(tail(bad, 3)) >= 5,1,0),
                    ifelse(sum(tail(bad, 4)) >= 7,1,0),
                    ifelse(sum(tail(bad, 5)) >= 9,1,0),
                    ifelse(sum(tail(bad, 6)) >= 11,1,0)))
  1:(length(bad)-bad_tail)
})
batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                    ifelse(sum(tail(bad, 3)) >= 3,1,0),
                    ifelse(sum(tail(bad, 4)) >= 4,1,0),
                    ifelse(sum(tail(bad, 5)) >= 5,1,0),
                    ifelse(sum(tail(bad, 6)) >= 6,1,0)))
  1:(length(bad)-bad_tail)
})
batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                    ifelse(sum(tail(bad, 3)) >= 3,1,0),
                    ifelse(sum(tail(bad, 4)) >= 4,1,0),
                    ifelse(sum(tail(bad, 5)) >= 5,1,0),
                    ifelse(sum(tail(bad, 6)) >= 6,1,0)))
  1:(length(bad)-bad_tail)
})
batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

## remove starts
foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
  bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                    ifelse(sum(head(bad, 2)) >= 3,1,0),
                    ifelse(sum(head(bad, 3)) >= 5,1,0),
                    ifelse(sum(head(bad, 4)) >= 7,1,0),
                    ifelse(sum(head(bad, 5)) >= 9,1,0),
                    ifelse(sum(head(bad, 6)) >= 11,1,0)))
  if (bad_head < length(bad)) {
    (bad_head + 1):length(bad)
  }
})
batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)

# taper down average WAR for players with small PAs
batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
  round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
  round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	

batters_adjusted <- do.call(rbind, mclapply(
  split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
  mc.cores = ncores, FUN = function(xx){
    ## natural cubic spline
    ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
    nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
    ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
    nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
    ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
    nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
    ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
    nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
    ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
    nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
    
    xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
      mutate(HR = round((adj_HR + nn_HR)/2)) %>%
      mutate(BB = round((adj_BB + nn_BB)/2)) %>%
      mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
      mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
  })) 

bat_season <- batters_adjusted %>% 
  mutate(PA = adj_AB + BB + HBP + SF)
bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
  bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB

bat_season <- bat_season %>% 
  dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
  mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
  mutate(HR = ifelse(HR > 0, HR, 0)) %>%
  mutate(BB = ifelse(BB > 0, BB, 0)) %>%
  mutate(OBP = ifelse(OBP > 0, OBP, 0))

colnames(bat_season)[5] <- 'AB'
colnames(bat_season)[8] <- 'BA'
bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
  mutate(BA = round(H / AB, 3)) %>%
  mutate(BA = ifelse(AB == 0, 0, BA)) %>%
  mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
  mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))

bat_career_nonpara <- bat_season_nonpara %>% group_by(playerID) %>% 
  summarise(name = unique(name), 
            playerID = unique(playerID), 
            PA = sum(round(PA)), 
            AB = sum(AB), 
            H = sum(H), 
            HR = sum(round(HR)), 
            BB = sum(round(BB)), 
            BA = round(H/AB, 3), 
            HBP = sum(HBP), 
            SF = sum(SF), 
            OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
            ebWAR = sum(ebWAR), 
            efWAR = sum(efWAR)) %>% ungroup() %>% 
  arrange(desc(ebWAR))

bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))

econ_effect_historical_career_bat <- career_bWAR
econ_effect_historical_career_trimmed_bat <- bat_career_nonpara

```

```{r cache=TRUE, echo=FALSE}
batters_talent_bWAR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
  talent_computing_nonpara_fixed(dataset = batters_schell, component_name = "bWAR", year = yy, 
                                 ystar = thresh_fun(component = batters_schell %>% filter(full_time == 'Y', 
                                                                                          yearID == yy) %>% 
                                                      select(comp), component_name = 'bWAR'), alpha = 1.16) })) %>% 
  arrange(-WAR_talent)

no_strike <- batters_talent_bWAR %>% 
  filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
         full_time == 'Y', lgID == 'NL') %>%
  arrange(WAR_talent)

t <- isoreg(no_strike$WAR_talent, no_strike$comp)
talent_new <- quantile(no_strike$WAR_talent, probs = (seq(0,250)/250))
comp_new <- as.stepfun(t)(talent_new)

ystar <- thresh_fun(comp_new, component_name = 'bWAR')
pop_new <- round(mean(no_strike$pops))
component_name = 'bWAR'
yy <- sort(comp_new)
n <- length(yy)
ytilde <- rep(0, n + 1)
if (component_name == 'bWAR' | component_name == 'fWAR') {
  ytilde[1] <- yy[1] - (yy[2] - yy[1])
}
if (component_name == 'HR' | component_name == 'BB') {
  # since the minimal HR is greater or equal to 0.
  ytilde[1] <- 0
}
ytilde[n+1] <- yy[n] + ystar
ytilde[2:n] <- unlist(lapply(2:n, function(j){
  (yy[j]+yy[j-1])/2 
}))

career_kAB_1st <- do.call(rbind, mclapply(1:30000, function(zz){
  int <- career_talent_nonpara(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                               snippet = batters_talent_bWAR[zz,], alpha = 1.16)
  int
}, mc.cores = ncores))


career_kAB_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
  int <- career_talent_nonpara(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                               snippet = batters_talent_bWAR[zz,], alpha = 1.16)
  int
}, mc.cores = ncores)) 

career_kAB_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_bWAR), function(zz){
  int <- career_talent_nonpara(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                               snippet = batters_talent_bWAR[zz,], alpha = 1.16)
  int
}, mc.cores = ncores)) 

career_kAB <- rbind(career_kAB_1st, career_kAB_2nd, career_kAB_3rd)

mapped_batters_1 <- merge(career_kAB, mapped_quan_b_raw, 
                          by = c('playerID', 'yearID'))

min_refbWAR <- -2

mapped_batters_bWAR <- mapped_batters_1 %>% 
  mutate(adj_bWAR = adj_comp * mapped_G_raw) %>% 
  mutate(adj_bWAR = ifelse(adj_bWAR < min_refbWAR, min_refbWAR, adj_bWAR)) %>%
  mutate(mapped_G_bWAR = round(adj_bWAR / adj_comp))
career_bWAR <- mapped_batters_bWAR %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            mapped_G = sum(mapped_G_bWAR),
            adj_bWAR = sum(adj_bWAR))

master_batters_AB <- master_batters_trim %>% select(-c(adj_bWAR, mapped_G_bWAR))
bWAR_part <- mapped_batters_bWAR %>%
  mutate(adj_bWAR = round(adj_bWAR, 2)) %>%
  select(yearID, playerID, adj_bWAR, mapped_G_bWAR) 
master_batters <- merge(master_batters_AB, bWAR_part, by = c('yearID', 'playerID'))
master_batters <- master_batters %>% 
  mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0

master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
  mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))
master_batters_nonpara$mapped_G <- apply(master_batters_nonpara[,c(14,18)], 1, min)

## Batters
batters <- master_batters_nonpara

## extract and remove bad players 
foo <- batters %>% 
  arrange(desc(adj_AVG)) %>% 
  filter(adj_AB >= 300) %>% 
  dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
  mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
bar <- split(foo, as.factor(foo$playerID))
baz <- do.call(rbind, lapply(bar, function(m){
  m[which.max(m$adj_fWAR), ]
}))
baz <- baz %>% arrange(adj_fWAR)
bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)

baz <- do.call(rbind, lapply(bar, function(m){
  m[which.max(m$adj_bWAR), ]
}))
baz <- baz %>% arrange(adj_bWAR)
bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
bad_players <- union(bad_players_bWAR, bad_players_fWAR)
batters <- batters[!batters$playerID %in% bad_players, ]

###### investigate anomalies ######

## more on base events than PAs

# check average for minimal at bats and correct issues
batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
batters[batters$adj_AB > 0, ]$adj_AVG <- 
  round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)

## build adjusted data set
batters_adjusted <- batters %>% 
  dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))


## trim out bad players
# first round
foo <- split(batters_adjusted, f = batters_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
})
checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                      m_bad = unlist(lapply(bar, mean)), 
                      len = unlist(lapply(bar, length)))
batters_adjusted <- batters_adjusted %>% 
  filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)

# second round
foo <- split(batters_adjusted, f = batters_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
})
checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                      m_bad = unlist(lapply(bar, mean)), 
                      len = unlist(lapply(bar, length)))
batters_adjusted <- batters_adjusted %>% 
  filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)

# third round
foo <- split(batters_adjusted, f = batters_adjusted$playerID)
bar <- lapply(foo, function(m){
  min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
})
checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                      m_bad = unlist(lapply(bar, mean)), 
                      len = unlist(lapply(bar, length)))
batters_adjusted <- batters_adjusted %>% 
  filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)

# forth round
foo <- split(batters_adjusted, f = batters_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
})
checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                      m_bad = unlist(lapply(bar, mean)), 
                      len = unlist(lapply(bar, length)))
batters_adjusted <- batters_adjusted %>% 
  filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)


## remove tails 
foo <- split(batters_adjusted, f = batters_adjusted$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                    ifelse(sum(tail(bad, 3)) >= 5,1,0),
                    ifelse(sum(tail(bad, 4)) >= 7,1,0),
                    ifelse(sum(tail(bad, 5)) >= 9,1,0),
                    ifelse(sum(tail(bad, 6)) >= 11,1,0)))
  1:(length(bad)-bad_tail)
})
batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                    ifelse(sum(tail(bad, 3)) >= 3,1,0),
                    ifelse(sum(tail(bad, 4)) >= 4,1,0),
                    ifelse(sum(tail(bad, 5)) >= 5,1,0),
                    ifelse(sum(tail(bad, 6)) >= 6,1,0)))
  1:(length(bad)-bad_tail)
})
batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                    ifelse(sum(tail(bad, 3)) >= 3,1,0),
                    ifelse(sum(tail(bad, 4)) >= 4,1,0),
                    ifelse(sum(tail(bad, 5)) >= 5,1,0),
                    ifelse(sum(tail(bad, 6)) >= 6,1,0)))
  1:(length(bad)-bad_tail)
})
batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

## remove starts
foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
  bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                    ifelse(sum(head(bad, 2)) >= 3,1,0),
                    ifelse(sum(head(bad, 3)) >= 5,1,0),
                    ifelse(sum(head(bad, 4)) >= 7,1,0),
                    ifelse(sum(head(bad, 5)) >= 9,1,0),
                    ifelse(sum(head(bad, 6)) >= 11,1,0)))
  if (bad_head < length(bad)) {
    (bad_head + 1):length(bad)
  }
})
batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)

# taper down average WAR for players with small PAs
batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
  round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
  round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	

batters_adjusted <- do.call(rbind, mclapply(
  split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
  mc.cores = ncores, FUN = function(xx){
    ## natural cubic spline
    ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
    nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
    ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
    nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
    ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
    nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
    ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
    nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
    ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
    nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
    
    xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
      mutate(HR = round((adj_HR + nn_HR)/2)) %>%
      mutate(BB = round((adj_BB + nn_BB)/2)) %>%
      mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
      mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
  })) 

bat_season <- batters_adjusted %>% 
  mutate(PA = adj_AB + BB + HBP + SF)
bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
  bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB

bat_season <- bat_season %>% 
  dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
  mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
  mutate(HR = ifelse(HR > 0, HR, 0)) %>%
  mutate(BB = ifelse(BB > 0, BB, 0)) %>%
  mutate(OBP = ifelse(OBP > 0, OBP, 0))

colnames(bat_season)[5] <- 'AB'
colnames(bat_season)[8] <- 'BA'
bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
  mutate(BA = round(H / AB, 3)) %>%
  mutate(BA = ifelse(AB == 0, 0, BA)) %>%
  mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
  mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))

bat_career_nonpara <- bat_season_nonpara %>% group_by(playerID) %>% 
  summarise(name = unique(name), 
            playerID = unique(playerID), 
            PA = sum(round(PA)), 
            AB = sum(AB), 
            H = sum(H), 
            HR = sum(round(HR)), 
            BB = sum(round(BB)), 
            BA = round(H/AB, 3), 
            HBP = sum(HBP), 
            SF = sum(SF), 
            OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
            ebWAR = sum(ebWAR), 
            efWAR = sum(efWAR)) %>% ungroup() %>% 
  arrange(desc(ebWAR))

bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))

econ_effect_fixed_career_bat <- career_bWAR
econ_effect_fixed_career_trimmed_bat <- bat_career_nonpara

```

```{r cache=TRUE, echo=FALSE}
load('bat_pit_pops.RData')
batters <- bat_dat %>% select(yearID, playerID, lgID, name, age, PA, G, bWAR, pops)
cutoff <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
  m <- batters %>% filter(yearID == xx) %>% filter(PA >= 75)
  data.frame(thres = median(m$PA), yearID = xx)
}))
batters <- merge(batters, cutoff, by = 'yearID')
batters <- batters %>% mutate(comp =  bWAR / G, full_time = ifelse(PA >= thres, 'Y', 'N'))
batters_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
  int<- batters %>% filter(yearID == xx)
  lg_avg <- sum(int$bWAR)/sum(int$G)
  int %>% mutate(comp = (bWAR + lg_avg * 7)/(G + 7))
}))

batters_schell <- batters_schell %>% 
  select(-pops) %>% 
  left_join(MLBpops %>% 
              select(year, NL_pop, AL_pop), by = c('yearID' = 'year')) %>% 
  mutate(pops = ifelse(lgID == "NL",NL_pop,AL_pop))

```

```{r cache=TRUE, echo=FALSE}
batters_talent_bWAR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
  talent_computing_nonpara(dataset = batters_schell, component_name = "bWAR", year = yy, 
                           ystar = thresh_fun(component = batters_schell %>% filter(full_time == 'Y', 
                                                                                    yearID == yy) %>% 
                                                select(comp), component_name = 'bWAR'), alpha = 1.16) })) %>% 
  arrange(-WAR_talent)

no_strike <- batters_talent_bWAR %>% 
  filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
         full_time == 'Y', lgID == 'NL') %>%
  arrange(WAR_talent)

t <- isoreg(no_strike$WAR_talent, no_strike$comp)
talent_new <- quantile(no_strike$WAR_talent, probs = (seq(0,250)/250))
comp_new <- as.stepfun(t)(talent_new)

ystar <- thresh_fun(comp_new, component_name = 'bWAR')
pop_new <- round(mean(no_strike$pops))
component_name = 'bWAR'
yy <- sort(comp_new)
n <- length(yy)
ytilde <- rep(0, n + 1)
if (component_name == 'bWAR' | component_name == 'fWAR') {
  ytilde[1] <- yy[1] - (yy[2] - yy[1])
}
if (component_name == 'HR' | component_name == 'BB') {
  # since the minimal HR is greater or equal to 0.
  ytilde[1] <- 0
}
ytilde[n+1] <- yy[n] + ystar
ytilde[2:n] <- unlist(lapply(2:n, function(j){
  (yy[j]+yy[j-1])/2 
}))

career_kAB_1st <- do.call(rbind, mclapply(1:30000, function(zz){
  int <- career_talent_nonpara(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                               snippet = batters_talent_bWAR[zz,], alpha = 1.16)
  int
}, mc.cores = ncores))


career_kAB_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
  int <- career_talent_nonpara(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                               snippet = batters_talent_bWAR[zz,], alpha = 1.16)
  int
}, mc.cores = ncores)) 

career_kAB_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_bWAR), function(zz){
  int <- career_talent_nonpara(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                               snippet = batters_talent_bWAR[zz,], alpha = 1.16)
  int
}, mc.cores = ncores)) 

career_kAB <- rbind(career_kAB_1st, career_kAB_2nd, career_kAB_3rd)

mapped_batters_1 <- merge(career_kAB, mapped_quan_b_raw, 
                          by = c('playerID', 'yearID'))
min_refbWAR <- -2

mapped_batters_bWAR <- mapped_batters_1 %>% 
  mutate(adj_bWAR = adj_comp * mapped_G_raw) %>% 
  mutate(adj_bWAR = ifelse(adj_bWAR < min_refbWAR, min_refbWAR, adj_bWAR)) %>%
  mutate(mapped_G_bWAR = round(adj_bWAR / adj_comp))
career_bWAR <- mapped_batters_bWAR %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            mapped_G = sum(mapped_G_bWAR),
            adj_bWAR = sum(adj_bWAR))

master_batters_AB <- master_batters_trim %>% select(-c(adj_bWAR, mapped_G_bWAR))
bWAR_part <- mapped_batters_bWAR %>%
  mutate(adj_bWAR = round(adj_bWAR, 2)) %>%
  select(yearID, playerID, adj_bWAR, mapped_G_bWAR) 
master_batters <- merge(master_batters_AB, bWAR_part, by = c('yearID', 'playerID'))
master_batters <- master_batters %>% 
  mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0

master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
  mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))
master_batters_nonpara$mapped_G <- apply(master_batters_nonpara[,c(14,18)], 1, min)

## Batters
batters <- master_batters_nonpara

## extract and remove bad players 
foo <- batters %>% 
  arrange(desc(adj_AVG)) %>% 
  filter(adj_AB >= 300) %>% 
  dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
  mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
bar <- split(foo, as.factor(foo$playerID))
baz <- do.call(rbind, lapply(bar, function(m){
  m[which.max(m$adj_fWAR), ]
}))
baz <- baz %>% arrange(adj_fWAR)
bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)

baz <- do.call(rbind, lapply(bar, function(m){
  m[which.max(m$adj_bWAR), ]
}))
baz <- baz %>% arrange(adj_bWAR)
bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
bad_players <- union(bad_players_bWAR, bad_players_fWAR)
batters <- batters[!batters$playerID %in% bad_players, ]

###### investigate anomalies ######

## more on base events than PAs

# check average for minimal at bats and correct issues
batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
batters[batters$adj_AB > 0, ]$adj_AVG <- 
  round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)

## build adjusted data set
batters_adjusted <- batters %>% 
  dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))


## trim out bad players
# first round
foo <- split(batters_adjusted, f = batters_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
})
checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                      m_bad = unlist(lapply(bar, mean)), 
                      len = unlist(lapply(bar, length)))
batters_adjusted <- batters_adjusted %>% 
  filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)

# second round
foo <- split(batters_adjusted, f = batters_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
})
checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                      m_bad = unlist(lapply(bar, mean)), 
                      len = unlist(lapply(bar, length)))
batters_adjusted <- batters_adjusted %>% 
  filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)

# third round
foo <- split(batters_adjusted, f = batters_adjusted$playerID)
bar <- lapply(foo, function(m){
  min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
})
checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                      m_bad = unlist(lapply(bar, mean)), 
                      len = unlist(lapply(bar, length)))
batters_adjusted <- batters_adjusted %>% 
  filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)

# forth round
foo <- split(batters_adjusted, f = batters_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
})
checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                      m_bad = unlist(lapply(bar, mean)), 
                      len = unlist(lapply(bar, length)))
batters_adjusted <- batters_adjusted %>% 
  filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)


## remove tails 
foo <- split(batters_adjusted, f = batters_adjusted$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                    ifelse(sum(tail(bad, 3)) >= 5,1,0),
                    ifelse(sum(tail(bad, 4)) >= 7,1,0),
                    ifelse(sum(tail(bad, 5)) >= 9,1,0),
                    ifelse(sum(tail(bad, 6)) >= 11,1,0)))
  1:(length(bad)-bad_tail)
})
batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                    ifelse(sum(tail(bad, 3)) >= 3,1,0),
                    ifelse(sum(tail(bad, 4)) >= 4,1,0),
                    ifelse(sum(tail(bad, 5)) >= 5,1,0),
                    ifelse(sum(tail(bad, 6)) >= 6,1,0)))
  1:(length(bad)-bad_tail)
})
batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                    ifelse(sum(tail(bad, 3)) >= 3,1,0),
                    ifelse(sum(tail(bad, 4)) >= 4,1,0),
                    ifelse(sum(tail(bad, 5)) >= 5,1,0),
                    ifelse(sum(tail(bad, 6)) >= 6,1,0)))
  1:(length(bad)-bad_tail)
})
batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

## remove starts
foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
  bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                    ifelse(sum(head(bad, 2)) >= 3,1,0),
                    ifelse(sum(head(bad, 3)) >= 5,1,0),
                    ifelse(sum(head(bad, 4)) >= 7,1,0),
                    ifelse(sum(head(bad, 5)) >= 9,1,0),
                    ifelse(sum(head(bad, 6)) >= 11,1,0)))
  if (bad_head < length(bad)) {
    (bad_head + 1):length(bad)
  }
})
batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)

# taper down average WAR for players with small PAs
batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
  round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
  round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	

batters_adjusted <- do.call(rbind, mclapply(
  split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
  mc.cores = ncores, FUN = function(xx){
    ## natural cubic spline
    ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
    nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
    ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
    nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
    ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
    nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
    ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
    nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
    ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
    nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
    
    xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
      mutate(HR = round((adj_HR + nn_HR)/2)) %>%
      mutate(BB = round((adj_BB + nn_BB)/2)) %>%
      mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
      mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
  })) 

bat_season <- batters_adjusted %>% 
  mutate(PA = adj_AB + BB + HBP + SF)
bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
  bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB

bat_season <- bat_season %>% 
  dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
  mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
  mutate(HR = ifelse(HR > 0, HR, 0)) %>%
  mutate(BB = ifelse(BB > 0, BB, 0)) %>%
  mutate(OBP = ifelse(OBP > 0, OBP, 0))

colnames(bat_season)[5] <- 'AB'
colnames(bat_season)[8] <- 'BA'
bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
  mutate(BA = round(H / AB, 3)) %>%
  mutate(BA = ifelse(AB == 0, 0, BA)) %>%
  mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
  mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))

bat_career_nonpara <- bat_season_nonpara %>% group_by(playerID) %>% 
  summarise(name = unique(name), 
            playerID = unique(playerID), 
            PA = sum(round(PA)), 
            AB = sum(AB), 
            H = sum(H), 
            HR = sum(round(HR)), 
            BB = sum(round(BB)), 
            BA = round(H/AB, 3), 
            HBP = sum(HBP), 
            SF = sum(SF), 
            OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
            ebWAR = sum(ebWAR), 
            efWAR = sum(efWAR)) %>% ungroup() %>% 
  arrange(desc(ebWAR))

bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))

normal_historical_career_bat <- career_bWAR
normal_historical_career_trimmed_bat <- bat_career_nonpara

```

```{r cache=TRUE, echo=FALSE}
batters_talent_bWAR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
  talent_computing_nonpara_fixed(dataset = batters_schell, component_name = "bWAR", year = yy, 
                                 ystar = thresh_fun(component = batters_schell %>% filter(full_time == 'Y', 
                                                                                          yearID == yy) %>% 
                                                      select(comp), component_name = 'bWAR'), alpha = 1.16) })) %>% 
  arrange(-WAR_talent)

no_strike <- batters_talent_bWAR %>% 
  filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
         full_time == 'Y', lgID == 'NL') %>%
  arrange(WAR_talent)

t <- isoreg(no_strike$WAR_talent, no_strike$comp)
talent_new <- quantile(no_strike$WAR_talent, probs = (seq(0,250)/250))
comp_new <- as.stepfun(t)(talent_new)

ystar <- thresh_fun(comp_new, component_name = 'bWAR')
pop_new <- round(mean(no_strike$pops))
component_name = 'bWAR'
yy <- sort(comp_new)
n <- length(yy)
ytilde <- rep(0, n + 1)
if (component_name == 'bWAR' | component_name == 'fWAR') {
  ytilde[1] <- yy[1] - (yy[2] - yy[1])
}
if (component_name == 'HR' | component_name == 'BB') {
  # since the minimal HR is greater or equal to 0.
  ytilde[1] <- 0
}
ytilde[n+1] <- yy[n] + ystar
ytilde[2:n] <- unlist(lapply(2:n, function(j){
  (yy[j]+yy[j-1])/2 
}))

career_kAB_1st <- do.call(rbind, mclapply(1:30000, function(zz){
  int <- career_talent_nonpara(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                               snippet = batters_talent_bWAR[zz,], alpha = 1.16)
  int
}, mc.cores = ncores))


career_kAB_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
  int <- career_talent_nonpara(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                               snippet = batters_talent_bWAR[zz,], alpha = 1.16)
  int
}, mc.cores = ncores)) 

career_kAB_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_bWAR), function(zz){
  int <- career_talent_nonpara(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                               snippet = batters_talent_bWAR[zz,], alpha = 1.16)
  int
}, mc.cores = ncores)) 

career_kAB <- rbind(career_kAB_1st, career_kAB_2nd, career_kAB_3rd)

mapped_batters_1 <- merge(career_kAB, mapped_quan_b_raw, 
                          by = c('playerID', 'yearID'))
min_refbWAR <- -2

mapped_batters_bWAR <- mapped_batters_1 %>% 
  mutate(adj_bWAR = adj_comp * mapped_G_raw) %>% 
  mutate(adj_bWAR = ifelse(adj_bWAR < min_refbWAR, min_refbWAR, adj_bWAR)) %>%
  mutate(mapped_G_bWAR = round(adj_bWAR / adj_comp))
career_bWAR <- mapped_batters_bWAR %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            mapped_G = sum(mapped_G_bWAR),
            adj_bWAR = sum(adj_bWAR))

master_batters_AB <- master_batters_trim %>% select(-c(adj_bWAR, mapped_G_bWAR))
bWAR_part <- mapped_batters_bWAR %>%
  mutate(adj_bWAR = round(adj_bWAR, 2)) %>%
  select(yearID, playerID, adj_bWAR, mapped_G_bWAR) 
master_batters <- merge(master_batters_AB, bWAR_part, by = c('yearID', 'playerID'))
master_batters <- master_batters %>% 
  mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0

master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
  mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))
master_batters_nonpara$mapped_G <- apply(master_batters_nonpara[,c(14,18)], 1, min)

## Batters
batters <- master_batters_nonpara

## extract and remove bad players 
foo <- batters %>% 
  arrange(desc(adj_AVG)) %>% 
  filter(adj_AB >= 300) %>% 
  dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
  mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
bar <- split(foo, as.factor(foo$playerID))
baz <- do.call(rbind, lapply(bar, function(m){
  m[which.max(m$adj_fWAR), ]
}))
baz <- baz %>% arrange(adj_fWAR)
bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)

baz <- do.call(rbind, lapply(bar, function(m){
  m[which.max(m$adj_bWAR), ]
}))
baz <- baz %>% arrange(adj_bWAR)
bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
bad_players <- union(bad_players_bWAR, bad_players_fWAR)
batters <- batters[!batters$playerID %in% bad_players, ]

###### investigate anomalies ######

## more on base events than PAs

# check average for minimal at bats and correct issues
batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
batters[batters$adj_AB > 0, ]$adj_AVG <- 
  round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)

## build adjusted data set
batters_adjusted <- batters %>% 
  dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))


## trim out bad players
# first round
foo <- split(batters_adjusted, f = batters_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
})
checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                      m_bad = unlist(lapply(bar, mean)), 
                      len = unlist(lapply(bar, length)))
batters_adjusted <- batters_adjusted %>% 
  filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)

# second round
foo <- split(batters_adjusted, f = batters_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
})
checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                      m_bad = unlist(lapply(bar, mean)), 
                      len = unlist(lapply(bar, length)))
batters_adjusted <- batters_adjusted %>% 
  filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)

# third round
foo <- split(batters_adjusted, f = batters_adjusted$playerID)
bar <- lapply(foo, function(m){
  min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
})
checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                      m_bad = unlist(lapply(bar, mean)), 
                      len = unlist(lapply(bar, length)))
batters_adjusted <- batters_adjusted %>% 
  filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)

# forth round
foo <- split(batters_adjusted, f = batters_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
})
checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                      m_bad = unlist(lapply(bar, mean)), 
                      len = unlist(lapply(bar, length)))
batters_adjusted <- batters_adjusted %>% 
  filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)


## remove tails 
foo <- split(batters_adjusted, f = batters_adjusted$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                    ifelse(sum(tail(bad, 3)) >= 5,1,0),
                    ifelse(sum(tail(bad, 4)) >= 7,1,0),
                    ifelse(sum(tail(bad, 5)) >= 9,1,0),
                    ifelse(sum(tail(bad, 6)) >= 11,1,0)))
  1:(length(bad)-bad_tail)
})
batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                    ifelse(sum(tail(bad, 3)) >= 3,1,0),
                    ifelse(sum(tail(bad, 4)) >= 4,1,0),
                    ifelse(sum(tail(bad, 5)) >= 5,1,0),
                    ifelse(sum(tail(bad, 6)) >= 6,1,0)))
  1:(length(bad)-bad_tail)
})
batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                    ifelse(sum(tail(bad, 3)) >= 3,1,0),
                    ifelse(sum(tail(bad, 4)) >= 4,1,0),
                    ifelse(sum(tail(bad, 5)) >= 5,1,0),
                    ifelse(sum(tail(bad, 6)) >= 6,1,0)))
  1:(length(bad)-bad_tail)
})
batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

## remove starts
foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
  bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                    ifelse(sum(head(bad, 2)) >= 3,1,0),
                    ifelse(sum(head(bad, 3)) >= 5,1,0),
                    ifelse(sum(head(bad, 4)) >= 7,1,0),
                    ifelse(sum(head(bad, 5)) >= 9,1,0),
                    ifelse(sum(head(bad, 6)) >= 11,1,0)))
  if (bad_head < length(bad)) {
    (bad_head + 1):length(bad)
  }
})
batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)

# taper down average WAR for players with small PAs
batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
  round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
  round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	

batters_adjusted <- do.call(rbind, mclapply(
  split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
  mc.cores = ncores, FUN = function(xx){
    ## natural cubic spline
    ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
    nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
    ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
    nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
    ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
    nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
    ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
    nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
    ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
    nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
    
    xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
      mutate(HR = round((adj_HR + nn_HR)/2)) %>%
      mutate(BB = round((adj_BB + nn_BB)/2)) %>%
      mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
      mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
  })) 

bat_season <- batters_adjusted %>% 
  mutate(PA = adj_AB + BB + HBP + SF)
bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
  bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB

bat_season <- bat_season %>% 
  dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
  mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
  mutate(HR = ifelse(HR > 0, HR, 0)) %>%
  mutate(BB = ifelse(BB > 0, BB, 0)) %>%
  mutate(OBP = ifelse(OBP > 0, OBP, 0))

colnames(bat_season)[5] <- 'AB'
colnames(bat_season)[8] <- 'BA'
bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
  mutate(BA = round(H / AB, 3)) %>%
  mutate(BA = ifelse(AB == 0, 0, BA)) %>%
  mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
  mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))

bat_career_nonpara <- bat_season_nonpara %>% group_by(playerID) %>% 
  summarise(name = unique(name), 
            playerID = unique(playerID), 
            PA = sum(round(PA)), 
            AB = sum(AB), 
            H = sum(H), 
            HR = sum(round(HR)), 
            BB = sum(round(BB)), 
            BA = round(H/AB, 3), 
            HBP = sum(HBP), 
            SF = sum(SF), 
            OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
            ebWAR = sum(ebWAR), 
            efWAR = sum(efWAR)) %>% ungroup() %>% 
  arrange(desc(ebWAR))

bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))

normal_fixed_career_bat <- career_bWAR
normal_fixed_career_trimmed_bat <- bat_career_nonpara

```

```{r cache=TRUE, echo=FALSE}
foo <- getRetrosheet(type = "game", year = 2022)
rotation_bound <- as.data.frame(cbind(years, unlist(mclapply(years, mc.cores = ncores, function(yr){
  foo <- getRetrosheet(type = "game", year = yr)
  Tms <- unique(foo$HmTm)
  
  starter <- lapply(Tms, function(tm){
    bar <- foo %>% filter(VisTm == tm | HmTm == tm) %>% 
      select(VisTm, HmTm, VisStPchID, HmStPchID, VisTmGNum, HmTmGNum)
    t(apply(bar, 1, function(xx){
      y <- NULL
      if(xx[2] == tm){
        y <- xx[4]
      }
      else{
        y <- xx[3]
      }
    })) 
  })
  
  y <- unlist(lapply(starter, function(xx){
    unlist(lapply(1:length(xx), function(j){
      flag <- TRUE
      k <- 1
      if(j > 1){
        while(flag){
          flag <- length(xx[(j-k):j]) == length(unique(xx[(j-k):j]))
          if(!flag){
            break
          }
          else{
            k <- k + 1
          }
          if(k == j){
            break
          }
        }
      }
      k
    }))
  }))
  mean(y)
  
}))))
```

```{r cache=TRUE, echo=FALSE}
pitchers <- pit_dat %>% 
  select(playerID, yearID, name, age, lgID, teamID, IP, pops, bWAR)
pitchers <- pitchers %>% mutate(comp = bWAR / IP)
pitchers$comp[is.na(pitchers$comp)] = 0

rotation_bound <- as.data.frame(cbind(years, unlist(mclapply(years, mc.cores = ncores, function(yr){
  foo <- getRetrosheet(type = "game", year = yr)
  Tms <- unique(foo$HmTm)
  
  starter <- lapply(Tms, function(tm){
    bar <- foo %>% filter(VisTm == tm | HmTm == tm) %>% 
      select(VisTm, HmTm, VisStPchID, HmStPchID, VisTmGNum, HmTmGNum)
    t(apply(bar, 1, function(xx){
      y <- NULL
      if(xx[2] == tm){
        y <- xx[4]
      }
      else{
        y <- xx[3]
      }
    })) 
  })
  
  y <- unlist(lapply(starter, function(xx){
    unlist(lapply(1:length(xx), function(j){
      flag <- TRUE
      k <- 1
      if(j > 1){
        while(flag){
          flag <- length(xx[(j-k):j]) == length(unique(xx[(j-k):j]))
          if(!flag){
            break
          }
          else{
            k <- k + 1
          }
          if(k == j){
            break
          }
        }
      }
      k
    }))
  }))
  mean(y)
  
}))))

unique_team <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
  c(xx, nrow(unique(pitchers %>% filter(yearID == xx) %>% select(teamID))))
}))

rotation_player <- data.frame(yearID = years, rotation = ceiling(rotation_bound[,2] * unique_team[,2]))

cutoff <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
  m <- pitchers %>% filter(yearID == xx) %>% arrange(-IP)
  index <- rotation_player$rotation[rotation_player$yearID == xx]
  data.frame(thres = (m$IP[index]), yearID = xx)
}))

pitchers <- merge(pitchers, cutoff, by = 'yearID')

pitchers <- pitchers %>% mutate(full_time = ifelse(IP >= thres, 'Y', 'N'))

pitchers_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
  int<- pitchers %>% filter(yearID == xx)
  lg_avg <- sum(int$bWAR)/sum(int$IP)
  int %>% mutate(comp = (bWAR + lg_avg * 14)/(IP + 14))
}))
pitchers_schell <- pitchers_schell %>% 
  select(-pops) %>% 
  left_join(MLBpops_pre_int %>% 
              select(year, NL_pop, AL_pop), by = c('yearID' = 'year')) %>% 
  mutate(pops = ifelse(lgID == "NL",NL_pop,AL_pop))

```

```{r cache=TRUE, echo=FALSE}
pitchers_talent_bWAR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
  talent_computing_nonpara(dataset = pitchers_schell, component_name = "bWAR_p", year = yy, 
                           ystar = thresh_fun(component = pitchers_schell %>% 
                                                filter(full_time =='Y', yearID == yy) %>%
                                                select(comp), component_name = 'bWAR_p'), alpha = 1.16)
})) %>% arrange(-WAR_talent)

no_strike <- pitchers_talent_bWAR %>% 
  filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
         full_time == 'Y', lgID == 'NL') %>%
  arrange(WAR_talent)

min_refbWAR <- -2

t <- isoreg(no_strike$WAR_talent, no_strike$comp)

talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,154)/154)
comp_new <- as.stepfun(t)(talent_new)

ystar <- thresh_fun(comp_new, component_name = 'bWAR_p')
pop_new <- round(mean(no_strike$pops))
component_name = 'bWAR_p'
yy <- sort(comp_new)
n <- length(yy)
ytilde <- rep(0, n + 1)
if (component_name == 'ERA') {
  ytilde[1] <- yy[1] - (yy[2] - yy[1])
}
if (component_name == 'bWAR_p'| component_name == 'fWAR_p') {
  ytilde[1] <- yy[1] - (yy[2] - yy[1])/10
}
if (component_name == 'SO') {
  ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
}
ytilde[n+1] <- yy[n] + ystar
ytilde[2:n] <- unlist(lapply(2:n, function(j){
  (yy[j]+yy[j-1])/2 
}))

career_kAB <- do.call(rbind, mclapply(1:nrow(pitchers_talent_bWAR), function(xx){
  int <- career_talent_nonpara(dataset = pitchers_talent_bWAR, component_name = 'bWAR_p', 
                               snippet = pitchers_talent_bWAR[xx,], alpha = 1.16)
  int
}, mc.cores = ncores)) 

mapped_pitchers_1 <- merge(career_kAB, mapped_quan_p, 
                           by = c('playerID', 'yearID'))

mapped_pitchers_bWAR <- mapped_pitchers_1 %>% 
  mutate(adj_bWAR = adj_comp * mapped_IP_raw) %>%
  mutate(adj_bWAR = ifelse(adj_bWAR < min_refbWAR, min_refbWAR, adj_bWAR)) %>%
  mutate(mapped_IP_bWAR = round(adj_bWAR / adj_comp))
career_bWAR <- mapped_pitchers_bWAR %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            mapped_IP = sum(mapped_IP_bWAR),
            adj_bWAR = sum(adj_bWAR))
master_pitchers_AB <- master_pitchers_trim %>% select(-adj_bWAR)
bWAR_part <- mapped_pitchers_bWAR %>% 
  mutate(adj_bWAR = round(adj_bWAR, 2)) %>% 
  select(yearID, playerID, adj_bWAR, mapped_IP_bWAR)
master_pitchers <- merge(master_pitchers_AB, bWAR_part, by = c('yearID', 'playerID'))
master_pitchers$mapped_IP <- apply(master_pitchers[,c(5,13)], 1, min)
master_pitchers <- master_pitchers %>% select(-mapped_IP_bWAR)

## Pitchers
pitchers <- master_pitchers %>% 
  mutate(adj_K9 = round(adj_SO/mapped_IP*9,1), 
         K9 = round(SO/IP*9,1), 
         adj_fWAR = round(adj_fWAR, 2))
pitchers <- as.data.frame(pitchers)
#pitchers$avg_ERA[pitchers$avg_ERA > 6.20] <- 6.20
#pitchers <- pitchers[pitchers$adj_bWAR != 0, ]

## extract and remove bad pitchers 
foo <- pitchers %>% 
  arrange(adj_ERA) %>% 
  filter(mapped_IP >= 100) %>% 
  dplyr::select(name, playerID, yearID, mapped_IP, adj_ERA, adj_SO, adj_fWAR, adj_bWAR)
bar <- split(foo, as.factor(foo$playerID))
baz <- do.call(rbind, lapply(bar, function(m){
  m[which.max(m$adj_fWAR), ]
}))
baz <- baz %>% arrange(adj_fWAR)
bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)

baz <- do.call(rbind, lapply(bar, function(m){
  m[which.max(m$adj_bWAR), ]
}))
baz <- baz %>% arrange(adj_bWAR)
bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
bad_players <- union(bad_players_bWAR, bad_players_fWAR)
pitchers <- pitchers[!pitchers$playerID %in% bad_players, ]


## build adjusted data set
pitchers_adjusted <- pitchers %>% dplyr::select(name, playerID, age, yearID, 
                                                mapped_IP, adj_ERA, adj_SO, adj_bWAR, adj_fWAR, full_time)
colnames(pitchers_adjusted) <- c("name", "playerID", "age", "year", "IP", 
                                 "adj_ERA", "adj_SO", "adj_bWAR", "adj_fWAR", "full_time")
pitchers_adjusted$playerID <- droplevels(as.factor(pitchers_adjusted$playerID))

## trim out bad players
# first round
foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
})
checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                      m_bad = unlist(lapply(bar, mean)),
                      len = unlist(lapply(bar, length)))
pitchers_adjusted <- pitchers_adjusted %>%
  filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)

# second round
foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
})
checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                      m_bad = unlist(lapply(bar, mean)),
                      len = unlist(lapply(bar, length)))
pitchers_adjusted <- pitchers_adjusted %>%
  filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)

# third round
foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
bar <- lapply(foo, function(m){
  min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
})
checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                      m_bad = unlist(lapply(bar, mean)),
                      len = unlist(lapply(bar, length)))
pitchers_adjusted <- pitchers_adjusted %>%
  filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)

# forth round
foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
})
checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                      m_bad = unlist(lapply(bar, mean)),
                      len = unlist(lapply(bar, length)))
pitchers_adjusted <- pitchers_adjusted %>%
  filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)


## remove tails 
foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= 0.41, 1, 0) + ifelse(m$adj_fWAR <= 0.4, 1, 0)
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                    ifelse(sum(tail(bad, 3)) >= 5,1,0),
                    ifelse(sum(tail(bad, 4)) >= 7,1,0),
                    ifelse(sum(tail(bad, 5)) >= 9,1,0),
                    ifelse(sum(tail(bad, 6)) >= 11,1,0)))
  1:(length(bad)-bad_tail)
})
pitchers_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

foo <- split(pitchers_adjusted_1, f = pitchers_adjusted_1$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                    ifelse(sum(tail(bad, 3)) >= 3,1,0),
                    ifelse(sum(tail(bad, 4)) >= 4,1,0),
                    ifelse(sum(tail(bad, 5)) >= 5,1,0),
                    ifelse(sum(tail(bad, 6)) >= 6,1,0)))
  1:(length(bad)-bad_tail)
})
pitchers_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

foo <- split(pitchers_adjusted_2, f = pitchers_adjusted_2$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                    ifelse(sum(tail(bad, 3)) >= 3,1,0),
                    ifelse(sum(tail(bad, 4)) >= 4,1,0),
                    ifelse(sum(tail(bad, 5)) >= 5,1,0),
                    ifelse(sum(tail(bad, 6)) >= 6,1,0)))
  1:(length(bad)-bad_tail)
})
pitchers_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

## remove starts
foo <- split(pitchers_adjusted_3, f = pitchers_adjusted_3$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
  bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                    ifelse(sum(head(bad, 2)) >= 3,1,0),
                    ifelse(sum(head(bad, 3)) >= 5,1,0),
                    ifelse(sum(head(bad, 4)) >= 7,1,0),
                    ifelse(sum(head(bad, 5)) >= 9,1,0),
                    ifelse(sum(head(bad, 6)) >= 11,1,0)))
  if (bad_head < length(bad)) {
    (bad_head + 1):length(bad)
  }
})
pitchers_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

pitchers_adjusted_4$playerID <- droplevels(pitchers_adjusted_4$playerID)

# taper down average WAR for players with small innings
pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_fWAR <- 
  round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_fWAR/9,2)
pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_bWAR <- 
  round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_bWAR/9,2)	
pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                      pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_fWAR <- 
  round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                              pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_fWAR/9, 2)
pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                      pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_bWAR <- 
  round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                              pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_bWAR/9, 2)


pitchers_adjusted <- do.call(rbind, mclapply(
  split(pitchers_adjusted_4, f = droplevels(as.factor(pitchers_adjusted_4$playerID))), 
  mc.cores = ncores, FUN = function(xx){
    ## natural cubic spline
    ns_ERA = lm(adj_ERA ~ ns(year, df=6), data=xx)
    nn_ERA <- predict(ns_ERA, data.frame("year"= xx$year))
    ns_SO = lm(adj_SO ~ ns(year, df=6), data=xx)
    nn_SO <- predict(ns_SO, data.frame("year"= xx$year))
    ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
    nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
    ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
    nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
    
    xx %>% mutate(ERA = round((adj_ERA + nn_ERA)/2, 3)) %>% 
      mutate(SO = round((adj_SO + nn_SO)/2)) %>%
      mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
      mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
  })) 

pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)
pitchers_adjusted <- pitchers_adjusted %>% 
  mutate(ER = round(ERA * IP / 9)) %>%
  mutate(ERA = round(ER / IP *9, 2)) %>% 
  mutate(ERA = ifelse(is.na(ERA), 0, ERA))

rownames(pitchers_adjusted) <- c()

pit_season <- pitchers_adjusted %>% 
  mutate(IP = ceiling(IP)) %>% 
  mutate(ERA = round(ER/IP*9, 2))
colnames(pit_season)[12] <- 'K'
pit_season[which(pit_season$K >= 1.5*pit_season$IP), ]$K <- 
  round(1.5*pit_season[which(pit_season$K >= 1.5*pit_season$IP), ]$IP)

pit_season <- pit_season %>% dplyr::select(-c(adj_bWAR, adj_fWAR, adj_ERA, adj_SO, full_time))

pit_career <- pit_season %>% group_by(playerID) %>% 
  summarise(name = unique(name), 
            playerID = unique(playerID), 
            IP = sum(IP), 
            ER = sum(ER), 
            ERA = round(ER/IP*9,2), 
            K = sum(K), 
            ebWAR = sum(ebWAR), 
            efWAR = sum(efWAR)) %>% 
  arrange(desc(ebWAR))
pre_int_historical_career_pit <- career_bWAR
pre_int_historical_career_trimmed_pit <- pit_career

```

```{r cache=TRUE, echo=FALSE}
pitchers_talent_bWAR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
  talent_computing_nonpara_fixed(dataset = pitchers_schell, component_name = "bWAR_p", year = yy, 
                                 ystar = thresh_fun(component = pitchers_schell %>% 
                                                      filter(full_time =='Y', yearID == yy) %>%
                                                      select(comp), component_name = 'bWAR_p'), alpha = 1.16)
})) %>% arrange(-WAR_talent)

no_strike <- pitchers_talent_bWAR %>% 
  filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
         full_time == 'Y', lgID == 'NL') %>%
  arrange(WAR_talent)

min_refbWAR <- -2

t <- isoreg(no_strike$WAR_talent, no_strike$comp)

talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,154)/154)
comp_new <- as.stepfun(t)(talent_new)

ystar <- thresh_fun(comp_new, component_name = 'bWAR_p')
pop_new <- round(mean(no_strike$pops))
component_name = 'bWAR_p'
yy <- sort(comp_new)
n <- length(yy)
ytilde <- rep(0, n + 1)
if (component_name == 'ERA') {
  ytilde[1] <- yy[1] - (yy[2] - yy[1])
}
if (component_name == 'bWAR_p'| component_name == 'fWAR_p') {
  ytilde[1] <- yy[1] - (yy[2] - yy[1])/10
}
if (component_name == 'SO') {
  ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
}
ytilde[n+1] <- yy[n] + ystar
ytilde[2:n] <- unlist(lapply(2:n, function(j){
  (yy[j]+yy[j-1])/2 
}))

career_kAB <- do.call(rbind, mclapply(1:nrow(pitchers_talent_bWAR), function(xx){
  int <- career_talent_nonpara(dataset = pitchers_talent_bWAR, component_name = 'bWAR_p', 
                               snippet = pitchers_talent_bWAR[xx,], alpha = 1.16)
  int
}, mc.cores = ncores)) 


mapped_pitchers_1 <- merge(career_kAB, mapped_quan_p, 
                           by = c('playerID', 'yearID'))

mapped_pitchers_bWAR <- mapped_pitchers_1 %>% 
  mutate(adj_bWAR = adj_comp * mapped_IP_raw) %>%
  mutate(adj_bWAR = ifelse(adj_bWAR < min_refbWAR, min_refbWAR, adj_bWAR)) %>%
  mutate(mapped_IP_bWAR = round(adj_bWAR / adj_comp))
career_bWAR <- mapped_pitchers_bWAR %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            mapped_IP = sum(mapped_IP_bWAR),
            adj_bWAR = sum(adj_bWAR))
master_pitchers_AB <- master_pitchers_trim %>% select(-adj_bWAR)
bWAR_part <- mapped_pitchers_bWAR %>% 
  mutate(adj_bWAR = round(adj_bWAR, 2)) %>% 
  select(yearID, playerID, adj_bWAR, mapped_IP_bWAR)
master_pitchers <- merge(master_pitchers_AB, bWAR_part, by = c('yearID', 'playerID'))
master_pitchers$mapped_IP <- apply(master_pitchers[,c(5,13)], 1, min)
master_pitchers <- master_pitchers %>% select(-mapped_IP_bWAR)

## Pitchers
pitchers <- master_pitchers %>% 
  mutate(adj_K9 = round(adj_SO/mapped_IP*9,1), 
         K9 = round(SO/IP*9,1), 
         adj_fWAR = round(adj_fWAR, 2))
pitchers <- as.data.frame(pitchers)
#pitchers$avg_ERA[pitchers$avg_ERA > 6.20] <- 6.20
#pitchers <- pitchers[pitchers$adj_bWAR != 0, ]

## extract and remove bad pitchers 
foo <- pitchers %>% 
  arrange(adj_ERA) %>% 
  filter(mapped_IP >= 100) %>% 
  dplyr::select(name, playerID, yearID, mapped_IP, adj_ERA, adj_SO, adj_fWAR, adj_bWAR)
bar <- split(foo, as.factor(foo$playerID))
baz <- do.call(rbind, lapply(bar, function(m){
  m[which.max(m$adj_fWAR), ]
}))
baz <- baz %>% arrange(adj_fWAR)
bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)

baz <- do.call(rbind, lapply(bar, function(m){
  m[which.max(m$adj_bWAR), ]
}))
baz <- baz %>% arrange(adj_bWAR)
bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
bad_players <- union(bad_players_bWAR, bad_players_fWAR)
pitchers <- pitchers[!pitchers$playerID %in% bad_players, ]


## build adjusted data set
pitchers_adjusted <- pitchers %>% dplyr::select(name, playerID, age, yearID, 
                                                mapped_IP, adj_ERA, adj_SO, adj_bWAR, adj_fWAR, full_time)
colnames(pitchers_adjusted) <- c("name", "playerID", "age", "year", "IP", 
                                 "adj_ERA", "adj_SO", "adj_bWAR", "adj_fWAR", "full_time")
pitchers_adjusted$playerID <- droplevels(as.factor(pitchers_adjusted$playerID))

## trim out bad players
# first round
foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
})
checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                      m_bad = unlist(lapply(bar, mean)),
                      len = unlist(lapply(bar, length)))
pitchers_adjusted <- pitchers_adjusted %>%
  filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)

# second round
foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
})
checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                      m_bad = unlist(lapply(bar, mean)),
                      len = unlist(lapply(bar, length)))
pitchers_adjusted <- pitchers_adjusted %>%
  filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)

# third round
foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
bar <- lapply(foo, function(m){
  min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
})
checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                      m_bad = unlist(lapply(bar, mean)),
                      len = unlist(lapply(bar, length)))
pitchers_adjusted <- pitchers_adjusted %>%
  filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)

# forth round
foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
})
checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                      m_bad = unlist(lapply(bar, mean)),
                      len = unlist(lapply(bar, length)))
pitchers_adjusted <- pitchers_adjusted %>%
  filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)


## remove tails 
foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= 0.41, 1, 0) + ifelse(m$adj_fWAR <= 0.4, 1, 0)
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                    ifelse(sum(tail(bad, 3)) >= 5,1,0),
                    ifelse(sum(tail(bad, 4)) >= 7,1,0),
                    ifelse(sum(tail(bad, 5)) >= 9,1,0),
                    ifelse(sum(tail(bad, 6)) >= 11,1,0)))
  1:(length(bad)-bad_tail)
})
pitchers_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

foo <- split(pitchers_adjusted_1, f = pitchers_adjusted_1$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                    ifelse(sum(tail(bad, 3)) >= 3,1,0),
                    ifelse(sum(tail(bad, 4)) >= 4,1,0),
                    ifelse(sum(tail(bad, 5)) >= 5,1,0),
                    ifelse(sum(tail(bad, 6)) >= 6,1,0)))
  1:(length(bad)-bad_tail)
})
pitchers_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

foo <- split(pitchers_adjusted_2, f = pitchers_adjusted_2$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                    ifelse(sum(tail(bad, 3)) >= 3,1,0),
                    ifelse(sum(tail(bad, 4)) >= 4,1,0),
                    ifelse(sum(tail(bad, 5)) >= 5,1,0),
                    ifelse(sum(tail(bad, 6)) >= 6,1,0)))
  1:(length(bad)-bad_tail)
})
pitchers_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

## remove starts
foo <- split(pitchers_adjusted_3, f = pitchers_adjusted_3$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
  bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                    ifelse(sum(head(bad, 2)) >= 3,1,0),
                    ifelse(sum(head(bad, 3)) >= 5,1,0),
                    ifelse(sum(head(bad, 4)) >= 7,1,0),
                    ifelse(sum(head(bad, 5)) >= 9,1,0),
                    ifelse(sum(head(bad, 6)) >= 11,1,0)))
  if (bad_head < length(bad)) {
    (bad_head + 1):length(bad)
  }
})
pitchers_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

pitchers_adjusted_4$playerID <- droplevels(pitchers_adjusted_4$playerID)

# taper down average WAR for players with small innings
pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_fWAR <- 
  round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_fWAR/9,2)
pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_bWAR <- 
  round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_bWAR/9,2)	
pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                      pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_fWAR <- 
  round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                              pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_fWAR/9, 2)
pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                      pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_bWAR <- 
  round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                              pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_bWAR/9, 2)


pitchers_adjusted <- do.call(rbind, mclapply(
  split(pitchers_adjusted_4, f = droplevels(as.factor(pitchers_adjusted_4$playerID))), 
  mc.cores = ncores, FUN = function(xx){
    ## natural cubic spline
    ns_ERA = lm(adj_ERA ~ ns(year, df=6), data=xx)
    nn_ERA <- predict(ns_ERA, data.frame("year"= xx$year))
    ns_SO = lm(adj_SO ~ ns(year, df=6), data=xx)
    nn_SO <- predict(ns_SO, data.frame("year"= xx$year))
    ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
    nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
    ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
    nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
    
    xx %>% mutate(ERA = round((adj_ERA + nn_ERA)/2, 3)) %>% 
      mutate(SO = round((adj_SO + nn_SO)/2)) %>%
      mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
      mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
  })) 

pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)
pitchers_adjusted <- pitchers_adjusted %>% 
  mutate(ER = round(ERA * IP / 9)) %>%
  mutate(ERA = round(ER / IP *9, 2)) %>% 
  mutate(ERA = ifelse(is.na(ERA), 0, ERA))

rownames(pitchers_adjusted) <- c()

pit_season <- pitchers_adjusted %>% 
  mutate(IP = ceiling(IP)) %>% 
  mutate(ERA = round(ER/IP*9, 2))
colnames(pit_season)[12] <- 'K'
pit_season[which(pit_season$K >= 1.5*pit_season$IP), ]$K <- 
  round(1.5*pit_season[which(pit_season$K >= 1.5*pit_season$IP), ]$IP)

pit_season <- pit_season %>% dplyr::select(-c(adj_bWAR, adj_fWAR, adj_ERA, adj_SO, full_time))

pit_career <- pit_season %>% group_by(playerID) %>% 
  summarise(name = unique(name), 
            playerID = unique(playerID), 
            IP = sum(IP), 
            ER = sum(ER), 
            ERA = round(ER/IP*9,2), 
            K = sum(K), 
            ebWAR = sum(ebWAR), 
            efWAR = sum(efWAR)) %>% 
  arrange(desc(ebWAR))
pre_int_fixed_career_pit <- career_bWAR
pre_int_fixed_career_trimmed_pit <- pit_career

```

```{r cache=TRUE, echo=FALSE}
foo <- getRetrosheet(type = "game", year = 2022)
rotation_bound <- as.data.frame(cbind(years, unlist(mclapply(years, mc.cores = ncores, function(yr){
  foo <- getRetrosheet(type = "game", year = yr)
  Tms <- unique(foo$HmTm)
  
  starter <- lapply(Tms, function(tm){
    bar <- foo %>% filter(VisTm == tm | HmTm == tm) %>% 
      select(VisTm, HmTm, VisStPchID, HmStPchID, VisTmGNum, HmTmGNum)
    t(apply(bar, 1, function(xx){
      y <- NULL
      if(xx[2] == tm){
        y <- xx[4]
      }
      else{
        y <- xx[3]
      }
    })) 
  })
  
  y <- unlist(lapply(starter, function(xx){
    unlist(lapply(1:length(xx), function(j){
      flag <- TRUE
      k <- 1
      if(j > 1){
        while(flag){
          flag <- length(xx[(j-k):j]) == length(unique(xx[(j-k):j]))
          if(!flag){
            break
          }
          else{
            k <- k + 1
          }
          if(k == j){
            break
          }
        }
      }
      k
    }))
  }))
  mean(y)
  
}))))
```

```{r cache=TRUE, echo=FALSE}
pitchers <- pit_dat %>% 
  select(playerID, yearID, name, age, lgID, teamID, IP, pops, bWAR)
pitchers <- pitchers %>% mutate(comp = bWAR / IP)
pitchers$comp[is.na(pitchers$comp)] = 0

rotation_bound <- as.data.frame(cbind(years, unlist(mclapply(years, mc.cores = ncores, function(yr){
  foo <- getRetrosheet(type = "game", year = yr)
  Tms <- unique(foo$HmTm)
  
  starter <- lapply(Tms, function(tm){
    bar <- foo %>% filter(VisTm == tm | HmTm == tm) %>% 
      select(VisTm, HmTm, VisStPchID, HmStPchID, VisTmGNum, HmTmGNum)
    t(apply(bar, 1, function(xx){
      y <- NULL
      if(xx[2] == tm){
        y <- xx[4]
      }
      else{
        y <- xx[3]
      }
    })) 
  })
  
  y <- unlist(lapply(starter, function(xx){
    unlist(lapply(1:length(xx), function(j){
      flag <- TRUE
      k <- 1
      if(j > 1){
        while(flag){
          flag <- length(xx[(j-k):j]) == length(unique(xx[(j-k):j]))
          if(!flag){
            break
          }
          else{
            k <- k + 1
          }
          if(k == j){
            break
          }
        }
      }
      k
    }))
  }))
  mean(y)
  
}))))

unique_team <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
  c(xx, nrow(unique(pitchers %>% filter(yearID == xx) %>% select(teamID))))
}))

rotation_player <- data.frame(yearID = years, rotation = ceiling(rotation_bound[,2] * unique_team[,2]))

cutoff <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
  m <- pitchers %>% filter(yearID == xx) %>% arrange(-IP)
  index <- rotation_player$rotation[rotation_player$yearID == xx]
  data.frame(thres = (m$IP[index]), yearID = xx)
}))

pitchers <- merge(pitchers, cutoff, by = 'yearID')

pitchers <- pitchers %>% mutate(full_time = ifelse(IP >= thres, 'Y', 'N'))

pitchers_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
  int<- pitchers %>% filter(yearID == xx)
  lg_avg <- sum(int$bWAR)/sum(int$IP)
  int %>% mutate(comp = (bWAR + lg_avg * 14)/(IP + 14))
}))
pitchers_schell <- pitchers_schell %>% 
  select(-pops) %>% 
  left_join(MLBpops_econ_effect %>% 
              select(year, NL_pop, AL_pop), by = c('yearID' = 'year')) %>% 
  mutate(pops = ifelse(lgID == "NL",NL_pop,AL_pop))

```

```{r cache=TRUE, echo=FALSE}
pitchers_talent_bWAR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
  talent_computing_nonpara(dataset = pitchers_schell, component_name = "bWAR_p", year = yy, 
                           ystar = thresh_fun(component = pitchers_schell %>% 
                                                filter(full_time =='Y', yearID == yy) %>%
                                                select(comp), component_name = 'bWAR_p'), alpha = 1.16)
})) %>% arrange(-WAR_talent)

no_strike <- pitchers_talent_bWAR %>% 
  filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
         full_time == 'Y', lgID == 'NL') %>%
  arrange(WAR_talent)

min_refbWAR <- -2

t <- isoreg(no_strike$WAR_talent, no_strike$comp)

talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,154)/154)
comp_new <- as.stepfun(t)(talent_new)

ystar <- thresh_fun(comp_new, component_name = 'bWAR_p')
pop_new <- round(mean(no_strike$pops))
component_name = 'bWAR_p'
yy <- sort(comp_new)
n <- length(yy)
ytilde <- rep(0, n + 1)
if (component_name == 'ERA') {
  ytilde[1] <- yy[1] - (yy[2] - yy[1])
}
if (component_name == 'bWAR_p'| component_name == 'fWAR_p') {
  ytilde[1] <- yy[1] - (yy[2] - yy[1])/10
}
if (component_name == 'SO') {
  ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
}
ytilde[n+1] <- yy[n] + ystar
ytilde[2:n] <- unlist(lapply(2:n, function(j){
  (yy[j]+yy[j-1])/2 
}))

career_kAB <- do.call(rbind, mclapply(1:nrow(pitchers_talent_bWAR), function(xx){
  int <- career_talent_nonpara(dataset = pitchers_talent_bWAR, component_name = 'bWAR_p', 
                               snippet = pitchers_talent_bWAR[xx,], alpha = 1.16)
  int
}, mc.cores = ncores)) 


mapped_pitchers_1 <- merge(career_kAB, mapped_quan_p, 
                           by = c('playerID', 'yearID'))

mapped_pitchers_bWAR <- mapped_pitchers_1 %>% 
  mutate(adj_bWAR = adj_comp * mapped_IP_raw) %>%
  mutate(adj_bWAR = ifelse(adj_bWAR < min_refbWAR, min_refbWAR, adj_bWAR)) %>%
  mutate(mapped_IP_bWAR = round(adj_bWAR / adj_comp))
career_bWAR <- mapped_pitchers_bWAR %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            mapped_IP = sum(mapped_IP_bWAR),
            adj_bWAR = sum(adj_bWAR))
master_pitchers_AB <- master_pitchers_trim %>% select(-adj_bWAR)
bWAR_part <- mapped_pitchers_bWAR %>% 
  mutate(adj_bWAR = round(adj_bWAR, 2)) %>% 
  select(yearID, playerID, adj_bWAR, mapped_IP_bWAR)
master_pitchers <- merge(master_pitchers_AB, bWAR_part, by = c('yearID', 'playerID'))
master_pitchers$mapped_IP <- apply(master_pitchers[,c(5,13)], 1, min)
master_pitchers <- master_pitchers %>% select(-mapped_IP_bWAR)

## Pitchers
pitchers <- master_pitchers %>% 
  mutate(adj_K9 = round(adj_SO/mapped_IP*9,1), 
         K9 = round(SO/IP*9,1), 
         adj_fWAR = round(adj_fWAR, 2))
pitchers <- as.data.frame(pitchers)
#pitchers$avg_ERA[pitchers$avg_ERA > 6.20] <- 6.20
#pitchers <- pitchers[pitchers$adj_bWAR != 0, ]

## extract and remove bad pitchers 
foo <- pitchers %>% 
  arrange(adj_ERA) %>% 
  filter(mapped_IP >= 100) %>% 
  dplyr::select(name, playerID, yearID, mapped_IP, adj_ERA, adj_SO, adj_fWAR, adj_bWAR)
bar <- split(foo, as.factor(foo$playerID))
baz <- do.call(rbind, lapply(bar, function(m){
  m[which.max(m$adj_fWAR), ]
}))
baz <- baz %>% arrange(adj_fWAR)
bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)

baz <- do.call(rbind, lapply(bar, function(m){
  m[which.max(m$adj_bWAR), ]
}))
baz <- baz %>% arrange(adj_bWAR)
bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
bad_players <- union(bad_players_bWAR, bad_players_fWAR)
pitchers <- pitchers[!pitchers$playerID %in% bad_players, ]


## build adjusted data set
pitchers_adjusted <- pitchers %>% dplyr::select(name, playerID, age, yearID, 
                                                mapped_IP, adj_ERA, adj_SO, adj_bWAR, adj_fWAR, full_time)
colnames(pitchers_adjusted) <- c("name", "playerID", "age", "year", "IP", 
                                 "adj_ERA", "adj_SO", "adj_bWAR", "adj_fWAR", "full_time")
pitchers_adjusted$playerID <- droplevels(as.factor(pitchers_adjusted$playerID))

## trim out bad players
# first round
foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
})
checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                      m_bad = unlist(lapply(bar, mean)),
                      len = unlist(lapply(bar, length)))
pitchers_adjusted <- pitchers_adjusted %>%
  filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)

# second round
foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
})
checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                      m_bad = unlist(lapply(bar, mean)),
                      len = unlist(lapply(bar, length)))
pitchers_adjusted <- pitchers_adjusted %>%
  filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)

# third round
foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
bar <- lapply(foo, function(m){
  min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
})
checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                      m_bad = unlist(lapply(bar, mean)),
                      len = unlist(lapply(bar, length)))
pitchers_adjusted <- pitchers_adjusted %>%
  filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)

# forth round
foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
})
checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                      m_bad = unlist(lapply(bar, mean)),
                      len = unlist(lapply(bar, length)))
pitchers_adjusted <- pitchers_adjusted %>%
  filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)


## remove tails 
foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= 0.41, 1, 0) + ifelse(m$adj_fWAR <= 0.4, 1, 0)
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                    ifelse(sum(tail(bad, 3)) >= 5,1,0),
                    ifelse(sum(tail(bad, 4)) >= 7,1,0),
                    ifelse(sum(tail(bad, 5)) >= 9,1,0),
                    ifelse(sum(tail(bad, 6)) >= 11,1,0)))
  1:(length(bad)-bad_tail)
})
pitchers_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

foo <- split(pitchers_adjusted_1, f = pitchers_adjusted_1$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                    ifelse(sum(tail(bad, 3)) >= 3,1,0),
                    ifelse(sum(tail(bad, 4)) >= 4,1,0),
                    ifelse(sum(tail(bad, 5)) >= 5,1,0),
                    ifelse(sum(tail(bad, 6)) >= 6,1,0)))
  1:(length(bad)-bad_tail)
})
pitchers_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

foo <- split(pitchers_adjusted_2, f = pitchers_adjusted_2$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                    ifelse(sum(tail(bad, 3)) >= 3,1,0),
                    ifelse(sum(tail(bad, 4)) >= 4,1,0),
                    ifelse(sum(tail(bad, 5)) >= 5,1,0),
                    ifelse(sum(tail(bad, 6)) >= 6,1,0)))
  1:(length(bad)-bad_tail)
})
pitchers_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

## remove starts
foo <- split(pitchers_adjusted_3, f = pitchers_adjusted_3$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
  bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                    ifelse(sum(head(bad, 2)) >= 3,1,0),
                    ifelse(sum(head(bad, 3)) >= 5,1,0),
                    ifelse(sum(head(bad, 4)) >= 7,1,0),
                    ifelse(sum(head(bad, 5)) >= 9,1,0),
                    ifelse(sum(head(bad, 6)) >= 11,1,0)))
  if (bad_head < length(bad)) {
    (bad_head + 1):length(bad)
  }
})
pitchers_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

pitchers_adjusted_4$playerID <- droplevels(pitchers_adjusted_4$playerID)

# taper down average WAR for players with small innings
pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_fWAR <- 
  round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_fWAR/9,2)
pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_bWAR <- 
  round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_bWAR/9,2)	
pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                      pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_fWAR <- 
  round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                              pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_fWAR/9, 2)
pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                      pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_bWAR <- 
  round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                              pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_bWAR/9, 2)


pitchers_adjusted <- do.call(rbind, mclapply(
  split(pitchers_adjusted_4, f = droplevels(as.factor(pitchers_adjusted_4$playerID))), 
  mc.cores = ncores, FUN = function(xx){
    ## natural cubic spline
    ns_ERA = lm(adj_ERA ~ ns(year, df=6), data=xx)
    nn_ERA <- predict(ns_ERA, data.frame("year"= xx$year))
    ns_SO = lm(adj_SO ~ ns(year, df=6), data=xx)
    nn_SO <- predict(ns_SO, data.frame("year"= xx$year))
    ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
    nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
    ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
    nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
    
    xx %>% mutate(ERA = round((adj_ERA + nn_ERA)/2, 3)) %>% 
      mutate(SO = round((adj_SO + nn_SO)/2)) %>%
      mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
      mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
  })) 

pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)
pitchers_adjusted <- pitchers_adjusted %>% 
  mutate(ER = round(ERA * IP / 9)) %>%
  mutate(ERA = round(ER / IP *9, 2)) %>% 
  mutate(ERA = ifelse(is.na(ERA), 0, ERA))

rownames(pitchers_adjusted) <- c()

pit_season <- pitchers_adjusted %>% 
  mutate(IP = ceiling(IP)) %>% 
  mutate(ERA = round(ER/IP*9, 2))
colnames(pit_season)[12] <- 'K'
pit_season[which(pit_season$K >= 1.5*pit_season$IP), ]$K <- 
  round(1.5*pit_season[which(pit_season$K >= 1.5*pit_season$IP), ]$IP)

pit_season <- pit_season %>% dplyr::select(-c(adj_bWAR, adj_fWAR, adj_ERA, adj_SO, full_time))

pit_career <- pit_season %>% group_by(playerID) %>% 
  summarise(name = unique(name), 
            playerID = unique(playerID), 
            IP = sum(IP), 
            ER = sum(ER), 
            ERA = round(ER/IP*9,2), 
            K = sum(K), 
            ebWAR = sum(ebWAR), 
            efWAR = sum(efWAR)) %>% 
  arrange(desc(ebWAR))
econ_effect_historical_career_pit <- career_bWAR
econ_effect_historical_career_trimmed_pit <- pit_career

```

```{r cache=TRUE, echo=FALSE}
pitchers_talent_bWAR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
  talent_computing_nonpara_fixed(dataset = pitchers_schell, component_name = "bWAR_p", year = yy, 
                                 ystar = thresh_fun(component = pitchers_schell %>% 
                                                      filter(full_time =='Y', yearID == yy) %>%
                                                      select(comp), component_name = 'bWAR_p'), alpha = 1.16)
})) %>% arrange(-WAR_talent)

no_strike <- pitchers_talent_bWAR %>% 
  filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
         full_time == 'Y', lgID == 'NL') %>%
  arrange(WAR_talent)

min_refbWAR <- -2

t <- isoreg(no_strike$WAR_talent, no_strike$comp)

talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,154)/154)
comp_new <- as.stepfun(t)(talent_new)

ystar <- thresh_fun(comp_new, component_name = 'bWAR_p')
pop_new <- round(mean(no_strike$pops))
component_name = 'bWAR_p'
yy <- sort(comp_new)
n <- length(yy)
ytilde <- rep(0, n + 1)
if (component_name == 'ERA') {
  ytilde[1] <- yy[1] - (yy[2] - yy[1])
}
if (component_name == 'bWAR_p'| component_name == 'fWAR_p') {
  ytilde[1] <- yy[1] - (yy[2] - yy[1])/10
}
if (component_name == 'SO') {
  ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
}
ytilde[n+1] <- yy[n] + ystar
ytilde[2:n] <- unlist(lapply(2:n, function(j){
  (yy[j]+yy[j-1])/2 
}))

career_kAB <- do.call(rbind, mclapply(1:nrow(pitchers_talent_bWAR), function(xx){
  int <- career_talent_nonpara(dataset = pitchers_talent_bWAR, component_name = 'bWAR_p', 
                               snippet = pitchers_talent_bWAR[xx,], alpha = 1.16)
  int
}, mc.cores = ncores)) 

mapped_pitchers_1 <- merge(career_kAB, mapped_quan_p, 
                           by = c('playerID', 'yearID'))

mapped_pitchers_bWAR <- mapped_pitchers_1 %>% 
  mutate(adj_bWAR = adj_comp * mapped_IP_raw) %>%
  mutate(adj_bWAR = ifelse(adj_bWAR < min_refbWAR, min_refbWAR, adj_bWAR)) %>%
  mutate(mapped_IP_bWAR = round(adj_bWAR / adj_comp))
career_bWAR <- mapped_pitchers_bWAR %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            mapped_IP = sum(mapped_IP_bWAR),
            adj_bWAR = sum(adj_bWAR))
master_pitchers_AB <- master_pitchers_trim %>% select(-adj_bWAR)
bWAR_part <- mapped_pitchers_bWAR %>% 
  mutate(adj_bWAR = round(adj_bWAR, 2)) %>% 
  select(yearID, playerID, adj_bWAR, mapped_IP_bWAR)
master_pitchers <- merge(master_pitchers_AB, bWAR_part, by = c('yearID', 'playerID'))
master_pitchers$mapped_IP <- apply(master_pitchers[,c(5,13)], 1, min)
master_pitchers <- master_pitchers %>% select(-mapped_IP_bWAR)

## Pitchers
pitchers <- master_pitchers %>% 
  mutate(adj_K9 = round(adj_SO/mapped_IP*9,1), 
         K9 = round(SO/IP*9,1), 
         adj_fWAR = round(adj_fWAR, 2))
pitchers <- as.data.frame(pitchers)
#pitchers$avg_ERA[pitchers$avg_ERA > 6.20] <- 6.20
#pitchers <- pitchers[pitchers$adj_bWAR != 0, ]

## extract and remove bad pitchers 
foo <- pitchers %>% 
  arrange(adj_ERA) %>% 
  filter(mapped_IP >= 100) %>% 
  dplyr::select(name, playerID, yearID, mapped_IP, adj_ERA, adj_SO, adj_fWAR, adj_bWAR)
bar <- split(foo, as.factor(foo$playerID))
baz <- do.call(rbind, lapply(bar, function(m){
  m[which.max(m$adj_fWAR), ]
}))
baz <- baz %>% arrange(adj_fWAR)
bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)

baz <- do.call(rbind, lapply(bar, function(m){
  m[which.max(m$adj_bWAR), ]
}))
baz <- baz %>% arrange(adj_bWAR)
bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
bad_players <- union(bad_players_bWAR, bad_players_fWAR)
pitchers <- pitchers[!pitchers$playerID %in% bad_players, ]


## build adjusted data set
pitchers_adjusted <- pitchers %>% dplyr::select(name, playerID, age, yearID, 
                                                mapped_IP, adj_ERA, adj_SO, adj_bWAR, adj_fWAR, full_time)
colnames(pitchers_adjusted) <- c("name", "playerID", "age", "year", "IP", 
                                 "adj_ERA", "adj_SO", "adj_bWAR", "adj_fWAR", "full_time")
pitchers_adjusted$playerID <- droplevels(as.factor(pitchers_adjusted$playerID))

## trim out bad players
# first round
foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
})
checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                      m_bad = unlist(lapply(bar, mean)),
                      len = unlist(lapply(bar, length)))
pitchers_adjusted <- pitchers_adjusted %>%
  filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)

# second round
foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
})
checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                      m_bad = unlist(lapply(bar, mean)),
                      len = unlist(lapply(bar, length)))
pitchers_adjusted <- pitchers_adjusted %>%
  filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)

# third round
foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
bar <- lapply(foo, function(m){
  min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
})
checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                      m_bad = unlist(lapply(bar, mean)),
                      len = unlist(lapply(bar, length)))
pitchers_adjusted <- pitchers_adjusted %>%
  filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)

# forth round
foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
})
checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                      m_bad = unlist(lapply(bar, mean)),
                      len = unlist(lapply(bar, length)))
pitchers_adjusted <- pitchers_adjusted %>%
  filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)


## remove tails 
foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= 0.41, 1, 0) + ifelse(m$adj_fWAR <= 0.4, 1, 0)
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                    ifelse(sum(tail(bad, 3)) >= 5,1,0),
                    ifelse(sum(tail(bad, 4)) >= 7,1,0),
                    ifelse(sum(tail(bad, 5)) >= 9,1,0),
                    ifelse(sum(tail(bad, 6)) >= 11,1,0)))
  1:(length(bad)-bad_tail)
})
pitchers_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

foo <- split(pitchers_adjusted_1, f = pitchers_adjusted_1$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                    ifelse(sum(tail(bad, 3)) >= 3,1,0),
                    ifelse(sum(tail(bad, 4)) >= 4,1,0),
                    ifelse(sum(tail(bad, 5)) >= 5,1,0),
                    ifelse(sum(tail(bad, 6)) >= 6,1,0)))
  1:(length(bad)-bad_tail)
})
pitchers_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

foo <- split(pitchers_adjusted_2, f = pitchers_adjusted_2$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                    ifelse(sum(tail(bad, 3)) >= 3,1,0),
                    ifelse(sum(tail(bad, 4)) >= 4,1,0),
                    ifelse(sum(tail(bad, 5)) >= 5,1,0),
                    ifelse(sum(tail(bad, 6)) >= 6,1,0)))
  1:(length(bad)-bad_tail)
})
pitchers_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

## remove starts
foo <- split(pitchers_adjusted_3, f = pitchers_adjusted_3$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
  bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                    ifelse(sum(head(bad, 2)) >= 3,1,0),
                    ifelse(sum(head(bad, 3)) >= 5,1,0),
                    ifelse(sum(head(bad, 4)) >= 7,1,0),
                    ifelse(sum(head(bad, 5)) >= 9,1,0),
                    ifelse(sum(head(bad, 6)) >= 11,1,0)))
  if (bad_head < length(bad)) {
    (bad_head + 1):length(bad)
  }
})
pitchers_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

pitchers_adjusted_4$playerID <- droplevels(pitchers_adjusted_4$playerID)

# taper down average WAR for players with small innings
pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_fWAR <- 
  round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_fWAR/9,2)
pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_bWAR <- 
  round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_bWAR/9,2)	
pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                      pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_fWAR <- 
  round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                              pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_fWAR/9, 2)
pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                      pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_bWAR <- 
  round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                              pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_bWAR/9, 2)


pitchers_adjusted <- do.call(rbind, mclapply(
  split(pitchers_adjusted_4, f = droplevels(as.factor(pitchers_adjusted_4$playerID))), 
  mc.cores = ncores, FUN = function(xx){
    ## natural cubic spline
    ns_ERA = lm(adj_ERA ~ ns(year, df=6), data=xx)
    nn_ERA <- predict(ns_ERA, data.frame("year"= xx$year))
    ns_SO = lm(adj_SO ~ ns(year, df=6), data=xx)
    nn_SO <- predict(ns_SO, data.frame("year"= xx$year))
    ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
    nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
    ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
    nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
    
    xx %>% mutate(ERA = round((adj_ERA + nn_ERA)/2, 3)) %>% 
      mutate(SO = round((adj_SO + nn_SO)/2)) %>%
      mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
      mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
  })) 

pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)
pitchers_adjusted <- pitchers_adjusted %>% 
  mutate(ER = round(ERA * IP / 9)) %>%
  mutate(ERA = round(ER / IP *9, 2)) %>% 
  mutate(ERA = ifelse(is.na(ERA), 0, ERA))

rownames(pitchers_adjusted) <- c()

pit_season <- pitchers_adjusted %>% 
  mutate(IP = ceiling(IP)) %>% 
  mutate(ERA = round(ER/IP*9, 2))
colnames(pit_season)[12] <- 'K'
pit_season[which(pit_season$K >= 1.5*pit_season$IP), ]$K <- 
  round(1.5*pit_season[which(pit_season$K >= 1.5*pit_season$IP), ]$IP)

pit_season <- pit_season %>% dplyr::select(-c(adj_bWAR, adj_fWAR, adj_ERA, adj_SO, full_time))

pit_career <- pit_season %>% group_by(playerID) %>% 
  summarise(name = unique(name), 
            playerID = unique(playerID), 
            IP = sum(IP), 
            ER = sum(ER), 
            ERA = round(ER/IP*9,2), 
            K = sum(K), 
            ebWAR = sum(ebWAR), 
            efWAR = sum(efWAR)) %>% 
  arrange(desc(ebWAR))
econ_effect_fixed_career_pit <- career_bWAR
econ_effect_fixed_career_trimmed_pit <- pit_career

```

```{r cache=TRUE, echo=FALSE}
foo <- getRetrosheet(type = "game", year = 2022)
rotation_bound <- as.data.frame(cbind(years, unlist(mclapply(years, mc.cores = ncores, function(yr){
  foo <- getRetrosheet(type = "game", year = yr)
  Tms <- unique(foo$HmTm)
  
  starter <- lapply(Tms, function(tm){
    bar <- foo %>% filter(VisTm == tm | HmTm == tm) %>% 
      select(VisTm, HmTm, VisStPchID, HmStPchID, VisTmGNum, HmTmGNum)
    t(apply(bar, 1, function(xx){
      y <- NULL
      if(xx[2] == tm){
        y <- xx[4]
      }
      else{
        y <- xx[3]
      }
    })) 
  })
  
  y <- unlist(lapply(starter, function(xx){
    unlist(lapply(1:length(xx), function(j){
      flag <- TRUE
      k <- 1
      if(j > 1){
        while(flag){
          flag <- length(xx[(j-k):j]) == length(unique(xx[(j-k):j]))
          if(!flag){
            break
          }
          else{
            k <- k + 1
          }
          if(k == j){
            break
          }
        }
      }
      k
    }))
  }))
  mean(y)
  
}))))
```

```{r cache=TRUE, echo=FALSE}
pitchers <- pit_dat %>% 
  select(playerID, yearID, name, age, lgID, teamID, IP, pops, bWAR)
pitchers <- pitchers %>% mutate(comp = bWAR / IP)
pitchers$comp[is.na(pitchers$comp)] = 0

rotation_bound <- as.data.frame(cbind(years, unlist(mclapply(years, mc.cores = ncores, function(yr){
  foo <- getRetrosheet(type = "game", year = yr)
  Tms <- unique(foo$HmTm)
  
  starter <- lapply(Tms, function(tm){
    bar <- foo %>% filter(VisTm == tm | HmTm == tm) %>% 
      select(VisTm, HmTm, VisStPchID, HmStPchID, VisTmGNum, HmTmGNum)
    t(apply(bar, 1, function(xx){
      y <- NULL
      if(xx[2] == tm){
        y <- xx[4]
      }
      else{
        y <- xx[3]
      }
    })) 
  })
  
  y <- unlist(lapply(starter, function(xx){
    unlist(lapply(1:length(xx), function(j){
      flag <- TRUE
      k <- 1
      if(j > 1){
        while(flag){
          flag <- length(xx[(j-k):j]) == length(unique(xx[(j-k):j]))
          if(!flag){
            break
          }
          else{
            k <- k + 1
          }
          if(k == j){
            break
          }
        }
      }
      k
    }))
  }))
  mean(y)
  
}))))

unique_team <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
  c(xx, nrow(unique(pitchers %>% filter(yearID == xx) %>% select(teamID))))
}))

rotation_player <- data.frame(yearID = years, rotation = ceiling(rotation_bound[,2] * unique_team[,2]))

cutoff <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
  m <- pitchers %>% filter(yearID == xx) %>% arrange(-IP)
  index <- rotation_player$rotation[rotation_player$yearID == xx]
  data.frame(thres = (m$IP[index]), yearID = xx)
}))

pitchers <- merge(pitchers, cutoff, by = 'yearID')

pitchers <- pitchers %>% mutate(full_time = ifelse(IP >= thres, 'Y', 'N'))

pitchers_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
  int<- pitchers %>% filter(yearID == xx)
  lg_avg <- sum(int$bWAR)/sum(int$IP)
  int %>% mutate(comp = (bWAR + lg_avg * 14)/(IP + 14))
}))
pitchers_schell <- pitchers_schell %>% 
  select(-pops) %>% 
  left_join(MLBpops %>% 
              select(year, NL_pop, AL_pop), by = c('yearID' = 'year')) %>% 
  mutate(pops = ifelse(lgID == "NL",NL_pop,AL_pop))

```

```{r cache=TRUE, echo=FALSE}
pitchers_talent_bWAR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
  talent_computing_nonpara(dataset = pitchers_schell, component_name = "bWAR_p", year = yy, 
                           ystar = thresh_fun(component = pitchers_schell %>% 
                                                filter(full_time =='Y', yearID == yy) %>%
                                                select(comp), component_name = 'bWAR_p'), alpha = 1.16)
})) %>% arrange(-WAR_talent)

no_strike <- pitchers_talent_bWAR %>% 
  filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
         full_time == 'Y', lgID == 'NL') %>%
  arrange(WAR_talent)

min_refbWAR <- -2

t <- isoreg(no_strike$WAR_talent, no_strike$comp)

talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,154)/154)
comp_new <- as.stepfun(t)(talent_new)

ystar <- thresh_fun(comp_new, component_name = 'bWAR_p')
pop_new <- round(mean(no_strike$pops))
component_name = 'bWAR_p'
yy <- sort(comp_new)
n <- length(yy)
ytilde <- rep(0, n + 1)
if (component_name == 'ERA') {
  ytilde[1] <- yy[1] - (yy[2] - yy[1])
}
if (component_name == 'bWAR_p'| component_name == 'fWAR_p') {
  ytilde[1] <- yy[1] - (yy[2] - yy[1])/10
}
if (component_name == 'SO') {
  ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
}
ytilde[n+1] <- yy[n] + ystar
ytilde[2:n] <- unlist(lapply(2:n, function(j){
  (yy[j]+yy[j-1])/2 
}))

career_kAB <- do.call(rbind, mclapply(1:nrow(pitchers_talent_bWAR), function(xx){
  int <- career_talent_nonpara(dataset = pitchers_talent_bWAR, component_name = 'bWAR_p', 
                               snippet = pitchers_talent_bWAR[xx,], alpha = 1.16)
  int
}, mc.cores = ncores)) 

mapped_pitchers_1 <- merge(career_kAB, mapped_quan_p, 
                           by = c('playerID', 'yearID'))

mapped_pitchers_bWAR <- mapped_pitchers_1 %>% 
  mutate(adj_bWAR = adj_comp * mapped_IP_raw) %>%
  mutate(adj_bWAR = ifelse(adj_bWAR < min_refbWAR, min_refbWAR, adj_bWAR)) %>%
  mutate(mapped_IP_bWAR = round(adj_bWAR / adj_comp))
career_bWAR <- mapped_pitchers_bWAR %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            mapped_IP = sum(mapped_IP_bWAR),
            adj_bWAR = sum(adj_bWAR))
master_pitchers_AB <- master_pitchers_trim %>% select(-adj_bWAR)
bWAR_part <- mapped_pitchers_bWAR %>% 
  mutate(adj_bWAR = round(adj_bWAR, 2)) %>% 
  select(yearID, playerID, adj_bWAR, mapped_IP_bWAR)
master_pitchers <- merge(master_pitchers_AB, bWAR_part, by = c('yearID', 'playerID'))
master_pitchers$mapped_IP <- apply(master_pitchers[,c(5,13)], 1, min)
master_pitchers <- master_pitchers %>% select(-mapped_IP_bWAR)

## Pitchers
pitchers <- master_pitchers %>% 
  mutate(adj_K9 = round(adj_SO/mapped_IP*9,1), 
         K9 = round(SO/IP*9,1), 
         adj_fWAR = round(adj_fWAR, 2))
pitchers <- as.data.frame(pitchers)
#pitchers$avg_ERA[pitchers$avg_ERA > 6.20] <- 6.20
#pitchers <- pitchers[pitchers$adj_bWAR != 0, ]

## extract and remove bad pitchers 
foo <- pitchers %>% 
  arrange(adj_ERA) %>% 
  filter(mapped_IP >= 100) %>% 
  dplyr::select(name, playerID, yearID, mapped_IP, adj_ERA, adj_SO, adj_fWAR, adj_bWAR)
bar <- split(foo, as.factor(foo$playerID))
baz <- do.call(rbind, lapply(bar, function(m){
  m[which.max(m$adj_fWAR), ]
}))
baz <- baz %>% arrange(adj_fWAR)
bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)

baz <- do.call(rbind, lapply(bar, function(m){
  m[which.max(m$adj_bWAR), ]
}))
baz <- baz %>% arrange(adj_bWAR)
bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
bad_players <- union(bad_players_bWAR, bad_players_fWAR)
pitchers <- pitchers[!pitchers$playerID %in% bad_players, ]


## build adjusted data set
pitchers_adjusted <- pitchers %>% dplyr::select(name, playerID, age, yearID, 
                                                mapped_IP, adj_ERA, adj_SO, adj_bWAR, adj_fWAR, full_time)
colnames(pitchers_adjusted) <- c("name", "playerID", "age", "year", "IP", 
                                 "adj_ERA", "adj_SO", "adj_bWAR", "adj_fWAR", "full_time")
pitchers_adjusted$playerID <- droplevels(as.factor(pitchers_adjusted$playerID))

## trim out bad players
# first round
foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
})
checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                      m_bad = unlist(lapply(bar, mean)),
                      len = unlist(lapply(bar, length)))
pitchers_adjusted <- pitchers_adjusted %>%
  filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)

# second round
foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
})
checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                      m_bad = unlist(lapply(bar, mean)),
                      len = unlist(lapply(bar, length)))
pitchers_adjusted <- pitchers_adjusted %>%
  filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)

# third round
foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
bar <- lapply(foo, function(m){
  min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
})
checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                      m_bad = unlist(lapply(bar, mean)),
                      len = unlist(lapply(bar, length)))
pitchers_adjusted <- pitchers_adjusted %>%
  filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)

# forth round
foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
})
checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                      m_bad = unlist(lapply(bar, mean)),
                      len = unlist(lapply(bar, length)))
pitchers_adjusted <- pitchers_adjusted %>%
  filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)


## remove tails 
foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= 0.41, 1, 0) + ifelse(m$adj_fWAR <= 0.4, 1, 0)
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                    ifelse(sum(tail(bad, 3)) >= 5,1,0),
                    ifelse(sum(tail(bad, 4)) >= 7,1,0),
                    ifelse(sum(tail(bad, 5)) >= 9,1,0),
                    ifelse(sum(tail(bad, 6)) >= 11,1,0)))
  1:(length(bad)-bad_tail)
})
pitchers_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

foo <- split(pitchers_adjusted_1, f = pitchers_adjusted_1$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                    ifelse(sum(tail(bad, 3)) >= 3,1,0),
                    ifelse(sum(tail(bad, 4)) >= 4,1,0),
                    ifelse(sum(tail(bad, 5)) >= 5,1,0),
                    ifelse(sum(tail(bad, 6)) >= 6,1,0)))
  1:(length(bad)-bad_tail)
})
pitchers_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

foo <- split(pitchers_adjusted_2, f = pitchers_adjusted_2$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                    ifelse(sum(tail(bad, 3)) >= 3,1,0),
                    ifelse(sum(tail(bad, 4)) >= 4,1,0),
                    ifelse(sum(tail(bad, 5)) >= 5,1,0),
                    ifelse(sum(tail(bad, 6)) >= 6,1,0)))
  1:(length(bad)-bad_tail)
})
pitchers_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

## remove starts
foo <- split(pitchers_adjusted_3, f = pitchers_adjusted_3$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
  bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                    ifelse(sum(head(bad, 2)) >= 3,1,0),
                    ifelse(sum(head(bad, 3)) >= 5,1,0),
                    ifelse(sum(head(bad, 4)) >= 7,1,0),
                    ifelse(sum(head(bad, 5)) >= 9,1,0),
                    ifelse(sum(head(bad, 6)) >= 11,1,0)))
  if (bad_head < length(bad)) {
    (bad_head + 1):length(bad)
  }
})
pitchers_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

pitchers_adjusted_4$playerID <- droplevels(pitchers_adjusted_4$playerID)

# taper down average WAR for players with small innings
pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_fWAR <- 
  round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_fWAR/9,2)
pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_bWAR <- 
  round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_bWAR/9,2)	
pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                      pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_fWAR <- 
  round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                              pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_fWAR/9, 2)
pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                      pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_bWAR <- 
  round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                              pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_bWAR/9, 2)


pitchers_adjusted <- do.call(rbind, mclapply(
  split(pitchers_adjusted_4, f = droplevels(as.factor(pitchers_adjusted_4$playerID))), 
  mc.cores = ncores, FUN = function(xx){
    ## natural cubic spline
    ns_ERA = lm(adj_ERA ~ ns(year, df=6), data=xx)
    nn_ERA <- predict(ns_ERA, data.frame("year"= xx$year))
    ns_SO = lm(adj_SO ~ ns(year, df=6), data=xx)
    nn_SO <- predict(ns_SO, data.frame("year"= xx$year))
    ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
    nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
    ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
    nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
    
    xx %>% mutate(ERA = round((adj_ERA + nn_ERA)/2, 3)) %>% 
      mutate(SO = round((adj_SO + nn_SO)/2)) %>%
      mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
      mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
  })) 

pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)
pitchers_adjusted <- pitchers_adjusted %>% 
  mutate(ER = round(ERA * IP / 9)) %>%
  mutate(ERA = round(ER / IP *9, 2)) %>% 
  mutate(ERA = ifelse(is.na(ERA), 0, ERA))

rownames(pitchers_adjusted) <- c()

pit_season <- pitchers_adjusted %>% 
  mutate(IP = ceiling(IP)) %>% 
  mutate(ERA = round(ER/IP*9, 2))
colnames(pit_season)[12] <- 'K'
pit_season[which(pit_season$K >= 1.5*pit_season$IP), ]$K <- 
  round(1.5*pit_season[which(pit_season$K >= 1.5*pit_season$IP), ]$IP)

pit_season <- pit_season %>% dplyr::select(-c(adj_bWAR, adj_fWAR, adj_ERA, adj_SO, full_time))

pit_career <- pit_season %>% group_by(playerID) %>% 
  summarise(name = unique(name), 
            playerID = unique(playerID), 
            IP = sum(IP), 
            ER = sum(ER), 
            ERA = round(ER/IP*9,2), 
            K = sum(K), 
            ebWAR = sum(ebWAR), 
            efWAR = sum(efWAR)) %>% 
  arrange(desc(ebWAR))
normal_historical_career_pit <- career_bWAR
normal_historical_career_trimmed_pit <- pit_career

```

```{r cache=TRUE, echo=FALSE}
pitchers_talent_bWAR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
  talent_computing_nonpara_fixed(dataset = pitchers_schell, component_name = "bWAR_p", year = yy, 
                                 ystar = thresh_fun(component = pitchers_schell %>% 
                                                      filter(full_time =='Y', yearID == yy) %>%
                                                      select(comp), component_name = 'bWAR_p'), alpha = 1.16)
})) %>% arrange(-WAR_talent)

no_strike <- pitchers_talent_bWAR %>% 
  filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
         full_time == 'Y', lgID == 'NL') %>%
  arrange(WAR_talent)

min_refbWAR <- -2

t <- isoreg(no_strike$WAR_talent, no_strike$comp)

talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,154)/154)
comp_new <- as.stepfun(t)(talent_new)

ystar <- thresh_fun(comp_new, component_name = 'bWAR_p')
pop_new <- round(mean(no_strike$pops))
component_name = 'bWAR_p'
yy <- sort(comp_new)
n <- length(yy)
ytilde <- rep(0, n + 1)
if (component_name == 'ERA') {
  ytilde[1] <- yy[1] - (yy[2] - yy[1])
}
if (component_name == 'bWAR_p'| component_name == 'fWAR_p') {
  ytilde[1] <- yy[1] - (yy[2] - yy[1])/10
}
if (component_name == 'SO') {
  ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
}
ytilde[n+1] <- yy[n] + ystar
ytilde[2:n] <- unlist(lapply(2:n, function(j){
  (yy[j]+yy[j-1])/2 
}))

career_kAB <- do.call(rbind, mclapply(1:nrow(pitchers_talent_bWAR), function(xx){
  int <- career_talent_nonpara(dataset = pitchers_talent_bWAR, component_name = 'bWAR_p', 
                               snippet = pitchers_talent_bWAR[xx,], alpha = 1.16)
  int
}, mc.cores = ncores)) 

mapped_pitchers_1 <- merge(career_kAB, mapped_quan_p, 
                           by = c('playerID', 'yearID'))

mapped_pitchers_bWAR <- mapped_pitchers_1 %>% 
  mutate(adj_bWAR = adj_comp * mapped_IP_raw) %>%
  mutate(adj_bWAR = ifelse(adj_bWAR < min_refbWAR, min_refbWAR, adj_bWAR)) %>%
  mutate(mapped_IP_bWAR = round(adj_bWAR / adj_comp))
career_bWAR <- mapped_pitchers_bWAR %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            mapped_IP = sum(mapped_IP_bWAR),
            adj_bWAR = sum(adj_bWAR))
master_pitchers_AB <- master_pitchers_trim %>% select(-adj_bWAR)
bWAR_part <- mapped_pitchers_bWAR %>% 
  mutate(adj_bWAR = round(adj_bWAR, 2)) %>% 
  select(yearID, playerID, adj_bWAR, mapped_IP_bWAR)
master_pitchers <- merge(master_pitchers_AB, bWAR_part, by = c('yearID', 'playerID'))
master_pitchers$mapped_IP <- apply(master_pitchers[,c(5,13)], 1, min)
master_pitchers <- master_pitchers %>% select(-mapped_IP_bWAR)

## Pitchers
pitchers <- master_pitchers %>% 
  mutate(adj_K9 = round(adj_SO/mapped_IP*9,1), 
         K9 = round(SO/IP*9,1), 
         adj_fWAR = round(adj_fWAR, 2))
pitchers <- as.data.frame(pitchers)
#pitchers$avg_ERA[pitchers$avg_ERA > 6.20] <- 6.20
#pitchers <- pitchers[pitchers$adj_bWAR != 0, ]

## extract and remove bad pitchers 
foo <- pitchers %>% 
  arrange(adj_ERA) %>% 
  filter(mapped_IP >= 100) %>% 
  dplyr::select(name, playerID, yearID, mapped_IP, adj_ERA, adj_SO, adj_fWAR, adj_bWAR)
bar <- split(foo, as.factor(foo$playerID))
baz <- do.call(rbind, lapply(bar, function(m){
  m[which.max(m$adj_fWAR), ]
}))
baz <- baz %>% arrange(adj_fWAR)
bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)

baz <- do.call(rbind, lapply(bar, function(m){
  m[which.max(m$adj_bWAR), ]
}))
baz <- baz %>% arrange(adj_bWAR)
bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
bad_players <- union(bad_players_bWAR, bad_players_fWAR)
pitchers <- pitchers[!pitchers$playerID %in% bad_players, ]


## build adjusted data set
pitchers_adjusted <- pitchers %>% dplyr::select(name, playerID, age, yearID, 
                                                mapped_IP, adj_ERA, adj_SO, adj_bWAR, adj_fWAR, full_time)
colnames(pitchers_adjusted) <- c("name", "playerID", "age", "year", "IP", 
                                 "adj_ERA", "adj_SO", "adj_bWAR", "adj_fWAR", "full_time")
pitchers_adjusted$playerID <- droplevels(as.factor(pitchers_adjusted$playerID))

## trim out bad players
# first round
foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
})
checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                      m_bad = unlist(lapply(bar, mean)),
                      len = unlist(lapply(bar, length)))
pitchers_adjusted <- pitchers_adjusted %>%
  filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)

# second round
foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
})
checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                      m_bad = unlist(lapply(bar, mean)),
                      len = unlist(lapply(bar, length)))
pitchers_adjusted <- pitchers_adjusted %>%
  filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)

# third round
foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
bar <- lapply(foo, function(m){
  min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
})
checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                      m_bad = unlist(lapply(bar, mean)),
                      len = unlist(lapply(bar, length)))
pitchers_adjusted <- pitchers_adjusted %>%
  filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)

# forth round
foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
bar <- lapply(foo, function(m){
  ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
})
checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                      m_bad = unlist(lapply(bar, mean)),
                      len = unlist(lapply(bar, length)))
pitchers_adjusted <- pitchers_adjusted %>%
  filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)


## remove tails 
foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= 0.41, 1, 0) + ifelse(m$adj_fWAR <= 0.4, 1, 0)
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                    ifelse(sum(tail(bad, 3)) >= 5,1,0),
                    ifelse(sum(tail(bad, 4)) >= 7,1,0),
                    ifelse(sum(tail(bad, 5)) >= 9,1,0),
                    ifelse(sum(tail(bad, 6)) >= 11,1,0)))
  1:(length(bad)-bad_tail)
})
pitchers_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

foo <- split(pitchers_adjusted_1, f = pitchers_adjusted_1$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                    ifelse(sum(tail(bad, 3)) >= 3,1,0),
                    ifelse(sum(tail(bad, 4)) >= 4,1,0),
                    ifelse(sum(tail(bad, 5)) >= 5,1,0),
                    ifelse(sum(tail(bad, 6)) >= 6,1,0)))
  1:(length(bad)-bad_tail)
})
pitchers_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

foo <- split(pitchers_adjusted_2, f = pitchers_adjusted_2$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
  bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                    ifelse(sum(tail(bad, 3)) >= 3,1,0),
                    ifelse(sum(tail(bad, 4)) >= 4,1,0),
                    ifelse(sum(tail(bad, 5)) >= 5,1,0),
                    ifelse(sum(tail(bad, 6)) >= 6,1,0)))
  1:(length(bad)-bad_tail)
})
pitchers_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

## remove starts
foo <- split(pitchers_adjusted_3, f = pitchers_adjusted_3$playerID)
bar <- lapply(foo, function(m){
  bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
  bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                    ifelse(sum(head(bad, 2)) >= 3,1,0),
                    ifelse(sum(head(bad, 3)) >= 5,1,0),
                    ifelse(sum(head(bad, 4)) >= 7,1,0),
                    ifelse(sum(head(bad, 5)) >= 9,1,0),
                    ifelse(sum(head(bad, 6)) >= 11,1,0)))
  if (bad_head < length(bad)) {
    (bad_head + 1):length(bad)
  }
})
pitchers_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
  foo[[j]][bar[[j]], ]
})) %>% arrange(year)

pitchers_adjusted_4$playerID <- droplevels(pitchers_adjusted_4$playerID)

# taper down average WAR for players with small innings
pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_fWAR <- 
  round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_fWAR/9,2)
pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_bWAR <- 
  round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_bWAR/9,2)	
pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                      pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_fWAR <- 
  round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                              pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_fWAR/9, 2)
pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                      pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_bWAR <- 
  round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                              pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_bWAR/9, 2)


pitchers_adjusted <- do.call(rbind, mclapply(
  split(pitchers_adjusted_4, f = droplevels(as.factor(pitchers_adjusted_4$playerID))), 
  mc.cores = ncores, FUN = function(xx){
    ## natural cubic spline
    ns_ERA = lm(adj_ERA ~ ns(year, df=6), data=xx)
    nn_ERA <- predict(ns_ERA, data.frame("year"= xx$year))
    ns_SO = lm(adj_SO ~ ns(year, df=6), data=xx)
    nn_SO <- predict(ns_SO, data.frame("year"= xx$year))
    ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
    nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
    ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
    nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
    
    xx %>% mutate(ERA = round((adj_ERA + nn_ERA)/2, 3)) %>% 
      mutate(SO = round((adj_SO + nn_SO)/2)) %>%
      mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
      mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
  })) 

pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)
pitchers_adjusted <- pitchers_adjusted %>% 
  mutate(ER = round(ERA * IP / 9)) %>%
  mutate(ERA = round(ER / IP *9, 2)) %>% 
  mutate(ERA = ifelse(is.na(ERA), 0, ERA))

rownames(pitchers_adjusted) <- c()

pit_season <- pitchers_adjusted %>% 
  mutate(IP = ceiling(IP)) %>% 
  mutate(ERA = round(ER/IP*9, 2))
colnames(pit_season)[12] <- 'K'
pit_season[which(pit_season$K >= 1.5*pit_season$IP), ]$K <- 
  round(1.5*pit_season[which(pit_season$K >= 1.5*pit_season$IP), ]$IP)

pit_season <- pit_season %>% dplyr::select(-c(adj_bWAR, adj_fWAR, adj_ERA, adj_SO, full_time))

pit_career <- pit_season %>% group_by(playerID) %>% 
  summarise(name = unique(name), 
            playerID = unique(playerID), 
            IP = sum(IP), 
            ER = sum(ER), 
            ERA = round(ER/IP*9,2), 
            K = sum(K), 
            ebWAR = sum(ebWAR), 
            efWAR = sum(efWAR)) %>% 
  arrange(desc(ebWAR))
normal_fixed_career_pit <- career_bWAR
normal_fixed_career_trimmed_pit <- pit_career

```

```{r cache=TRUE, echo=FALSE}
career_bWAR_diff <- c()
Willie_Mays <- pre_int_historical_career_bat %>% filter(playerID == 'mayswi01')
Babe_Ruth_bat <- pre_int_historical_career_bat %>% filter(playerID == 'ruthba01')
Babe_Ruth_pit <- pre_int_historical_career_pit %>% filter(playerID == 'ruthba01')
Willie_Mays_trimmed <- pre_int_historical_career_trimmed_bat %>% filter(playerID == 'mayswi01')
Babe_Ruth_bat_trimmed <- pre_int_historical_career_trimmed_bat %>% filter(playerID == 'ruthba01')
Babe_Ruth_pit_trimmed <- pre_int_historical_career_trimmed_pit %>% filter(playerID == 'ruthba01')

career_bWAR_diff <- rbind(career_bWAR_diff, 
                          data.frame(pops = 'pre_int', 
                                     league = 'historical', 
                                     diff_after = round(Willie_Mays_trimmed$ebWAR - 
                                                          Babe_Ruth_bat_trimmed$ebWAR - 
                                                          Babe_Ruth_pit_trimmed$ebWAR, 2), 
                                     diff_before = round(Willie_Mays$adj_bWAR - 
                                                           Babe_Ruth_bat$adj_bWAR - 
                                                           Babe_Ruth_pit$adj_bWAR, 2)))

```


```{r cache=TRUE, echo=FALSE}

Willie_Mays <- pre_int_fixed_career_bat %>% filter(playerID == 'mayswi01')
Babe_Ruth_bat <- pre_int_fixed_career_bat %>% filter(playerID == 'ruthba01')
Babe_Ruth_pit <- pre_int_fixed_career_pit %>% filter(playerID == 'ruthba01')
Willie_Mays_trimmed <- pre_int_fixed_career_trimmed_bat %>% filter(playerID == 'mayswi01')
Babe_Ruth_bat_trimmed <- pre_int_fixed_career_trimmed_bat %>% filter(playerID == 'ruthba01')
Babe_Ruth_pit_trimmed <- pre_int_fixed_career_trimmed_pit %>% filter(playerID == 'ruthba01')

career_bWAR_diff <- rbind(career_bWAR_diff, 
                          data.frame(pops = 'pre_int', 
                                     league = 'fixed', 
                                     diff_after = round(Willie_Mays_trimmed$ebWAR - 
                                                          Babe_Ruth_bat_trimmed$ebWAR - 
                                                          Babe_Ruth_pit_trimmed$ebWAR, 2), 
                                     diff_before = round(Willie_Mays$adj_bWAR - 
                                                           Babe_Ruth_bat$adj_bWAR - 
                                                           Babe_Ruth_pit$adj_bWAR, 2)))

```

```{r cache=TRUE, echo=FALSE}

Willie_Mays <- econ_effect_historical_career_bat %>% filter(playerID == 'mayswi01')
Babe_Ruth_bat <- econ_effect_historical_career_bat %>% filter(playerID == 'ruthba01')
Babe_Ruth_pit <- econ_effect_historical_career_pit %>% filter(playerID == 'ruthba01')
Willie_Mays_trimmed <- econ_effect_historical_career_trimmed_bat %>% filter(playerID == 'mayswi01')
Babe_Ruth_bat_trimmed <- econ_effect_historical_career_trimmed_bat %>% filter(playerID == 'ruthba01')
Babe_Ruth_pit_trimmed <- econ_effect_historical_career_trimmed_pit %>% filter(playerID == 'ruthba01')

career_bWAR_diff <- rbind(career_bWAR_diff, 
                          data.frame(pops = 'econ_effect', 
                                     league = 'historical', 
                                     diff_after = round(Willie_Mays_trimmed$ebWAR - 
                                                          Babe_Ruth_bat_trimmed$ebWAR - 
                                                          Babe_Ruth_pit_trimmed$ebWAR, 2), 
                                     diff_before = round(Willie_Mays$adj_bWAR - 
                                                           Babe_Ruth_bat$adj_bWAR - 
                                                           Babe_Ruth_pit$adj_bWAR, 2)))

```

```{r cache=TRUE, echo=FALSE}

Willie_Mays <- econ_effect_fixed_career_bat %>% filter(playerID == 'mayswi01')
Babe_Ruth_bat <- econ_effect_fixed_career_bat %>% filter(playerID == 'ruthba01')
Babe_Ruth_pit <- econ_effect_fixed_career_pit %>% filter(playerID == 'ruthba01')
Willie_Mays_trimmed <- econ_effect_fixed_career_trimmed_bat %>% filter(playerID == 'mayswi01')
Babe_Ruth_bat_trimmed <- econ_effect_fixed_career_trimmed_bat %>% filter(playerID == 'ruthba01')
Babe_Ruth_pit_trimmed <- econ_effect_fixed_career_trimmed_pit %>% filter(playerID == 'ruthba01')

career_bWAR_diff <- rbind(career_bWAR_diff, 
                          data.frame(pops = 'econ_effect', 
                                     league = 'fixed', 
                                     diff_after = round(Willie_Mays_trimmed$ebWAR - 
                                                          Babe_Ruth_bat_trimmed$ebWAR - 
                                                          Babe_Ruth_pit_trimmed$ebWAR, 2), 
                                     diff_before = round(Willie_Mays$adj_bWAR - 
                                                           Babe_Ruth_bat$adj_bWAR - 
                                                           Babe_Ruth_pit$adj_bWAR, 2)))

```

```{r cache=TRUE, echo=FALSE}

Willie_Mays <- normal_historical_career_bat %>% filter(playerID == 'mayswi01')
Babe_Ruth_bat <- normal_historical_career_bat %>% filter(playerID == 'ruthba01')
Babe_Ruth_pit <- normal_historical_career_pit %>% filter(playerID == 'ruthba01')
Willie_Mays_trimmed <- normal_historical_career_trimmed_bat %>% filter(playerID == 'mayswi01')
Babe_Ruth_bat_trimmed <- normal_historical_career_trimmed_bat %>% filter(playerID == 'ruthba01')
Babe_Ruth_pit_trimmed <- normal_historical_career_trimmed_pit %>% filter(playerID == 'ruthba01')

career_bWAR_diff <- rbind(career_bWAR_diff, 
                          data.frame(pops = 'normal', 
                                     league = 'historical', 
                                     diff_after = round(Willie_Mays_trimmed$ebWAR - 
                                                          Babe_Ruth_bat_trimmed$ebWAR - 
                                                          Babe_Ruth_pit_trimmed$ebWAR, 2), 
                                     diff_before = round(Willie_Mays$adj_bWAR - 
                                                           Babe_Ruth_bat$adj_bWAR - 
                                                           Babe_Ruth_pit$adj_bWAR, 2)))

```

```{r cache=TRUE, echo=FALSE}

Willie_Mays <- normal_fixed_career_bat %>% filter(playerID == 'mayswi01')
Babe_Ruth_bat <- normal_fixed_career_bat %>% filter(playerID == 'ruthba01')
Babe_Ruth_pit <- normal_fixed_career_pit %>% filter(playerID == 'ruthba01')
Willie_Mays_trimmed <- normal_fixed_career_trimmed_bat %>% filter(playerID == 'mayswi01')
Babe_Ruth_bat_trimmed <- normal_fixed_career_trimmed_bat %>% filter(playerID == 'ruthba01')
Babe_Ruth_pit_trimmed <- normal_fixed_career_trimmed_pit %>% filter(playerID == 'ruthba01')

career_bWAR_diff <- rbind(career_bWAR_diff, 
                          data.frame(pops = 'normal', 
                                     league = 'fixed', 
                                     diff_after = round(Willie_Mays_trimmed$ebWAR - 
                                                          Babe_Ruth_bat_trimmed$ebWAR - 
                                                          Babe_Ruth_pit_trimmed$ebWAR, 2), 
                                     diff_before = round(Willie_Mays$adj_bWAR - 
                                                           Babe_Ruth_bat$adj_bWAR - 
                                                           Babe_Ruth_pit$adj_bWAR, 2)))
kable(career_bWAR_diff)
```

## Z-scores for 1997 Gwynn and 1911 Cobb from park factor adjusted BAs and regular unadjusted BAs.

```{r echo=FALSE}
load("bat_pit.RData")
batters <- bat_dat
cutoff <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    m <- batters %>% filter(yearID == xx) %>% filter(PA >= 75)
    data.frame(thres = median(m$PA), yearID = xx)
  }))
batters <- merge(batters, cutoff, by = 'yearID')
dat <- batters %>% select(playerID, yearID, name, AB, PA, obs_hits, H, thres) %>% mutate(BA = ifelse(AB != 0, H / AB, 0), 
         obs_BA = ifelse(AB != 0,  obs_hits / AB, 0), 
         full_time = ifelse(PA >= thres, 'Y', 'N')) 
Cobb_1911 <- dat %>% filter(yearID == 1911, full_time == 'Y') %>% 
  mutate(prob_BA = pnorm(BA, mean(BA), sd(BA))) %>%
  mutate(zscore_BA = qnorm(prob_BA, 0, 1)) %>% 
  mutate(prob_obs_BA = pnorm(obs_BA, mean(obs_BA), sd(obs_BA))) %>%
  mutate(zscore_obs_BA = qnorm(prob_obs_BA, 0, 1)) 

Gwynn_1997 <- dat %>% filter(yearID == 1997, full_time == 'Y') %>% 
  mutate(prob_BA = pnorm(BA, mean(BA), sd(BA))) %>%
  mutate(zscore_BA = qnorm(prob_BA, 0, 1)) %>% 
  mutate(prob_obs_BA = pnorm(obs_BA, mean(obs_BA), sd(obs_BA))) %>%
  mutate(zscore_obs_BA = qnorm(prob_obs_BA, 0, 1)) 

knitr::kable(data.frame(name = c('Ty Cobb', 'Tony Gwynn'), 
                 year = c(1911, 1997), 
                 zscore_BA = c((Cobb_1911 %>% filter(playerID == 'cobbty01'))$zscore_BA, 
                   (Gwynn_1997 %>% filter(playerID == 'gwynnto01'))$zscore_BA), 
                 normality_BA = c(shapiro.test(Cobb_1911$BA)$p.value, 
                                  shapiro.test(Gwynn_1997$BA)$p.value),
                 zscore_obs_BA = c((Cobb_1911 %>% filter(playerID == 'cobbty01'))$zscore_obs_BA, 
                   (Gwynn_1997 %>% filter(playerID == 'gwynnto01'))$zscore_obs_BA), 
                 normality_obs_BA = c(shapiro.test(Cobb_1911$obs_BA)$p.value, 
                                  shapiro.test(Gwynn_1997$obs_BA)$p.value)))

```

## Fixed MLB-eligible population for all seasons. 

In order to show how the MLB-eligible population change our rankings, we set 1 million as the MLB-eligible population for every season and see what the rankings look like. 

```{r cache=TRUE, echo=FALSE}
batters <- bat_dat %>% select(yearID, playerID, lgID, name, age, PA, G, bWAR, pops) 
batters$pops <- 1e6
cutoff <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    m <- batters %>% filter(yearID == xx) %>% filter(PA >= 75)
    data.frame(thres = median(m$PA), yearID = xx)
  }))
batters <- merge(batters, cutoff, by = 'yearID')
batters <- batters %>% mutate(comp =  bWAR / G, full_time = ifelse(PA >= thres, 'Y', 'N'))
batters_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- batters %>% filter(yearID == xx)
    lg_avg <- sum(int$bWAR)/sum(int$G)
    int %>% mutate(comp = (bWAR + lg_avg * 7)/(G + 7))
  }))

batters_talent_bWAR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
  talent_computing_nonpara(dataset = batters_schell, component_name = "bWAR", year = yy, ystar = thresh_fun(component = batters_schell %>% filter(full_time == 'Y', yearID == yy) %>% select(comp), component_name = 'bWAR'), alpha = 1.16) })) %>% arrange(-WAR_talent)

no_strike <- batters_talent_bWAR %>% 
    filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  
t <- isoreg(no_strike$WAR_talent, no_strike$comp)
talent_new <- quantile(no_strike$WAR_talent, probs = (seq(0,250)/250))
comp_new <- as.stepfun(t)(talent_new)

ystar <- thresh_fun(comp_new, component_name = 'bWAR')
pop_new <- round(mean(no_strike$pops))
component_name = 'bWAR'
yy <- sort(comp_new)
n <- length(yy)
ytilde <- rep(0, n + 1)
if (component_name == 'bWAR' | component_name == 'fWAR') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
}
if (component_name == 'HR' | component_name == 'BB') {
    # since the minimal HR is greater or equal to 0.
    ytilde[1] <- 0
}
ytilde[n+1] <- yy[n] + ystar
ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2 
}))

career_kAB_1st <- do.call(rbind, mclapply(1:30000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                         snippet = batters_talent_bWAR[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores))
  
  
career_kAB_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                         snippet = batters_talent_bWAR[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
career_kAB_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_bWAR), function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                         snippet = batters_talent_bWAR[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
career_kAB <- rbind(career_kAB_1st, career_kAB_2nd, career_kAB_3rd)

## mapping statistics
  
mapped_quan_b_raw <- do.call(rbind, mclapply(years, function(xx){
    batters_full <- batters %>% filter(yearID == xx) %>% 
      filter(full_time == 'Y') %>% arrange(-G)
    batters_less <- batters %>% filter(yearID == xx) %>% 
      filter(full_time == 'N') %>% arrange(-G)
    
    n1 <- nrow(batters_full)
    n2 <- nrow(batters_less)
    
    mapped_G_full <- c()
    mapped_G_less <- c()
    for (yy in c(1977:1980, 1982:1989)) {
      batters_ref_full <- batters %>% 
        filter(yearID == yy, full_time == 'Y') %>% arrange(-G)
      batters_ref_less <- batters %>% 
        filter(yearID == yy, full_time == 'N') %>% arrange(-G)
      n1r <- nrow(batters_ref_full)
      n2r <- nrow(batters_ref_less)
      
      mapped_G_full <- cbind(mapped_G_full, approx(x = seq((n1r-1),0)/(n1r-1), 
                                                   y = batters_ref_full$G, 
                                                   xout = seq((n1-1),0)/(n1-1))$y)
      mapped_G_less <- cbind(mapped_G_less, approx(x = seq((n2r-1),0)/(n2r-1), 
                                                   y = batters_ref_less$G, 
                                                   xout = seq((n2-1),0)/(n2-1))$y)
    }
    
    batters_full$mapped_G <- rowMeans(mapped_G_full)
    batters_less$mapped_G <- rowMeans(mapped_G_less)
    
    
    batters_full <- batters_full %>% arrange(-PA)
    batters_less <- batters_less %>% arrange(-PA)
    mapped_PA_full <- c()
    mapped_PA_less <- c()
    for (yy in c(1977:1980, 1982:1989)) {
      batters_ref_full <- batters %>% 
        filter(yearID == yy, full_time == 'Y') %>% arrange(-PA)
      batters_ref_less <- batters %>% 
        filter(yearID == yy, full_time == 'N') %>% arrange(-PA)
      n1r <- nrow(batters_ref_full)
      n2r <- nrow(batters_ref_less)
      
      mapped_PA_full <- cbind(mapped_PA_full, approx(x = seq((n1r-1),0)/(n1r-1), 
                                                     y = batters_ref_full$PA, 
                                                     xout = seq((n1-1),0)/(n1-1))$y)
      mapped_PA_less <- cbind(mapped_PA_less, approx(x = seq((n2r-1),0)/(n2r-1), 
                                                     y = batters_ref_less$PA, 
                                                     xout = seq((n2-1),0)/(n2-1))$y)
    }
    
    batters_full$mapped_PA <- rowMeans(mapped_PA_full)
    batters_less$mapped_PA <- rowMeans(mapped_PA_less)
    
    m <- rbind(batters_full, batters_less)
    data.frame(playerID = m$playerID, yearID = m$yearID,
               mapped_G_raw = round(m$mapped_G), mapped_PA_raw = round(m$mapped_PA))
    
  }, mc.cores = ncores))
   
mapped_batters_1 <- merge(career_kAB, mapped_quan_b_raw, 
                            by = c('playerID', 'yearID'))
  
min_refbWAR <- -2
  
mapped_batters_bWAR_fixed <- mapped_batters_1 %>% 
    mutate(adj_bWAR = adj_comp * mapped_G_raw) %>% 
    mutate(adj_bWAR = ifelse(adj_bWAR < min_refbWAR, min_refbWAR, adj_bWAR)) %>%
    mutate(mapped_G_bWAR = round(adj_bWAR / adj_comp))
```

```{r cache=TRUE, echo=FALSE}
batters <- bat_dat %>% select(yearID, playerID, lgID, name, age, PA, G, bWAR,fWAR,pops)
batters$pops <- 1e6
  
  batters <- merge(batters, cutoff, by = 'yearID')
  
  batters <- batters %>% mutate(comp =  fWAR / G, full_time = ifelse(PA >= thres, 'Y', 'N'))
  
  batters_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- batters %>% filter(yearID == xx)
    lg_avg <- sum(int$fWAR)/sum(int$G)
    int %>% mutate(comp = (fWAR + lg_avg * 7)/(G + 7))
  }))
  
  batters_talent_fWAR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
    talent_computing_nonpara(dataset = batters_schell, component_name = "fWAR", year = yy, 
                             ystar = thresh_fun(component = batters_schell %>% filter(full_time == 'Y', yearID == yy) %>% select(comp), component_name = 'fWAR'), alpha = 1.16)
  })) %>% arrange(-WAR_talent)
  
  no_strike <- batters_talent_fWAR %>% 
    filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  
  t <- isoreg(no_strike$WAR_talent, no_strike$comp)
  
  talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,250)/250)
  
  comp_new <- as.stepfun(t)(talent_new)
  
  ystar <- thresh_fun(comp_new, component_name = 'fWAR')
  pop_new <- round(mean(no_strike$pops))
  component_name = 'fWAR'
  yy <- sort(comp_new)
  n <- length(yy)
  ytilde <- rep(0, n + 1)
  if (component_name == 'bWAR' | component_name == 'fWAR') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
  }
  if (component_name == 'HR' | component_name == 'BB') {
    # since the minimal HR is greater or equal to 0.
    ytilde[1] <- 0
  }
  ytilde[n+1] <- yy[n] + ystar
  ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2 
  }))
  
  career_kAB_1st <- do.call(rbind, mclapply(1:30000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_fWAR, component_name = 'fWAR', 
                         snippet = batters_talent_fWAR[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores))
  
  
  career_kAB_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_fWAR, component_name = 'fWAR', 
                         snippet = batters_talent_fWAR[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
  career_kAB_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_fWAR), function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_fWAR, component_name = 'fWAR', 
                         snippet = batters_talent_fWAR[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
  career_kAB <- rbind(career_kAB_1st, career_kAB_2nd, career_kAB_3rd)
  
  mapped_batters_1 <- merge(career_kAB, mapped_quan_b_raw, 
                            by = c('playerID', 'yearID'))
  
  min_reffWAR <- -2
  
  mapped_batters_fWAR_fixed <- mapped_batters_1 %>% 
    mutate(adj_fWAR = adj_comp * mapped_G_raw) %>% 
    mutate(adj_fWAR = ifelse(adj_fWAR < min_reffWAR, min_reffWAR, adj_fWAR)) %>%
    mutate(mapped_G_fWAR = round(adj_fWAR / adj_comp))
```

```{r cache=TRUE, echo=FALSE}
batters_HR <- bat_dat %>% 
    select(yearID, playerID, lgID, name, PA, AB, HR, BB, HBP, SH, SF, bWAR, pops) 
batters_HR$pops <- 1e6
  
  cutoff <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    m <- batters_HR %>% filter(yearID == xx) %>% filter(PA >= 75)
    data.frame(thres = median(m$PA), yearID = xx)
  }))
  
  batters <- merge(batters_HR, cutoff, by = 'yearID')
  
  batters <- batters %>% mutate(comp =  ifelse(AB != 0, HR / AB, 0), full_time = ifelse(PA >= thres, 'Y', 'N'))
  
  batters_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- batters %>% filter(yearID == xx)
    lg_avg <- sum(int$HR)/sum(int$AB)
    int %>% mutate(comp = (HR + lg_avg * 25)/(AB + 25))
  }))
  
  batters_talent_HR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
    talent_computing_nonpara(dataset = batters_schell, component_name = "HR", 
                             year = yy, ystar = thresh_fun(component = batters_schell %>% 
                                                            filter(full_time == 'Y', yearID == yy) %>%
                                                            select(comp), component_name = 'HR'), 
                             alpha = 1.16)
  })) %>% arrange(-WAR_talent)
  
  no_strike <- batters_talent_HR %>% 
    filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  
  min_refHR <- min(no_strike$HR)
  
  t <- isoreg(no_strike$WAR_talent, no_strike$comp)
  
  talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,250)/250)
  
  comp_new <- as.stepfun(t)(talent_new)
  
  ystar <- thresh_fun(comp_new, component_name = 'HR')
  pop_new <- round(mean(no_strike$pops))
  component_name = 'HR'
  yy <- sort(comp_new)
  n <- length(yy)
  ytilde <- rep(0, n + 1)
  if (component_name == 'bWAR' | component_name == 'fWAR') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
  }
  if (component_name == 'HR' | component_name == 'BB') {
    # since the minimal HR is greater or equal to 0.
    ytilde[1] <- 0
  }
  ytilde[n+1] <- yy[n] + ystar
  ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2 
  }))
  
  career_kAB_1st <- do.call(rbind, mclapply(1:30000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_HR, component_name = 'HR', 
                         snippet = batters_talent_HR[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores))
  
  
  career_kAB_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_HR, component_name = 'HR', 
                         snippet = batters_talent_HR[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
  career_kAB_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_HR), function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_HR, component_name = 'HR', 
                         snippet = batters_talent_HR[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
  career_kAB <- rbind(career_kAB_1st, career_kAB_2nd, career_kAB_3rd)
```

```{r cache=TRUE, echo=FALSE}
  batters_BB <- bat_dat %>% select(yearID, playerID, lgID, name, G, PA, BB, pops) 
  batters_BB$pops <- 1e6
  
  batters <- merge(batters_BB, cutoff, by = 'yearID')
  
  batters <- batters %>% mutate(comp = ifelse(PA > 0, BB / PA, 0), full_time = ifelse(PA >= thres, 'Y', 'N'))
  
  batters_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- batters %>% filter(yearID == xx)
    lg_avg <- sum(int$BB)/sum(int$PA)
    int %>% mutate(comp = (BB + lg_avg * 28)/(PA + 28))
  }))
  
  batters_talent_BB <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
    talent_computing_nonpara(dataset = batters_schell, component_name = "BB", 
                             year = yy, ystar = 
                               thresh_fun(component = batters_schell %>% 
                                           filter(full_time == 'Y', yearID == yy) %>% 
                                           select(comp), component_name = 'BB'), alpha = 1.16)
  })) %>% arrange(-WAR_talent)
  
  
  no_strike <- batters_talent_BB %>% 
    filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  
  min_refBB <- 0
  
  t <- isoreg(no_strike$WAR_talent, no_strike$comp)
  
  talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,250)/250)
  
  comp_new <- as.stepfun(t)(talent_new)
  
  ystar <- thresh_fun(comp_new, component_name = 'BB')
  pop_new <- round(mean(no_strike$pops))
  component_name = 'BB'
  yy <- sort(comp_new)
  n <- length(yy)
  ytilde <- rep(0, n + 1)
  if (component_name == 'bWAR' | component_name == 'fWAR') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
  }
  if (component_name == 'HR' | component_name == 'BB') {
    # since the minimal HR is greater or equal to 0.
    ytilde[1] <- 0
  }
  ytilde[n+1] <- yy[n] + ystar
  ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2 
  }))
  
  career_kAB_BB_1st <- do.call(rbind, mclapply(1:30000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_BB, component_name = 'BB', 
                         snippet = batters_talent_BB[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores))
  
  
  career_kAB_BB_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_BB, component_name = 'BB', 
                         snippet = batters_talent_BB[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
  career_kAB_BB_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_BB), function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_BB, component_name = 'BB', 
                         snippet = batters_talent_BB[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
  career_kAB_BB <- rbind(career_kAB_BB_1st, career_kAB_BB_2nd, career_kAB_BB_3rd)
  
  colnames(career_kAB)[colnames(career_kAB) == 'adj_comp'] <- "adj_HR_AB"
  
  career_combined <- merge(career_kAB %>% select(-comp), career_kAB_BB %>% 
                             select(yearID, playerID, comp, adj_comp), by = c('yearID', 'playerID'))
  
  mapped_batters_1 <- merge(career_combined, mapped_quan_b_raw, 
                            by = c('playerID', 'yearID'))
  
  mapped_batters_HR_fixed <- mapped_batters_1 %>%
    mutate(adj_BB = ceiling(adj_comp * ceiling(mapped_PA_raw))) %>% 
    mutate(adj_BB = ifelse(adj_BB < min_refBB, min_refBB, adj_BB)) %>% 
    mutate(mapped_PA = mapped_PA_raw) %>%
    mutate(adj_AB = ceiling(mapped_PA) - adj_BB - HBP - SH - SF) %>% 
    mutate(adj_AB = ifelse(adj_AB < 0, 0, adj_AB)) %>% 
    mutate(adj_HR = ceiling(adj_HR_AB * adj_AB)) %>% 
    mutate(adj_HR = ifelse(adj_HR < min_refHR, min_refHR, adj_HR))
```

```{r cache=TRUE, echo=FALSE}
batters <- bat_dat
  
  batters <- merge(batters, cutoff, by = 'yearID')
  
  batters <- batters %>% select(playerID, yearID, lgID, name, age, lgID, AB, 
                                PA, obs_hits, H, thres, bWAR, pops) 
  batters$pops <- 1e6
  batters <- batters %>%
    mutate(comp = ifelse(AB != 0, H / AB, 0), full_time = ifelse(PA >= thres, 'Y', 'N'))
  
  batters_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- batters %>% filter(yearID == xx)
    lg_avg <- sum(int$H)/sum(int$AB)
    int %>% mutate(comp = (H + lg_avg * 25)/(AB + 25))
  }))

  batters_talent_AVG <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
    talent_computing_nonpara(dataset = batters_schell, component_name = "AVG", 
                             year = yy, ystar = thresh_fun(component = batters_schell %>% 
                                                            filter(full_time == 'Y', yearID == yy) %>%
                                                            select(comp), component_name = 'AVG'), 
                             alpha = 1.16)
  })) %>% arrange(-WAR_talent)
  
  no_strike <- batters_talent_AVG %>%
    filter(yearID < 1990, yearID >= 1977, yearID != 1981,
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  
  min_refAVG <- min(no_strike$comp)
  
  t <- isoreg(no_strike$WAR_talent, no_strike$comp)
  
  talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,250)/250)
  
  comp_new <- as.stepfun(t)(talent_new)
  
  ystar <- thresh_fun(comp_new, component_name = 'AVG')
  pop_new <- round(mean(no_strike$pops))
  component_name = 'AVG'
  yy <- sort(comp_new)
  n <- length(yy)
  ytilde <- rep(0, n + 1)
  if (component_name == 'bWAR' | component_name == 'fWAR') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
  }
  if (component_name == 'HR' | component_name == 'BB') {
    # since the minimal HR is greater or equal to 0.
    ytilde[1] <- 0
  }
  if (component_name == 'AVG') {
    ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
  }
  ytilde[n+1] <- yy[n] + ystar
  ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2
  }))

  career_kAB_AVG_1st <- do.call(rbind, mclapply(1:30000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                         snippet = batters_talent_AVG[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores))
  
  
  career_kAB_AVG_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                         snippet = batters_talent_AVG[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores))
  
  career_kAB_AVG_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_AVG), function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                         snippet = batters_talent_AVG[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores))
  
  
  career_kAB <- rbind(career_kAB_AVG_1st, 
                      career_kAB_AVG_2nd, 
                      career_kAB_AVG_3rd)
 
  mapped_batters_AVG_fixed <- career_kAB %>% 
    mutate(adj_AVG = ifelse(adj_comp < min_refAVG, min_refAVG, adj_comp))
```

```{r cache=TRUE, echo=FALSE}
  AVG_part_fixed <- mapped_batters_AVG_fixed %>%
    mutate(adj_AVG = round(adj_AVG, 3)) %>% 
    select(yearID, playerID, name, adj_AVG) 
  HR_part_fixed <- mapped_batters_HR_fixed %>% 
    mutate(mapped_PA = round(mapped_PA)) %>% 
    mutate(adj_HR = round(adj_HR)) %>%
    mutate(adj_AB = round(adj_AB)) %>%
    select(yearID, playerID, adj_HR, adj_AB, HBP, SF, mapped_PA) 
  bWAR_part_fixed <- mapped_batters_bWAR_fixed %>%
    mutate(adj_bWAR = round(adj_bWAR, 2)) %>%
    select(yearID, playerID, adj_bWAR, mapped_G_bWAR) 
  fWAR_part_fixed <- mapped_batters_fWAR_fixed %>%
    mutate(adj_fWAR = round(adj_fWAR, 2)) %>%
    select(yearID, playerID, age, adj_fWAR, mapped_G_fWAR) 
  BB_part_fixed <- mapped_batters_HR_fixed %>% 
    mutate(adj_BB = round(adj_BB)) %>%
    select(yearID, playerID, BB, adj_BB)
  master_batters_fixed <- merge(BB_part_fixed, merge(AVG_part_fixed, 
                                         merge(HR_part_fixed, merge(bWAR_part_fixed, fWAR_part_fixed, 
                                                              by = c('yearID', 'playerID')), 
                                               by = c('yearID', 'playerID')), 
                                         by = c('yearID', 'playerID')), 
                          by = c('yearID', 'playerID'))
  
  master_batters_fixed <- master_batters_fixed %>% 
    mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
  master_batters_fixed$adj_OBP[is.na(master_batters_fixed$adj_OBP)] <- 0
  
  master_batters_fixed <- master_batters_fixed %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
    mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))
  master_batters_fixed$mapped_G <- apply(master_batters_fixed[,c(13,16)], 1, min)
```

```{r cache=TRUE, echo=FALSE}
  ## Batters
  batters <- master_batters_fixed

  ## extract and remove bad players 
  foo <- batters %>% 
    arrange(desc(adj_AVG)) %>% 
    filter(adj_AB >= 300) %>% 
    dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
    mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
  bar <- split(foo, as.factor(foo$playerID))
  baz <- do.call(rbind, lapply(bar, function(m){
    m[which.max(m$adj_fWAR), ]
  }))
  baz <- baz %>% arrange(adj_fWAR)
  bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
  
  baz <- do.call(rbind, lapply(bar, function(m){
    m[which.max(m$adj_bWAR), ]
  }))
  baz <- baz %>% arrange(adj_bWAR)
  bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
  bad_players <- union(bad_players_bWAR, bad_players_fWAR)
  batters <- batters[!batters$playerID %in% bad_players, ]
  
  ###### investigate anomalies ######
  
  ## more on base events than PAs
  
  # check average for minimal at bats and correct issues
  batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
  batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
  batters[batters$adj_AB > 0, ]$adj_AVG <- 
    round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)
  
  ## build adjusted data set
  batters_adjusted <- batters %>% 
    dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                  adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
  colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                  "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
  batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))

  
  ## trim out bad players
  # first round
  foo <- split(batters_adjusted, f = batters_adjusted$playerID)
  bar <- lapply(foo, function(m){
    ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
  })
  checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                        m_bad = unlist(lapply(bar, mean)), 
                        len = unlist(lapply(bar, length)))
  batters_adjusted <- batters_adjusted %>% 
    filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
  batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
  
  # second round
  foo <- split(batters_adjusted, f = batters_adjusted$playerID)
  bar <- lapply(foo, function(m){
    ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
  })
  checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                        m_bad = unlist(lapply(bar, mean)), 
                        len = unlist(lapply(bar, length)))
  batters_adjusted <- batters_adjusted %>% 
    filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
  batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
  
  # third round
  foo <- split(batters_adjusted, f = batters_adjusted$playerID)
  bar <- lapply(foo, function(m){
    min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
  })
  checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                        m_bad = unlist(lapply(bar, mean)), 
                        len = unlist(lapply(bar, length)))
  batters_adjusted <- batters_adjusted %>% 
    filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
  batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
  
  # forth round
  foo <- split(batters_adjusted, f = batters_adjusted$playerID)
  bar <- lapply(foo, function(m){
    ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
  })
  checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                        m_bad = unlist(lapply(bar, mean)), 
                        len = unlist(lapply(bar, length)))
  batters_adjusted <- batters_adjusted %>% 
    filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
  batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
  
  
  ## remove tails 
  foo <- split(batters_adjusted, f = batters_adjusted$playerID)
  bar <- lapply(foo, function(m){
    bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
    bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                      ifelse(sum(tail(bad, 3)) >= 5,1,0),
                      ifelse(sum(tail(bad, 4)) >= 7,1,0),
                      ifelse(sum(tail(bad, 5)) >= 9,1,0),
                      ifelse(sum(tail(bad, 6)) >= 11,1,0)))
    1:(length(bad)-bad_tail)
  })
  batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
    foo[[j]][bar[[j]], ]
  })) %>% arrange(year)
  
  foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
  bar <- lapply(foo, function(m){
    bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
    bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                      ifelse(sum(tail(bad, 3)) >= 3,1,0),
                      ifelse(sum(tail(bad, 4)) >= 4,1,0),
                      ifelse(sum(tail(bad, 5)) >= 5,1,0),
                      ifelse(sum(tail(bad, 6)) >= 6,1,0)))
    1:(length(bad)-bad_tail)
  })
  batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
    foo[[j]][bar[[j]], ]
  })) %>% arrange(year)
  
  foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
  bar <- lapply(foo, function(m){
    bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
    bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                      ifelse(sum(tail(bad, 3)) >= 3,1,0),
                      ifelse(sum(tail(bad, 4)) >= 4,1,0),
                      ifelse(sum(tail(bad, 5)) >= 5,1,0),
                      ifelse(sum(tail(bad, 6)) >= 6,1,0)))
    1:(length(bad)-bad_tail)
  })
  batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
    foo[[j]][bar[[j]], ]
  })) %>% arrange(year)
  
  ## remove starts
  foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
  bar <- lapply(foo, function(m){
    bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
    bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                      ifelse(sum(head(bad, 2)) >= 3,1,0),
                      ifelse(sum(head(bad, 3)) >= 5,1,0),
                      ifelse(sum(head(bad, 4)) >= 7,1,0),
                      ifelse(sum(head(bad, 5)) >= 9,1,0),
                      ifelse(sum(head(bad, 6)) >= 11,1,0)))
    if (bad_head < length(bad)) {
      (bad_head + 1):length(bad)
    }
  })
  batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
    foo[[j]][bar[[j]], ]
  })) %>% arrange(year)
  
  batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)
  
  # taper down average WAR for players with small PAs
  batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
    round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
  batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
    round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	
  
  batters_adjusted <- do.call(rbind, mclapply(
    split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
    mc.cores = ncores, FUN = function(xx){
      ## natural cubic spline
      ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
      nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
      ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
      nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
      ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
      nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
      ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
      nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
      ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
      nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
      
      xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
        mutate(HR = round((adj_HR + nn_HR)/2)) %>%
        mutate(BB = round((adj_BB + nn_BB)/2)) %>%
        mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
        mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
    })) 
  
  bat_season_fixed <- batters_adjusted %>% 
    mutate(PA = adj_AB + BB + HBP + SF)
  bat_season_fixed[bat_season_fixed$HR >= bat_season_fixed$adj_AB, ]$HR <- 
    bat_season_fixed[bat_season_fixed$HR >= bat_season_fixed$adj_AB, ]$adj_AB

 bat_season_fixed <- bat_season_fixed %>% 
   dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
 bat_season_fixed <- bat_season_fixed %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
   mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
   mutate(HR = ifelse(HR > 0, HR, 0)) %>%
   mutate(BB = ifelse(BB > 0, BB, 0)) %>%
   mutate(OBP = ifelse(OBP > 0, OBP, 0))
 
 colnames(bat_season_fixed)[5] <- 'AB'
 colnames(bat_season_fixed)[8] <- 'BA'
 bat_season_fixed <- bat_season_fixed %>% mutate(H = ceiling(AB * BA)) %>%
   mutate(BA = round(H / AB, 3)) %>%
   mutate(BA = ifelse(AB == 0, 0, BA)) %>%
   mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
   mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))
 
  bat_career_fixed <- bat_season_fixed %>% group_by(playerID) %>% 
    summarise(name = unique(name), 
              playerID = unique(playerID), 
              PA = sum(round(PA)), 
              AB = sum(AB), 
              H = sum(H), 
              HR = sum(round(HR)), 
              BB = sum(round(BB)), 
              BA = round(H/AB, 3), 
              HBP = sum(HBP), 
              SF = sum(SF), 
              OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
              ebWAR = sum(ebWAR), 
              efWAR = sum(efWAR)) %>% ungroup() %>% 
    arrange(desc(ebWAR))
  
  bat_career_fixed <- bat_career_fixed %>% mutate(BA = ifelse(AB == 0, 0, BA))
  bat_career_fixed <- bat_career_fixed %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))
```

```{r echo=FALSE}
foo <- getRetrosheet(type = "game", year = 2022)
rotation_bound <- as.data.frame(cbind(years, unlist(mclapply(years, mc.cores = ncores, function(yr){
    foo <- getRetrosheet(type = "game", year = yr)
    Tms <- unique(foo$HmTm)
    
    starter <- lapply(Tms, function(tm){
      bar <- foo %>% filter(VisTm == tm | HmTm == tm) %>% 
        select(VisTm, HmTm, VisStPchID, HmStPchID, VisTmGNum, HmTmGNum)
      t(apply(bar, 1, function(xx){
        y <- NULL
        if(xx[2] == tm){
          y <- xx[4]
        }
        else{
          y <- xx[3]
        }
      })) 
    })
    
    y <- unlist(lapply(starter, function(xx){
      unlist(lapply(1:length(xx), function(j){
        flag <- TRUE
        k <- 1
        if(j > 1){
          while(flag){
            flag <- length(xx[(j-k):j]) == length(unique(xx[(j-k):j]))
            if(!flag){
              break
            }
            else{
              k <- k + 1
            }
            if(k == j){
              break
            }
          }
        }
        k
      }))
    }))
    mean(y)
    
  }))))
```

```{r cache=TRUE, echo=FALSE}
pitchers <- pit_dat %>% 
    select(playerID, yearID, name, age, lgID, teamID, IP, pops, bWAR)
pitchers$pops <- 1e6
  pitchers <- pitchers %>% mutate(comp = bWAR / IP)
  pitchers$comp[is.na(pitchers$comp)] = 0
  
  rotation_bound <- as.data.frame(cbind(years, unlist(mclapply(years, mc.cores = ncores, function(yr){
    foo <- getRetrosheet(type = "game", year = yr)
    Tms <- unique(foo$HmTm)
    
    starter <- lapply(Tms, function(tm){
      bar <- foo %>% filter(VisTm == tm | HmTm == tm) %>% 
        select(VisTm, HmTm, VisStPchID, HmStPchID, VisTmGNum, HmTmGNum)
      t(apply(bar, 1, function(xx){
        y <- NULL
        if(xx[2] == tm){
          y <- xx[4]
        }
        else{
          y <- xx[3]
        }
      })) 
    })
    
    y <- unlist(lapply(starter, function(xx){
      unlist(lapply(1:length(xx), function(j){
        flag <- TRUE
        k <- 1
        if(j > 1){
          while(flag){
            flag <- length(xx[(j-k):j]) == length(unique(xx[(j-k):j]))
            if(!flag){
              break
            }
            else{
              k <- k + 1
            }
            if(k == j){
              break
            }
          }
        }
        k
      }))
    }))
    mean(y)
    
  }))))
  
  unique_team <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    c(xx, nrow(unique(pitchers %>% filter(yearID == xx) %>% select(teamID))))
  }))
  
  rotation_player <- data.frame(yearID = years, rotation = ceiling(rotation_bound[,2] * unique_team[,2]))
  
  cutoff <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    m <- pitchers %>% filter(yearID == xx) %>% arrange(-IP)
    index <- rotation_player$rotation[rotation_player$yearID == xx]
    data.frame(thres = (m$IP[index]), yearID = xx)
  }))
  
  pitchers <- merge(pitchers, cutoff, by = 'yearID')
  
  pitchers <- pitchers %>% mutate(full_time = ifelse(IP >= thres, 'Y', 'N'))
  
  pitchers_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- pitchers %>% filter(yearID == xx)
    lg_avg <- sum(int$bWAR)/sum(int$IP)
    int %>% mutate(comp = (bWAR + lg_avg * 14)/(IP + 14))
  }))
  
  pitchers_talent_bWAR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
    talent_computing_nonpara(dataset = pitchers_schell, component_name = "bWAR_p", year = yy, 
                             ystar = thresh_fun(component = pitchers_schell %>% 
                                                 filter(full_time =='Y', yearID == yy) %>%
                                                 select(comp), component_name = 'bWAR_p'), alpha = 1.16)
  })) %>% arrange(-WAR_talent)
  
  no_strike <- pitchers_talent_bWAR %>% 
    filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  
  min_refbWAR <- -2
  
  t <- isoreg(no_strike$WAR_talent, no_strike$comp)
  
  talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,154)/154)
  comp_new <- as.stepfun(t)(talent_new)
  
  ystar <- thresh_fun(comp_new, component_name = 'bWAR_p')
  pop_new <- round(mean(no_strike$pops))
  component_name = 'bWAR_p'
  yy <- sort(comp_new)
  n <- length(yy)
  ytilde <- rep(0, n + 1)
  if (component_name == 'ERA') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
  }
  if (component_name == 'bWAR_p'| component_name == 'fWAR_p') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])/10
  }
  if (component_name == 'SO') {
    ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
  }
  ytilde[n+1] <- yy[n] + ystar
  ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2 
  }))
  
  career_kAB <- do.call(rbind, mclapply(1:nrow(pitchers_talent_bWAR), function(xx){
    int <- career_talent_nonpara(dataset = pitchers_talent_bWAR, component_name = 'bWAR_p', 
                         snippet = pitchers_talent_bWAR[xx,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
  ## mapping statistics
  
  mapped_quan_p <- do.call(rbind, mclapply(years, function(xx){
    pitchers_full <- pitchers %>% filter(yearID == xx) %>% 
      filter(full_time == 'Y') %>% arrange(-IP)
    pitchers_less <- pitchers %>% filter(yearID == xx) %>% 
      filter(full_time == 'N') %>% arrange(-IP)
    
    n1 <- nrow(pitchers_full)
    n2 <- nrow(pitchers_less)
    
    mapped_IP_full <- c()
    mapped_IP_less <- c()
    for (yy in c(1977:1980, 1982:1989)) {
      pitchers_ref_full <- pitchers %>% 
        filter(yearID == yy, full_time == 'Y') %>% arrange(-IP)
      pitchers_ref_less <- pitchers %>% 
        filter(yearID == yy, full_time == 'N') %>% arrange(-IP)
      n1r <- nrow(pitchers_ref_full)
      n2r <- nrow(pitchers_ref_less)
      
      mapped_IP_full <- cbind(mapped_IP_full, approx(x = seq((n1r-1),0)/(n1r-1), 
                                                     y = pitchers_ref_full$IP,
                                                     xout = seq((n1-1),0)/(n1-1))$y)
      mapped_IP_less <- cbind(mapped_IP_less, approx(x = seq((n2r-1),0)/(n2r-1), 
                                                     y = pitchers_ref_less$IP, 
                                                     xout = seq((n2-1),0)/(n2-1))$y)
    }
    
    pitchers_full$mapped_IP <- rowMeans(mapped_IP_full)
    pitchers_less$mapped_IP <- rowMeans(mapped_IP_less)
    
    m <- rbind(pitchers_full, pitchers_less)
    data.frame(playerID = m$playerID, yearID = m$yearID, 
               mapped_IP_raw = round(m$mapped_IP))
    
  }, mc.cores = ncores))
  
  mapped_pitchers_1 <- merge(career_kAB, mapped_quan_p, 
                             by = c('playerID', 'yearID'))
  
  mapped_pitchers_bWAR_fixed <- mapped_pitchers_1 %>% 
    mutate(adj_bWAR = adj_comp * mapped_IP_raw) %>%
    mutate(adj_bWAR = ifelse(adj_bWAR < min_refbWAR, min_refbWAR, adj_bWAR)) %>%
    mutate(mapped_IP_bWAR = round(adj_bWAR / adj_comp))
  
```

```{r cache=TRUE, echo=FALSE}
pitchers <- pit_dat %>% 
    select(playerID, yearID, name, age, lgID, teamID, IP, pops, fWAR)
pitchers$pops <- 1e6
  pitchers <- pitchers %>% mutate(comp = fWAR / IP)
  pitchers$comp[is.na(pitchers$comp)] = 0
  
  pitchers <- merge(pitchers, cutoff, by = 'yearID')
  
  pitchers <- pitchers %>% mutate(full_time = ifelse(IP >= thres, 'Y', 'N'))
  
  pitchers_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- pitchers %>% filter(yearID == xx)
    lg_avg <- sum(int$fWAR)/sum(int$IP)
    int %>% mutate(comp = (fWAR + lg_avg * 14)/(IP + 14))
  }))
  
  
  pitchers_talent_fWAR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
    talent_computing_nonpara(dataset = pitchers_schell, component_name = "fWAR_p", year = yy, 
                             ystar = thresh_fun(component = pitchers_schell %>% 
                                                 filter(full_time =='Y', yearID == yy) %>%
                                                 select(comp), component_name = 'fWAR_p'), alpha = 1.16)
  })) %>% arrange(-WAR_talent)
  
  ## rotation talent adjustment
  
  no_strike <- pitchers_talent_fWAR %>% 
    filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  min_reffWAR <- -2
  t <- isoreg(no_strike$WAR_talent, no_strike$comp)
  
  
  talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,154)/154)
  comp_new <- as.stepfun(t)(talent_new)
  
  ystar <- thresh_fun(comp_new, component_name = 'fWAR_p')
  pop_new <- round(mean(no_strike$pops))
  component_name = 'fWAR_p'
  yy <- sort(comp_new)
  n <- length(yy)
  ytilde <- rep(0, n + 1)
  if (component_name == 'ERA') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
  }
  if (component_name == 'bWAR_p'| component_name == 'fWAR_p') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])/10
  }
  if (component_name == 'SO') {
    ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
  }
  ytilde[n+1] <- yy[n] + ystar
  ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2 
  }))
  
  career_kAB <- do.call(rbind, mclapply(1:nrow(pitchers_talent_fWAR), function(xx){
    int <- career_talent_nonpara(dataset = pitchers_talent_fWAR, component_name = 'fWAR_p', 
                         snippet = pitchers_talent_fWAR[xx,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
  mapped_pitchers_1 <- merge(career_kAB, mapped_quan_p, 
                             by = c('playerID', 'yearID'))
  
  mapped_pitchers_fWAR_fixed <- mapped_pitchers_1 %>% 
    mutate(adj_fWAR = adj_comp * mapped_IP_raw) %>%
    mutate(adj_fWAR = ifelse(adj_fWAR < min_reffWAR, min_reffWAR, adj_fWAR)) %>%
    mutate(mapped_IP_fWAR = round(adj_fWAR / adj_comp))
  
  mapped_quan_p_merge <- merge(mapped_pitchers_bWAR_fixed %>% select(yearID, playerID, mapped_IP_bWAR), 
                         mapped_pitchers_fWAR_fixed %>% select(yearID, playerID, mapped_IP_fWAR), 
                         by = c('yearID', 'playerID')) 
  mapped_quan_p_merge$mapped_IP <- apply(mapped_quan_p_merge[,c(3,4)], 1, min)
  mapped_quan_p <- mapped_quan_p_merge %>% select(yearID, playerID, mapped_IP)
  
```

```{r cache=TRUE, echo=FALSE}
pitchers <- pit_dat %>% 
    select(playerID, yearID, name, age, lgID, teamID, IP, pops, SO)
pitchers$pops <- 1e6
  pitchers <- pitchers %>% mutate(comp = SO / IP *9)
  pitchers$comp[is.na(pitchers$comp)] = 0
  
  pitchers <- merge(pitchers, cutoff, by = 'yearID')
  
  pitchers <- pitchers %>% mutate(full_time = ifelse(IP >= thres, 'Y', 'N'))
  
  pitchers_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- pitchers %>% filter(yearID == xx)
    lg_avg <- sum(int$SO)/sum(int$IP)
    int %>% mutate(comp = (SO + lg_avg * 14)/(IP + 14) * 9)
  }))
  
  pitchers_talent_SO <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
    talent_computing_nonpara(dataset = pitchers_schell, component_name = "SO", year = yy, 
                             ystar = thresh_fun(component = pitchers_schell %>% 
                                                 filter(full_time =='Y', yearID == yy) %>%
                                                 select(comp), component_name = 'SO'), alpha = 1.16)
  })) %>% arrange(-WAR_talent)
  
  ## rotation talent adjustment
  
  no_strike <- pitchers_talent_SO %>% 
    filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  min_refSO <- min(no_strike$SO)
  t <- isoreg(no_strike$WAR_talent, no_strike$comp)
  
  talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,154)/154)
  comp_new <- as.stepfun(t)(talent_new)
  
  ystar <- thresh_fun(comp_new, component_name = 'SO')
  pop_new <- round(mean(no_strike$pops))
  component_name = 'SO'
  yy <- sort(comp_new)
  n <- length(yy)
  ytilde <- rep(0, n + 1)
  if (component_name == 'ERA') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
  }
  if (component_name == 'bWAR_p'| component_name == 'fWAR_p') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])/10
  }
  if (component_name == 'SO') {
    ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
  }
  ytilde[n+1] <- yy[n] + ystar
  ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2 
  }))
  
  career_kAB <- do.call(rbind, mclapply(1:nrow(pitchers_talent_SO), function(xx){
    int <- career_talent_nonpara(dataset = pitchers_talent_SO, component_name = 'SO', 
                         snippet = pitchers_talent_SO[xx,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
  mapped_pitchers_1 <- merge(career_kAB, mapped_quan_p, 
                             by = c('playerID', 'yearID'))
  
  mapped_pitchers_SO_fixed <- mapped_pitchers_1 %>% 
    mutate(adj_SO = adj_comp * mapped_IP / 9) %>%
    mutate(adj_SO = ifelse(adj_SO < min_refSO, min_refSO, adj_SO))
  
```

```{r cache=TRUE, echo=FALSE}
pitchers <- pit_dat %>% 
    select(playerID, yearID, name, age, lgID, teamID, IP, pops, ER)
pitchers$pops <- 1e6
  pitchers <- pitchers %>% mutate(comp = -9*ER / IP)
  pitchers$comp[is.na(pitchers$comp)] = 0
  
  pitchers <- merge(pitchers, cutoff, by = 'yearID')
  
  pitchers <- pitchers %>% mutate(full_time = ifelse(IP >= thres, 'Y', 'N'))
  
  pitchers_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- pitchers %>% filter(yearID == xx)
    lg_avg <- sum(int$ER)/sum(int$IP)
    int %>% mutate(comp = -9*(ER + lg_avg * 14)/(IP + 14) )
  }))
  
  pitchers_talent_ERA <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
    talent_computing_nonpara(dataset = pitchers_schell, component_name = "ERA", year = yy, 
                             ystar = thresh_fun(component = pitchers_schell %>% 
                                                 filter(full_time =='Y', yearID == yy) %>%
                                                 select(comp), component_name = 'ERA'), alpha = 1.16)
  })) %>% arrange(-WAR_talent)
  
  ## rotation talent adjustment
  
  no_strike <- pitchers_talent_ERA %>% 
    filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  min_refERA <- min(no_strike$ERA)
  
  t <- isoreg(no_strike$WAR_talent, no_strike$comp)
  
  
  talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,154)/154)
  comp_new <- as.stepfun(t)(talent_new)
  
  ystar <- thresh_fun(comp_new, component_name = 'ERA')
  pop_new <- round(mean(no_strike$pops))
  component_name = 'ERA'
  yy <- sort(comp_new)
  n <- length(yy)
  ytilde <- rep(0, n + 1)
  if (component_name == 'ERA') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
  }
  if (component_name == 'bWAR_p'| component_name == 'fWAR_p') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])/10
  }
  if (component_name == 'SO') {
    ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
  }
  ytilde[n+1] <- yy[n] + ystar
  ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2 
  }))
  
  career_kAB <- do.call(rbind, mclapply(1:nrow(pitchers_talent_ERA), function(xx){
    int <- career_talent_nonpara(dataset = pitchers_talent_ERA, component_name = 'ERA', 
                         snippet = pitchers_talent_ERA[xx,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
  mapped_pitchers_1 <- merge(career_kAB, mapped_quan_p, 
                           by = c('playerID', 'yearID'))
  
  mapped_pitchers_ERA_fixed <- mapped_pitchers_1 %>% 
    mutate(adj_ERA = ifelse(adj_comp > min_refERA, min_refERA, adj_comp))
  
```

```{r echo=FALSE}
ERA_part_fixed <- mapped_pitchers_ERA_fixed %>% 
    mutate(mapped_IP = round(mapped_IP, 1)) %>%
    mutate(adj_ERA = round(-adj_comp, 3)) %>%
    select(yearID, playerID, name, IP, mapped_IP, adj_ERA)
  SO_part_fixed <- mapped_pitchers_SO_fixed %>% 
    mutate(adj_SO = round(adj_SO))%>%
    select(yearID, playerID, SO, adj_SO)
  bWAR_part_fixed <- mapped_pitchers_bWAR_fixed %>% 
    mutate(adj_bWAR = round(adj_bWAR, 2)) %>% 
    select(yearID, playerID, adj_bWAR, full_time)
  fWAR_part_fixed <- mapped_pitchers_fWAR_fixed %>%
    mutate(adj_fWAR = round(adj_fWAR, 2)) %>% 
    select(yearID, age, playerID, adj_fWAR) 
  
  master_pitchers_fixed <- merge(ERA_part_fixed, merge(SO_part_fixed, merge(bWAR_part_fixed, fWAR_part_fixed, by = c('yearID', 'playerID')), 
                                           by = c('yearID', 'playerID')), by = c('yearID', 'playerID'))
  ## Pitchers
  pitchers <- master_pitchers_fixed %>% 
    mutate(adj_K9 = round(adj_SO/mapped_IP*9,1), 
           K9 = round(SO/IP*9,1), 
           adj_fWAR = round(adj_fWAR, 2))
  pitchers <- as.data.frame(pitchers)
  #pitchers$avg_ERA[pitchers$avg_ERA > 6.20] <- 6.20
  #pitchers <- pitchers[pitchers$adj_bWAR != 0, ]
  
  ## extract and remove bad pitchers 
  foo <- pitchers %>% 
    arrange(adj_ERA) %>% 
    filter(mapped_IP >= 100) %>% 
    dplyr::select(name, playerID, yearID, mapped_IP, adj_ERA, adj_SO, adj_fWAR, adj_bWAR)
  bar <- split(foo, as.factor(foo$playerID))
  baz <- do.call(rbind, lapply(bar, function(m){
    m[which.max(m$adj_fWAR), ]
  }))
  baz <- baz %>% arrange(adj_fWAR)
  bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
  
  baz <- do.call(rbind, lapply(bar, function(m){
    m[which.max(m$adj_bWAR), ]
  }))
  baz <- baz %>% arrange(adj_bWAR)
  bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
  bad_players <- union(bad_players_bWAR, bad_players_fWAR)
  pitchers <- pitchers[!pitchers$playerID %in% bad_players, ]
  
  
  ## build adjusted data set
  pitchers_adjusted <- pitchers %>% dplyr::select(name, playerID, age, yearID, 
                                                  mapped_IP, adj_ERA, adj_SO, adj_bWAR, adj_fWAR, full_time)
  colnames(pitchers_adjusted) <- c("name", "playerID", "age", "year", "IP", 
                                   "adj_ERA", "adj_SO", "adj_bWAR", "adj_fWAR", "full_time")
  pitchers_adjusted$playerID <- droplevels(as.factor(pitchers_adjusted$playerID))
  
  ## trim out bad players
  # first round
  foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
  bar <- lapply(foo, function(m){
    ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
  })
  checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                        m_bad = unlist(lapply(bar, mean)),
                        len = unlist(lapply(bar, length)))
  pitchers_adjusted <- pitchers_adjusted %>%
    filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
  pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)

  # second round
  foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
  bar <- lapply(foo, function(m){
    ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
  })
  checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                        m_bad = unlist(lapply(bar, mean)),
                        len = unlist(lapply(bar, length)))
  pitchers_adjusted <- pitchers_adjusted %>%
    filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
  pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)

  # third round
  foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
  bar <- lapply(foo, function(m){
    min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
  })
  checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                        m_bad = unlist(lapply(bar, mean)),
                        len = unlist(lapply(bar, length)))
  pitchers_adjusted <- pitchers_adjusted %>%
    filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
  pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)

  # forth round
  foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
  bar <- lapply(foo, function(m){
    ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
  })
  checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                        m_bad = unlist(lapply(bar, mean)),
                        len = unlist(lapply(bar, length)))
  pitchers_adjusted <- pitchers_adjusted %>%
    filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
  pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)
  
  
  ## remove tails 
  foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
  bar <- lapply(foo, function(m){
    bad <- ifelse(m$adj_bWAR <= 0.41, 1, 0) + ifelse(m$adj_fWAR <= 0.4, 1, 0)
    bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                      ifelse(sum(tail(bad, 3)) >= 5,1,0),
                      ifelse(sum(tail(bad, 4)) >= 7,1,0),
                      ifelse(sum(tail(bad, 5)) >= 9,1,0),
                      ifelse(sum(tail(bad, 6)) >= 11,1,0)))
    1:(length(bad)-bad_tail)
  })
  pitchers_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
    foo[[j]][bar[[j]], ]
  })) %>% arrange(year)
  
  foo <- split(pitchers_adjusted_1, f = pitchers_adjusted_1$playerID)
  bar <- lapply(foo, function(m){
    bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
    bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                      ifelse(sum(tail(bad, 3)) >= 3,1,0),
                      ifelse(sum(tail(bad, 4)) >= 4,1,0),
                      ifelse(sum(tail(bad, 5)) >= 5,1,0),
                      ifelse(sum(tail(bad, 6)) >= 6,1,0)))
    1:(length(bad)-bad_tail)
  })
  pitchers_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
    foo[[j]][bar[[j]], ]
  })) %>% arrange(year)
  
  foo <- split(pitchers_adjusted_2, f = pitchers_adjusted_2$playerID)
  bar <- lapply(foo, function(m){
    bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
    bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                      ifelse(sum(tail(bad, 3)) >= 3,1,0),
                      ifelse(sum(tail(bad, 4)) >= 4,1,0),
                      ifelse(sum(tail(bad, 5)) >= 5,1,0),
                      ifelse(sum(tail(bad, 6)) >= 6,1,0)))
    1:(length(bad)-bad_tail)
  })
  pitchers_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
    foo[[j]][bar[[j]], ]
  })) %>% arrange(year)
  
  ## remove starts
  foo <- split(pitchers_adjusted_3, f = pitchers_adjusted_3$playerID)
  bar <- lapply(foo, function(m){
    bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
    bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                      ifelse(sum(head(bad, 2)) >= 3,1,0),
                      ifelse(sum(head(bad, 3)) >= 5,1,0),
                      ifelse(sum(head(bad, 4)) >= 7,1,0),
                      ifelse(sum(head(bad, 5)) >= 9,1,0),
                      ifelse(sum(head(bad, 6)) >= 11,1,0)))
    if (bad_head < length(bad)) {
      (bad_head + 1):length(bad)
    }
  })
  pitchers_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
    foo[[j]][bar[[j]], ]
  })) %>% arrange(year)
  
  pitchers_adjusted_4$playerID <- droplevels(pitchers_adjusted_4$playerID)
  
  # taper down average WAR for players with small innings
  pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_fWAR <- 
    round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_fWAR/9,2)
  pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_bWAR <- 
    round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_bWAR/9,2)	
  pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                        pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_fWAR <- 
    round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                                pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_fWAR/9, 2)
  pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                        pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_bWAR <- 
    round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                                pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_bWAR/9, 2)
  
  
  pitchers_adjusted <- do.call(rbind, mclapply(
    split(pitchers_adjusted_4, f = droplevels(as.factor(pitchers_adjusted_4$playerID))), 
    mc.cores = ncores, FUN = function(xx){
      ## natural cubic spline
      ns_ERA = lm(adj_ERA ~ ns(year, df=6), data=xx)
      nn_ERA <- predict(ns_ERA, data.frame("year"= xx$year))
      ns_SO = lm(adj_SO ~ ns(year, df=6), data=xx)
      nn_SO <- predict(ns_SO, data.frame("year"= xx$year))
      ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
      nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
      ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
      nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
      
      xx %>% mutate(ERA = round((adj_ERA + nn_ERA)/2, 3)) %>% 
        mutate(SO = round((adj_SO + nn_SO)/2)) %>%
        mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
        mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
    })) 
  
  pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)
  pitchers_adjusted <- pitchers_adjusted %>% 
    mutate(ER = round(ERA * IP / 9)) %>%
    mutate(ERA = round(ER / IP *9, 2)) %>% 
    mutate(ERA = ifelse(is.na(ERA), 0, ERA))
  
  rownames(pitchers_adjusted) <- c()
  
  pit_season_fixed <- pitchers_adjusted %>% 
    mutate(IP = ceiling(IP)) %>% 
    mutate(ERA = round(ER/IP*9, 2))
  colnames(pit_season_fixed)[12] <- 'K'
  pit_season_fixed[which(pit_season_fixed$K >= 1.5*pit_season_fixed$IP), ]$K <- 
    round(1.5*pit_season_fixed[which(pit_season_fixed$K >= 1.5*pit_season_fixed$IP), ]$IP)
  
  pit_season_fixed <- pit_season_fixed %>% dplyr::select(-c(adj_bWAR, adj_fWAR, adj_ERA, adj_SO, full_time))
  
  pit_career_fixed <- pit_season_fixed %>% group_by(playerID) %>% 
    summarise(name = unique(name), 
              playerID = unique(playerID), 
              IP = sum(IP), 
              ER = sum(ER), 
              ERA = round(ER/IP*9,2), 
              K = sum(K), 
              ebWAR = sum(ebWAR), 
              efWAR = sum(efWAR)) %>% 
    arrange(desc(ebWAR))
```

The following tables display the results with the fixed MLB-eligible population.

Top 25 combined bWAR and fWAR rankings:

```{r echo=FALSE}
## bWAR
m_b <- bat_career_fixed %>% 
  select(name, playerID, ebWAR)

m_p <- pit_career_fixed %>% 
  select(name, playerID, ebWAR)

m_ebWAR<- rbind(m_b, m_p)

index <- which(m_ebWAR$name == "Babe Ruth")
m_ebWAR$ebWAR[index[1]] <- sum(m_ebWAR$ebWAR[index])
index <- which(m_ebWAR$name == "Shohei Ohtani")
m_ebWAR$ebWAR[index[1]] <- sum(m_ebWAR$ebWAR[index])

## fWAR
m_b <- bat_career_fixed %>% 
  select(name, playerID, efWAR)

m_p <- pit_career_fixed %>% 
  select(name, playerID, efWAR)

m_efWAR<- rbind(m_b, m_p)

index <- which(m_efWAR$name == "Babe Ruth")
m_efWAR$efWAR[index[1]] <- sum(m_efWAR$efWAR[index])
index <- which(m_efWAR$name == "Shohei Ohtani")
m_efWAR$efWAR[index[1]] <- sum(m_efWAR$efWAR[index])

WAR_rankings <- cbind((m_ebWAR%>% arrange(desc(ebWAR)))$name[1:25], (m_efWAR%>% arrange(desc(efWAR)))$name[1:25])

colnames(WAR_rankings) <- c('ebWAR', 'efWAR')
kable(WAR_rankings)
```

Top 25 BA, OBP and HR leaders

```{r echo=FALSE}
rookie_year <- master_batters_fixed %>% group_by(playerID) %>% 
  summarise(rookie_year = min(yearID))
batcar_year <- merge(bat_career_fixed, rookie_year, by = 'playerID')
rownames(batcar_year) <- c()

zz_BA <- (batcar_year %>% arrange(desc(BA)) %>% 
             filter(AB >= 3000, rookie_year <= 2011) %>%
  select(name, BA))[1:25,]
zz_OBP <- (batcar_year %>% arrange(desc(OBP)) %>% 
             filter(AB >= 3000, rookie_year <= 2011) %>%
         select(name, OBP))[1:25,]
zz_HR <- (batcar_year %>% arrange(desc(HR))  %>% 
            filter(rookie_year <= 2005) %>%
         select(name, HR))[1:25,]
BA_OBP_HR <- cbind(zz_BA, zz_OBP, zz_HR)
colnames(BA_OBP_HR) <- c('name', 'BA', 'name', 'OBP', 'name', 'HR')
kable(BA_OBP_HR)
```

Top 25 bWAR and fWAR batting leaders

```{r echo=FALSE}
zz_bWAR <- (batcar_year %>% arrange(desc(ebWAR))  %>%
              filter(rookie_year <= 2005) %>%
         select(name, ebWAR))[1:25,]
zz_fWAR <- (batcar_year %>% arrange(desc(efWAR))  %>%
              filter(rookie_year <= 2005) %>%
         select(name, efWAR))[1:25,]

ebWAR_efWAR_b <- cbind(zz_bWAR, zz_fWAR)
colnames(ebWAR_efWAR_b) <- c('name', 'ebWAR', 'name', 'efWAR')
kable(ebWAR_efWAR_b)
```

Top 25 IP, ERA, SO leaders

```{r echo=FALSE}
rookie_year <- master_pitchers_fixed %>% group_by(playerID) %>% 
  summarise(rookie_year = min(yearID))
pitcar_year <- merge(pit_career_fixed, rookie_year, by = 'playerID')

zz_IP <- (pitcar_year %>% arrange(desc(IP)) %>%
            filter(rookie_year <= 2005) %>%
             select(name,IP))[1:25,]
zz_ERA <- (pitcar_year %>% arrange(ERA) %>% filter(IP >= 1500) %>% filter(rookie_year <= 2011) %>%
         select(name,ERA))[1:25,]
zz_K <- (pitcar_year %>% arrange(desc(K)) %>%
           filter(rookie_year <= 2005) %>%
         select(name, K))[1:25,]

IP_ERA_K <- cbind(zz_IP, zz_ERA, zz_K)
colnames(IP_ERA_K) <- c('name', 'IP', 'name', 'ERA', 'name', 'SO')
kable(IP_ERA_K)
```

Top 25 bWAR and fWAR pitching leaders

```{r echo=FALSE}
zz_bWAR <- (pitcar_year %>% arrange(desc(ebWAR))  %>%
              filter(rookie_year <= 2005) %>%
         select(name, ebWAR))[1:25,]
zz_fWAR <- (pitcar_year %>% arrange(desc(efWAR))  %>%
              filter(rookie_year <= 2005) %>%
         select(name, efWAR))[1:25,]

ebWAR_efWAR_p <- cbind(zz_bWAR, zz_fWAR)
colnames(ebWAR_efWAR_p) <- c('name', 'ebWAR', 'name', 'efWAR')
kable(ebWAR_efWAR_p)
```

```{r echo=FALSE, cache=TRUE}
load("bat_pit.RData")
batters <- bat_dat %>% select(yearID, playerID, lgID, name, age, PA, G, bWAR, pops)
cutoff <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    m <- batters %>% filter(yearID == xx) %>% filter(PA >= 75)
    data.frame(thres = median(m$PA), yearID = xx)
  }))
batters <- merge(batters, cutoff, by = 'yearID')
batters <- batters %>% mutate(comp =  bWAR / G, full_time = ifelse(PA >= thres, 'Y', 'N'))
```

```{r echo=FALSE, cache=TRUE}
batters_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- batters %>% filter(yearID == xx)
    lg_avg <- sum(int$bWAR)/sum(int$G)
    int %>% mutate(comp = (bWAR + lg_avg * 7)/(G + 7))
  }))
```

```{r echo=FALSE, cache=TRUE}
batters_talent_bWAR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
  talent_computing_nonpara(dataset = batters_schell, component_name = "bWAR", year = yy, ystar = thresh_fun(component = batters_schell %>% filter(full_time == 'Y', yearID == yy) %>% select(comp), component_name = 'bWAR'), alpha = 1.16) })) %>% arrange(-WAR_talent)
```

```{r echo=FALSE, cache=TRUE}
no_strike <- batters_talent_bWAR %>% 
    filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  
t <- isoreg(no_strike$WAR_talent, no_strike$comp)
talent_new <- quantile(no_strike$WAR_talent, probs = (seq(0,250)/250))
comp_new <- as.stepfun(t)(talent_new)
```

```{r echo=FALSE}
ystar <- thresh_fun(comp_new, component_name = 'bWAR')
pop_new <- round(mean(no_strike$pops))
component_name = 'bWAR'
yy <- sort(comp_new)
n <- length(yy)
ytilde <- rep(0, n + 1)
if (component_name == 'bWAR' | component_name == 'fWAR') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
}
if (component_name == 'HR' | component_name == 'BB') {
    # since the minimal HR is greater or equal to 0.
    ytilde[1] <- 0
}
ytilde[n+1] <- yy[n] + ystar
ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2 
}))
```

```{r echo=FALSE, cache=TRUE}
career_kAB_1st <- do.call(rbind, mclapply(1:30000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                         snippet = batters_talent_bWAR[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores))
  
  
career_kAB_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                         snippet = batters_talent_bWAR[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
career_kAB_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_bWAR), function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_bWAR, component_name = 'bWAR', 
                         snippet = batters_talent_bWAR[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
career_kAB <- rbind(career_kAB_1st, career_kAB_2nd, career_kAB_3rd)
```

```{r cache=TRUE, echo=FALSE}
## mapping statistics
  
mapped_quan_b_raw <- do.call(rbind, mclapply(years, function(xx){
    batters_full <- batters %>% filter(yearID == xx) %>% 
      filter(full_time == 'Y') %>% arrange(-G)
    batters_less <- batters %>% filter(yearID == xx) %>% 
      filter(full_time == 'N') %>% arrange(-G)
    
    n1 <- nrow(batters_full)
    n2 <- nrow(batters_less)
    
    mapped_G_full <- c()
    mapped_G_less <- c()
    for (yy in c(1977:1980, 1982:1989)) {
      batters_ref_full <- batters %>% 
        filter(yearID == yy, full_time == 'Y') %>% arrange(-G)
      batters_ref_less <- batters %>% 
        filter(yearID == yy, full_time == 'N') %>% arrange(-G)
      n1r <- nrow(batters_ref_full)
      n2r <- nrow(batters_ref_less)
      
      mapped_G_full <- cbind(mapped_G_full, approx(x = seq((n1r-1),0)/(n1r-1), 
                                                   y = batters_ref_full$G, 
                                                   xout = seq((n1-1),0)/(n1-1))$y)
      mapped_G_less <- cbind(mapped_G_less, approx(x = seq((n2r-1),0)/(n2r-1), 
                                                   y = batters_ref_less$G, 
                                                   xout = seq((n2-1),0)/(n2-1))$y)
    }
    
    batters_full$mapped_G <- rowMeans(mapped_G_full)
    batters_less$mapped_G <- rowMeans(mapped_G_less)
    
    
    batters_full <- batters_full %>% arrange(-PA)
    batters_less <- batters_less %>% arrange(-PA)
    mapped_PA_full <- c()
    mapped_PA_less <- c()
    for (yy in c(1977:1980, 1982:1989)) {
      batters_ref_full <- batters %>% 
        filter(yearID == yy, full_time == 'Y') %>% arrange(-PA)
      batters_ref_less <- batters %>% 
        filter(yearID == yy, full_time == 'N') %>% arrange(-PA)
      n1r <- nrow(batters_ref_full)
      n2r <- nrow(batters_ref_less)
      
      mapped_PA_full <- cbind(mapped_PA_full, approx(x = seq((n1r-1),0)/(n1r-1), 
                                                     y = batters_ref_full$PA, 
                                                     xout = seq((n1-1),0)/(n1-1))$y)
      mapped_PA_less <- cbind(mapped_PA_less, approx(x = seq((n2r-1),0)/(n2r-1), 
                                                     y = batters_ref_less$PA, 
                                                     xout = seq((n2-1),0)/(n2-1))$y)
    }
    
    batters_full$mapped_PA <- rowMeans(mapped_PA_full)
    batters_less$mapped_PA <- rowMeans(mapped_PA_less)
    
    m <- rbind(batters_full, batters_less)
    data.frame(playerID = m$playerID, yearID = m$yearID,
               mapped_G_raw = round(m$mapped_G), mapped_PA_raw = round(m$mapped_PA))
    
  }, mc.cores = ncores))
   
mapped_batters_1 <- merge(career_kAB, mapped_quan_b_raw, 
                            by = c('playerID', 'yearID'))
  
min_refbWAR <- -2
  
mapped_batters_bWAR <- mapped_batters_1 %>% 
    mutate(adj_bWAR = adj_comp * mapped_G_raw) %>% 
    mutate(adj_bWAR = ifelse(adj_bWAR < min_refbWAR, min_refbWAR, adj_bWAR)) %>%
    mutate(mapped_G_bWAR = round(adj_bWAR / adj_comp))
```

```{r cache=TRUE, echo=FALSE}
batters <- bat_dat %>% select(yearID, playerID, lgID, name, age, PA, G, bWAR,fWAR,pops)
  
  batters <- merge(batters, cutoff, by = 'yearID')
  
  batters <- batters %>% mutate(comp =  fWAR / G, full_time = ifelse(PA >= thres, 'Y', 'N'))
  
  batters_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- batters %>% filter(yearID == xx)
    lg_avg <- sum(int$fWAR)/sum(int$G)
    int %>% mutate(comp = (fWAR + lg_avg * 7)/(G + 7))
  }))
  
  batters_talent_fWAR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
    talent_computing_nonpara(dataset = batters_schell, component_name = "fWAR", year = yy, 
                             ystar = thresh_fun(component = batters_schell %>% filter(full_time == 'Y', yearID == yy) %>% select(comp), component_name = 'fWAR'), alpha = 1.16)
  })) %>% arrange(-WAR_talent)
  
  no_strike <- batters_talent_fWAR %>% 
    filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  
  t <- isoreg(no_strike$WAR_talent, no_strike$comp)
  
  talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,250)/250)
  
  comp_new <- as.stepfun(t)(talent_new)
  
  ystar <- thresh_fun(comp_new, component_name = 'fWAR')
  pop_new <- round(mean(no_strike$pops))
  component_name = 'fWAR'
  yy <- sort(comp_new)
  n <- length(yy)
  ytilde <- rep(0, n + 1)
  if (component_name == 'bWAR' | component_name == 'fWAR') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
  }
  if (component_name == 'HR' | component_name == 'BB') {
    # since the minimal HR is greater or equal to 0.
    ytilde[1] <- 0
  }
  ytilde[n+1] <- yy[n] + ystar
  ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2 
  }))
  
  career_kAB_1st <- do.call(rbind, mclapply(1:30000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_fWAR, component_name = 'fWAR', 
                         snippet = batters_talent_fWAR[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores))
  
  
  career_kAB_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_fWAR, component_name = 'fWAR', 
                         snippet = batters_talent_fWAR[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
  career_kAB_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_fWAR), function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_fWAR, component_name = 'fWAR', 
                         snippet = batters_talent_fWAR[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
  career_kAB <- rbind(career_kAB_1st, career_kAB_2nd, career_kAB_3rd)
  
  mapped_batters_1 <- merge(career_kAB, mapped_quan_b_raw, 
                            by = c('playerID', 'yearID'))
  
  min_reffWAR <- -2
  
  mapped_batters_fWAR <- mapped_batters_1 %>% 
    mutate(adj_fWAR = adj_comp * mapped_G_raw) %>% 
    mutate(adj_fWAR = ifelse(adj_fWAR < min_reffWAR, min_reffWAR, adj_fWAR)) %>%
    mutate(mapped_G_fWAR = round(adj_fWAR / adj_comp))
```

```{r cache=TRUE, echo=FALSE}
batters_HR <- bat_dat %>% 
    select(yearID, playerID, lgID, name, PA, AB, HR, BB, HBP, SH, SF, bWAR, pops)
  
  cutoff <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    m <- batters_HR %>% filter(yearID == xx) %>% filter(PA >= 75)
    data.frame(thres = median(m$PA), yearID = xx)
  }))
  
  batters <- merge(batters_HR, cutoff, by = 'yearID')
  
  batters <- batters %>% mutate(comp =  ifelse(AB != 0, HR / AB, 0), full_time = ifelse(PA >= thres, 'Y', 'N'))
  
  batters_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- batters %>% filter(yearID == xx)
    lg_avg <- sum(int$HR)/sum(int$AB)
    int %>% mutate(comp = (HR + lg_avg * 25)/(AB + 25))
  }))
  
  batters_talent_HR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
    talent_computing_nonpara(dataset = batters_schell, component_name = "HR", 
                             year = yy, ystar = thresh_fun(component = batters_schell %>% 
                                                            filter(full_time == 'Y', yearID == yy) %>%
                                                            select(comp), component_name = 'HR'), 
                             alpha = 1.16)
  })) %>% arrange(-WAR_talent)
  
  no_strike <- batters_talent_HR %>% 
    filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  
  min_refHR <- min(no_strike$HR)
  
  t <- isoreg(no_strike$WAR_talent, no_strike$comp)
  
  talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,250)/250)
  
  comp_new <- as.stepfun(t)(talent_new)
  
  ystar <- thresh_fun(comp_new, component_name = 'HR')
  pop_new <- round(mean(no_strike$pops))
  component_name = 'HR'
  yy <- sort(comp_new)
  n <- length(yy)
  ytilde <- rep(0, n + 1)
  if (component_name == 'bWAR' | component_name == 'fWAR') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
  }
  if (component_name == 'HR' | component_name == 'BB') {
    # since the minimal HR is greater or equal to 0.
    ytilde[1] <- 0
  }
  ytilde[n+1] <- yy[n] + ystar
  ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2 
  }))
  
  career_kAB_1st <- do.call(rbind, mclapply(1:30000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_HR, component_name = 'HR', 
                         snippet = batters_talent_HR[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores))
  
  
  career_kAB_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_HR, component_name = 'HR', 
                         snippet = batters_talent_HR[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
  career_kAB_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_HR), function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_HR, component_name = 'HR', 
                         snippet = batters_talent_HR[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
  career_kAB <- rbind(career_kAB_1st, career_kAB_2nd, career_kAB_3rd)
  
```

```{r cache=TRUE, echo=FALSE}
batters_BB <- bat_dat %>% select(yearID, playerID, lgID, name, G, PA, BB, pops)
  
  batters <- merge(batters_BB, cutoff, by = 'yearID')
  
  batters <- batters %>% mutate(comp = ifelse(PA > 0, BB / PA, 0), full_time = ifelse(PA >= thres, 'Y', 'N'))
  
  batters_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- batters %>% filter(yearID == xx)
    lg_avg <- sum(int$BB)/sum(int$PA)
    int %>% mutate(comp = (BB + lg_avg * 28)/(PA + 28))
  }))
  
  batters_talent_BB <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
    talent_computing_nonpara(dataset = batters_schell, component_name = "BB", 
                             year = yy, ystar = 
                               thresh_fun(component = batters_schell %>% 
                                           filter(full_time == 'Y', yearID == yy) %>% 
                                           select(comp), component_name = 'BB'), alpha = 1.16)
  })) %>% arrange(-WAR_talent)
  
  
  no_strike <- batters_talent_BB %>% 
    filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  
  min_refBB <- 0
  
  t <- isoreg(no_strike$WAR_talent, no_strike$comp)
  
  talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,250)/250)
  
  comp_new <- as.stepfun(t)(talent_new)
  
  ystar <- thresh_fun(comp_new, component_name = 'BB')
  pop_new <- round(mean(no_strike$pops))
  component_name = 'BB'
  yy <- sort(comp_new)
  n <- length(yy)
  ytilde <- rep(0, n + 1)
  if (component_name == 'bWAR' | component_name == 'fWAR') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
  }
  if (component_name == 'HR' | component_name == 'BB') {
    # since the minimal HR is greater or equal to 0.
    ytilde[1] <- 0
  }
  ytilde[n+1] <- yy[n] + ystar
  ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2 
  }))
  
  career_kAB_BB_1st <- do.call(rbind, mclapply(1:30000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_BB, component_name = 'BB', 
                         snippet = batters_talent_BB[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores))
  
  
  career_kAB_BB_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_BB, component_name = 'BB', 
                         snippet = batters_talent_BB[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
  career_kAB_BB_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_BB), function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_BB, component_name = 'BB', 
                         snippet = batters_talent_BB[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
  career_kAB_BB <- rbind(career_kAB_BB_1st, career_kAB_BB_2nd, career_kAB_BB_3rd)
  
  colnames(career_kAB)[colnames(career_kAB) == 'adj_comp'] <- "adj_HR_AB"
  
  career_combined <- merge(career_kAB %>% select(-comp), career_kAB_BB %>% 
                             select(yearID, playerID, comp, adj_comp), by = c('yearID', 'playerID'))
  
  mapped_batters_1 <- merge(career_combined, mapped_quan_b_raw, 
                            by = c('playerID', 'yearID'))
  
  mapped_batters_HR <- mapped_batters_1 %>%
    mutate(adj_BB = ceiling(adj_comp * ceiling(mapped_PA_raw))) %>% 
    mutate(adj_BB = ifelse(adj_BB < min_refBB, min_refBB, adj_BB)) %>% 
    mutate(mapped_PA = mapped_PA_raw) %>%
    mutate(adj_AB = ceiling(mapped_PA) - adj_BB - HBP - SH - SF) %>% 
    mutate(adj_AB = ifelse(adj_AB < 0, 0, adj_AB)) %>% 
    mutate(adj_HR = ceiling(adj_HR_AB * adj_AB)) %>% 
    mutate(adj_HR = ifelse(adj_HR < min_refHR, min_refHR, adj_HR))
  
```

```{r echo=FALSE, cache=TRUE}
batters <- bat_dat
  
  batters <- merge(batters, cutoff, by = 'yearID')
  
  batters <- batters %>% select(playerID, yearID, lgID, name, age, lgID, AB, 
                                PA, obs_hits, H, thres, bWAR, pops) %>%
    mutate(comp = ifelse(AB != 0, H / AB, 0), full_time = ifelse(PA >= thres, 'Y', 'N'))
  
  batters_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- batters %>% filter(yearID == xx)
    lg_avg <- sum(int$H)/sum(int$AB)
    int %>% mutate(comp = (H + lg_avg * 25)/(AB + 25))
  }))
  
```

```{r cache=TRUE, echo=FALSE}
batters_talent_AVG <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
    talent_computing_nonpara(dataset = batters_schell, component_name = "AVG", 
                             year = yy, ystar = thresh_fun(component = batters_schell %>% 
                                                            filter(full_time == 'Y', yearID == yy) %>%
                                                            select(comp), component_name = 'AVG'), 
                             alpha = 1.16)
  })) %>% arrange(-WAR_talent)
  
  no_strike <- batters_talent_AVG %>%
    filter(yearID < 1990, yearID >= 1977, yearID != 1981,
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  
  min_refAVG <- min(no_strike$comp)
  
  t <- isoreg(no_strike$WAR_talent, no_strike$comp)
  
  talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,250)/250)
  
  comp_new <- as.stepfun(t)(talent_new)
  
  ystar <- thresh_fun(comp_new, component_name = 'AVG')
  pop_new <- round(mean(no_strike$pops))
  component_name = 'AVG'
  yy <- sort(comp_new)
  n <- length(yy)
  ytilde <- rep(0, n + 1)
  if (component_name == 'bWAR' | component_name == 'fWAR') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
  }
  if (component_name == 'HR' | component_name == 'BB') {
    # since the minimal HR is greater or equal to 0.
    ytilde[1] <- 0
  }
  if (component_name == 'AVG') {
    ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
  }
  ytilde[n+1] <- yy[n] + ystar
  ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2
  }))
  
  # get career adjustment on season by season basis
  # talent_exp <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
  #   m <- batters_talent_AVG %>% filter(yearID == xx, PA >= thres) %>% pull(bWAR) %>% sort()
  #   n <- length(m)
  #   batters_talent_AVG %>% filter(yearID == xx) %>%
  #     mutate(WAR_talent_exp = WAR_talent + quantile(no_strike$WAR_talent, 1/n) - avg_talent)
  # })) 
  
  career_kAB_AVG_1st <- do.call(rbind, mclapply(1:30000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                         snippet = batters_talent_AVG[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores))
  
  
  career_kAB_AVG_2nd <- do.call(rbind, mclapply(30001:60000, function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                         snippet = batters_talent_AVG[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores))
  
  career_kAB_AVG_3rd <- do.call(rbind, mclapply(60001:nrow(batters_talent_AVG), function(zz){
    int <- career_talent_nonpara(dataset = batters_talent_AVG, component_name = 'AVG',
                         snippet = batters_talent_AVG[zz,], alpha = 1.16)
    int
  }, mc.cores = ncores))
  
  
  career_kAB <- rbind(career_kAB_AVG_1st, 
                      career_kAB_AVG_2nd, 
                      career_kAB_AVG_3rd)
 
  mapped_batters_AVG_nonpara <- career_kAB %>% 
    mutate(adj_AVG = ifelse(adj_comp < min_refAVG, min_refAVG, adj_comp))
  
```

```{r echo=FALSE, cache=TRUE}
AVG_part <- mapped_batters_AVG_nonpara %>%
    mutate(adj_AVG = round(adj_AVG, 3)) %>% 
    select(yearID, playerID, name, adj_AVG) 
  HR_part <- mapped_batters_HR %>% 
    mutate(mapped_PA = round(mapped_PA)) %>% 
    mutate(adj_HR = round(adj_HR)) %>%
    mutate(adj_AB = round(adj_AB)) %>%
    select(yearID, playerID, adj_HR, adj_AB, HBP, SF, mapped_PA) 
  bWAR_part <- mapped_batters_bWAR %>%
    mutate(adj_bWAR = round(adj_bWAR, 2)) %>%
    select(yearID, playerID, adj_bWAR, mapped_G_bWAR) 
  fWAR_part <- mapped_batters_fWAR %>%
    mutate(adj_fWAR = round(adj_fWAR, 2)) %>%
    select(yearID, playerID, age, adj_fWAR, mapped_G_fWAR) 
  BB_part <- mapped_batters_HR %>% 
    mutate(adj_BB = round(adj_BB)) %>%
    select(yearID, playerID, BB, adj_BB)
  master_batters <- merge(BB_part, merge(AVG_part, 
                                         merge(HR_part, merge(bWAR_part, fWAR_part, 
                                                              by = c('yearID', 'playerID')), 
                                               by = c('yearID', 'playerID')), 
                                         by = c('yearID', 'playerID')), 
                          by = c('yearID', 'playerID'))
  
  master_batters <- master_batters %>% 
    mutate(adj_OBP = round((adj_AVG * adj_AB + adj_BB + HBP) / (adj_AB + adj_BB + HBP + SF), 3))
  master_batters$adj_OBP[is.na(master_batters$adj_OBP)] <- 0
  
  master_batters_nonpara <- master_batters %>% mutate(adj_BB = ifelse(adj_BB < 0, 0, adj_BB)) %>% 
    mutate(adj_AB = ifelse(mapped_PA < adj_AB, mapped_PA, adj_AB))
  master_batters_nonpara$mapped_G <- apply(master_batters_nonpara[,c(13,16)], 1, min)
  
  ## Batters
  batters <- master_batters_nonpara

  ## extract and remove bad players 
  foo <- batters %>% 
    arrange(desc(adj_AVG)) %>% 
    filter(adj_AB >= 300) %>% 
    dplyr::select(name, playerID, yearID, adj_AB, adj_AVG, adj_OBP, adj_HR, adj_fWAR, adj_bWAR) %>% 
    mutate(adj_HR_AB = round(adj_HR/adj_AB,4))
  bar <- split(foo, as.factor(foo$playerID))
  baz <- do.call(rbind, lapply(bar, function(m){
    m[which.max(m$adj_fWAR), ]
  }))
  baz <- baz %>% arrange(adj_fWAR)
  bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
  
  baz <- do.call(rbind, lapply(bar, function(m){
    m[which.max(m$adj_bWAR), ]
  }))
  baz <- baz %>% arrange(adj_bWAR)
  bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
  bad_players <- union(bad_players_bWAR, bad_players_fWAR)
  batters <- batters[!batters$playerID %in% bad_players, ]
  
  ###### investigate anomalies ######
  
  ## more on base events than PAs
  
  # check average for minimal at bats and correct issues
  batters[batters$adj_AVG > 0 & batters$adj_AB == 0, ]$adj_AVG <- 0 
  batters <- batters %>% mutate(adj_hits = round(adj_AVG * adj_AB))
  batters[batters$adj_AB > 0, ]$adj_AVG <- 
    round(batters[batters$adj_AB > 0, ]$adj_hits / batters[batters$adj_AB > 0, ]$adj_AB, 3)
  
  ## build adjusted data set
  batters_adjusted <- batters %>% 
    dplyr::select(name, playerID, age, yearID, mapped_PA, adj_AB, adj_hits, adj_HR, adj_BB, 
                  adj_AVG, adj_OBP, HBP, SF, adj_bWAR, adj_fWAR)
  colnames(batters_adjusted) <- c("name", "playerID", "age", "year", "mapped_PA", "adj_AB", "adj_H", 
                                  "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "HBP", "SF", "adj_bWAR", "adj_fWAR")
  batters_adjusted$playerID <- droplevels(as.factor(batters_adjusted$playerID))

  
  ## trim out bad players
  # first round
  foo <- split(batters_adjusted, f = batters_adjusted$playerID)
  bar <- lapply(foo, function(m){
    ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
  })
  checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                        m_bad = unlist(lapply(bar, mean)), 
                        len = unlist(lapply(bar, length)))
  batters_adjusted <- batters_adjusted %>% 
    filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
  batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
  
  # second round
  foo <- split(batters_adjusted, f = batters_adjusted$playerID)
  bar <- lapply(foo, function(m){
    ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
  })
  checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                        m_bad = unlist(lapply(bar, mean)), 
                        len = unlist(lapply(bar, length)))
  batters_adjusted <- batters_adjusted %>% 
    filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
  batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
  
  # third round
  foo <- split(batters_adjusted, f = batters_adjusted$playerID)
  bar <- lapply(foo, function(m){
    min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
  })
  checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                        m_bad = unlist(lapply(bar, mean)), 
                        len = unlist(lapply(bar, length)))
  batters_adjusted <- batters_adjusted %>% 
    filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
  batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
  
  # forth round
  foo <- split(batters_adjusted, f = batters_adjusted$playerID)
  bar <- lapply(foo, function(m){
    ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
  })
  checker <- data.frame(pid = levels(batters_adjusted$playerID), 
                        m_bad = unlist(lapply(bar, mean)), 
                        len = unlist(lapply(bar, length)))
  batters_adjusted <- batters_adjusted %>% 
    filter(!batters_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
  batters_adjusted$playerID <- droplevels(batters_adjusted$playerID)
  
  
  ## remove tails 
  foo <- split(batters_adjusted, f = batters_adjusted$playerID)
  bar <- lapply(foo, function(m){
    bad <- ifelse(m$adj_bWAR <= 0.2, 1, 0) + ifelse(m$adj_fWAR <= 0.2, 1, 0)
    bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                      ifelse(sum(tail(bad, 3)) >= 5,1,0),
                      ifelse(sum(tail(bad, 4)) >= 7,1,0),
                      ifelse(sum(tail(bad, 5)) >= 9,1,0),
                      ifelse(sum(tail(bad, 6)) >= 11,1,0)))
    1:(length(bad)-bad_tail)
  })
  batters_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
    foo[[j]][bar[[j]], ]
  })) %>% arrange(year)
  
  foo <- split(batters_adjusted_1, f = batters_adjusted_1$playerID)
  bar <- lapply(foo, function(m){
    bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
    bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                      ifelse(sum(tail(bad, 3)) >= 3,1,0),
                      ifelse(sum(tail(bad, 4)) >= 4,1,0),
                      ifelse(sum(tail(bad, 5)) >= 5,1,0),
                      ifelse(sum(tail(bad, 6)) >= 6,1,0)))
    1:(length(bad)-bad_tail)
  })
  batters_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
    foo[[j]][bar[[j]], ]
  })) %>% arrange(year)
  
  foo <- split(batters_adjusted_2, f = batters_adjusted_2$playerID)
  bar <- lapply(foo, function(m){
    bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
    bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                      ifelse(sum(tail(bad, 3)) >= 3,1,0),
                      ifelse(sum(tail(bad, 4)) >= 4,1,0),
                      ifelse(sum(tail(bad, 5)) >= 5,1,0),
                      ifelse(sum(tail(bad, 6)) >= 6,1,0)))
    1:(length(bad)-bad_tail)
  })
  batters_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
    foo[[j]][bar[[j]], ]
  })) %>% arrange(year)
  
  ## remove starts
  foo <- split(batters_adjusted_3, f = batters_adjusted_3$playerID)
  bar <- lapply(foo, function(m){
    bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
    bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                      ifelse(sum(head(bad, 2)) >= 3,1,0),
                      ifelse(sum(head(bad, 3)) >= 5,1,0),
                      ifelse(sum(head(bad, 4)) >= 7,1,0),
                      ifelse(sum(head(bad, 5)) >= 9,1,0),
                      ifelse(sum(head(bad, 6)) >= 11,1,0)))
    if (bad_head < length(bad)) {
      (bad_head + 1):length(bad)
    }
  })
  batters_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
    foo[[j]][bar[[j]], ]
  })) %>% arrange(year)
  
  batters_adjusted_4$playerID <- droplevels(batters_adjusted_4$playerID)
  
  # taper down average WAR for players with small PAs
  batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR <- 
    round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_fWAR/9,2)
  batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR <- 
    round(batters_adjusted_4[batters_adjusted_4$mapped_PA <= 20, ]$adj_bWAR/9,2)	
  
  batters_adjusted <- do.call(rbind, mclapply(
    split(batters_adjusted_4, f = droplevels(as.factor(batters_adjusted_4$playerID))), 
    mc.cores = ncores, FUN = function(xx){
      ## natural cubic spline
      ns_AVG = lm(adj_AVG ~ ns(year, df=6), data=xx)
      nn_AVG <- predict(ns_AVG, data.frame("year"= xx$year))
      ns_HR = lm(adj_HR ~ ns(year, df=6), data=xx)
      nn_HR <- predict(ns_HR, data.frame("year"= xx$year))
      ns_BB = lm(adj_BB ~ ns(year, df=6), data=xx)
      nn_BB <- predict(ns_BB, data.frame("year"= xx$year))
      ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
      nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
      ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
      nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
      
      xx %>% mutate(AVG = round((adj_AVG + nn_AVG)/2, 3)) %>% 
        mutate(HR = round((adj_HR + nn_HR)/2)) %>%
        mutate(BB = round((adj_BB + nn_BB)/2)) %>%
        mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
        mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
    })) 
  
  bat_season <- batters_adjusted %>% 
    mutate(PA = adj_AB + BB + HBP + SF)
  bat_season[bat_season$HR >= bat_season$adj_AB, ]$HR <- 
    bat_season[bat_season$HR >= bat_season$adj_AB, ]$adj_AB

 bat_season <- bat_season %>% 
   dplyr::select(-c("adj_H", "adj_HR", "adj_BB", "adj_AVG", "adj_OBP", "adj_bWAR", "adj_fWAR", 'mapped_PA'))
 bat_season <- bat_season %>% mutate(OBP = round((AVG * adj_AB + BB + HBP)/(adj_AB + BB + HBP + SF), 3 )) %>%
   mutate(AVG = ifelse(AVG > 0, AVG, 0)) %>%
   mutate(HR = ifelse(HR > 0, HR, 0)) %>%
   mutate(BB = ifelse(BB > 0, BB, 0)) %>%
   mutate(OBP = ifelse(OBP > 0, OBP, 0))
 
 colnames(bat_season)[5] <- 'AB'
 colnames(bat_season)[8] <- 'BA'
 bat_season_nonpara <- bat_season %>% mutate(H = ceiling(AB * BA)) %>%
   mutate(BA = round(H / AB, 3)) %>%
   mutate(BA = ifelse(AB == 0, 0, BA)) %>%
   mutate(OBP = round((H+BB+HBP)/(AB+BB+HBP+SF), 3)) %>%
   mutate(OBP = ifelse(AB+BB+HBP+SF == 0, 0, OBP))
 
  bat_career_nonpara <- bat_season_nonpara %>% group_by(playerID) %>% 
    summarise(name = unique(name), 
              playerID = unique(playerID), 
              PA = sum(round(PA)), 
              AB = sum(AB), 
              H = sum(H), 
              HR = sum(round(HR)), 
              BB = sum(round(BB)), 
              BA = round(H/AB, 3), 
              HBP = sum(HBP), 
              SF = sum(SF), 
              OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
              ebWAR = sum(ebWAR), 
              efWAR = sum(efWAR)) %>% ungroup() %>% 
    arrange(desc(ebWAR))
  
  bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
  bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))
  
```

```{r echo=FALSE}
foo <- getRetrosheet(type = "game", year = 2022)
rotation_bound <- as.data.frame(cbind(years, unlist(mclapply(years, mc.cores = ncores, function(yr){
    foo <- getRetrosheet(type = "game", year = yr)
    Tms <- unique(foo$HmTm)
    
    starter <- lapply(Tms, function(tm){
      bar <- foo %>% filter(VisTm == tm | HmTm == tm) %>% 
        select(VisTm, HmTm, VisStPchID, HmStPchID, VisTmGNum, HmTmGNum)
      t(apply(bar, 1, function(xx){
        y <- NULL
        if(xx[2] == tm){
          y <- xx[4]
        }
        else{
          y <- xx[3]
        }
      })) 
    })
    
    y <- unlist(lapply(starter, function(xx){
      unlist(lapply(1:length(xx), function(j){
        flag <- TRUE
        k <- 1
        if(j > 1){
          while(flag){
            flag <- length(xx[(j-k):j]) == length(unique(xx[(j-k):j]))
            if(!flag){
              break
            }
            else{
              k <- k + 1
            }
            if(k == j){
              break
            }
          }
        }
        k
      }))
    }))
    mean(y)
    
  }))))
```

```{r cache=TRUE, echo=FALSE}
pitchers <- pit_dat %>% 
    select(playerID, yearID, name, age, lgID, teamID, IP, pops, bWAR)
  pitchers <- pitchers %>% mutate(comp = bWAR / IP)
  pitchers$comp[is.na(pitchers$comp)] = 0
  
  rotation_bound <- as.data.frame(cbind(years, unlist(mclapply(years, mc.cores = ncores, function(yr){
    foo <- getRetrosheet(type = "game", year = yr)
    Tms <- unique(foo$HmTm)
    
    starter <- lapply(Tms, function(tm){
      bar <- foo %>% filter(VisTm == tm | HmTm == tm) %>% 
        select(VisTm, HmTm, VisStPchID, HmStPchID, VisTmGNum, HmTmGNum)
      t(apply(bar, 1, function(xx){
        y <- NULL
        if(xx[2] == tm){
          y <- xx[4]
        }
        else{
          y <- xx[3]
        }
      })) 
    })
    
    y <- unlist(lapply(starter, function(xx){
      unlist(lapply(1:length(xx), function(j){
        flag <- TRUE
        k <- 1
        if(j > 1){
          while(flag){
            flag <- length(xx[(j-k):j]) == length(unique(xx[(j-k):j]))
            if(!flag){
              break
            }
            else{
              k <- k + 1
            }
            if(k == j){
              break
            }
          }
        }
        k
      }))
    }))
    mean(y)
    
  }))))
  
  unique_team <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    c(xx, nrow(unique(pitchers %>% filter(yearID == xx) %>% select(teamID))))
  }))
  
  rotation_player <- data.frame(yearID = years, rotation = ceiling(rotation_bound[,2] * unique_team[,2]))
  
  cutoff <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    m <- pitchers %>% filter(yearID == xx) %>% arrange(-IP)
    index <- rotation_player$rotation[rotation_player$yearID == xx]
    data.frame(thres = (m$IP[index]), yearID = xx)
  }))
  
  pitchers <- merge(pitchers, cutoff, by = 'yearID')
  
  pitchers <- pitchers %>% mutate(full_time = ifelse(IP >= thres, 'Y', 'N'))
  
  pitchers_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- pitchers %>% filter(yearID == xx)
    lg_avg <- sum(int$bWAR)/sum(int$IP)
    int %>% mutate(comp = (bWAR + lg_avg * 14)/(IP + 14))
  }))
  
  pitchers_talent_bWAR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
    talent_computing_nonpara(dataset = pitchers_schell, component_name = "bWAR_p", year = yy, 
                             ystar = thresh_fun(component = pitchers_schell %>% 
                                                 filter(full_time =='Y', yearID == yy) %>%
                                                 select(comp), component_name = 'bWAR_p'), alpha = 1.16)
  })) %>% arrange(-WAR_talent)
  
  no_strike <- pitchers_talent_bWAR %>% 
    filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  
  min_refbWAR <- -2
  
  t <- isoreg(no_strike$WAR_talent, no_strike$comp)
  
  talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,154)/154)
  comp_new <- as.stepfun(t)(talent_new)
  
  ystar <- thresh_fun(comp_new, component_name = 'bWAR_p')
  pop_new <- round(mean(no_strike$pops))
  component_name = 'bWAR_p'
  yy <- sort(comp_new)
  n <- length(yy)
  ytilde <- rep(0, n + 1)
  if (component_name == 'ERA') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
  }
  if (component_name == 'bWAR_p'| component_name == 'fWAR_p') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])/10
  }
  if (component_name == 'SO') {
    ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
  }
  ytilde[n+1] <- yy[n] + ystar
  ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2 
  }))
  
  career_kAB <- do.call(rbind, mclapply(1:nrow(pitchers_talent_bWAR), function(xx){
    int <- career_talent_nonpara(dataset = pitchers_talent_bWAR, component_name = 'bWAR_p', 
                         snippet = pitchers_talent_bWAR[xx,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
  ## mapping statistics
  
  mapped_quan_p <- do.call(rbind, mclapply(years, function(xx){
    pitchers_full <- pitchers %>% filter(yearID == xx) %>% 
      filter(full_time == 'Y') %>% arrange(-IP)
    pitchers_less <- pitchers %>% filter(yearID == xx) %>% 
      filter(full_time == 'N') %>% arrange(-IP)
    
    n1 <- nrow(pitchers_full)
    n2 <- nrow(pitchers_less)
    
    mapped_IP_full <- c()
    mapped_IP_less <- c()
    for (yy in c(1977:1980, 1982:1989)) {
      pitchers_ref_full <- pitchers %>% 
        filter(yearID == yy, full_time == 'Y') %>% arrange(-IP)
      pitchers_ref_less <- pitchers %>% 
        filter(yearID == yy, full_time == 'N') %>% arrange(-IP)
      n1r <- nrow(pitchers_ref_full)
      n2r <- nrow(pitchers_ref_less)
      
      mapped_IP_full <- cbind(mapped_IP_full, approx(x = seq((n1r-1),0)/(n1r-1), 
                                                     y = pitchers_ref_full$IP,
                                                     xout = seq((n1-1),0)/(n1-1))$y)
      mapped_IP_less <- cbind(mapped_IP_less, approx(x = seq((n2r-1),0)/(n2r-1), 
                                                     y = pitchers_ref_less$IP, 
                                                     xout = seq((n2-1),0)/(n2-1))$y)
    }
    
    pitchers_full$mapped_IP <- rowMeans(mapped_IP_full)
    pitchers_less$mapped_IP <- rowMeans(mapped_IP_less)
    
    m <- rbind(pitchers_full, pitchers_less)
    data.frame(playerID = m$playerID, yearID = m$yearID, 
               mapped_IP_raw = round(m$mapped_IP))
    
  }, mc.cores = ncores))
  
  mapped_pitchers_1 <- merge(career_kAB, mapped_quan_p, 
                             by = c('playerID', 'yearID'))
  
  mapped_pitchers_bWAR <- mapped_pitchers_1 %>% 
    mutate(adj_bWAR = adj_comp * mapped_IP_raw) %>%
    mutate(adj_bWAR = ifelse(adj_bWAR < min_refbWAR, min_refbWAR, adj_bWAR)) %>%
    mutate(mapped_IP_bWAR = round(adj_bWAR / adj_comp))
  
```

```{r cache=TRUE, echo=FALSE}
pitchers <- pit_dat %>% 
    select(playerID, yearID, name, age, lgID, teamID, IP, pops, fWAR)
  pitchers <- pitchers %>% mutate(comp = fWAR / IP)
  pitchers$comp[is.na(pitchers$comp)] = 0
  
  pitchers <- merge(pitchers, cutoff, by = 'yearID')
  
  pitchers <- pitchers %>% mutate(full_time = ifelse(IP >= thres, 'Y', 'N'))
  
  pitchers_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- pitchers %>% filter(yearID == xx)
    lg_avg <- sum(int$fWAR)/sum(int$IP)
    int %>% mutate(comp = (fWAR + lg_avg * 14)/(IP + 14))
  }))
  
  
  pitchers_talent_fWAR <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
    talent_computing_nonpara(dataset = pitchers_schell, component_name = "fWAR_p", year = yy, 
                             ystar = thresh_fun(component = pitchers_schell %>% 
                                                 filter(full_time =='Y', yearID == yy) %>%
                                                 select(comp), component_name = 'fWAR_p'), alpha = 1.16)
  })) %>% arrange(-WAR_talent)
  
  ## rotation talent adjustment
  
  no_strike <- pitchers_talent_fWAR %>% 
    filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  min_reffWAR <- -2
  t <- isoreg(no_strike$WAR_talent, no_strike$comp)
  
  
  talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,154)/154)
  comp_new <- as.stepfun(t)(talent_new)
  
  ystar <- thresh_fun(comp_new, component_name = 'fWAR_p')
  pop_new <- round(mean(no_strike$pops))
  component_name = 'fWAR_p'
  yy <- sort(comp_new)
  n <- length(yy)
  ytilde <- rep(0, n + 1)
  if (component_name == 'ERA') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
  }
  if (component_name == 'bWAR_p'| component_name == 'fWAR_p') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])/10
  }
  if (component_name == 'SO') {
    ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
  }
  ytilde[n+1] <- yy[n] + ystar
  ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2 
  }))
  
  career_kAB <- do.call(rbind, mclapply(1:nrow(pitchers_talent_fWAR), function(xx){
    int <- career_talent_nonpara(dataset = pitchers_talent_fWAR, component_name = 'fWAR_p', 
                         snippet = pitchers_talent_fWAR[xx,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
  mapped_pitchers_1 <- merge(career_kAB, mapped_quan_p, 
                             by = c('playerID', 'yearID'))
  
  mapped_pitchers_fWAR <- mapped_pitchers_1 %>% 
    mutate(adj_fWAR = adj_comp * mapped_IP_raw) %>%
    mutate(adj_fWAR = ifelse(adj_fWAR < min_reffWAR, min_reffWAR, adj_fWAR)) %>%
    mutate(mapped_IP_fWAR = round(adj_fWAR / adj_comp))
  
  mapped_quan_p_merge <- merge(mapped_pitchers_bWAR %>% select(yearID, playerID, mapped_IP_bWAR), 
                         mapped_pitchers_fWAR %>% select(yearID, playerID, mapped_IP_fWAR), 
                         by = c('yearID', 'playerID')) 
  mapped_quan_p_merge$mapped_IP <- apply(mapped_quan_p_merge[,c(3,4)], 1, min)
  mapped_quan_p <- mapped_quan_p_merge %>% select(yearID, playerID, mapped_IP)
  
```

```{r cache=TRUE, echo=FALSE}
pitchers <- pit_dat %>% 
    select(playerID, yearID, name, age, lgID, teamID, IP, pops, SO)
  pitchers <- pitchers %>% mutate(comp = SO / IP *9)
  pitchers$comp[is.na(pitchers$comp)] = 0
  
  pitchers <- merge(pitchers, cutoff, by = 'yearID')
  
  pitchers <- pitchers %>% mutate(full_time = ifelse(IP >= thres, 'Y', 'N'))
  
  pitchers_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- pitchers %>% filter(yearID == xx)
    lg_avg <- sum(int$SO)/sum(int$IP)
    int %>% mutate(comp = (SO + lg_avg * 14)/(IP + 14) * 9)
  }))
  
  pitchers_talent_SO <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
    talent_computing_nonpara(dataset = pitchers_schell, component_name = "SO", year = yy, 
                             ystar = thresh_fun(component = pitchers_schell %>% 
                                                 filter(full_time =='Y', yearID == yy) %>%
                                                 select(comp), component_name = 'SO'), alpha = 1.16)
  })) %>% arrange(-WAR_talent)
  
  ## rotation talent adjustment
  
  no_strike <- pitchers_talent_SO %>% 
    filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  min_refSO <- min(no_strike$SO)
  t <- isoreg(no_strike$WAR_talent, no_strike$comp)
  
  talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,154)/154)
  comp_new <- as.stepfun(t)(talent_new)
  
  ystar <- thresh_fun(comp_new, component_name = 'SO')
  pop_new <- round(mean(no_strike$pops))
  component_name = 'SO'
  yy <- sort(comp_new)
  n <- length(yy)
  ytilde <- rep(0, n + 1)
  if (component_name == 'ERA') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
  }
  if (component_name == 'bWAR_p'| component_name == 'fWAR_p') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])/10
  }
  if (component_name == 'SO') {
    ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
  }
  ytilde[n+1] <- yy[n] + ystar
  ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2 
  }))
  
  career_kAB <- do.call(rbind, mclapply(1:nrow(pitchers_talent_SO), function(xx){
    int <- career_talent_nonpara(dataset = pitchers_talent_SO, component_name = 'SO', 
                         snippet = pitchers_talent_SO[xx,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
  mapped_pitchers_1 <- merge(career_kAB, mapped_quan_p, 
                             by = c('playerID', 'yearID'))
  
  mapped_pitchers_SO <- mapped_pitchers_1 %>% 
    mutate(adj_SO = adj_comp * mapped_IP / 9) %>%
    mutate(adj_SO = ifelse(adj_SO < min_refSO, min_refSO, adj_SO))
  
```

```{r cache=TRUE, echo=FALSE}
pitchers <- pit_dat %>% 
    select(playerID, yearID, name, age, lgID, teamID, IP, pops, ER)
  pitchers <- pitchers %>% mutate(comp = -9*ER / IP)
  pitchers$comp[is.na(pitchers$comp)] = 0
  
  pitchers <- merge(pitchers, cutoff, by = 'yearID')
  
  pitchers <- pitchers %>% mutate(full_time = ifelse(IP >= thres, 'Y', 'N'))
  
  pitchers_schell <- do.call(rbind, mclapply(years, mc.cores = ncores, FUN = function(xx){
    int<- pitchers %>% filter(yearID == xx)
    lg_avg <- sum(int$ER)/sum(int$IP)
    int %>% mutate(comp = -9*(ER + lg_avg * 14)/(IP + 14) )
  }))
  
  pitchers_talent_ERA <- do.call(rbind, mclapply(years, mc.cores = ncores, function(yy){
    talent_computing_nonpara(dataset = pitchers_schell, component_name = "ERA", year = yy, 
                             ystar = thresh_fun(component = pitchers_schell %>% 
                                                 filter(full_time =='Y', yearID == yy) %>%
                                                 select(comp), component_name = 'ERA'), alpha = 1.16)
  })) %>% arrange(-WAR_talent)
  
  ## rotation talent adjustment
  
  no_strike <- pitchers_talent_ERA %>% 
    filter(yearID < 1990, yearID >= 1977, yearID != 1981, 
           full_time == 'Y', lgID == 'NL') %>%
    arrange(WAR_talent)
  min_refERA <- min(no_strike$ERA)
  
  t <- isoreg(no_strike$WAR_talent, no_strike$comp)
  
  
  talent_new <- quantile(no_strike$WAR_talent, probs = seq(0,154)/154)
  comp_new <- as.stepfun(t)(talent_new)
  
  ystar <- thresh_fun(comp_new, component_name = 'ERA')
  pop_new <- round(mean(no_strike$pops))
  component_name = 'ERA'
  yy <- sort(comp_new)
  n <- length(yy)
  ytilde <- rep(0, n + 1)
  if (component_name == 'ERA') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])
  }
  if (component_name == 'bWAR_p'| component_name == 'fWAR_p') {
    ytilde[1] <- yy[1] - (yy[2] - yy[1])/10
  }
  if (component_name == 'SO') {
    ytilde[1] <- ifelse(yy[1] - (yy[2] - yy[1]) < 0, 0, yy[1] - (yy[2] - yy[1]) )
  }
  ytilde[n+1] <- yy[n] + ystar
  ytilde[2:n] <- unlist(lapply(2:n, function(j){
    (yy[j]+yy[j-1])/2 
  }))
  
  career_kAB <- do.call(rbind, mclapply(1:nrow(pitchers_talent_ERA), function(xx){
    int <- career_talent_nonpara(dataset = pitchers_talent_ERA, component_name = 'ERA', 
                         snippet = pitchers_talent_ERA[xx,], alpha = 1.16)
    int
  }, mc.cores = ncores)) 
  
  mapped_pitchers_1 <- merge(career_kAB, mapped_quan_p, 
                           by = c('playerID', 'yearID'))
  
  mapped_pitchers_ERA <- mapped_pitchers_1 %>% 
    mutate(adj_ERA = ifelse(adj_comp > min_refERA, min_refERA, adj_comp))
  
```

```{r echo=FALSE}
ERA_part <- mapped_pitchers_ERA %>% 
    mutate(mapped_IP = round(mapped_IP, 1)) %>%
    mutate(adj_ERA = round(-adj_comp, 3)) %>%
    select(yearID, playerID, name, IP, mapped_IP, adj_ERA)
  SO_part <- mapped_pitchers_SO %>% 
    mutate(adj_SO = round(adj_SO))%>%
    select(yearID, playerID, SO, adj_SO)
  bWAR_part <- mapped_pitchers_bWAR %>% 
    mutate(adj_bWAR = round(adj_bWAR, 2)) %>% 
    select(yearID, playerID, adj_bWAR, full_time)
  fWAR_part <- mapped_pitchers_fWAR %>%
    mutate(adj_fWAR = round(adj_fWAR, 2)) %>% 
    select(yearID, age, playerID, adj_fWAR) 
  
  master_pitchers <- merge(ERA_part, merge(SO_part, merge(bWAR_part, fWAR_part, by = c('yearID', 'playerID')), 
                                           by = c('yearID', 'playerID')), by = c('yearID', 'playerID'))
  ## Pitchers
  pitchers <- master_pitchers %>% 
    mutate(adj_K9 = round(adj_SO/mapped_IP*9,1), 
           K9 = round(SO/IP*9,1), 
           adj_fWAR = round(adj_fWAR, 2))
  pitchers <- as.data.frame(pitchers)
  #pitchers$avg_ERA[pitchers$avg_ERA > 6.20] <- 6.20
  #pitchers <- pitchers[pitchers$adj_bWAR != 0, ]
  
  ## extract and remove bad pitchers 
  foo <- pitchers %>% 
    arrange(adj_ERA) %>% 
    filter(mapped_IP >= 100) %>% 
    dplyr::select(name, playerID, yearID, mapped_IP, adj_ERA, adj_SO, adj_fWAR, adj_bWAR)
  bar <- split(foo, as.factor(foo$playerID))
  baz <- do.call(rbind, lapply(bar, function(m){
    m[which.max(m$adj_fWAR), ]
  }))
  baz <- baz %>% arrange(adj_fWAR)
  bad_players_fWAR <- baz %>% filter(adj_fWAR < 0) %>% pull(playerID)
  
  baz <- do.call(rbind, lapply(bar, function(m){
    m[which.max(m$adj_bWAR), ]
  }))
  baz <- baz %>% arrange(adj_bWAR)
  bad_players_bWAR <- baz %>% filter(adj_bWAR < 0) %>% pull(playerID)
  bad_players <- union(bad_players_bWAR, bad_players_fWAR)
  pitchers <- pitchers[!pitchers$playerID %in% bad_players, ]
  
  
  ## build adjusted data set
  pitchers_adjusted <- pitchers %>% dplyr::select(name, playerID, age, yearID, 
                                                  mapped_IP, adj_ERA, adj_SO, adj_bWAR, adj_fWAR, full_time)
  colnames(pitchers_adjusted) <- c("name", "playerID", "age", "year", "IP", 
                                   "adj_ERA", "adj_SO", "adj_bWAR", "adj_fWAR", "full_time")
  pitchers_adjusted$playerID <- droplevels(as.factor(pitchers_adjusted$playerID))
  
  ## trim out bad players
  # first round
  foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
  bar <- lapply(foo, function(m){
    ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
  })
  checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                        m_bad = unlist(lapply(bar, mean)),
                        len = unlist(lapply(bar, length)))
  pitchers_adjusted <- pitchers_adjusted %>%
    filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
  pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)

  # second round
  foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
  bar <- lapply(foo, function(m){
    ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
  })
  checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                        m_bad = unlist(lapply(bar, mean)),
                        len = unlist(lapply(bar, length)))
  pitchers_adjusted <- pitchers_adjusted %>%
    filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1 & checker$len <= 2])
  pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)

  # third round
  foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
  bar <- lapply(foo, function(m){
    min(ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0))
  })
  checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                        m_bad = unlist(lapply(bar, mean)),
                        len = unlist(lapply(bar, length)))
  pitchers_adjusted <- pitchers_adjusted %>%
    filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad >= 1])
  pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)

  # forth round
  foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
  bar <- lapply(foo, function(m){
    ifelse(m$adj_bWAR == -2, 1, 0) + ifelse(m$adj_fWAR == -2, 1, 0)
  })
  checker <- data.frame(pid = levels(pitchers_adjusted$playerID),
                        m_bad = unlist(lapply(bar, mean)),
                        len = unlist(lapply(bar, length)))
  pitchers_adjusted <- pitchers_adjusted %>%
    filter(!pitchers_adjusted$playerID %in% rownames(checker)[checker$m_bad == 2])
  pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)
  
  
  ## remove tails 
  foo <- split(pitchers_adjusted, f = pitchers_adjusted$playerID)
  bar <- lapply(foo, function(m){
    bad <- ifelse(m$adj_bWAR <= 0.41, 1, 0) + ifelse(m$adj_fWAR <= 0.4, 1, 0)
    bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 3,1,0),
                      ifelse(sum(tail(bad, 3)) >= 5,1,0),
                      ifelse(sum(tail(bad, 4)) >= 7,1,0),
                      ifelse(sum(tail(bad, 5)) >= 9,1,0),
                      ifelse(sum(tail(bad, 6)) >= 11,1,0)))
    1:(length(bad)-bad_tail)
  })
  pitchers_adjusted_1 <- do.call(rbind, lapply(1:length(bar), function(j){
    foo[[j]][bar[[j]], ]
  })) %>% arrange(year)
  
  foo <- split(pitchers_adjusted_1, f = pitchers_adjusted_1$playerID)
  bar <- lapply(foo, function(m){
    bad <- ifelse(m$adj_fWAR <= -1.5, 1, 0) 
    bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                      ifelse(sum(tail(bad, 3)) >= 3,1,0),
                      ifelse(sum(tail(bad, 4)) >= 4,1,0),
                      ifelse(sum(tail(bad, 5)) >= 5,1,0),
                      ifelse(sum(tail(bad, 6)) >= 6,1,0)))
    1:(length(bad)-bad_tail)
  })
  pitchers_adjusted_2 <- do.call(rbind, lapply(1:length(bar), function(j){
    foo[[j]][bar[[j]], ]
  })) %>% arrange(year)
  
  foo <- split(pitchers_adjusted_2, f = pitchers_adjusted_2$playerID)
  bar <- lapply(foo, function(m){
    bad <- ifelse(m$adj_bWAR <= -1.5, 1, 0) 
    bad_tail <- sum(c(ifelse(sum(tail(bad, 2)) >= 2,1,0),
                      ifelse(sum(tail(bad, 3)) >= 3,1,0),
                      ifelse(sum(tail(bad, 4)) >= 4,1,0),
                      ifelse(sum(tail(bad, 5)) >= 5,1,0),
                      ifelse(sum(tail(bad, 6)) >= 6,1,0)))
    1:(length(bad)-bad_tail)
  })
  pitchers_adjusted_3 <- do.call(rbind, lapply(1:length(bar), function(j){
    foo[[j]][bar[[j]], ]
  })) %>% arrange(year)
  
  ## remove starts
  foo <- split(pitchers_adjusted_3, f = pitchers_adjusted_3$playerID)
  bar <- lapply(foo, function(m){
    bad <- ifelse(m$adj_bWAR <= 0, 1, 0) + ifelse(m$adj_fWAR <= 0, 1, 0)
    bad_head <- sum(c(ifelse(sum(head(bad, 1)) == 2,1,0),
                      ifelse(sum(head(bad, 2)) >= 3,1,0),
                      ifelse(sum(head(bad, 3)) >= 5,1,0),
                      ifelse(sum(head(bad, 4)) >= 7,1,0),
                      ifelse(sum(head(bad, 5)) >= 9,1,0),
                      ifelse(sum(head(bad, 6)) >= 11,1,0)))
    if (bad_head < length(bad)) {
      (bad_head + 1):length(bad)
    }
  })
  pitchers_adjusted_4 <- do.call(rbind, lapply(1:length(bar), function(j){
    foo[[j]][bar[[j]], ]
  })) %>% arrange(year)
  
  pitchers_adjusted_4$playerID <- droplevels(pitchers_adjusted_4$playerID)
  
  # taper down average WAR for players with small innings
  pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_fWAR <- 
    round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_fWAR/9,2)
  pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_bWAR <- 
    round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 20, ]$adj_bWAR/9,2)	
  pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                        pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_fWAR <- 
    round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                                pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_fWAR/9, 2)
  pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                        pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_bWAR <- 
    round(pitchers_adjusted_4[pitchers_adjusted_4$mapped_IP <= 40 & 
                                pitchers_adjusted_4$mapped_IP > 20 & pitchers_adjusted_4$adj_ERA > 4, ]$adj_bWAR/9, 2)
  
  
  pitchers_adjusted <- do.call(rbind, mclapply(
    split(pitchers_adjusted_4, f = droplevels(as.factor(pitchers_adjusted_4$playerID))), 
    mc.cores = ncores, FUN = function(xx){
      ## natural cubic spline
      ns_ERA = lm(adj_ERA ~ ns(year, df=6), data=xx)
      nn_ERA <- predict(ns_ERA, data.frame("year"= xx$year))
      ns_SO = lm(adj_SO ~ ns(year, df=6), data=xx)
      nn_SO <- predict(ns_SO, data.frame("year"= xx$year))
      ns_bWAR = lm(adj_bWAR ~ ns(year, df=6), data=xx)
      nn_bWAR <- predict(ns_bWAR, data.frame("year"= xx$year))
      ns_fWAR = lm(adj_fWAR ~ ns(year, df=6), data=xx)
      nn_fWAR <- predict(ns_fWAR, data.frame("year"= xx$year))
      
      xx %>% mutate(ERA = round((adj_ERA + nn_ERA)/2, 3)) %>% 
        mutate(SO = round((adj_SO + nn_SO)/2)) %>%
        mutate(ebWAR = round((adj_bWAR + nn_bWAR)/2, 2)) %>%
        mutate(efWAR = round((adj_fWAR + nn_fWAR)/2, 2))
    })) 
  
  pitchers_adjusted$playerID <- droplevels(pitchers_adjusted$playerID)
  pitchers_adjusted <- pitchers_adjusted %>% 
    mutate(ER = round(ERA * IP / 9)) %>%
    mutate(ERA = round(ER / IP *9, 2)) %>% 
    mutate(ERA = ifelse(is.na(ERA), 0, ERA))
  
  rownames(pitchers_adjusted) <- c()
  
  pit_season <- pitchers_adjusted %>% 
    mutate(IP = ceiling(IP)) %>% 
    mutate(ERA = round(ER/IP*9, 2))
  colnames(pit_season)[12] <- 'K'
  pit_season[which(pit_season$K >= 1.5*pit_season$IP), ]$K <- 
    round(1.5*pit_season[which(pit_season$K >= 1.5*pit_season$IP), ]$IP)
  
  pit_season <- pit_season %>% dplyr::select(-c(adj_bWAR, adj_fWAR, adj_ERA, adj_SO, full_time))
  
  pit_career <- pit_season %>% group_by(playerID) %>% 
    summarise(name = unique(name), 
              playerID = unique(playerID), 
              IP = sum(IP), 
              ER = sum(ER), 
              ERA = round(ER/IP*9,2), 
              K = sum(K), 
              ebWAR = sum(ebWAR), 
              efWAR = sum(efWAR)) %>% 
    arrange(desc(ebWAR))
```

## MLB-eligible population Calculation

Based on the MLB-eligible population computed from the [supplementary materials](./MLBeligiblepop.html), we are able to obtain the proportion of the MLB-eligible population before 1950 in different season spans. For example, we would like to calculate the proportion of the MLB-eligible population before 1950 from 1871 to 2005. Given the MLB-eligible population are evenly distribution from the age 20 to 29, the cumulative MLB-eligible males aged 20 to 29 from 1871 to 1879 is equal to 90% of the MLB-eligible population in 1871. Similarly, the cumulative MLB-eligible males aged 20 to 29 from 2000 to 2005 is equal to 50% of the MLB-eligible population in 2005. The code below shows how to compute the proportion of the MLB-eligible population before 1950 from 1871 to 2005.

```{r echo=FALSE}
MLBpops <- bat_dat %>% group_by(yearID) %>% summarise(pops = unique(pops)) %>% group_by(yearID) %>%
  summarise(population = round(mean(pops), 2))
```


```{r}
# MLBpops contains the MLB-eligible population from 1871 to 2022
n <- MLBpops[MLBpops$yearID %in% c(1871, seq(1880, 2000, 10), 2005),]
p <- n
p$population[1] <- n$population[1] /10*9
p$population[15] <- n$population[15] /2
o <- p %>% mutate(population = round(population, 2)) %>% 
  mutate(cpp = round(cumsum(p$population)/(sum(p$population)), 3))

kable(o[o$yearID == 1950,c(1,3)])

```

## Table 8: bWAR rankings from Full House Model using different talent generating function in the Supplementary materials.

```{r echo=FALSE}
kable(cbind(rank = seq(1,25), dist_combined))
```

## Table 9: BA of Tony Gwynn in the 1997 season minus the BA of Ty Cobb in the 1911 season under different configurations before or after applying the smoothing and trimming method in the Supplementary materials. 

The table shows the value of the BA of Tony Gwynn in the 1997 season minus the BA of Ty Cobb in the 1911 season under different configurations before or after applying the smoothing and trimming method. The Park Factor column indicates whether we apply the park-factor adjustment to the BA. The Population column indicates the population changes we apply to the MLB-eligible population. The Increase shows we add 10\% for pre-integration seasons; The Decrease shows we deduct 10\% for the years prior to 1980 due to the economic effect; The Normal shows we use the normal MLB-eligible population. The Distribution column indicates we use parametric distribution and non-parametric distribution to measure the BA in each season. The League Size column indicates we consider two different league sizes as the number of components in each season. The Historical shows we use historical league size as the number of components in each season. The Fixed shows that we compute the maximum number of components in every season and consider this value as the fixed number of components each season. The Difference after indicates the value of the BA of Tony Gwynn in the 1997 season minus the BA of Ty Cobb in the 1911 season under different configurations after applying the smoothing and trimming method. The Difference before indicates the value of the BA of Tony Gwynn in the 1997 season minus the BA of Ty Cobb in the 1911 season under different configurations before applying the smoothing and trimming method.

```{r echo=FALSE}
colnames(season_diff) <- c('Park Factor', 'Population', 'Distribution', 'League Size', 'Difference before', 'Difference after')
season_diff <- season_diff[, c(1,2,3,4,6,5)]
season_diff[c(2:12,14:24), 1] <- ''
season_diff[c(2:4, 6:8, 10:12, 14:16, 18:20, 22:24), 2] <- ''
season_diff[c(2,4, 6,8, 10,12, 14,16, 18,20, 22,24), 3] <- ''
kable(season_diff)
```

## Table 10: career BA of Tony Gwynn minus the career BA of Ty Cobb under different configurations before and after applying the smoothing and trimming method in the Supplementary materials.

The table shows the value of the career BA of Tony Gwynn minus the career BA of Ty Cobb under different configurations before and after applying the smoothing and trimming method. The Park Factor column indicates whether we apply the park-factor adjustment to the BA. The Population column indicates the population changes we apply to the MLB-eligible population. The Increase shows we add 10\% for pre-integration seasons; The Decrease shows we deduct 10\% for the years prior to 1980 due to the economic effect; The Normal shows we use the normal MLB-eligible population. The Distribution column indicates we use parametric distribution and non-parametric distribution to measure the BA in each season. The League Size column indicates we consider two different league sizes as the number of components in each season. The Historical shows we use historical league size as the number of components in each season. The Fixed shows that we compute the maximum number of components in every season and consider this value as the fixed number of components each season. The Difference after indicates the value of the career BA of Tony Gwynn minus the career BA of Ty Cobb under different configurations after the smoothing and trimming method. The Difference before indicates the value of the career BA of Tony Gwynn minus the career BA of Ty Cobb under different configurations before the smoothing and trimming method. 

```{r echo=FALSE}
career_diff <- c()
career_AVG <- YES_pre_int_para_historical_season %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            hits = sum(adj_AVG * adj_AB), 
            AB = sum(adj_AB),
            BA = hits / AB)
career_AVG <- career_AVG %>% mutate(BA = ifelse(AB == 0, 0, BA))

bat_career_nonpara <- YES_pre_int_para_historical_season_trimmed %>% group_by(playerID) %>% 
          summarise(name = unique(name), 
                    playerID = unique(playerID), 
                    PA = sum(round(PA)), 
                    AB = sum(AB), 
                    H = sum(H), 
                    HR = sum(round(HR)), 
                    BB = sum(round(BB)), 
                    BA = round(H/AB, 3), 
                    HBP = sum(HBP), 
                    SF = sum(SF), 
                    OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
                    ebWAR = sum(ebWAR), 
                    efWAR = sum(efWAR)) %>% ungroup() %>% 
          arrange(desc(ebWAR))
        
        bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
        bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))
        

Ty_Cobb <- career_AVG %>% filter(playerID == 'cobbty01')
Tony_Gwynn <- career_AVG %>% filter(playerID == 'gwynnto01')
Ty_Cobb_trimmed <- bat_career_nonpara %>% filter(playerID == 'cobbty01')
Tony_Gwynn_trimmed <- bat_career_nonpara %>% filter( playerID == 'gwynnto01')
career_diff <- rbind(career_diff, data.frame(PF = 'YES', 
                                             pops = 'pre_int', 
                                             para = 'para', 
                                             league = 'historical', 
                                             diff_before = round(Tony_Gwynn$BA - Ty_Cobb$BA, 3), 
                                             diff_after = round(Tony_Gwynn_trimmed$BA - Ty_Cobb_trimmed$BA, 3)))
```

```{r echo=FALSE}
career_AVG <- YES_pre_int_para_fixed_season %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            hits = sum(adj_AVG * adj_AB), 
            AB = sum(adj_AB),
            BA = hits / AB)
career_AVG <- career_AVG %>% mutate(BA = ifelse(AB == 0, 0, BA))

bat_career_nonpara <- YES_pre_int_para_fixed_season_trimmed %>% group_by(playerID) %>% 
          summarise(name = unique(name), 
                    playerID = unique(playerID), 
                    PA = sum(round(PA)), 
                    AB = sum(AB), 
                    H = sum(H), 
                    HR = sum(round(HR)), 
                    BB = sum(round(BB)), 
                    BA = round(H/AB, 3), 
                    HBP = sum(HBP), 
                    SF = sum(SF), 
                    OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
                    ebWAR = sum(ebWAR), 
                    efWAR = sum(efWAR)) %>% ungroup() %>% 
          arrange(desc(ebWAR))
        
        bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
        bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))
        

Ty_Cobb <- career_AVG %>% filter(playerID == 'cobbty01')
Tony_Gwynn <- career_AVG %>% filter(playerID == 'gwynnto01')
Ty_Cobb_trimmed <- bat_career_nonpara %>% filter(playerID == 'cobbty01')
Tony_Gwynn_trimmed <- bat_career_nonpara %>% filter(playerID == 'gwynnto01')
career_diff <- rbind(career_diff, data.frame(PF = 'YES', 
                                             pops = 'pre_int', 
                                             para = 'para', 
                                             league = 'fixed', 
                                             diff_before = round(Tony_Gwynn$BA - Ty_Cobb$BA, 3), 
                                             diff_after = round(Tony_Gwynn_trimmed$BA - Ty_Cobb_trimmed$BA, 3)))
```

```{r echo=FALSE}
career_AVG <- YES_pre_int_nonpara_historical_season %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            hits = sum(adj_AVG * adj_AB), 
            AB = sum(adj_AB),
            BA = hits / AB)
career_AVG <- career_AVG %>% mutate(BA = ifelse(AB == 0, 0, BA))

bat_career_nonpara <- YES_pre_int_nonpara_historical_season_trimmed %>% group_by(playerID) %>% 
          summarise(name = unique(name), 
                    playerID = unique(playerID), 
                    PA = sum(round(PA)), 
                    AB = sum(AB), 
                    H = sum(H), 
                    HR = sum(round(HR)), 
                    BB = sum(round(BB)), 
                    BA = round(H/AB, 3), 
                    HBP = sum(HBP), 
                    SF = sum(SF), 
                    OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
                    ebWAR = sum(ebWAR), 
                    efWAR = sum(efWAR)) %>% ungroup() %>% 
          arrange(desc(ebWAR))
        
        bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
        bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))
        

Ty_Cobb <- career_AVG %>% filter(playerID == 'cobbty01')
Tony_Gwynn <- career_AVG %>% filter(playerID == 'gwynnto01')
Ty_Cobb_trimmed <- bat_career_nonpara %>% filter(playerID == 'cobbty01')
Tony_Gwynn_trimmed <- bat_career_nonpara %>% filter(playerID == 'gwynnto01')
career_diff <- rbind(career_diff, data.frame(PF = 'YES', 
                                             pops = 'pre_int', 
                                             para = 'nonpara', 
                                             league = 'historical', 
                                             diff_before = round(Tony_Gwynn$BA - Ty_Cobb$BA, 3), 
                                             diff_after = round(Tony_Gwynn_trimmed$BA - Ty_Cobb_trimmed$BA, 3)))
```

```{r echo=FALSE}
career_AVG <- YES_pre_int_nonpara_fixed_season %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            hits = sum(adj_AVG * adj_AB), 
            AB = sum(adj_AB),
            BA = hits / AB)
career_AVG <- career_AVG %>% mutate(BA = ifelse(AB == 0, 0, BA))

bat_career_nonpara <- YES_pre_int_nonpara_fixed_season_trimmed %>% group_by(playerID) %>% 
          summarise(name = unique(name), 
                    playerID = unique(playerID), 
                    PA = sum(round(PA)), 
                    AB = sum(AB), 
                    H = sum(H), 
                    HR = sum(round(HR)), 
                    BB = sum(round(BB)), 
                    BA = round(H/AB, 3), 
                    HBP = sum(HBP), 
                    SF = sum(SF), 
                    OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
                    ebWAR = sum(ebWAR), 
                    efWAR = sum(efWAR)) %>% ungroup() %>% 
          arrange(desc(ebWAR))
        
        bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
        bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))
        

Ty_Cobb <- career_AVG %>% filter(playerID == 'cobbty01')
Tony_Gwynn <- career_AVG %>% filter(playerID == 'gwynnto01')
Ty_Cobb_trimmed <- bat_career_nonpara %>% filter(playerID == 'cobbty01')
Tony_Gwynn_trimmed <- bat_career_nonpara %>% filter(playerID == 'gwynnto01')
career_diff <- rbind(career_diff, data.frame(PF = 'YES', 
                                             pops = 'pre_int', 
                                             para = 'nonpara', 
                                             league = 'fixed', 
                                             diff_before = round(Tony_Gwynn$BA - Ty_Cobb$BA, 3), 
                                             diff_after = round(Tony_Gwynn_trimmed$BA - Ty_Cobb_trimmed$BA, 3)))
```

```{r echo=FALSE}
career_AVG <- YES_econ_effect_para_historical_season %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            hits = sum(adj_AVG * adj_AB), 
            AB = sum(adj_AB),
            BA = hits / AB)
career_AVG <- career_AVG %>% mutate(BA = ifelse(AB == 0, 0, BA))

bat_career_nonpara <- YES_econ_effect_para_historical_season_trimmed %>% group_by(playerID) %>% 
          summarise(name = unique(name), 
                    playerID = unique(playerID), 
                    PA = sum(round(PA)), 
                    AB = sum(AB), 
                    H = sum(H), 
                    HR = sum(round(HR)), 
                    BB = sum(round(BB)), 
                    BA = round(H/AB, 3), 
                    HBP = sum(HBP), 
                    SF = sum(SF), 
                    OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
                    ebWAR = sum(ebWAR), 
                    efWAR = sum(efWAR)) %>% ungroup() %>% 
          arrange(desc(ebWAR))
        
        bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
        bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))
        

Ty_Cobb <- career_AVG %>% filter(playerID == 'cobbty01')
Tony_Gwynn <- career_AVG %>% filter(playerID == 'gwynnto01')
Ty_Cobb_trimmed <- bat_career_nonpara %>% filter(playerID == 'cobbty01')
Tony_Gwynn_trimmed <- bat_career_nonpara %>% filter(playerID == 'gwynnto01')
career_diff <- rbind(career_diff, data.frame(PF = 'YES', 
                                             pops = 'econ_effect', 
                                             para = 'para', 
                                             league = 'historical', 
                                             diff_before = round(Tony_Gwynn$BA - Ty_Cobb$BA, 3), 
                                             diff_after = round(Tony_Gwynn_trimmed$BA - Ty_Cobb_trimmed$BA, 3)))
```

```{r echo=FALSE}
career_AVG <- YES_econ_effect_para_fixed_season %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            hits = sum(adj_AVG * adj_AB), 
            AB = sum(adj_AB),
            BA = hits / AB)
career_AVG <- career_AVG %>% mutate(BA = ifelse(AB == 0, 0, BA))

bat_career_nonpara <- YES_econ_effect_para_fixed_season_trimmed %>% group_by(playerID) %>% 
          summarise(name = unique(name), 
                    playerID = unique(playerID), 
                    PA = sum(round(PA)), 
                    AB = sum(AB), 
                    H = sum(H), 
                    HR = sum(round(HR)), 
                    BB = sum(round(BB)), 
                    BA = round(H/AB, 3), 
                    HBP = sum(HBP), 
                    SF = sum(SF), 
                    OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
                    ebWAR = sum(ebWAR), 
                    efWAR = sum(efWAR)) %>% ungroup() %>% 
          arrange(desc(ebWAR))
        
        bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
        bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))
        

Ty_Cobb <- career_AVG %>% filter(playerID == 'cobbty01')
Tony_Gwynn <- career_AVG %>% filter(playerID == 'gwynnto01')
Ty_Cobb_trimmed <- bat_career_nonpara %>% filter(playerID == 'cobbty01')
Tony_Gwynn_trimmed <- bat_career_nonpara %>% filter(playerID == 'gwynnto01')
career_diff <- rbind(career_diff, data.frame(PF = 'YES', 
                                             pops = 'econ_effect', 
                                             para = 'para', 
                                             league = 'fixed', 
                                             diff_before = round(Tony_Gwynn$BA - Ty_Cobb$BA, 3), 
                                             diff_after = round(Tony_Gwynn_trimmed$BA - Ty_Cobb_trimmed$BA, 3)))
```

```{r echo=FALSE}
career_AVG <- YES_econ_effect_nonpara_historical_season %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            hits = sum(adj_AVG * adj_AB), 
            AB = sum(adj_AB),
            BA = hits / AB)
career_AVG <- career_AVG %>% mutate(BA = ifelse(AB == 0, 0, BA))

bat_career_nonpara <- YES_econ_effect_nonpara_historical_season_trimmed %>% group_by(playerID) %>% 
          summarise(name = unique(name), 
                    playerID = unique(playerID), 
                    PA = sum(round(PA)), 
                    AB = sum(AB), 
                    H = sum(H), 
                    HR = sum(round(HR)), 
                    BB = sum(round(BB)), 
                    BA = round(H/AB, 3), 
                    HBP = sum(HBP), 
                    SF = sum(SF), 
                    OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
                    ebWAR = sum(ebWAR), 
                    efWAR = sum(efWAR)) %>% ungroup() %>% 
          arrange(desc(ebWAR))
        
        bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
        bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))
        

Ty_Cobb <- career_AVG %>% filter(playerID == 'cobbty01')
Tony_Gwynn <- career_AVG %>% filter(playerID == 'gwynnto01')
Ty_Cobb_trimmed <- bat_career_nonpara %>% filter(playerID == 'cobbty01')
Tony_Gwynn_trimmed <- bat_career_nonpara %>% filter(playerID == 'gwynnto01')
career_diff <- rbind(career_diff, data.frame(PF = 'YES', 
                                             pops = 'econ_effect', 
                                             para = 'nonpara', 
                                             league = 'historical', 
                                             diff_before = round(Tony_Gwynn$BA - Ty_Cobb$BA, 3), 
                                             diff_after = round(Tony_Gwynn_trimmed$BA - Ty_Cobb_trimmed$BA, 3)))
```

```{r echo=FALSE}
career_AVG <- YES_econ_effect_nonpara_fixed_season %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            hits = sum(adj_AVG * adj_AB), 
            AB = sum(adj_AB),
            BA = hits / AB)
career_AVG <- career_AVG %>% mutate(BA = ifelse(AB == 0, 0, BA))

bat_career_nonpara <- YES_econ_effect_nonpara_fixed_season_trimmed %>% group_by(playerID) %>% 
          summarise(name = unique(name), 
                    playerID = unique(playerID), 
                    PA = sum(round(PA)), 
                    AB = sum(AB), 
                    H = sum(H), 
                    HR = sum(round(HR)), 
                    BB = sum(round(BB)), 
                    BA = round(H/AB, 3), 
                    HBP = sum(HBP), 
                    SF = sum(SF), 
                    OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
                    ebWAR = sum(ebWAR), 
                    efWAR = sum(efWAR)) %>% ungroup() %>% 
          arrange(desc(ebWAR))
        
        bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
        bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))
        

Ty_Cobb <- career_AVG %>% filter(playerID == 'cobbty01')
Tony_Gwynn <- career_AVG %>% filter(playerID == 'gwynnto01')
Ty_Cobb_trimmed <- bat_career_nonpara %>% filter(playerID == 'cobbty01')
Tony_Gwynn_trimmed <- bat_career_nonpara %>% filter(playerID == 'gwynnto01')
career_diff <- rbind(career_diff, data.frame(PF = 'YES', 
                                             pops = 'econ_effect', 
                                             para = 'nonpara', 
                                             league = 'fixed', 
                                             diff_before = round(Tony_Gwynn$BA - Ty_Cobb$BA, 3), 
                                             diff_after = round(Tony_Gwynn_trimmed$BA - Ty_Cobb_trimmed$BA, 3)))
```

```{r echo=FALSE}
career_AVG <- YES_normal_para_historical_season %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            hits = sum(adj_AVG * adj_AB), 
            AB = sum(adj_AB),
            BA = hits / AB)
career_AVG <- career_AVG %>% mutate(BA = ifelse(AB == 0, 0, BA))

bat_career_nonpara <- YES_normal_para_historical_season_trimmed %>% group_by(playerID) %>% 
          summarise(name = unique(name), 
                    playerID = unique(playerID), 
                    PA = sum(round(PA)), 
                    AB = sum(AB), 
                    H = sum(H), 
                    HR = sum(round(HR)), 
                    BB = sum(round(BB)), 
                    BA = round(H/AB, 3), 
                    HBP = sum(HBP), 
                    SF = sum(SF), 
                    OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
                    ebWAR = sum(ebWAR), 
                    efWAR = sum(efWAR)) %>% ungroup() %>% 
          arrange(desc(ebWAR))
        
        bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
        bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))
        

Ty_Cobb <- career_AVG %>% filter(playerID == 'cobbty01')
Tony_Gwynn <- career_AVG %>% filter(playerID == 'gwynnto01')
Ty_Cobb_trimmed <- bat_career_nonpara %>% filter(playerID == 'cobbty01')
Tony_Gwynn_trimmed <- bat_career_nonpara %>% filter(playerID == 'gwynnto01')
career_diff <- rbind(career_diff, data.frame(PF = 'YES', 
                                             pops = 'normal', 
                                             para = 'para', 
                                             league = 'historical', 
                                             diff_before = round(Tony_Gwynn$BA - Ty_Cobb$BA, 3), 
                                             diff_after = round(Tony_Gwynn_trimmed$BA - Ty_Cobb_trimmed$BA, 3)))
```

```{r echo=FALSE}
career_AVG <- YES_normal_para_fixed_season %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            hits = sum(adj_AVG * adj_AB), 
            AB = sum(adj_AB),
            BA = hits / AB)
career_AVG <- career_AVG %>% mutate(BA = ifelse(AB == 0, 0, BA))

bat_career_nonpara <- YES_normal_para_fixed_season_trimmed %>% group_by(playerID) %>% 
          summarise(name = unique(name), 
                    playerID = unique(playerID), 
                    PA = sum(round(PA)), 
                    AB = sum(AB), 
                    H = sum(H), 
                    HR = sum(round(HR)), 
                    BB = sum(round(BB)), 
                    BA = round(H/AB, 3), 
                    HBP = sum(HBP), 
                    SF = sum(SF), 
                    OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
                    ebWAR = sum(ebWAR), 
                    efWAR = sum(efWAR)) %>% ungroup() %>% 
          arrange(desc(ebWAR))
        
        bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
        bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))
        

Ty_Cobb <- career_AVG %>% filter(playerID == 'cobbty01')
Tony_Gwynn <- career_AVG %>% filter(playerID == 'gwynnto01')
Ty_Cobb_trimmed <- bat_career_nonpara %>% filter(playerID == 'cobbty01')
Tony_Gwynn_trimmed <- bat_career_nonpara %>% filter(playerID == 'gwynnto01')
career_diff <- rbind(career_diff, data.frame(PF = 'YES', 
                                             pops = 'normal', 
                                             para = 'para', 
                                             league = 'fixed', 
                                             diff_before = round(Tony_Gwynn$BA - Ty_Cobb$BA, 3), 
                                             diff_after = round(Tony_Gwynn_trimmed$BA - Ty_Cobb_trimmed$BA, 3)))
```

```{r echo=FALSE}
career_AVG <- YES_normal_nonpara_historical_season %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            hits = sum(adj_AVG * adj_AB), 
            AB = sum(adj_AB),
            BA = hits / AB)
career_AVG <- career_AVG %>% mutate(BA = ifelse(AB == 0, 0, BA))

bat_career_nonpara <- YES_normal_nonpara_historical_season_trimmed %>% group_by(playerID) %>% 
          summarise(name = unique(name), 
                    playerID = unique(playerID), 
                    PA = sum(round(PA)), 
                    AB = sum(AB), 
                    H = sum(H), 
                    HR = sum(round(HR)), 
                    BB = sum(round(BB)), 
                    BA = round(H/AB, 3), 
                    HBP = sum(HBP), 
                    SF = sum(SF), 
                    OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
                    ebWAR = sum(ebWAR), 
                    efWAR = sum(efWAR)) %>% ungroup() %>% 
          arrange(desc(ebWAR))
        
        bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
        bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))
        

Ty_Cobb <- career_AVG %>% filter(playerID == 'cobbty01')
Tony_Gwynn <- career_AVG %>% filter(playerID == 'gwynnto01')
Ty_Cobb_trimmed <- bat_career_nonpara %>% filter(playerID == 'cobbty01')
Tony_Gwynn_trimmed <- bat_career_nonpara %>% filter(playerID == 'gwynnto01')
career_diff <- rbind(career_diff, data.frame(PF = 'YES', 
                                             pops = 'normal', 
                                             para = 'nonpara', 
                                             league = 'historical', 
                                             diff_before = round(Tony_Gwynn$BA - Ty_Cobb$BA, 3), 
                                             diff_after = round(Tony_Gwynn_trimmed$BA - Ty_Cobb_trimmed$BA, 3)))
```

```{r echo=FALSE}
career_AVG <- YES_normal_nonpara_fixed_season %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            hits = sum(adj_AVG * adj_AB), 
            AB = sum(adj_AB),
            BA = hits / AB)
career_AVG <- career_AVG %>% mutate(BA = ifelse(AB == 0, 0, BA))

bat_career_nonpara <- YES_normal_nonpara_fixed_season_trimmed %>% group_by(playerID) %>% 
          summarise(name = unique(name), 
                    playerID = unique(playerID), 
                    PA = sum(round(PA)), 
                    AB = sum(AB), 
                    H = sum(H), 
                    HR = sum(round(HR)), 
                    BB = sum(round(BB)), 
                    BA = round(H/AB, 3), 
                    HBP = sum(HBP), 
                    SF = sum(SF), 
                    OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
                    ebWAR = sum(ebWAR), 
                    efWAR = sum(efWAR)) %>% ungroup() %>% 
          arrange(desc(ebWAR))
        
        bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
        bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))
        

Ty_Cobb <- career_AVG %>% filter(playerID == 'cobbty01')
Tony_Gwynn <- career_AVG %>% filter(playerID == 'gwynnto01')
Ty_Cobb_trimmed <- bat_career_nonpara %>% filter(playerID == 'cobbty01')
Tony_Gwynn_trimmed <- bat_career_nonpara %>% filter(playerID == 'gwynnto01')
career_diff <- rbind(career_diff, data.frame(PF = 'YES', 
                                             pops = 'normal', 
                                             para = 'nonpara', 
                                             league = 'fixed', 
                                             diff_before = round(Tony_Gwynn$BA - Ty_Cobb$BA, 3), 
                                             diff_after = round(Tony_Gwynn_trimmed$BA - Ty_Cobb_trimmed$BA, 3)))


```

```{r echo=FALSE}

career_AVG <- NO_pre_int_para_historical_season %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            hits = sum(adj_AVG * adj_AB), 
            AB = sum(adj_AB),
            BA = hits / AB)
career_AVG <- career_AVG %>% mutate(BA = ifelse(AB == 0, 0, BA))

bat_career_nonpara <- NO_pre_int_para_historical_season_trimmed %>% group_by(playerID) %>% 
          summarise(name = unique(name), 
                    playerID = unique(playerID), 
                    PA = sum(round(PA)), 
                    AB = sum(AB), 
                    H = sum(H), 
                    HR = sum(round(HR)), 
                    BB = sum(round(BB)), 
                    BA = round(H/AB, 3), 
                    HBP = sum(HBP), 
                    SF = sum(SF), 
                    OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
                    ebWAR = sum(ebWAR), 
                    efWAR = sum(efWAR)) %>% ungroup() %>% 
          arrange(desc(ebWAR))
        
        bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
        bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))
        

Ty_Cobb <- career_AVG %>% filter(playerID == 'cobbty01')
Tony_Gwynn <- career_AVG %>% filter(playerID == 'gwynnto01')
Ty_Cobb_trimmed <- bat_career_nonpara %>% filter(playerID == 'cobbty01')
Tony_Gwynn_trimmed <- bat_career_nonpara %>% filter(playerID == 'gwynnto01')
career_diff <- rbind(career_diff, data.frame(PF = 'NO', 
                                             pops = 'pre_int', 
                                             para = 'para', 
                                             league = 'historical', 
                                             diff_before = round(Tony_Gwynn$BA - Ty_Cobb$BA, 3), 
                                             diff_after = round(Tony_Gwynn_trimmed$BA - Ty_Cobb_trimmed$BA, 3)))

```

```{r echo=FALSE}
career_AVG <- NO_pre_int_para_fixed_season %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            hits = sum(adj_AVG * adj_AB), 
            AB = sum(adj_AB),
            BA = hits / AB)
career_AVG <- career_AVG %>% mutate(BA = ifelse(AB == 0, 0, BA))

bat_career_nonpara <- NO_pre_int_para_fixed_season_trimmed %>% group_by(playerID) %>% 
          summarise(name = unique(name), 
                    playerID = unique(playerID), 
                    PA = sum(round(PA)), 
                    AB = sum(AB), 
                    H = sum(H), 
                    HR = sum(round(HR)), 
                    BB = sum(round(BB)), 
                    BA = round(H/AB, 3), 
                    HBP = sum(HBP), 
                    SF = sum(SF), 
                    OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
                    ebWAR = sum(ebWAR), 
                    efWAR = sum(efWAR)) %>% ungroup() %>% 
          arrange(desc(ebWAR))
        
        bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
        bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))
        

Ty_Cobb <- career_AVG %>% filter(playerID == 'cobbty01')
Tony_Gwynn <- career_AVG %>% filter(playerID == 'gwynnto01')
Ty_Cobb_trimmed <- bat_career_nonpara %>% filter(playerID == 'cobbty01')
Tony_Gwynn_trimmed <- bat_career_nonpara %>% filter(playerID == 'gwynnto01')
career_diff <- rbind(career_diff, data.frame(PF = 'NO', 
                                             pops = 'pre_int', 
                                             para = 'para', 
                                             league = 'fixed', 
                                             diff_before = round(Tony_Gwynn$BA - Ty_Cobb$BA, 3), 
                                             diff_after = round(Tony_Gwynn_trimmed$BA - Ty_Cobb_trimmed$BA, 3)))

```

```{r echo=FALSE}
career_AVG <- NO_pre_int_nonpara_historical_season %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            hits = sum(adj_AVG * adj_AB), 
            AB = sum(adj_AB),
            BA = hits / AB)
career_AVG <- career_AVG %>% mutate(BA = ifelse(AB == 0, 0, BA))

bat_career_nonpara <- NO_pre_int_nonpara_historical_season_trimmed %>% group_by(playerID) %>% 
          summarise(name = unique(name), 
                    playerID = unique(playerID), 
                    PA = sum(round(PA)), 
                    AB = sum(AB), 
                    H = sum(H), 
                    HR = sum(round(HR)), 
                    BB = sum(round(BB)), 
                    BA = round(H/AB, 3), 
                    HBP = sum(HBP), 
                    SF = sum(SF), 
                    OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
                    ebWAR = sum(ebWAR), 
                    efWAR = sum(efWAR)) %>% ungroup() %>% 
          arrange(desc(ebWAR))
        
        bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
        bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))
        

Ty_Cobb <- career_AVG %>% filter(playerID == 'cobbty01')
Tony_Gwynn <- career_AVG %>% filter(playerID == 'gwynnto01')
Ty_Cobb_trimmed <- bat_career_nonpara %>% filter(playerID == 'cobbty01')
Tony_Gwynn_trimmed <- bat_career_nonpara %>% filter(playerID == 'gwynnto01')
career_diff <- rbind(career_diff, data.frame(PF = 'NO', 
                                             pops = 'pre_int', 
                                             para = 'nonpara', 
                                             league = 'historical', 
                                             diff_before = round(Tony_Gwynn$BA - Ty_Cobb$BA, 3), 
                                             diff_after = round(Tony_Gwynn_trimmed$BA - Ty_Cobb_trimmed$BA, 3)))

```

```{r echo=FALSE}
career_AVG <- NO_pre_int_nonpara_fixed_season %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            hits = sum(adj_AVG * adj_AB), 
            AB = sum(adj_AB),
            BA = hits / AB)
career_AVG <- career_AVG %>% mutate(BA = ifelse(AB == 0, 0, BA))

bat_career_nonpara <- NO_pre_int_nonpara_fixed_season_trimmed %>% group_by(playerID) %>% 
          summarise(name = unique(name), 
                    playerID = unique(playerID), 
                    PA = sum(round(PA)), 
                    AB = sum(AB), 
                    H = sum(H), 
                    HR = sum(round(HR)), 
                    BB = sum(round(BB)), 
                    BA = round(H/AB, 3), 
                    HBP = sum(HBP), 
                    SF = sum(SF), 
                    OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
                    ebWAR = sum(ebWAR), 
                    efWAR = sum(efWAR)) %>% ungroup() %>% 
          arrange(desc(ebWAR))
        
        bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
        bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))
        

Ty_Cobb <- career_AVG %>% filter(playerID == 'cobbty01')
Tony_Gwynn <- career_AVG %>% filter(playerID == 'gwynnto01')
Ty_Cobb_trimmed <- bat_career_nonpara %>% filter(playerID == 'cobbty01')
Tony_Gwynn_trimmed <- bat_career_nonpara %>% filter(playerID == 'gwynnto01')
career_diff <- rbind(career_diff, data.frame(PF = 'NO', 
                                             pops = 'pre_int', 
                                             para = 'nonpara', 
                                             league = 'fixed', 
                                             diff_before = round(Tony_Gwynn$BA - Ty_Cobb$BA, 3), 
                                             diff_after = round(Tony_Gwynn_trimmed$BA - Ty_Cobb_trimmed$BA, 3)))

```

```{r echo=FALSE}
career_AVG <- NO_econ_effect_para_historical_season %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            hits = sum(adj_AVG * adj_AB), 
            AB = sum(adj_AB),
            BA = hits / AB)
career_AVG <- career_AVG %>% mutate(BA = ifelse(AB == 0, 0, BA))

bat_career_nonpara <- NO_econ_effect_para_historical_season_trimmed %>% group_by(playerID) %>% 
          summarise(name = unique(name), 
                    playerID = unique(playerID), 
                    PA = sum(round(PA)), 
                    AB = sum(AB), 
                    H = sum(H), 
                    HR = sum(round(HR)), 
                    BB = sum(round(BB)), 
                    BA = round(H/AB, 3), 
                    HBP = sum(HBP), 
                    SF = sum(SF), 
                    OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
                    ebWAR = sum(ebWAR), 
                    efWAR = sum(efWAR)) %>% ungroup() %>% 
          arrange(desc(ebWAR))
        
        bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
        bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))
        

Ty_Cobb <- career_AVG %>% filter(playerID == 'cobbty01')
Tony_Gwynn <- career_AVG %>% filter(playerID == 'gwynnto01')
Ty_Cobb_trimmed <- bat_career_nonpara %>% filter(playerID == 'cobbty01')
Tony_Gwynn_trimmed <- bat_career_nonpara %>% filter(playerID == 'gwynnto01')
career_diff <- rbind(career_diff, data.frame(PF = 'NO', 
                                             pops = 'econ_effect', 
                                             para = 'para', 
                                             league = 'historical', 
                                             diff_before = round(Tony_Gwynn$BA - Ty_Cobb$BA, 3), 
                                             diff_after = round(Tony_Gwynn_trimmed$BA - Ty_Cobb_trimmed$BA, 3)))

```

```{r echo=FALSE}
career_AVG <- NO_econ_effect_para_fixed_season %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            hits = sum(adj_AVG * adj_AB), 
            AB = sum(adj_AB),
            BA = hits / AB)
career_AVG <- career_AVG %>% mutate(BA = ifelse(AB == 0, 0, BA))

bat_career_nonpara <- NO_econ_effect_para_fixed_season_trimmed %>% group_by(playerID) %>% 
          summarise(name = unique(name), 
                    playerID = unique(playerID), 
                    PA = sum(round(PA)), 
                    AB = sum(AB), 
                    H = sum(H), 
                    HR = sum(round(HR)), 
                    BB = sum(round(BB)), 
                    BA = round(H/AB, 3), 
                    HBP = sum(HBP), 
                    SF = sum(SF), 
                    OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
                    ebWAR = sum(ebWAR), 
                    efWAR = sum(efWAR)) %>% ungroup() %>% 
          arrange(desc(ebWAR))
        
        bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
        bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))
        

Ty_Cobb <- career_AVG %>% filter(playerID == 'cobbty01')
Tony_Gwynn <- career_AVG %>% filter(playerID == 'gwynnto01')
Ty_Cobb_trimmed <- bat_career_nonpara %>% filter(playerID == 'cobbty01')
Tony_Gwynn_trimmed <- bat_career_nonpara %>% filter(playerID == 'gwynnto01')
career_diff <- rbind(career_diff, data.frame(PF = 'NO', 
                                             pops = 'econ_effect', 
                                             para = 'para', 
                                             league = 'fixed', 
                                             diff_before = round(Tony_Gwynn$BA - Ty_Cobb$BA, 3), 
                                             diff_after = round(Tony_Gwynn_trimmed$BA - Ty_Cobb_trimmed$BA, 3)))

```

```{r echo=FALSE}
career_AVG <- NO_econ_effect_nonpara_historical_season %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            hits = sum(adj_AVG * adj_AB), 
            AB = sum(adj_AB),
            BA = hits / AB)
career_AVG <- career_AVG %>% mutate(BA = ifelse(AB == 0, 0, BA))

bat_career_nonpara <- NO_econ_effect_nonpara_historical_season_trimmed %>% group_by(playerID) %>% 
          summarise(name = unique(name), 
                    playerID = unique(playerID), 
                    PA = sum(round(PA)), 
                    AB = sum(AB), 
                    H = sum(H), 
                    HR = sum(round(HR)), 
                    BB = sum(round(BB)), 
                    BA = round(H/AB, 3), 
                    HBP = sum(HBP), 
                    SF = sum(SF), 
                    OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
                    ebWAR = sum(ebWAR), 
                    efWAR = sum(efWAR)) %>% ungroup() %>% 
          arrange(desc(ebWAR))
        
        bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
        bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))
        

Ty_Cobb <- career_AVG %>% filter(playerID == 'cobbty01')
Tony_Gwynn <- career_AVG %>% filter(playerID == 'gwynnto01')
Ty_Cobb_trimmed <- bat_career_nonpara %>% filter(playerID == 'cobbty01')
Tony_Gwynn_trimmed <- bat_career_nonpara %>% filter(playerID == 'gwynnto01')
career_diff <- rbind(career_diff, data.frame(PF = 'NO', 
                                             pops = 'econ_effect', 
                                             para = 'nonpara', 
                                             league = 'historical', 
                                             diff_before = round(Tony_Gwynn$BA - Ty_Cobb$BA, 3), 
                                             diff_after = round(Tony_Gwynn_trimmed$BA - Ty_Cobb_trimmed$BA, 3)))

```

```{r echo=FALSE}
career_AVG <- NO_econ_effect_nonpara_fixed_season %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            hits = sum(adj_AVG * adj_AB), 
            AB = sum(adj_AB),
            BA = hits / AB)
career_AVG <- career_AVG %>% mutate(BA = ifelse(AB == 0, 0, BA))

bat_career_nonpara <- NO_econ_effect_nonpara_fixed_season_trimmed %>% group_by(playerID) %>% 
          summarise(name = unique(name), 
                    playerID = unique(playerID), 
                    PA = sum(round(PA)), 
                    AB = sum(AB), 
                    H = sum(H), 
                    HR = sum(round(HR)), 
                    BB = sum(round(BB)), 
                    BA = round(H/AB, 3), 
                    HBP = sum(HBP), 
                    SF = sum(SF), 
                    OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
                    ebWAR = sum(ebWAR), 
                    efWAR = sum(efWAR)) %>% ungroup() %>% 
          arrange(desc(ebWAR))
        
        bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
        bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))
        

Ty_Cobb <- career_AVG %>% filter(playerID == 'cobbty01')
Tony_Gwynn <- career_AVG %>% filter(playerID == 'gwynnto01')
Ty_Cobb_trimmed <- bat_career_nonpara %>% filter(playerID == 'cobbty01')
Tony_Gwynn_trimmed <- bat_career_nonpara %>% filter(playerID == 'gwynnto01')
career_diff <- rbind(career_diff, data.frame(PF = 'NO', 
                                             pops = 'econ_effect', 
                                             para = 'nonpara', 
                                             league = 'fixed', 
                                             diff_before = round(Tony_Gwynn$BA - Ty_Cobb$BA, 3), 
                                             diff_after = round(Tony_Gwynn_trimmed$BA - Ty_Cobb_trimmed$BA, 3)))

```


```{r echo=FALSE}
career_AVG <- NO_normal_para_historical_season %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            hits = sum(adj_AVG * adj_AB), 
            AB = sum(adj_AB),
            BA = hits / AB)
career_AVG <- career_AVG %>% mutate(BA = ifelse(AB == 0, 0, BA))

bat_career_nonpara <- NO_normal_para_historical_season_trimmed %>% group_by(playerID) %>% 
          summarise(name = unique(name), 
                    playerID = unique(playerID), 
                    PA = sum(round(PA)), 
                    AB = sum(AB), 
                    H = sum(H), 
                    HR = sum(round(HR)), 
                    BB = sum(round(BB)), 
                    BA = round(H/AB, 3), 
                    HBP = sum(HBP), 
                    SF = sum(SF), 
                    OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
                    ebWAR = sum(ebWAR), 
                    efWAR = sum(efWAR)) %>% ungroup() %>% 
          arrange(desc(ebWAR))
        
        bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
        bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))
        

Ty_Cobb <- career_AVG %>% filter(playerID == 'cobbty01')
Tony_Gwynn <- career_AVG %>% filter(playerID == 'gwynnto01')
Ty_Cobb_trimmed <- bat_career_nonpara %>% filter(playerID == 'cobbty01')
Tony_Gwynn_trimmed <- bat_career_nonpara %>% filter(playerID == 'gwynnto01')
career_diff <- rbind(career_diff, data.frame(PF = 'NO', 
                                             pops = 'normal', 
                                             para = 'para', 
                                             league = 'historical', 
                                             diff_before = round(Tony_Gwynn$BA - Ty_Cobb$BA, 3), 
                                             diff_after = round(Tony_Gwynn_trimmed$BA - Ty_Cobb_trimmed$BA, 3)))

```

```{r echo=FALSE}
career_AVG <- NO_normal_para_fixed_season %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            hits = sum(adj_AVG * adj_AB), 
            AB = sum(adj_AB),
            BA = hits / AB)
career_AVG <- career_AVG %>% mutate(BA = ifelse(AB == 0, 0, BA))

bat_career_nonpara <- NO_normal_para_fixed_season_trimmed %>% group_by(playerID) %>% 
          summarise(name = unique(name), 
                    playerID = unique(playerID), 
                    PA = sum(round(PA)), 
                    AB = sum(AB), 
                    H = sum(H), 
                    HR = sum(round(HR)), 
                    BB = sum(round(BB)), 
                    BA = round(H/AB, 3), 
                    HBP = sum(HBP), 
                    SF = sum(SF), 
                    OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
                    ebWAR = sum(ebWAR), 
                    efWAR = sum(efWAR)) %>% ungroup() %>% 
          arrange(desc(ebWAR))
        
        bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
        bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))
        

Ty_Cobb <- career_AVG %>% filter(playerID == 'cobbty01')
Tony_Gwynn <- career_AVG %>% filter(playerID == 'gwynnto01')
Ty_Cobb_trimmed <- bat_career_nonpara %>% filter(playerID == 'cobbty01')
Tony_Gwynn_trimmed <- bat_career_nonpara %>% filter(playerID == 'gwynnto01')
career_diff <- rbind(career_diff, data.frame(PF = 'NO', 
                                             pops = 'normal', 
                                             para = 'para', 
                                             league = 'fixed', 
                                             diff_before = round(Tony_Gwynn$BA - Ty_Cobb$BA, 3), 
                                             diff_after = round(Tony_Gwynn_trimmed$BA - Ty_Cobb_trimmed$BA, 3)))

```

```{r echo=FALSE}
career_AVG <- NO_normal_nonpara_historical_season %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            hits = sum(adj_AVG * adj_AB), 
            AB = sum(adj_AB),
            BA = hits / AB)
career_AVG <- career_AVG %>% mutate(BA = ifelse(AB == 0, 0, BA))

bat_career_nonpara <- NO_normal_nonpara_historical_season_trimmed %>% group_by(playerID) %>% 
          summarise(name = unique(name), 
                    playerID = unique(playerID), 
                    PA = sum(round(PA)), 
                    AB = sum(AB), 
                    H = sum(H), 
                    HR = sum(round(HR)), 
                    BB = sum(round(BB)), 
                    BA = round(H/AB, 3), 
                    HBP = sum(HBP), 
                    SF = sum(SF), 
                    OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
                    ebWAR = sum(ebWAR), 
                    efWAR = sum(efWAR)) %>% ungroup() %>% 
          arrange(desc(ebWAR))
        
        bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
        bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))
        

Ty_Cobb <- career_AVG %>% filter(playerID == 'cobbty01')
Tony_Gwynn <- career_AVG %>% filter(playerID == 'gwynnto01')
Ty_Cobb_trimmed <- bat_career_nonpara %>% filter(playerID == 'cobbty01')
Tony_Gwynn_trimmed <- bat_career_nonpara %>% filter(playerID == 'gwynnto01')
career_diff <- rbind(career_diff, data.frame(PF = 'NO', 
                                             pops = 'normal', 
                                             para = 'nonpara', 
                                             league = 'historical', 
                                             diff_before = round(Tony_Gwynn$BA - Ty_Cobb$BA, 3), 
                                             diff_after = round(Tony_Gwynn_trimmed$BA - Ty_Cobb_trimmed$BA, 3)))

```

```{r echo=FALSE}

career_AVG <- NO_normal_nonpara_fixed_season %>% group_by(playerID) %>% 
  summarise(name = unique(name),
            hits = sum(adj_AVG * adj_AB), 
            AB = sum(adj_AB),
            BA = hits / AB)
career_AVG <- career_AVG %>% mutate(BA = ifelse(AB == 0, 0, BA))

bat_career_nonpara <- NO_normal_nonpara_fixed_season_trimmed %>% group_by(playerID) %>% 
          summarise(name = unique(name), 
                    PA = sum(round(PA)), 
                    AB = sum(AB), 
                    H = sum(H), 
                    HR = sum(round(HR)), 
                    BB = sum(round(BB)), 
                    BA = round(H/AB, 3), 
                    HBP = sum(HBP), 
                    SF = sum(SF), 
                    OBP = round((H + BB + HBP)/(AB + BB + HBP + SF), 3), 
                    ebWAR = sum(ebWAR), 
                    efWAR = sum(efWAR)) %>% ungroup() %>% 
          arrange(desc(ebWAR))
        
        bat_career_nonpara <- bat_career_nonpara %>% mutate(BA = ifelse(AB == 0, 0, BA))
        bat_career_nonpara <- bat_career_nonpara %>% mutate(OBP = ifelse(AB + BB + HBP + SF == 0, 0, OBP))
        

Ty_Cobb <- career_AVG %>% filter(playerID == 'cobbty01')
Tony_Gwynn <- career_AVG %>% filter(playerID == 'gwynnto01')
Ty_Cobb_trimmed <- bat_career_nonpara %>% filter(playerID == 'cobbty01')
Tony_Gwynn_trimmed <- bat_career_nonpara %>% filter(playerID == 'gwynnto01')

career_diff <- rbind(career_diff, data.frame(PF = 'NO', 
                                             pops = 'normal', 
                                             para = 'nonpara', 
                                             league = 'fixed', 
                                             diff_before = round(Tony_Gwynn$BA - Ty_Cobb$BA, 3), 
                                             diff_after = round(Tony_Gwynn_trimmed$BA - Ty_Cobb_trimmed$BA, 3)))

```

```{r echo=FALSE}
career_diff <- career_diff[, c(1,2,3,4,6,5)]

career_diff[c(2:12,14:24), 1] <- ''
career_diff[c(2:4, 6:8, 10:12, 14:16, 18:20, 22:24), 2] <- ''
career_diff[c(2,4, 6,8, 10,12, 14,16, 18,20, 22,24), 3] <- ''

colnames(career_diff) <- c('Park Factor', 'Population', 'Distribution', 'League Size', 'Difference before', 'Difference after')

kable(career_diff)
```

## Table 11: career bWAR of Willie Mays minus the career bWAR of Babe Ruth under different configurations before and after applying the smoothing and trimming method in the Supplementary materials.

The table shows the value of career bWAR of Willie Mays minus the career bWAR of Babe Ruth under different configurations before and after applying the smoothing and trimming method. The Population column indicates the population changes we apply to the MLB-eligible population. The Increase shows we add 10\% for pre-integration seasons; The Decrease shows we deduct 10\% for the years prior to 1980 due to the economic effect; The Normal shows we use the normal MLB-eligible population. The League Size column indicates we consider two different league sizes as the number of components in each season. The Historical shows we use historical league size as the number of components in each season. The Fixed shows that we compute the maximum number of components in every season and consider this value as the fixed number of components each season. The Difference after indicates the value of the career bWAR of Willie Mays minus the career bWAR of Babe Ruth under different configurations after applying the smoothing and trimming method. The Difference before indicates the value of the career bWAR of Willie Mays minus the career bWAR of Babe Ruth under different configurations before applying the smoothing and trimming method.

```{r echo=FALSE}
career_bWAR_diff[c(2,4,6), 1] <- ''

colnames(career_bWAR_diff) <- c('Population', 'League Size', 'Difference before', 'Difference after')

kable(career_bWAR_diff)
```
